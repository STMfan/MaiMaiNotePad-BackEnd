# ç¼“å­˜é›†æˆç¤ºä¾‹

> åœ¨ MaiMNP Backend åº”ç”¨ä¸­é›†æˆç¼“å­˜ä¸­é—´ä»¶çš„å®Œæ•´ç¤ºä¾‹å’Œæµ‹è¯•æ–¹æ³•

## æ¦‚è¿°

æœ¬æ–‡æ¡£å±•ç¤ºå¦‚ä½•åœ¨ MaiMNP Backend åº”ç”¨ä¸­é›†æˆç¼“å­˜ä¸­é—´ä»¶ã€‚

## é›†æˆæ­¥éª¤

### 1. æ›´æ–°ä¸­é—´ä»¶é…ç½®

ä¿®æ”¹ `app/core/middleware.py`ï¼Œæ·»åŠ ç¼“å­˜ä¸­é—´ä»¶ï¼š

```python
"""
ä¸­é—´ä»¶é…ç½®æ¨¡å—

æä¾›ç»Ÿä¸€çš„ä¸­é—´ä»¶åˆå§‹åŒ–å’Œç®¡ç†ï¼ŒåŒ…æ‹¬ï¼šé€Ÿç‡é™åˆ¶ã€CORSã€é”™è¯¯å¤„ç†ã€ç¼“å­˜ç­‰ã€‚
"""

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded
from slowapi.middleware import SlowAPIMiddleware

from app.core.logging import app_logger
from app.core.cache import CacheMiddleware, get_cache_manager


def setup_middlewares(app: FastAPI) -> None:
    """
    ä¸º FastAPI åº”ç”¨é…ç½®æ‰€æœ‰ä¸­é—´ä»¶ã€‚

    Args:
        app: FastAPI åº”ç”¨å®ä¾‹

    ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºï¼ˆä»å¤–åˆ°å†…ï¼‰ï¼š
    1. ErrorHandlerMiddleware - é”™è¯¯å¤„ç†å’Œè¯·æ±‚æ—¥å¿—ï¼ˆå¾…æ·»åŠ ï¼‰
    2. CacheMiddleware - ç¼“å­˜ä¸­é—´ä»¶ï¼ˆå¯é€‰ï¼‰
    3. SlowAPIMiddleware - é€Ÿç‡é™åˆ¶
    4. CORSMiddleware - è·¨åŸŸæ”¯æŒ
    """
    try:
        # 1. æ·»åŠ ç¼“å­˜ä¸­é—´ä»¶ï¼ˆå¯é€‰ï¼‰
        try:
            cache_manager = get_cache_manager()
            if cache_manager.is_enabled():
                app.add_middleware(
                    CacheMiddleware,
                    cache_manager=cache_manager,
                    default_ttl=300,  # é»˜è®¤ç¼“å­˜ 5 åˆ†é’Ÿ
                    cache_query_params=True,
                    excluded_paths=[
                        "/api/auth",      # è®¤è¯æ¥å£ä¸ç¼“å­˜
                        "/api/admin",     # ç®¡ç†æ¥å£ä¸ç¼“å­˜
                        "/api/ws",        # WebSocket ä¸ç¼“å­˜
                        "/health",        # å¥åº·æ£€æŸ¥ä¸ç¼“å­˜
                    ]
                )
                app_logger.info("ç¼“å­˜ä¸­é—´ä»¶å·²å¯ç”¨")
            else:
                app_logger.info("ç¼“å­˜ä¸­é—´ä»¶å·²ç¦ç”¨ï¼ˆé™çº§æ¨¡å¼ï¼‰")
        except Exception as e:
            app_logger.warning(f"ç¼“å­˜ä¸­é—´ä»¶åˆå§‹åŒ–å¤±è´¥ï¼Œè·³è¿‡: {e}")
        
        # 2. åˆå§‹åŒ–é€Ÿç‡é™åˆ¶å™¨
        limiter = Limiter(key_func=get_remote_address, storage_uri="memory://")
        app.state.limiter = limiter
        app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)
        app_logger.debug("é€Ÿç‡é™åˆ¶å™¨å·²åˆå§‹åŒ–")

        # 3. æ·»åŠ é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
        app.add_middleware(SlowAPIMiddleware)
        app_logger.debug("é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶å·²æ·»åŠ ")

        # 4. æ·»åŠ  CORS ä¸­é—´ä»¶
        app.add_middleware(
            CORSMiddleware,
            allow_origins=["*"],  # ç”Ÿäº§ç¯å¢ƒåº”é…ç½®å…·ä½“åŸŸå
            allow_credentials=True,
            allow_methods=["*"],
            allow_headers=["*"],
            expose_headers=["Content-Disposition"],
        )
        app_logger.debug("CORS ä¸­é—´ä»¶å·²é…ç½®")

        app_logger.info("ä¸­é—´ä»¶é…ç½®å®Œæˆ")

    except Exception as e:
        app_logger.error(f"ä¸­é—´ä»¶é…ç½®å¤±è´¥: {str(e)}")
        raise
```

### 2. æ›´æ–°é…ç½®æ–‡ä»¶

ç¡®ä¿ `app/core/config.py` åŒ…å«ç¼“å­˜é…ç½®ï¼š

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # ... å…¶ä»–é…ç½® ...
    
    # ç¼“å­˜é…ç½®
    CACHE_ENABLED: bool = True
    CACHE_HOST: str = "localhost"
    CACHE_PORT: int = 6379
    CACHE_DB: int = 0
    CACHE_PASSWORD: str | None = None
    CACHE_KEY_PREFIX: str = "maimnp"
    CACHE_DEFAULT_TTL: int = 3600
    CACHE_MAX_CONNECTIONS: int = 10
    CACHE_SOCKET_TIMEOUT: int = 5
    CACHE_SOCKET_CONNECT_TIMEOUT: int = 5
    CACHE_RETRY_ON_TIMEOUT: bool = True
    
    class Config:
        env_file = ".env"
        case_sensitive = True

settings = Settings()
```

### 3. æ›´æ–°ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ç¼“å­˜é…ç½®ï¼š

```bash
# ç¼“å­˜é…ç½®
CACHE_ENABLED=true
CACHE_HOST=localhost
CACHE_PORT=6379
CACHE_DB=0
CACHE_PASSWORD=
CACHE_KEY_PREFIX=maimnp
CACHE_DEFAULT_TTL=3600
CACHE_MAX_CONNECTIONS=10
CACHE_SOCKET_TIMEOUT=5
CACHE_SOCKET_CONNECT_TIMEOUT=5
CACHE_RETRY_ON_TIMEOUT=true
```

### 4. æ·»åŠ ç¼“å­˜ç»Ÿè®¡ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

åœ¨ `app/api/routes/admin.py` æˆ–åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶ï¼š

```python
from fastapi import APIRouter, Depends
from app.core.cache import get_cache_manager
from app.api.deps import get_current_admin_user

router = APIRouter(prefix="/cache", tags=["ç¼“å­˜ç®¡ç†"])


@router.get("/stats")
async def get_cache_stats(
    current_user = Depends(get_current_admin_user)
):
    """è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    cache_manager = get_cache_manager()
    
    # ä»åº”ç”¨çŠ¶æ€è·å–ä¸­é—´ä»¶å®ä¾‹
    from app.main import app
    cache_middleware = None
    for middleware in app.user_middleware:
        if middleware.cls.__name__ == "CacheMiddleware":
            cache_middleware = middleware
            break
    
    if cache_middleware:
        return cache_middleware.get_stats()
    else:
        return {
            "message": "ç¼“å­˜ä¸­é—´ä»¶æœªå¯ç”¨",
            "cache_enabled": cache_manager.is_enabled()
        }


@router.post("/stats/reset")
async def reset_cache_stats(
    current_user = Depends(get_current_admin_user)
):
    """é‡ç½®ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…ç®¡ç†å‘˜ï¼‰"""
    from app.main import app
    cache_middleware = None
    for middleware in app.user_middleware:
        if middleware.cls.__name__ == "CacheMiddleware":
            cache_middleware = middleware
            break
    
    if cache_middleware:
        cache_middleware.reset_stats()
        return {"message": "ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®"}
    else:
        return {"message": "ç¼“å­˜ä¸­é—´ä»¶æœªå¯ç”¨"}


@router.post("/invalidate")
async def invalidate_cache(
    pattern: str,
    current_user = Depends(get_current_admin_user)
):
    """æ‰¹é‡å¤±æ•ˆç¼“å­˜ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    
    Args:
        pattern: ç¼“å­˜é”®æ¨¡å¼ï¼ˆæ”¯æŒ * é€šé…ç¬¦ï¼‰
    """
    cache_manager = get_cache_manager()
    deleted_count = await cache_manager.invalidate_pattern(pattern)
    
    return {
        "message": f"å·²åˆ é™¤ {deleted_count} ä¸ªç¼“å­˜é”®",
        "pattern": pattern,
        "deleted_count": deleted_count
    }
```

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1ï¼šå¯ç”¨ç¼“å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# .env
CACHE_ENABLED=true
CACHE_HOST=redis.production.internal
CACHE_PORT=6379
CACHE_PASSWORD=your_secure_password
```

å¯åŠ¨åº”ç”¨åï¼Œæ‰€æœ‰ GET è¯·æ±‚ä¼šè‡ªåŠ¨ç¼“å­˜ï¼š

```bash
# é¦–æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
curl -X GET http://localhost:8000/api/users
# å“åº”å¤´: X-Cache: MISS

# åç»­è¯·æ±‚ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
curl -X GET http://localhost:8000/api/users
# å“åº”å¤´: X-Cache: HIT
```

### åœºæ™¯ 2ï¼šç¦ç”¨ç¼“å­˜ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
# .env
CACHE_ENABLED=false
```

å¯åŠ¨åº”ç”¨åï¼Œæ‰€æœ‰è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼š

```bash
# æ‰€æœ‰è¯·æ±‚éƒ½ä¸ç¼“å­˜
curl -X GET http://localhost:8000/api/users
# å“åº”å¤´: æ—  X-Cache å¤´æˆ– X-Cache: MISS
```

### åœºæ™¯ 3ï¼šæŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡

```bash
# è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
curl -X GET http://localhost:8000/api/admin/cache/stats \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# å“åº”ç¤ºä¾‹
{
  "hits": 150,
  "misses": 50,
  "errors": 2,
  "bypassed": 30,
  "total_cached_requests": 200,
  "hit_rate": "75.00%",
  "cache_enabled": true
}
```

### åœºæ™¯ 4ï¼šæ‰‹åŠ¨å¤±æ•ˆç¼“å­˜

```bash
# å¤±æ•ˆæ‰€æœ‰ç”¨æˆ·ç›¸å…³ç¼“å­˜
curl -X POST http://localhost:8000/api/admin/cache/invalidate \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"pattern": "maimnp:http:*user*"}'

# å“åº”ç¤ºä¾‹
{
  "message": "å·²åˆ é™¤ 15 ä¸ªç¼“å­˜é”®",
  "pattern": "maimnp:http:*user*",
  "deleted_count": 15
}
```

## æµ‹è¯•éªŒè¯

### 1. å¯åŠ¨ Redis

```bash
# ä½¿ç”¨ Docker å¯åŠ¨ Redis
docker run -d \
  --name maimnp-redis \
  -p 6379:6379 \
  redis:7-alpine

# æˆ–ä½¿ç”¨ Homebrew å®‰è£…çš„ Redis
brew services start redis
```

### 2. å¯åŠ¨åº”ç”¨

```bash
# æ¿€æ´» Conda ç¯å¢ƒ
conda activate mai_notebook

# å¯åŠ¨åº”ç”¨
python app/main.py
```

### 3. æµ‹è¯•ç¼“å­˜åŠŸèƒ½

```bash
# æµ‹è¯• 1ï¼šé¦–æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
curl -v http://localhost:8000/api/users | grep X-Cache
# åº”è¯¥çœ‹åˆ°: X-Cache: MISS

# æµ‹è¯• 2ï¼šåç»­è¯·æ±‚ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
curl -v http://localhost:8000/api/users | grep X-Cache
# åº”è¯¥çœ‹åˆ°: X-Cache: HIT

# æµ‹è¯• 3ï¼šå¸¦æŸ¥è¯¢å‚æ•°çš„è¯·æ±‚
curl -v "http://localhost:8000/api/users?page=1" | grep X-Cache
# åº”è¯¥çœ‹åˆ°: X-Cache: MISSï¼ˆé¦–æ¬¡ï¼‰

curl -v "http://localhost:8000/api/users?page=1" | grep X-Cache
# åº”è¯¥çœ‹åˆ°: X-Cache: HITï¼ˆåç»­ï¼‰

# æµ‹è¯• 4ï¼šç¦ç”¨ç¼“å­˜çš„è¯·æ±‚
curl -v http://localhost:8000/api/users \
  -H "Cache-Control: no-cache" | grep X-Cache
# åº”è¯¥çœ‹åˆ°: X-Cache: MISSï¼ˆæ¯æ¬¡éƒ½æ˜¯ï¼‰
```

### 4. æµ‹è¯•é™çº§åŠŸèƒ½

```bash
# åœæ­¢ Redis
docker stop maimnp-redis

# æˆ–
brew services stop redis

# é‡å¯åº”ç”¨ï¼Œåº”è¯¥çœ‹åˆ°æ—¥å¿—ï¼š
# WARNING: Redis è¿æ¥å¤±è´¥ï¼Œé™çº§åˆ°æ•°æ®æº

# æµ‹è¯•è¯·æ±‚ï¼ˆåº”è¯¥æ­£å¸¸å·¥ä½œï¼‰
curl http://localhost:8000/api/users
# å“åº”æ­£å¸¸ï¼Œä½†ä¸ç¼“å­˜
```

## æ€§èƒ½å¯¹æ¯”

### ç¼“å­˜å¯ç”¨å‰

```bash
# ä½¿ç”¨ ab è¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 1000 -c 10 http://localhost:8000/api/users

# ç»“æœç¤ºä¾‹
Requests per second:    50.23 [#/sec]
Time per request:       199.08 [ms]
```

### ç¼“å­˜å¯ç”¨å

```bash
# ä½¿ç”¨ ab è¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 1000 -c 10 http://localhost:8000/api/users

# ç»“æœç¤ºä¾‹
Requests per second:    500.45 [#/sec]
Time per request:       19.98 [ms]

# æ€§èƒ½æå‡çº¦ 10 å€
```

## ç›‘æ§å’Œå‘Šè­¦

### 1. æ·»åŠ  Prometheus æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰

```python
from prometheus_client import Counter, Histogram, Gauge

# ç¼“å­˜æŒ‡æ ‡
cache_hits = Counter('cache_hits_total', 'ç¼“å­˜å‘½ä¸­æ¬¡æ•°')
cache_misses = Counter('cache_misses_total', 'ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°')
cache_errors = Counter('cache_errors_total', 'ç¼“å­˜é”™è¯¯æ¬¡æ•°')
cache_hit_rate = Gauge('cache_hit_rate', 'ç¼“å­˜å‘½ä¸­ç‡')

# åœ¨ä¸­é—´ä»¶ä¸­æ›´æ–°æŒ‡æ ‡
# cache_hits.inc()
# cache_misses.inc()
# cache_errors.inc()
```

### 2. é…ç½®å‘Šè­¦è§„åˆ™

```yaml
# prometheus/alerts.yml
groups:
  - name: cache_alerts
    rules:
      - alert: CacheHitRateLow
        expr: cache_hit_rate < 0.7
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ä½äº 70%ï¼Œå½“å‰å€¼: {{ $value }}"
      
      - alert: CacheErrorsHigh
        expr: rate(cache_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ç¼“å­˜é”™è¯¯ç‡è¿‡é«˜"
          description: "ç¼“å­˜é”™è¯¯ç‡è¿‡é«˜ï¼Œæ¯åˆ†é’Ÿè¶…è¿‡ 10 æ¬¡"
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç¼“å­˜æœªç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½æ˜¾ç¤º `X-Cache: MISS`

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ç¼“å­˜æ˜¯å¦å¯ç”¨
   ```bash
   # æŸ¥çœ‹æ—¥å¿—
   grep "ç¼“å­˜ä¸­é—´ä»¶" logs/app.log
   ```

2. æ£€æŸ¥ Redis è¿æ¥
   ```bash
   redis-cli ping
   ```

3. æ£€æŸ¥é…ç½®
   ```bash
   # æŸ¥çœ‹ç¯å¢ƒå˜é‡
   echo $CACHE_ENABLED
   ```

### é—®é¢˜ 2ï¼šRedis è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šæ—¥å¿—ä¸­å‡ºç° "Redis è¿æ¥å¤±è´¥"

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€
   ```bash
   docker ps | grep redis
   # æˆ–
   brew services list | grep redis
   ```

2. æ£€æŸ¥ç½‘ç»œè¿æ¥
   ```bash
   telnet localhost 6379
   ```

3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™

### é—®é¢˜ 3ï¼šç¼“å­˜å‘½ä¸­ç‡ä½

**ç—‡çŠ¶**ï¼šç¼“å­˜å‘½ä¸­ç‡ä½äº 70%

**å¯èƒ½åŸå› **ï¼š

1. TTL è®¾ç½®è¿‡çŸ­
2. æŸ¥è¯¢å‚æ•°è¿‡å¤šå¯¼è‡´ç¼“å­˜é”®åˆ†æ•£
3. æ•°æ®æ›´æ–°é¢‘ç¹

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. å¢åŠ  TTL
2. è€ƒè™‘å¿½ç•¥æŸäº›æŸ¥è¯¢å‚æ•°
3. è°ƒæ•´ç¼“å­˜ç­–ç•¥

## ç›¸å…³æ–‡æ¡£

- [ç¼“å­˜ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—](./ç¼“å­˜ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—.md)
- [ç¼“å­˜ç³»ç»Ÿé…ç½®æŒ‡å—](./ç¼“å­˜ç³»ç»Ÿé…ç½®æŒ‡å—.md)
- [ç¼“å­˜ç»Ÿè®¡APIæ–‡æ¡£](./ç¼“å­˜ç»Ÿè®¡APIæ–‡æ¡£.md)

---

**æ–‡æ¡£ä¿¡æ¯**

| é¡¹ç›® | å†…å®¹ |
|------|------|
| åˆ›å»ºæ—¥æœŸ | 2026-02-23 |
| æœ€åæ›´æ–° | 2026-02-23 |
| ç»´æŠ¤è€… | CorrectPath, A-Dawn, cuckoo711 |
| çŠ¶æ€ | ğŸ“ å‚è€ƒæ–‡æ¡£ |
