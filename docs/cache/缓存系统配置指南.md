# ç¼“å­˜ç³»ç»Ÿé…ç½®æŒ‡å—

> Redis ç¼“å­˜ç³»ç»Ÿçš„é…ç½®æ–¹æ³•å’Œå‚æ•°è¯´æ˜ï¼Œæ”¯æŒè‡ªåŠ¨é™çº§æœºåˆ¶

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» MaiMNP Backend çš„ Redis ç¼“å­˜ç³»ç»Ÿé…ç½®æ–¹æ³•ã€‚ç¼“å­˜ç³»ç»Ÿæ”¯æŒè‡ªåŠ¨é™çº§æœºåˆ¶ï¼Œå½“ç¼“å­˜ç¦ç”¨æˆ– Redis ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“è®¿é—®ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘æ­£å¸¸è¿è¡Œã€‚

## æ ¸å¿ƒç‰¹æ€§

- **å¯é€‰å¢å¼º**ï¼šç¼“å­˜ä½œä¸ºæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œä¸æ˜¯ç³»ç»Ÿå¿…éœ€ç»„ä»¶
- **è‡ªåŠ¨é™çº§**ï¼šç¼“å­˜ç¦ç”¨æˆ– Redis æ•…éšœæ—¶è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“
- **é…ç½®é©±åŠ¨**ï¼šæ”¯æŒé…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡ä¸¤ç§é…ç½®æ–¹å¼
- **çµæ´»æ§åˆ¶**ï¼šæ”¯æŒå…¨å±€å¯ç”¨/ç¦ç”¨å¼€å…³

## é…ç½®æ–¹å¼

### æ–¹å¼ 1ï¼šé…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

ç¼–è¾‘ `configs/config.toml` æ–‡ä»¶ï¼š

```toml
[cache]
# ç¼“å­˜å¼€å…³ï¼Œfalse æ—¶è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“
enabled = true
host = "localhost"
port = 6379
db = 0
key_prefix = "maimnp"
default_ttl = 3600  # é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ1 å°æ—¶
max_connections = 10
socket_timeout = 5
socket_connect_timeout = 5
retry_on_timeout = true
```

### æ–¹å¼ 2ï¼šç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# ç¼“å­˜é…ç½®ï¼ˆRedisï¼‰
CACHE_ENABLED=true
CACHE_HOST=localhost
CACHE_PORT=6379
CACHE_DB=0
CACHE_PASSWORD=  # Redis å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
CACHE_KEY_PREFIX=maimnp
CACHE_DEFAULT_TTL=3600
CACHE_MAX_CONNECTIONS=10
CACHE_SOCKET_TIMEOUT=5
CACHE_SOCKET_CONNECT_TIMEOUT=5
CACHE_RETRY_ON_TIMEOUT=true
```

**æ³¨æ„**ï¼šç¯å¢ƒå˜é‡çš„ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ã€‚

## é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enabled` | bool | true | ç¼“å­˜å¼€å…³ï¼Œfalse æ—¶è‡ªåŠ¨é™çº§ |
| `host` | str | localhost | Redis æœåŠ¡å™¨åœ°å€ |
| `port` | int | 6379 | Redis æœåŠ¡å™¨ç«¯å£ï¼ˆ1-65535ï¼‰ |
| `db` | int | 0 | Redis æ•°æ®åº“ç¼–å·ï¼ˆâ‰¥0ï¼‰ |
| `password` | str | None | Redis å¯†ç ï¼ˆå¯é€‰ï¼‰ |
| `key_prefix` | str | maimnp | ç¼“å­˜é”®å‰ç¼€ |
| `default_ttl` | int | 3600 | é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œ>0ï¼‰ |
| `max_connections` | int | 10 | æœ€å¤§è¿æ¥æ•°ï¼ˆ>0ï¼‰ |
| `socket_timeout` | int | 5 | Socket è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `socket_connect_timeout` | int | 5 | è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `retry_on_timeout` | bool | true | è¶…æ—¶æ—¶æ˜¯å¦é‡è¯• |

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç”Ÿäº§ç¯å¢ƒï¼ˆç¼“å­˜å¯ç”¨ï¼‰

```toml
[cache]
enabled = true
host = "redis.production.internal"
port = 6379
password = "${REDIS_PASSWORD}"  # ä»ç¯å¢ƒå˜é‡è¯»å–
default_ttl = 3600
```

### åœºæ™¯ 2ï¼šå¼€å‘ç¯å¢ƒï¼ˆç¼“å­˜ç¦ç”¨ï¼‰

```toml
[cache]
enabled = false  # ç¦ç”¨ç¼“å­˜ï¼Œä¾¿äºè°ƒè¯•
```

### åœºæ™¯ 3ï¼šæµ‹è¯•ç¯å¢ƒï¼ˆçŸ­ TTLï¼‰

```toml
[cache]
enabled = true
host = "localhost"
default_ttl = 300  # 5 åˆ†é’Ÿï¼Œä¾¿äºæµ‹è¯•
```

## é™çº§æœºåˆ¶

### è‡ªåŠ¨é™çº§è§¦å‘æ¡ä»¶

1. **é…ç½®ç¦ç”¨**ï¼š`enabled = false`
2. **æœªé…ç½®**ï¼šé…ç½®æ–‡ä»¶æ—  `[cache]` èŠ‚
3. **è¿æ¥å¤±è´¥**ï¼šRedis æœåŠ¡å™¨ä¸å¯è¾¾
4. **è®¤è¯å¤±è´¥**ï¼šRedis å¯†ç é”™è¯¯
5. **è¶…æ—¶**ï¼šæ“ä½œè¶…è¿‡ `socket_timeout`

### é™çº§è¡Œä¸º

- æ‰€æœ‰ç¼“å­˜æ“ä½œè‡ªåŠ¨è·³è¿‡
- ç›´æ¥è®¿é—®æ•°æ®åº“è·å–æ•°æ®
- ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¹ä¸šåŠ¡é€»è¾‘é€æ˜
- è®°å½•é™çº§æ—¥å¿—ï¼Œä¾¿äºç›‘æ§

## ä»£ç ç¤ºä¾‹

### åˆ›å»ºç¼“å­˜é…ç½®

```python
from app.core.cache import CacheConfig, create_cache_config_from_settings

# æ–¹å¼ 1ï¼šä»åº”ç”¨é…ç½®åˆ›å»ºï¼ˆæ¨èï¼‰
cache_config = create_cache_config_from_settings()

# æ–¹å¼ 2ï¼šæ‰‹åŠ¨åˆ›å»º
cache_config = CacheConfig(
    enabled=True,
    host="localhost",
    port=6379,
    db=0,
    key_prefix="maimnp",
    default_ttl=3600
)
```

### ä½¿ç”¨ç¼“å­˜ç®¡ç†å™¨

```python
from app.core.cache import CacheManager

# åˆ›å»ºç¼“å­˜ç®¡ç†å™¨
cache_manager = CacheManager(
    redis_client=None,  # åç»­ä»»åŠ¡ä¼šå®ç° Redis å®¢æˆ·ç«¯
    key_prefix="maimnp",
    enabled=cache_config.enabled
)

# æ£€æŸ¥ç¼“å­˜æ˜¯å¦å¯ç”¨
if cache_manager.is_enabled():
    print("ç¼“å­˜å·²å¯ç”¨")
else:
    print("ç¼“å­˜å·²ç¦ç”¨ï¼Œå°†ä½¿ç”¨æ•°æ®åº“")
```

## éªŒè¯é…ç½®

è¿è¡Œæµ‹è¯•éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®ï¼š

```bash
conda activate mai_notebook
python -m pytest tests/unit/core/cache/test_cache_config.py -v
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç¼“å­˜æœªç”Ÿæ•ˆ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤ `enabled = true`
2. æ£€æŸ¥ Redis æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`redis-cli ping`
3. æ£€æŸ¥è¿æ¥å‚æ•°æ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é™çº§ä¿¡æ¯

### é—®é¢˜ 2ï¼šé…ç½®éªŒè¯å¤±è´¥

**å¸¸è§é”™è¯¯**ï¼š
- ç«¯å£å·è¶…å‡ºèŒƒå›´ï¼ˆ1-65535ï¼‰
- æ•°æ®åº“ç¼–å·ä¸ºè´Ÿæ•°
- TTL ä¸ºé›¶æˆ–è´Ÿæ•°
- æœ€å¤§è¿æ¥æ•°ä¸ºé›¶æˆ–è´Ÿæ•°

**è§£å†³æ–¹æ³•**ï¼šæ ¹æ®é”™è¯¯æç¤ºè°ƒæ•´é…ç½®å‚æ•°ã€‚

## ä¸‹ä¸€æ­¥

å½“å‰ä»»åŠ¡å·²å®Œæˆç¼“å­˜é…ç½®ç³»ç»Ÿçš„æ­å»ºã€‚åç»­ä»»åŠ¡å°†å®ç°ï¼š

1. Redis å®¢æˆ·ç«¯å°è£…ï¼ˆä»»åŠ¡ 2ï¼‰
2. ç¼“å­˜ç®¡ç†å™¨æ ¸å¿ƒåŠŸèƒ½ï¼ˆä»»åŠ¡ 3ï¼‰
3. ç¼“å­˜è£…é¥°å™¨ï¼ˆä»»åŠ¡ 4ï¼‰
4. æœåŠ¡å±‚é›†æˆï¼ˆä»»åŠ¡ 7ï¼‰

## ç›¸å…³æ–‡æ¡£

- [ç¼“å­˜ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—](./ç¼“å­˜ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—.md)
- [ç¼“å­˜æ—¥å¿—è®°å½•æŒ‡å—](./ç¼“å­˜æ—¥å¿—è®°å½•æŒ‡å—.md)

---

**æ–‡æ¡£ä¿¡æ¯**

| é¡¹ç›® | å†…å®¹ |
|------|------|
| åˆ›å»ºæ—¥æœŸ | 2026-02-23 |
| æœ€åæ›´æ–° | 2026-02-23 |
| ç»´æŠ¤è€… | CorrectPath, A-Dawn, cuckoo711 |
| çŠ¶æ€ | ğŸ“ å‚è€ƒæ–‡æ¡£ |
