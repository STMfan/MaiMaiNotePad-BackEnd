# ç¼“å­˜ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—

> FastAPI ç¼“å­˜ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—ï¼Œæ”¯æŒè‡ªåŠ¨ç¼“å­˜ GET è¯·æ±‚ã€ç¼“å­˜å¤´å¤„ç†å’Œè‡ªåŠ¨é™çº§

## æ¦‚è¿°

`CacheMiddleware` æ˜¯ä¸€ä¸ª FastAPI ä¸­é—´ä»¶ï¼Œç”¨äºè‡ªåŠ¨ç¼“å­˜ GET è¯·æ±‚çš„å“åº”ã€‚å®ƒæ”¯æŒï¼š

- è‡ªåŠ¨ç¼“å­˜ GET è¯·æ±‚å“åº”
- æ ¹æ®è¯·æ±‚è·¯å¾„å’Œå‚æ•°ç”Ÿæˆç¼“å­˜é”®
- å¤„ç†ç¼“å­˜å¤´ï¼ˆCache-Controlã€ETagï¼‰
- æ”¯æŒè‡ªåŠ¨é™çº§ï¼ˆç¼“å­˜ç¦ç”¨æˆ– Redis æ•…éšœæ—¶ï¼‰
- æä¾›ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬é›†æˆ

åœ¨ FastAPI åº”ç”¨ä¸­æ·»åŠ ç¼“å­˜ä¸­é—´ä»¶ï¼š

```python
from fastapi import FastAPI
from app.core.cache import CacheMiddleware, create_cache_manager

app = FastAPI()

# åˆ›å»ºç¼“å­˜ç®¡ç†å™¨
cache_manager = create_cache_manager()

# æ·»åŠ ç¼“å­˜ä¸­é—´ä»¶
app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    default_ttl=300  # é»˜è®¤ç¼“å­˜ 5 åˆ†é’Ÿ
)
```

### 2. é…ç½®é€‰é¡¹

ä¸­é—´ä»¶æ”¯æŒä»¥ä¸‹é…ç½®é€‰é¡¹ï¼š

```python
app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    default_ttl=300,                    # é»˜è®¤ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
    cache_query_params=True,            # æ˜¯å¦å°†æŸ¥è¯¢å‚æ•°çº³å…¥ç¼“å­˜é”®
    excluded_paths=["/admin", "/api"]   # æ’é™¤çš„è·¯å¾„åˆ—è¡¨ï¼ˆä¸ç¼“å­˜ï¼‰
)
```

## å·¥ä½œåŸç†

### ç¼“å­˜æµç¨‹

1. **è¯·æ±‚æ‹¦æˆª**ï¼šä¸­é—´ä»¶æ‹¦æˆªæ‰€æœ‰ GET è¯·æ±‚
2. **ç¼“å­˜é”®ç”Ÿæˆ**ï¼šæ ¹æ®è¯·æ±‚è·¯å¾„å’Œå‚æ•°ç”Ÿæˆå”¯ä¸€çš„ç¼“å­˜é”®
3. **ç¼“å­˜æŸ¥è¯¢**ï¼šå°è¯•ä» Redis è·å–ç¼“å­˜æ•°æ®
4. **ç¼“å­˜å‘½ä¸­**ï¼šå¦‚æœç¼“å­˜å­˜åœ¨ï¼Œç›´æ¥è¿”å›ç¼“å­˜å“åº”
5. **ç¼“å­˜æœªå‘½ä¸­**ï¼šæ‰§è¡Œå®é™…è¯·æ±‚ï¼Œå¹¶ç¼“å­˜å“åº”

### ç¼“å­˜é”®ç”Ÿæˆè§„åˆ™

ç¼“å­˜é”®æ ¼å¼ï¼š`{prefix}:http:{hash}`

- `prefix`ï¼šç¼“å­˜é”®å‰ç¼€ï¼ˆæ¥è‡ª CacheManagerï¼‰
- `hash`ï¼šè¯·æ±‚è·¯å¾„å’Œå‚æ•°çš„ MD5 å“ˆå¸Œå€¼

ç¤ºä¾‹ï¼š
- `/users/123` â†’ `maimnp:http:a1b2c3d4...`
- `/users?page=1&size=10` â†’ `maimnp:http:e5f6g7h8...`

### ç¼“å­˜å¤´å¤„ç†

#### Cache-Control

ä¸­é—´ä»¶ä¼šè§£æå“åº”çš„ `Cache-Control` å¤´ï¼š

```python
# å“åº”ä¸­è®¾ç½® Cache-Control
@app.get("/users")
async def get_users():
    response = JSONResponse({"users": [...]})
    response.headers["Cache-Control"] = "max-age=3600"  # ç¼“å­˜ 1 å°æ—¶
    return response
```

æ”¯æŒçš„æŒ‡ä»¤ï¼š
- `max-age=<seconds>`ï¼šæŒ‡å®šç¼“å­˜æ—¶é—´
- `no-store`ï¼šç¦æ­¢ç¼“å­˜
- `no-cache`ï¼šå¼ºåˆ¶é‡æ–°éªŒè¯

#### ETag

ä¸­é—´ä»¶è‡ªåŠ¨ä¸ºå“åº”ç”Ÿæˆ ETagï¼š

```python
# å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦ä¸Š If-None-Match å¤´
GET /users
If-None-Match: "a1b2c3d4..."

# å¦‚æœ ETag åŒ¹é…ï¼Œè¿”å› 304 Not Modified
HTTP/1.1 304 Not Modified
ETag: "a1b2c3d4..."
```

## ç¼“å­˜ç­–ç•¥

### 1. è‡ªåŠ¨ç¼“å­˜

æ‰€æœ‰ GET è¯·æ±‚é»˜è®¤ä¼šè¢«ç¼“å­˜ï¼ˆé™¤éè¢«æ’é™¤ï¼‰ï¼š

```python
@app.get("/users")
async def get_users():
    # è¿™ä¸ªç«¯ç‚¹çš„å“åº”ä¼šè¢«è‡ªåŠ¨ç¼“å­˜
    return {"users": [...]}
```

### 2. æ’é™¤ç‰¹å®šè·¯å¾„

æŸäº›è·¯å¾„ä¸åº”è¯¥è¢«ç¼“å­˜ï¼ˆå¦‚ç®¡ç†æ¥å£ã€å®æ—¶æ•°æ®ï¼‰ï¼š

```python
app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    excluded_paths=[
        "/admin",           # ç®¡ç†æ¥å£
        "/api/internal",    # å†…éƒ¨ API
        "/ws"               # WebSocket ç«¯ç‚¹
    ]
)
```

### 3. ç¦ç”¨ç¼“å­˜

å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¯·æ±‚å¤´ç¦ç”¨ç¼“å­˜ï¼š

```python
# å®¢æˆ·ç«¯è¯·æ±‚
GET /users
Cache-Control: no-cache

# ä¸­é—´ä»¶ä¼šè·³è¿‡ç¼“å­˜ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚
```

### 4. è‡ªå®šä¹‰ TTL

åœ¨è·¯ç”±ä¸­è®¾ç½®è‡ªå®šä¹‰ç¼“å­˜æ—¶é—´ï¼š

```python
@app.get("/users")
async def get_users():
    response = JSONResponse({"users": [...]})
    response.headers["Cache-Control"] = "max-age=7200"  # ç¼“å­˜ 2 å°æ—¶
    return response
```

## é™çº§æœºåˆ¶

### ç¼“å­˜ç¦ç”¨

å½“ç¼“å­˜è¢«ç¦ç”¨æ—¶ï¼Œä¸­é—´ä»¶ä¼šè‡ªåŠ¨é™çº§ï¼š

```python
# é…ç½®æ–‡ä»¶ä¸­ç¦ç”¨ç¼“å­˜
[cache]
enabled = false

# æˆ–è€…åœ¨ä»£ç ä¸­ç¦ç”¨
cache_manager = CacheManager(
    redis_client=None,
    enabled=False
)
```

é™çº§è¡Œä¸ºï¼š
- æ‰€æœ‰è¯·æ±‚ç›´æ¥è½¬å‘åˆ°ä¸‹æ¸¸å¤„ç†å™¨
- ä¸æ‰§è¡Œä»»ä½• Redis æ“ä½œ
- å¯¹å®¢æˆ·ç«¯å®Œå…¨é€æ˜

### Redis æ•…éšœ

å½“ Redis è¿æ¥å¤±è´¥æ—¶ï¼Œä¸­é—´ä»¶ä¼šè‡ªåŠ¨é™çº§ï¼š

```python
# Redis ä¸å¯ç”¨æ—¶
# 1. æ•è·è¿æ¥å¼‚å¸¸
# 2. è®°å½•è­¦å‘Šæ—¥å¿—
# 3. ç›´æ¥æ‰§è¡Œè¯·æ±‚
# 4. è¿”å›æ­£å¸¸å“åº”
```

## ç¼“å­˜ç»Ÿè®¡

### è·å–ç»Ÿè®¡ä¿¡æ¯

ä¸­é—´ä»¶æä¾›ç¼“å­˜ç»Ÿè®¡åŠŸèƒ½ï¼š

```python
from fastapi import FastAPI, Depends
from app.core.cache import CacheMiddleware

app = FastAPI()

# æ·»åŠ ä¸­é—´ä»¶
cache_middleware = CacheMiddleware(
    app=app,
    cache_manager=cache_manager
)

# æ·»åŠ ç»Ÿè®¡ç«¯ç‚¹
@app.get("/cache/stats")
async def get_cache_stats():
    return cache_middleware.get_stats()
```

ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼š
```json
{
    "hits": 150,                    // ç¼“å­˜å‘½ä¸­æ¬¡æ•°
    "misses": 50,                   // ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
    "errors": 2,                    // é”™è¯¯æ¬¡æ•°
    "bypassed": 30,                 // è·³è¿‡ç¼“å­˜æ¬¡æ•°
    "total_cached_requests": 200,   // æ€»ç¼“å­˜è¯·æ±‚æ•°
    "hit_rate": "75.00%",           // ç¼“å­˜å‘½ä¸­ç‡
    "cache_enabled": true           // ç¼“å­˜æ˜¯å¦å¯ç”¨
}
```

### é‡ç½®ç»Ÿè®¡

```python
@app.post("/cache/stats/reset")
async def reset_cache_stats():
    cache_middleware.reset_stats()
    return {"message": "ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®"}
```

## å“åº”å¤´

ä¸­é—´ä»¶ä¼šåœ¨å“åº”ä¸­æ·»åŠ ä»¥ä¸‹å¤´éƒ¨ï¼š

### X-Cache

æŒ‡ç¤ºç¼“å­˜çŠ¶æ€ï¼š
- `HIT`ï¼šç¼“å­˜å‘½ä¸­
- `MISS`ï¼šç¼“å­˜æœªå‘½ä¸­

```python
# å“åº”ç¤ºä¾‹
HTTP/1.1 200 OK
X-Cache: HIT
ETag: "a1b2c3d4..."
Content-Type: application/json
```

### X-Response-Time

è®°å½•å“åº”æ—¶é—´ï¼ˆç”¨äºæ€§èƒ½ç›‘æ§ï¼‰ï¼š

```python
HTTP/1.1 200 OK
X-Cache: MISS
X-Response-Time: 0.123s
```

## æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½® TTL

æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è®¾ç½®åˆé€‚çš„ TTLï¼š

```python
# é™æ€æ•°æ®ï¼šé•¿ TTL
@app.get("/config")
async def get_config():
    response = JSONResponse({...})
    response.headers["Cache-Control"] = "max-age=86400"  # 1 å¤©
    return response

# åŠ¨æ€æ•°æ®ï¼šçŸ­ TTL
@app.get("/users/online")
async def get_online_users():
    response = JSONResponse({...})
    response.headers["Cache-Control"] = "max-age=60"  # 1 åˆ†é’Ÿ
    return response
```

### 2. æ’é™¤æ•æ„Ÿæ¥å£

ä¸è¦ç¼“å­˜åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ¥å£ï¼š

```python
app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    excluded_paths=[
        "/auth",        # è®¤è¯æ¥å£
        "/admin",       # ç®¡ç†æ¥å£
        "/api/private"  # ç§æœ‰ API
    ]
)
```

### 3. ç›‘æ§ç¼“å­˜æ€§èƒ½

å®šæœŸæ£€æŸ¥ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼š

```python
# æ·»åŠ ç›‘æ§ç«¯ç‚¹
@app.get("/health/cache")
async def cache_health():
    stats = cache_middleware.get_stats()
    
    # æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
    hit_rate = float(stats["hit_rate"].rstrip("%"))
    if hit_rate < 70:
        return {
            "status": "warning",
            "message": "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½",
            "stats": stats
        }
    
    return {
        "status": "healthy",
        "stats": stats
    }
```

### 4. å¤„ç†æŸ¥è¯¢å‚æ•°

æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦ç¼“å­˜æŸ¥è¯¢å‚æ•°ï¼š

```python
# åœºæ™¯ 1ï¼šæŸ¥è¯¢å‚æ•°å½±å“ç»“æœï¼ˆåº”è¯¥ç¼“å­˜ï¼‰
app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    cache_query_params=True  # /users?page=1 å’Œ /users?page=2 åˆ†åˆ«ç¼“å­˜
)

# åœºæ™¯ 2ï¼šæŸ¥è¯¢å‚æ•°ä¸å½±å“ç»“æœï¼ˆå¯ä»¥å¿½ç•¥ï¼‰
app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    cache_query_params=False  # /users?debug=1 å’Œ /users ä½¿ç”¨ç›¸åŒç¼“å­˜
)
```

## æ•…éšœæ’æŸ¥

### ç¼“å­˜æœªç”Ÿæ•ˆ

æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **ç¼“å­˜æ˜¯å¦å¯ç”¨**
   ```python
   # æ£€æŸ¥é…ç½®
   print(cache_manager.is_enabled())  # åº”è¯¥è¿”å› True
   ```

2. **è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸º GET**
   ```python
   # åªæœ‰ GET è¯·æ±‚ä¼šè¢«ç¼“å­˜
   # POSTã€PUTã€DELETE ç­‰è¯·æ±‚ä¸ä¼šè¢«ç¼“å­˜
   ```

3. **è·¯å¾„æ˜¯å¦è¢«æ’é™¤**
   ```python
   # æ£€æŸ¥ excluded_paths é…ç½®
   ```

4. **è¯·æ±‚å¤´æ˜¯å¦åŒ…å« no-cache**
   ```python
   # æ£€æŸ¥å®¢æˆ·ç«¯è¯·æ±‚å¤´
   Cache-Control: no-cache  # ä¼šè·³è¿‡ç¼“å­˜
   ```

### ç¼“å­˜å‘½ä¸­ç‡ä½

å¯èƒ½çš„åŸå› ï¼š

1. **TTL è®¾ç½®è¿‡çŸ­**ï¼šå¢åŠ  TTL æ—¶é—´
2. **æŸ¥è¯¢å‚æ•°è¿‡å¤š**ï¼šè€ƒè™‘å¿½ç•¥æŸäº›å‚æ•°
3. **æ•°æ®æ›´æ–°é¢‘ç¹**ï¼šè°ƒæ•´ç¼“å­˜ç­–ç•¥
4. **ç¼“å­˜é”®å†²çª**ï¼šæ£€æŸ¥é”®ç”Ÿæˆé€»è¾‘

### Redis è¿æ¥å¤±è´¥

ä¸­é—´ä»¶ä¼šè‡ªåŠ¨é™çº§ï¼Œä½†åº”è¯¥ï¼š

1. **æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€**
   ```bash
   redis-cli ping
   ```

2. **æ£€æŸ¥è¿æ¥é…ç½®**
   ```python
   # éªŒè¯é…ç½®
   print(cache_manager.redis_client.host)
   print(cache_manager.redis_client.port)
   ```

3. **æŸ¥çœ‹æ—¥å¿—**
   ```python
   # æ—¥å¿—ä¸­ä¼šè®°å½•è¿æ¥å¤±è´¥ä¿¡æ¯
   # WARNING: Redis è¿æ¥å¤±è´¥ï¼Œé™çº§åˆ°æ­£å¸¸è¯·æ±‚å¤„ç†
   ```

## å®Œæ•´ç¤ºä¾‹

```python
from fastapi import FastAPI
from app.core.cache import (
    create_cache_manager,
    CacheMiddleware
)

# åˆ›å»ºåº”ç”¨
app = FastAPI()

# åˆ›å»ºç¼“å­˜ç®¡ç†å™¨
cache_manager = create_cache_manager()

# æ·»åŠ ç¼“å­˜ä¸­é—´ä»¶
cache_middleware = CacheMiddleware(
    app=app,
    cache_manager=cache_manager,
    default_ttl=300,
    cache_query_params=True,
    excluded_paths=["/admin", "/auth", "/ws"]
)

app.add_middleware(
    CacheMiddleware,
    cache_manager=cache_manager,
    default_ttl=300,
    cache_query_params=True,
    excluded_paths=["/admin", "/auth", "/ws"]
)

# æ·»åŠ è·¯ç”±
@app.get("/users")
async def get_users():
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰"""
    return {"users": [...]}

@app.get("/users/{user_id}")
async def get_user(user_id: str):
    """è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰"""
    return {"user": {...}}

@app.get("/config")
async def get_config():
    """è·å–é…ç½®ï¼ˆé•¿æ—¶é—´ç¼“å­˜ï¼‰"""
    response = JSONResponse({"config": {...}})
    response.headers["Cache-Control"] = "max-age=86400"  # 1 å¤©
    return response

# ç¼“å­˜ç»Ÿè®¡ç«¯ç‚¹
@app.get("/cache/stats")
async def get_cache_stats():
    """è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯"""
    return cache_middleware.get_stats()

@app.post("/cache/stats/reset")
async def reset_cache_stats():
    """é‡ç½®ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯"""
    cache_middleware.reset_stats()
    return {"message": "ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®"}
```

## ç›¸å…³æ–‡æ¡£

- [ç¼“å­˜ç³»ç»Ÿé…ç½®æŒ‡å—](./ç¼“å­˜ç³»ç»Ÿé…ç½®æŒ‡å—.md)
- [ç¼“å­˜é›†æˆç¤ºä¾‹](./ç¼“å­˜é›†æˆç¤ºä¾‹.md)
- [ç¼“å­˜ç»Ÿè®¡APIæ–‡æ¡£](./ç¼“å­˜ç»Ÿè®¡APIæ–‡æ¡£.md)
- [ç¼“å­˜æ—¥å¿—è®°å½•æŒ‡å—](./ç¼“å­˜æ—¥å¿—è®°å½•æŒ‡å—.md)

---

**æ–‡æ¡£ä¿¡æ¯**

| é¡¹ç›® | å†…å®¹ |
|------|------|
| åˆ›å»ºæ—¥æœŸ | 2026-02-23 |
| æœ€åæ›´æ–° | 2026-02-23 |
| ç»´æŠ¤è€… | CorrectPath, A-Dawn, cuckoo711 |
| çŠ¶æ€ | ğŸ“ å‚è€ƒæ–‡æ¡£ |
