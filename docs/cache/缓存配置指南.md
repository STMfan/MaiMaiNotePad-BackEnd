# 缓存配置指南

## 概述

本文档介绍如何配置和管理 MaiMNP Backend 的 Redis 缓存系统。缓存系统支持启用/禁用开关，提供灵活的降级策略，确保在缓存故障时系统仍能正常运行。

## 配置文件

### 配置文件位置

缓存配置位于 `configs/` 目录下，项目提供了三个预配置文件：

```
configs/
├── config.dev.toml       # 开发环境配置
├── config.prod.toml      # 生产环境配置
└── config.degraded.toml  # 降级模式配置
```

### 配置文件选择

根据不同的使用场景选择合适的配置文件：

| 配置文件 | 使用场景 | 缓存状态 | TTL | 连接数 |
|---------|---------|---------|-----|--------|
| `config.dev.toml` | 本地开发、功能测试 | 启用 | 300秒 | 5 |
| `config.prod.toml` | 生产部署 | 启用 | 3600秒 | 20 |
| `config.degraded.toml` | 调试、故障恢复 | 禁用 | N/A | N/A |

## 配置参数说明

### 缓存配置节 `[cache]`

```toml
[cache]
enabled = true                    # 缓存开关
host = "localhost"                # Redis 服务器地址
port = 6379                       # Redis 服务器端口
db = 0                            # Redis 数据库编号
key_prefix = "maimnp"             # 缓存键前缀
default_ttl = 3600                # 默认过期时间（秒）
max_connections = 10              # 最大连接数
socket_timeout = 5                # Socket 超时时间（秒）
socket_connect_timeout = 5        # 连接超时时间（秒）
retry_on_timeout = true           # 超时时是否重试
```

### 参数详解

#### `enabled` - 缓存开关

- **类型**: 布尔值
- **默认值**: `true`
- **说明**: 控制缓存是否启用
  - `true`: 启用缓存，使用 Redis 存储数据
  - `false`: 禁用缓存，自动降级到数据库访问
- **使用场景**:
  - 开发调试时设为 `false` 以实时查看数据库变化
  - Redis 故障时设为 `false` 快速恢复服务
  - 性能测试对比时切换启用/禁用状态

#### `host` - Redis 服务器地址

- **类型**: 字符串
- **默认值**: `"localhost"`
- **说明**: Redis 服务器的主机名或 IP 地址
- **示例**:
  - 本地开发: `"localhost"` 或 `"127.0.0.1"`
  - 生产环境: `"redis.production.internal"`
  - Docker 环境: `"redis"` (服务名)

#### `port` - Redis 服务器端口

- **类型**: 整数
- **默认值**: `6379`
- **范围**: 1-65535
- **说明**: Redis 服务器监听的端口号

#### `db` - Redis 数据库编号

- **类型**: 整数
- **默认值**: `0`
- **范围**: 0-15 (取决于 Redis 配置)
- **说明**: Redis 数据库编号，用于隔离不同环境的数据

#### `key_prefix` - 缓存键前缀

- **类型**: 字符串
- **默认值**: `"maimnp"`
- **说明**: 所有缓存键的前缀，用于避免键冲突
- **建议**:
  - 开发环境: `"maimnp:dev"`
  - 生产环境: `"maimnp:prod"`
  - 测试环境: `"maimnp:test"`

#### `default_ttl` - 默认过期时间

- **类型**: 整数（秒）
- **默认值**: `3600` (1小时)
- **说明**: 缓存数据的默认过期时间
- **建议**:
  - 开发环境: 300秒 (5分钟) - 便于测试
  - 生产环境: 3600秒 (1小时) - 平衡性能和一致性
  - 热点数据: 可设置更长的 TTL

#### `max_connections` - 最大连接数

- **类型**: 整数
- **默认值**: `10`
- **说明**: Redis 连接池的最大连接数
- **建议**:
  - 开发环境: 5-10
  - 生产环境: 20-50 (根据并发量调整)

#### `socket_timeout` - Socket 超时时间

- **类型**: 整数（秒）
- **默认值**: `5`
- **说明**: Redis 操作的超时时间
- **建议**: 3-10秒，过短可能导致频繁超时

#### `socket_connect_timeout` - 连接超时时间

- **类型**: 整数（秒）
- **默认值**: `5`
- **说明**: 建立 Redis 连接的超时时间
- **建议**: 3-10秒

#### `retry_on_timeout` - 超时重试

- **类型**: 布尔值
- **默认值**: `true`
- **说明**: 超时时是否自动重试

## 环境变量配置

敏感信息（如 Redis 密码）应通过环境变量配置，不要写入配置文件。

### 支持的环境变量

```bash
# Redis 密码（生产环境必须设置）
export REDIS_PASSWORD="your_secure_password"

# 缓存开关（可覆盖配置文件）
export CACHE_ENABLED=true

# Redis 连接信息（可覆盖配置文件）
export CACHE_HOST="localhost"
export CACHE_PORT=6379
export CACHE_DB=0

# 其他配置
export CACHE_KEY_PREFIX="maimnp"
export CACHE_DEFAULT_TTL=3600
export CACHE_MAX_CONNECTIONS=10
```

### 配置优先级

配置加载遵循以下优先级（从高到低）：

1. **环境变量** - 最高优先级
2. **配置文件** (`config.toml`) - 中等优先级
3. **默认值** - 最低优先级

## 使用场景

### 场景 1：开发环境

**目标**: 快速开发和调试

**配置文件**: `configs/config.dev.toml`

```toml
[cache]
enabled = true
host = "localhost"
port = 6379
db = 0
key_prefix = "maimnp:dev"
default_ttl = 300  # 5分钟，便于测试缓存失效
max_connections = 5
```

**启动方式**:
```bash
# 使用开发配置
cp configs/config.dev.toml configs/config.toml
python main.py
```

### 场景 2：生产环境

**目标**: 高性能、高可用

**配置文件**: `configs/config.prod.toml`

```toml
[cache]
enabled = true
host = "redis.production.internal"
port = 6379
db = 0
key_prefix = "maimnp:prod"
default_ttl = 3600  # 1小时
max_connections = 20
```

**环境变量**:
```bash
export REDIS_PASSWORD="your_secure_password"
```

**启动方式**:
```bash
# 使用生产配置
cp configs/config.prod.toml configs/config.toml
export REDIS_PASSWORD="your_secure_password"
python main.py
```

### 场景 3：降级模式（缓存禁用）

**目标**: 调试问题或 Redis 故障时快速恢复

**配置文件**: `configs/config.degraded.toml`

```toml
[cache]
enabled = false  # 禁用缓存，直接访问数据库
```

**使用场景**:
- 调试缓存相关问题
- Redis 服务故障时应急恢复
- 性能测试对比（缓存启用 vs 禁用）
- 开发时需要实时查看数据库变化

**启动方式**:
```bash
# 使用降级配置
cp configs/config.degraded.toml configs/config.toml
python main.py
```

或者通过环境变量临时禁用：
```bash
export CACHE_ENABLED=false
python main.py
```

### 场景 4：Docker 部署

**docker/docker-compose.yml**:
```yaml
version: '3.8'

services:
  app:
    build: .
    environment:
      - CACHE_ENABLED=true
      - CACHE_HOST=redis
      - CACHE_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - redis
  
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data

volumes:
  redis-data:
```

## 配置验证

### 使用验证脚本

项目提供了配置验证脚本，可以在部署前验证配置的正确性：

```bash
# 验证开发环境配置
python scripts/python/validate_cache_config.py configs/config.dev.toml

# 验证生产环境配置
python scripts/python/validate_cache_config.py configs/config.prod.toml

# 验证降级模式配置
python scripts/python/validate_cache_config.py configs/config.degraded.toml

# 使用 Shell 脚本（自动激活 Conda 环境）
./scripts/shell/validate_cache_config.sh configs/config.prod.toml
```

### 验证输出示例

```
======================================================================
验证配置文件: configs/config.prod.toml
======================================================================

📋 缓存配置信息:
  - 缓存状态: ✅ 启用
  - Redis 地址: redis.production.internal:6379
  - 数据库编号: 0
  - 键前缀: maimnp:prod
  - 默认 TTL: 3600 秒
  - 最大连接数: 20
  - Socket 超时: 5 秒
  - 连接超时: 5 秒
  - 超时重试: 是
  - 密码保护: 否

⚠️  发现 1 个警告:
  1. 生产环境建议设置 Redis 密码以提高安全性

💡 配置建议:
  - 缓存已启用，确保 Redis 服务正常运行
  - 生产环境建议设置 REDIS_PASSWORD 环境变量
  - 定期监控缓存命中率和内存使用情况

======================================================================
✅ 验证完成
======================================================================
```

## 配置最佳实践

### 1. 安全性

- ✅ **生产环境必须设置 Redis 密码**
  ```bash
  export REDIS_PASSWORD="your_secure_password"
  ```

- ✅ **不要在配置文件中存储密码**
  ```toml
  # ❌ 错误
  [cache]
  password = "my_password"
  
  # ✅ 正确
  [cache]
  # 密码从环境变量 REDIS_PASSWORD 读取
  ```

- ✅ **使用防火墙限制 Redis 访问**
  - 仅允许应用服务器访问 Redis 端口
  - 不要将 Redis 暴露到公网

### 2. 性能优化

- ✅ **根据环境调整 TTL**
  - 开发环境: 300秒 (5分钟)
  - 生产环境: 3600秒 (1小时)
  - 热点数据: 可设置更长的 TTL

- ✅ **合理设置连接池大小**
  - 开发环境: 5-10
  - 生产环境: 20-50
  - 根据并发量和 Redis 性能调整

- ✅ **使用合适的键前缀**
  - 避免键冲突
  - 便于监控和调试
  - 支持按环境隔离数据

### 3. 可靠性

- ✅ **启用降级机制**
  - 缓存故障时自动降级到数据库
  - 不影响业务逻辑的正确性

- ✅ **配置合理的超时时间**
  - Socket 超时: 5秒
  - 连接超时: 5秒
  - 避免长时间阻塞

- ✅ **启用超时重试**
  ```toml
  [cache]
  retry_on_timeout = true
  ```

### 4. 监控和运维

- ✅ **定期检查缓存状态**
  ```bash
  # 查看缓存统计信息
  curl http://localhost:9278/api/metrics/cache-stats
  ```

- ✅ **监控关键指标**
  - 缓存命中率 (目标 ≥ 80%)
  - 缓存降级次数
  - Redis 内存使用
  - 响应时间

- ✅ **配置告警**
  - 缓存命中率低于 70%
  - Redis 连接失败
  - 内存使用超过 90%

## 故障排查

### 问题 1：缓存未生效

**症状**: 数据总是从数据库读取，缓存命中率为 0

**排查步骤**:

1. 检查缓存是否启用
   ```bash
   # 查看配置
   grep "enabled" configs/config.toml
   
   # 检查环境变量
   echo $CACHE_ENABLED
   ```

2. 检查 Redis 连接
   ```bash
   # 测试 Redis 连接
   redis-cli -h localhost -p 6379 ping
   ```

3. 查看应用日志
   ```bash
   tail -f logs/maimnp.log | grep cache
   ```

**解决方案**:
- 确保 `enabled = true`
- 确保 Redis 服务正常运行
- 检查网络连接和防火墙设置

### 问题 2：Redis 连接失败

**症状**: 应用启动时报 Redis 连接错误

**排查步骤**:

1. 检查 Redis 服务状态
   ```bash
   # 检查 Redis 是否运行
   redis-cli ping
   
   # 或使用 Docker
   docker ps | grep redis
   ```

2. 检查连接配置
   ```bash
   # 验证配置
   python scripts/python/validate_cache_config.py configs/config.toml
   ```

3. 测试连接
   ```bash
   # 使用 redis-cli 测试
   redis-cli -h localhost -p 6379 -a your_password ping
   ```

**解决方案**:
- 启动 Redis 服务
- 检查主机名和端口配置
- 验证密码是否正确
- 或者临时禁用缓存：`export CACHE_ENABLED=false`

### 问题 3：缓存数据不一致

**症状**: 更新数据后，API 返回旧数据

**排查步骤**:

1. 检查缓存失效逻辑
   ```python
   # 确保更新操作包含缓存失效
   @cache_invalidate(key_pattern="user:{user_id}")
   async def update_user(user_id: str, data: dict):
       # 更新逻辑
       pass
   ```

2. 手动清除缓存
   ```bash
   # 使用 redis-cli 清除特定键
   redis-cli DEL "maimnp:user:123"
   
   # 或清除所有缓存
   redis-cli FLUSHDB
   ```

**解决方案**:
- 确保更新/删除操作包含缓存失效逻辑
- 调整 TTL 设置
- 实现更严格的缓存失效策略

### 问题 4：内存使用过高

**症状**: Redis 内存使用持续增长

**排查步骤**:

1. 检查内存使用
   ```bash
   redis-cli INFO memory
   ```

2. 检查键数量
   ```bash
   redis-cli DBSIZE
   ```

3. 查看大键
   ```bash
   redis-cli --bigkeys
   ```

**解决方案**:
- 配置 Redis 最大内存和淘汰策略
  ```
  maxmemory 2gb
  maxmemory-policy allkeys-lru
  ```
- 调整 TTL 设置
- 清理过期键

## 相关文档

- [缓存日志记录指南](../缓存日志记录指南.md) - 缓存日志配置和使用
- [缓存中间件使用指南](../cache_middleware_usage.md) - 缓存中间件配置
- [缓存统计 API](../cache-stats-api.md) - 缓存监控接口
- [架构文档](../architecture/架构文档.md) - 系统架构说明

## 总结

- 缓存配置支持启用/禁用开关，提供灵活的降级策略
- 根据不同环境选择合适的配置文件
- 敏感信息通过环境变量配置
- 使用验证脚本确保配置正确性
- 定期监控缓存状态和性能指标
- 遵循最佳实践确保安全性和可靠性

---

**最后更新**: 2026-02-23
