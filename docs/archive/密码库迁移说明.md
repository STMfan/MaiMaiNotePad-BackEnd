# Passlib 到 Bcrypt 迁移说明

**日期**: 2026-02-22  
**原因**: 修复 Python 3.13 废弃警告

---

## 问题背景

在运行测试时出现以下警告：

```
DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
  from crypt import crypt as _crypt
```

这是因为 `passlib==1.7.4`（2020年版本）使用了 Python 3.13 将要移除的 `crypt` 模块。

---

## 解决方案

**直接使用 bcrypt 库**，移除 passlib 依赖。

### 优势

1. **无废弃警告** - bcrypt 库不依赖 crypt 模块
2. **更简单** - 项目只使用 bcrypt 算法，不需要 passlib 的多算法支持
3. **更现代** - bcrypt 4.2.1 是最新版本
4. **性能更好** - 直接调用，无中间层
5. **兼容性好** - 生成的哈希格式完全兼容

---

## 变更内容

### 1. 依赖更新

**requirements.txt**:
```diff
- passlib[bcrypt]==1.7.4
- bcrypt==3.2.2
+ bcrypt==4.2.1
```

### 2. 代码更新

**app/core/security.py**:

```python
# 旧代码（使用 passlib）
from passlib.context import CryptContext

pwd_context = CryptContext(
    schemes=["bcrypt"],
    deprecated="auto",
    bcrypt__rounds=bcrypt_rounds
)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password[:72])
```

```python
# 新代码（直接使用 bcrypt）
import bcrypt

BCRYPT_ROUNDS = int(os.getenv("BCRYPT_ROUNDS") or 12)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    try:
        password_bytes = plain_password.encode('utf-8')
        hashed_bytes = hashed_password.encode('utf-8') if isinstance(hashed_password, str) else hashed_password
        return bcrypt.checkpw(password_bytes, hashed_bytes)
    except Exception:
        return False

def get_password_hash(password: str) -> str:
    password_bytes = password[:72].encode('utf-8')
    salt = bcrypt.gensalt(rounds=BCRYPT_ROUNDS)
    hashed = bcrypt.hashpw(password_bytes, salt)
    return hashed.decode('utf-8')
```

### 3. 环境变量更新

**环境变量名称变更**:
- 旧: `PASSLIB_BCRYPT_ROUNDS`
- 新: `BCRYPT_ROUNDS`

**更新的文件**:
- `tests/.test_env`
- `tests/.test_env.template`
- `tests/fixtures/config.py`
- `tests/conftest.py`
- `app/core/config.py`

---

## 兼容性说明

### ✅ 完全兼容

1. **哈希格式兼容** - bcrypt 生成的哈希格式与 passlib 完全相同
2. **验证兼容** - 可以验证旧的 passlib 生成的哈希
3. **数据库无需迁移** - 现有的密码哈希无需更改
4. **API 接口不变** - 函数签名保持一致

### 测试验证

```python
# 旧密码哈希（passlib 生成）
old_hash = "$2b$12$..."

# 新代码可以正常验证
assert verify_password("password123", old_hash) == True
```

---

## 升级步骤

### 1. 更新依赖

```bash
pip install -r requirements.txt
```

### 2. 更新环境变量（如果有自定义配置）

如果你在 `.env` 或其他配置文件中设置了 `PASSLIB_BCRYPT_ROUNDS`，需要改为 `BCRYPT_ROUNDS`：

```bash
# 旧
PASSLIB_BCRYPT_ROUNDS=12

# 新
BCRYPT_ROUNDS=12
```

### 3. 验证

运行测试确保一切正常：

```bash
pytest
```

应该不再看到 `crypt` 相关的废弃警告。

---

## 性能对比

### Bcrypt Rounds 说明

- **Rounds**: 控制哈希计算的迭代次数（2^rounds）
- **推荐值**: 
  - 生产环境: 12-14
  - 测试环境: 4（加速测试）

### 测试性能

使用 `BCRYPT_ROUNDS=4` 可以将测试速度提升 21 倍：
- 使用 rounds=12: ~451秒
- 使用 rounds=4: ~21秒

---

## 回滚方案

如果需要回滚到 passlib：

1. 恢复 `requirements.txt`:
   ```
   passlib[bcrypt]==1.7.4
   bcrypt==3.2.2
   ```

2. 恢复 `app/core/security.py` 中的代码

3. 将环境变量 `BCRYPT_ROUNDS` 改回 `PASSLIB_BCRYPT_ROUNDS`

---

## 常见问题

### Q: 现有用户的密码还能用吗？
A: 可以。bcrypt 生成的哈希格式与 passlib 完全兼容，现有密码无需重置。

### Q: 需要重新哈希所有密码吗？
A: 不需要。新代码可以验证旧的哈希。

### Q: 性能有变化吗？
A: 性能略有提升，因为减少了中间层调用。

### Q: 为什么不升级 passlib？
A: passlib 1.7.4 是最新版本（2020年），已经多年未更新。直接使用 bcrypt 更简单、更现代。

---

## 相关文档

- [bcrypt 官方文档](https://github.com/pyca/bcrypt/)
- [安全配置文档](../configuration/配置管理文档.md)
- [测试文档](../../tests/docs/测试说明.md)

---

**文档信息**

| 项目 | 内容 |
|------|------|
| 创建日期 | 2026-02-22 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | ✅ 已完成 |
