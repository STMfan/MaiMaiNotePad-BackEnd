# 通用缓存失效机制实现

**日期**: 2026-02-24  
**版本**: 2.1.1  
**状态**: 已完成

## 概述

实现了通用的自动缓存失效机制，在数据更新时自动清除相关缓存，确保缓存数据的一致性。该机制已扩展到所有业务模块（用户、消息、评论、人设卡、知识库）。

## 背景

在之前的测试中发现，HTTP 缓存中间件会缓存 GET 请求响应（默认 TTL 300秒），即使数据库数据被删除或更新，API 仍返回缓存的旧数据，导致测试失败。需要一个通用的机制来自动失效缓存。

## 实现方案

### 1. 核心模块

创建了 `app/core/cache/invalidation.py` 模块，包含：

#### 1.1 通用缓存失效函数

```python
def invalidate_cache_sync(cache_manager, patterns: List[str]):
    """
    同步方式失效缓存（用于同步代码中）
    
    - 智能检测事件循环状态
    - 支持在异步和同步环境中使用
    - 自动处理事件循环创建和清理
    """
```

#### 1.2 业务特定函数

- `invalidate_persona_cache(pc_id=None)`: 失效人设卡缓存
- `invalidate_knowledge_cache(kb_id=None, uploader_id=None)`: 失效知识库缓存
- `invalidate_user_cache(user_id=None)`: 失效用户缓存
- `invalidate_message_cache(message_id=None, user_id=None)`: 失效消息缓存
- `invalidate_comment_cache(comment_id=None, target_id=None)`: 失效评论缓存

所有函数都自动获取 `cache_manager` 实例，无需手动传递。

### 2. 集成位置

#### 2.1 PersonaService (人设卡服务)

在以下方法中集成缓存失效：
- `save_persona_card()`: 创建人设卡后
- `update_persona_card()`: 更新人设卡后
- `delete_persona_card()`: 删除人设卡后
- `add_star()`: 添加收藏后
- `remove_star()`: 取消收藏后

#### 2.2 KnowledgeService (知识库服务)

在以下方法中集成缓存失效：
- `save_knowledge_base()`: 创建知识库后
- `update_knowledge_base()`: 更新知识库后
- `delete_knowledge_base()`: 删除知识库后
- `add_star()`: 添加收藏后
- `remove_star()`: 取消收藏后

#### 2.3 FileUploadService (文件上传服务)

在以下方法中集成缓存失效：
- `upload_persona_card()`: 上传人设卡后

#### 2.4 UserService (用户服务)

在以下方法中集成缓存失效：
- `create_user()`: 创建用户后
- `update_user()`: 更新用户信息后
- `update_password()`: 更新密码后
- `update_role()`: 更新角色后

#### 2.5 MessageService (消息服务)

在以下方法中集成缓存失效：
- `create_messages()`: 创建消息后
- `delete_message()`: 删除消息后
- `delete_broadcast_messages()`: 删除广播消息后
- `update_message()`: 更新消息后
- `update_broadcast_messages()`: 更新广播消息后

#### 2.6 评论路由 (app/api/routes/comments.py)

在以下路由中集成缓存失效：
- `create_comment()`: 创建评论后
- `delete_comment()`: 删除评论后

## 技术细节

### 缓存模式设计

每个业务模块使用特定的缓存模式：

```python
# 人设卡
"maimnp:http:*persona/public*"  # 公开人设卡列表
"maimnp:http:*persona/{pc_id}*"  # 特定人设卡详情

# 知识库
"maimnp:kb:public:*"  # 公开知识库列表
"maimnp:http:*knowledge/{kb_id}*"  # 特定知识库详情
"maimnp:kb:user:{uploader_id}:*"  # 用户知识库列表

# 用户
"maimnp:http:*users/{user_id}*"  # 用户详情
"user:{user_id}"  # 用户数据

# 消息
"maimnp:http:*messages*"  # 所有消息相关缓存
"maimnp:http:*messages/{message_id}*"  # 特定消息
"maimnp:http:*messages*user_id={user_id}*"  # 用户消息列表

# 评论
"maimnp:http:*comments*"  # 所有评论相关缓存
"maimnp:http:*comments/{comment_id}*"  # 特定评论
"maimnp:http:*comments*target_id={target_id}*"  # 目标评论列表
```

### 事件循环处理

智能检测和处理事件循环状态：

1. **已有事件循环**: 使用 `asyncio.create_task()` 异步执行
2. **无事件循环**: 创建新的事件循环，同步执行后关闭
3. **错误处理**: 捕获所有异常，记录日志但不影响业务逻辑

### 自动获取 cache_manager

所有业务特定函数内部自动获取 `cache_manager` 实例：

```python
from app.core.cache.factory import get_cache_manager

cache_manager = get_cache_manager()
if not cache_manager.is_enabled():
    return
```

这样调用时无需传递 `cache_manager` 参数，简化了使用。

## 测试结果

### 人设卡测试
- 67 个测试全部通过 ✅

### 知识库测试
- 11 个测试全部通过 ✅

### 用户测试
- 116 个测试全部通过 ✅

### 消息测试
- 66 个测试全部通过 ✅

### 评论测试
- 42 个测试全部通过 ✅

## 使用示例

### 在服务中使用

```python
from app.core.cache.invalidation import invalidate_persona_cache

class PersonaService:
    def save_persona_card(self, data: dict):
        # 保存人设卡
        persona_card = PersonaCard(**data)
        self.db.add(persona_card)
        self.db.commit()
        
        # 自动失效缓存
        invalidate_persona_cache(pc_id=persona_card.id)
        
        return persona_card
```

### 在路由中使用

```python
from app.core.cache.invalidation import invalidate_comment_cache

@router.post("/comments")
async def create_comment(data: dict, db: Session = Depends(get_db)):
    # 创建评论
    comment = Comment(**data)
    db.add(comment)
    db.commit()
    
    # 失效评论缓存
    invalidate_comment_cache()
    
    return Success(data=comment)
```

## 优势

1. **通用性**: 适用于所有业务模块
2. **自动化**: 数据更新时自动失效缓存，无需手动管理
3. **灵活性**: 支持同步和异步环境
4. **可靠性**: 智能处理事件循环，避免常见错误
5. **简单性**: 调用简单，无需传递 cache_manager 参数
6. **安全性**: 错误不会影响业务逻辑

## 注意事项

1. 缓存失效是异步操作，不会阻塞业务逻辑
2. 如果缓存未启用，函数会直接返回，不执行任何操作
3. 缓存失效失败会记录日志，但不会抛出异常
4. 建议在数据库提交成功后立即调用缓存失效函数

## 后续优化建议

1. 考虑添加批量缓存失效功能
2. 添加缓存失效的监控和统计
3. 优化缓存模式匹配性能
4. 考虑添加缓存预热机制

## 相关文件

- `app/core/cache/invalidation.py`: 缓存失效核心模块
- `app/services/persona_service.py`: 人设卡服务集成
- `app/services/knowledge_service.py`: 知识库服务集成
- `app/services/file_upload_service.py`: 文件上传服务集成
- `app/services/user_service.py`: 用户服务集成
- `app/services/message_service.py`: 消息服务集成
- `app/api/routes/comments.py`: 评论路由集成

## 总结

通用缓存失效机制已成功实现并集成到所有业务模块中，所有测试通过。该机制确保了缓存数据的一致性，提升了系统的可靠性和用户体验。
