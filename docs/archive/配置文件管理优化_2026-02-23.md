# 配置文件管理优化

**日期**: 2026-02-23  
**类型**: 功能优化  
**状态**: 已完成

## 概述

优化项目配置文件管理方式，从单一 `config.toml` 模式改为多环境配置文件模式，支持开发、生产、降级三种环境的快速切换。

## 背景

### 原有方式的问题

1. **配置切换不便**: 需要手动复制模板文件或修改 `config.toml`
2. **环境混淆风险**: 容易在生产环境使用开发配置
3. **版本控制困难**: `config.toml` 不提交到 Git，团队成员配置不一致
4. **降级模式不明确**: 缓存故障时需要手动修改配置

### 新方式的优势

1. **一键切换**: 通过环境变量或 manage.sh 快速切换配置
2. **环境隔离**: 三个独立配置文件，避免混淆
3. **版本控制**: 配置文件可提交到 Git（不含敏感信息）
4. **降级支持**: 专门的降级模式配置，应急响应更快

## 实现内容

### 1. 配置文件结构调整

#### 新增配置文件

- `configs/config.dev.toml` - 开发环境配置
- `configs/config.prod.toml` - 生产环境配置
- `configs/config.degraded.toml` - 降级模式配置

#### 废弃文件

- `configs/config.toml` - 不再使用（保留在 .gitignore）
- `configs/templates/config.toml.template` - 保留用于参考

### 2. ConfigManager 改进

**文件**: `app/core/config_manager.py`

#### 主要变更

```python
def __init__(self, config_file: Optional[str] = None):
    """
    初始化配置管理器
    
    Args:
        config_file: 配置文件路径，如果为 None 则根据 CONFIG_ENV 环境变量自动选择
                    CONFIG_ENV 可选值: dev, prod, degraded
                    默认使用 dev 配置
    """
    if config_file is None:
        # 从环境变量读取配置环境
        config_env = os.environ.get("CONFIG_ENV", "dev").lower()
        
        # 映射环境到配置文件
        env_to_file = {
            "dev": "configs/config.dev.toml",
            "prod": "configs/config.prod.toml",
            "degraded": "configs/config.degraded.toml",
        }
        
        self.config_file = env_to_file.get(config_env, "configs/config.dev.toml")
        self.config_env = config_env
    else:
        self.config_file = config_file
        self.config_env = "custom"
```

#### 新增方法

- `get_current_env()` - 获取当前配置环境
- `get_config_file_path()` - 获取当前配置文件路径

### 3. manage.sh 功能扩展

#### 新增交互式菜单

**菜单选项 4**: 配置管理

子菜单包括：
1. 切换到开发环境 (dev)
2. 切换到生产环境 (prod)
3. 切换到降级模式 (degraded)
4. 查看当前配置文件内容
5. 查看所有配置文件
6. 验证配置文件

#### 新增命令行命令

```bash
# 查看当前配置
./manage.sh config-show

# 切换配置环境
./manage.sh config-switch dev
./manage.sh config-switch prod
./manage.sh config-switch degraded

# 验证所有配置文件
./manage.sh config-validate
```

#### 帮助文档更新

添加了配置环境说明和使用示例。

### 4. 文档更新

#### configs/README.md

- 完全重写配置文件说明
- 添加配置切换方式说明
- 添加配置文件对比表
- 添加常见问题解答

#### 新增内容

- 配置环境说明（dev/prod/degraded）
- 三种配置切换方式
- 配置加载逻辑说明
- 部署指南更新
- 常见问题解答

## 配置环境对比

| 配置项 | dev | prod | degraded |
|--------|-----|------|----------|
| 缓存启用 | ✓ | ✓ | ✗ |
| 缓存 TTL | 5 分钟 | 1 小时 | N/A |
| Redis 连接数 | 5 | 20 | N/A |
| 日志级别 | DEBUG | INFO | INFO |
| 适用场景 | 本地开发 | 生产部署 | 故障恢复 |

## 使用方式

### 方式 1: 使用 manage.sh（推荐）

```bash
# 交互式菜单
./manage.sh
# 选择 "4. 配置管理"

# 命令行模式
./manage.sh config-switch prod
./manage.sh config-show
./manage.sh config-validate
```

### 方式 2: 设置环境变量

```bash
# 设置环境变量
export CONFIG_ENV=prod

# 启动服务
python -m uvicorn app.main:app
```

### 方式 3: 启动时指定

```bash
# 一次性指定
CONFIG_ENV=prod python -m uvicorn app.main:app
```

## 迁移指南

### 对于现有部署

1. **检查当前配置**
   ```bash
   cat configs/config.toml
   ```

2. **选择对应的环境配置**
   - 开发环境 → 使用 `config.dev.toml`
   - 生产环境 → 使用 `config.prod.toml`
   - 需要禁用缓存 → 使用 `config.degraded.toml`

3. **设置环境变量**
   ```bash
   # 在 .bashrc 或 .zshrc 中添加
   export CONFIG_ENV=prod
   ```

4. **验证配置**
   ```bash
   ./manage.sh config-validate
   ```

5. **重启服务**
   ```bash
   # 服务会自动使用新的配置文件
   ```

### 对于新部署

1. **设置环境变量**
   ```bash
   cp configs/templates/.env.template .env
   vim .env  # 设置敏感信息
   ```

2. **选择配置环境**
   ```bash
   export CONFIG_ENV=dev  # 或 prod, degraded
   ```

3. **启动服务**
   ```bash
   python -m uvicorn app.main:app
   ```

## 向后兼容性

- 保留 `config.toml` 在 `.gitignore` 中
- 保留 `config.toml.template` 用于参考
- `ConfigManager` 仍支持自定义配置文件路径
- 未设置 `CONFIG_ENV` 时默认使用 `dev` 配置

## 测试验证

### 配置加载测试

```python
from app.core.config_manager import config_manager

# 测试当前环境
print(f"当前环境: {config_manager.get_current_env()}")
print(f"配置文件: {config_manager.get_config_file_path()}")

# 测试配置读取
cache_enabled = config_manager.get_bool("cache.enabled")
print(f"缓存启用: {cache_enabled}")
```

### 配置切换测试

```bash
# 测试开发环境
CONFIG_ENV=dev python -c "from app.core.config_manager import config_manager; print(config_manager.get_current_env())"

# 测试生产环境
CONFIG_ENV=prod python -c "from app.core.config_manager import config_manager; print(config_manager.get_current_env())"

# 测试降级模式
CONFIG_ENV=degraded python -c "from app.core.config_manager import config_manager; print(config_manager.get_current_env())"
```

### 配置验证测试

```bash
# 验证所有配置文件格式
./manage.sh config-validate
```

## 相关文件

### 修改的文件

- `app/core/config_manager.py` - 配置管理器核心逻辑
- `manage.sh` - 添加配置管理功能
- `configs/README.md` - 完全重写配置说明

### 新增的文件

- `configs/config.dev.toml` - 开发环境配置
- `configs/config.prod.toml` - 生产环境配置
- `configs/config.degraded.toml` - 降级模式配置
- `docs/archive/配置文件管理优化_2026-02-23.md` - 本文档

## 注意事项

1. **环境变量优先**: 敏感信息必须通过环境变量设置，不要写入配置文件
2. **重启生效**: 切换配置环境后需要重启服务
3. **降级模式**: 仅在 Redis 故障或调试时使用，性能会明显下降
4. **生产环境**: 切换到生产环境前确保已设置所有必需的环境变量

## 后续优化建议

1. **配置热重载**: 支持不重启服务的配置热更新
2. **配置验证**: 启动时自动验证配置完整性
3. **配置监控**: 添加配置变更监控和告警
4. **配置中心**: 考虑引入配置中心（如 Consul、etcd）

## 总结

本次优化实现了：
- ✅ 多环境配置文件支持（dev/prod/degraded）
- ✅ 通过环境变量快速切换配置
- ✅ manage.sh 配置管理功能
- ✅ 配置文件验证功能
- ✅ 完善的文档和使用指南

配置管理更加灵活和规范，降低了配置错误的风险，提高了开发和运维效率。

---

**文档创建**: 2026-02-23  
**最后更新**: 2026-02-23
