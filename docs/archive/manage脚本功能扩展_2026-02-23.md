# manage.sh 脚本功能扩展

**日期**: 2026-02-23  
**状态**: ✅ 已完成  
**类型**: 功能增强

---

## 📋 扩展概述

为 `manage.sh` 脚本添加了 5 个新功能模块，使其成为更完整的项目管理工具。

---

## 🎯 新增功能

### 1. Docker 管理

提供 Docker 服务（Redis）的完整管理功能。

**功能列表**:
- 启动 Redis 服务
- 停止 Redis 服务
- 重启 Redis 服务
- 查看 Redis 状态
- 查看 Redis 日志
- 测试 Redis 连接

**交互式菜单**:
```
Docker 管理
  1. 启动 Redis 服务
  2. 停止 Redis 服务
  3. 重启 Redis 服务
  4. 查看 Redis 状态
  5. 查看 Redis 日志
  6. 测试 Redis 连接
  0. 返回主菜单
```

**命令行模式**:
```bash
./manage.sh docker-start    # 启动 Redis
./manage.sh docker-stop     # 停止 Redis
./manage.sh docker-status   # 查看状态
```

**特性**:
- 自动检测 Docker 和 docker-compose 是否安装
- 支持 `docker-compose` 和 `docker compose` 两种命令
- 实时查看日志（Ctrl+C 退出）
- 连接测试（PING 命令）

---

### 2. 初始化超级管理员

快速初始化或重置超级管理员账号。

**功能**:
- 调用 `scripts/python/init_superadmin.py` 脚本
- 创建或重置超级管理员账号
- 显示生成的登录信息

**交互式菜单**:
```
高级操作
  18. 初始化超级管理员
```

**命令行模式**:
```bash
./manage.sh init-admin
```

**使用场景**:
- 首次部署时初始化管理员
- 忘记管理员密码时重置
- 开发测试时快速创建管理员

---

### 3. 查看项目状态

一键查看项目的完整状态信息。

**显示内容**:

1. **Python 环境**
   - Conda 环境名称
   - Python 版本
   - Python 路径

2. **关键依赖**
   - FastAPI 版本
   - Pytest 版本
   - Redis 版本
   - SQLAlchemy 版本

3. **数据库状态**
   - 数据库文件是否存在
   - 数据库文件大小

4. **Docker 服务**
   - Redis 容器运行状态

5. **配置文件**
   - .env 文件是否存在
   - config.toml 文件是否存在

**交互式菜单**:
```
环境管理
  2. 查看项目状态
```

**命令行模式**:
```bash
./manage.sh status
```

**示例输出**:
```
Python 环境
✓ Conda 环境: mai_notebook
ℹ  Python 版本: 3.11.5
ℹ  Python 路径: /Users/user/miniconda3/envs/mai_notebook/bin/python

关键依赖
✓ FastAPI: 0.129.0
✓ Pytest: 8.0.0
✓ Redis: 5.2.1
✓ SQLAlchemy: 2.0.46

数据库状态
✓ 数据库文件: data/mainnp.db (2.5M)

Docker 服务
✓ Redis 容器: 运行中

配置文件
✓ .env: 存在
✓ config.toml: 存在

✓ 所有关键依赖已安装
```

---

### 4. 日志查看

方便地查看和管理应用日志。

**功能列表**:
- 查看最近 50 行日志
- 实时查看日志
- 查看所有日志文件
- 清空日志文件

**交互式菜单**:
```
项目维护
  17. 查看日志
```

**命令行模式**:
```bash
./manage.sh logs    # 查看最近 50 行
```

**使用场景**:
- 调试应用问题
- 监控应用运行状态
- 查看错误信息
- 定期清理日志

---

### 5. 依赖管理

完整的依赖管理功能。

**功能列表**:
- 安装所有依赖
- 安装开发依赖
- 更新依赖
- 检查依赖状态
- 导出当前依赖

**交互式菜单**:
```
环境管理
  3. 依赖管理
```

**命令行模式**:
```bash
./manage.sh deps-install    # 安装生产依赖
```

**子菜单**:
```
依赖管理
  1. 安装所有依赖
  2. 安装开发依赖
  3. 更新依赖
  4. 检查依赖状态
  5. 导出当前依赖
  0. 返回主菜单
```

**特性**:
- 更新依赖前需要确认
- 显示依赖安装结果
- 导出依赖到 `requirements-freeze.txt`
- 列出所有已安装的包

---

## 📊 菜单结构更新

### 更新前（14 个选项）

```
环境管理
  1. 创建虚拟环境

服务管理
  2. 启动服务（开发模式）
  3. 启动服务（生产模式）

测试相关
  4-9. 各种测试选项

项目维护
  10-13. 清理、数据库、代码质量、文档

高级操作
  14. 清档重置
```

### 更新后（19 个选项）

```
环境管理
  1. 创建虚拟环境
  2. 查看项目状态          ← 新增
  3. 依赖管理              ← 新增

服务管理
  4. 启动服务（开发模式）
  5. 启动服务（生产模式）
  6. Docker 管理（Redis）  ← 新增

测试相关
  7-12. 各种测试选项

项目维护
  13-17. 清理、数据库、代码质量、文档、日志  ← 新增日志

高级操作
  18. 初始化超级管理员    ← 新增
  19. 清档重置
```

---

## 🔧 命令行模式新增命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `status` | 查看项目状态 | `./manage.sh status` |
| `docker-start` | 启动 Redis 服务 | `./manage.sh docker-start` |
| `docker-stop` | 停止 Redis 服务 | `./manage.sh docker-stop` |
| `docker-status` | 查看 Redis 状态 | `./manage.sh docker-status` |
| `init-admin` | 初始化超级管理员 | `./manage.sh init-admin` |
| `logs` | 查看应用日志 | `./manage.sh logs` |
| `deps-install` | 安装依赖 | `./manage.sh deps-install` |

---

## 💡 使用场景

### 场景 1: 新项目部署

```bash
# 1. 创建虚拟环境
./manage.sh create-env

# 2. 安装依赖
./manage.sh deps-install

# 3. 启动 Redis
./manage.sh docker-start

# 4. 初始化数据库
./manage.sh db-upgrade

# 5. 初始化管理员
./manage.sh init-admin

# 6. 查看项目状态
./manage.sh status

# 7. 启动服务
./manage.sh start-dev
```

### 场景 2: 日常开发

```bash
# 查看项目状态
./manage.sh status

# 启动 Redis（如果未运行）
./manage.sh docker-start

# 运行测试
./manage.sh test

# 查看日志
./manage.sh logs

# 启动开发服务器
./manage.sh start-dev
```

### 场景 3: 问题排查

```bash
# 查看项目状态
./manage.sh status

# 查看 Redis 状态
./manage.sh docker-status

# 查看应用日志
./manage.sh logs

# 查看 Redis 日志
./manage.sh
# 选择 6. Docker 管理
# 选择 5. 查看 Redis 日志
```

### 场景 4: CI/CD 集成

```bash
#!/bin/bash
# CI/CD 脚本示例

# 安装依赖
./manage.sh deps-install || exit 1

# 启动 Redis
./manage.sh docker-start || exit 1

# 运行测试
./manage.sh test || exit 1

# 代码质量检查
./manage.sh lint || exit 1

# 停止 Redis
./manage.sh docker-stop
```

---

## 🎓 最佳实践

### 1. 开发环境设置

```bash
# 首次设置
./manage.sh create-env      # 创建环境
./manage.sh deps-install    # 安装依赖
./manage.sh docker-start    # 启动 Redis
./manage.sh init-admin      # 初始化管理员
./manage.sh status          # 验证状态
```

### 2. 每日开发流程

```bash
# 启动开发
./manage.sh docker-start    # 启动 Redis
./manage.sh status          # 检查状态
./manage.sh start-dev       # 启动服务

# 开发过程中
./manage.sh test            # 运行测试
./manage.sh logs            # 查看日志

# 结束开发
./manage.sh docker-stop     # 停止 Redis
```

### 3. 问题排查

```bash
# 1. 查看整体状态
./manage.sh status

# 2. 检查具体服务
./manage.sh docker-status   # Redis 状态
./manage.sh logs            # 应用日志

# 3. 重启服务
./manage.sh docker-stop
./manage.sh docker-start
```

---

## 📝 技术实现

### Docker 管理实现

```bash
docker_management() {
    # 检查 Docker 是否安装
    if ! command_exists docker; then
        print_error "未检测到 Docker"
        return
    fi
    
    # 支持两种 docker-compose 命令
    cd docker
    docker-compose up -d redis 2>/dev/null || docker compose up -d redis
    cd ..
}
```

### 项目状态检查

```bash
show_project_status() {
    # 检查 Python 环境
    # 检查关键依赖
    # 检查数据库状态
    # 检查 Docker 服务
    # 检查配置文件
    # 显示总结
}
```

### 日志查看

```bash
view_logs() {
    # 提供多种查看方式
    # 支持实时查看
    # 支持清空日志
}
```

---

## 🔍 错误处理

所有新功能都包含完善的错误处理：

1. **Docker 管理**: 检查 Docker 是否安装
2. **依赖管理**: 显示安装成功/失败状态
3. **日志查看**: 检查日志文件是否存在
4. **项目状态**: 优雅处理缺失的依赖或服务

---

## 📚 相关文档

- [manage.sh 脚本](../../manage.sh)
- [Docker 部署指南](../deployment/Docker部署指南.md)
- [依赖管理说明](../development/依赖管理说明.md)
- [manage 脚本错误处理改进](./manage脚本错误处理改进_2026-02-23.md)

---

**审核状态**: ✅ 已完成  
**归档日期**: 2026-02-23
