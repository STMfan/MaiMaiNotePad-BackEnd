# manage.sh 脚本错误处理改进

**日期**: 2026-02-23  
**状态**: ✅ 已完成  
**类型**: 脚本优化

---

## 📋 改进概述

改进 `manage.sh` 脚本的错误处理机制，使脚本在遇到错误时不会直接退出，而是给用户提供更友好的错误信息和继续选择。

---

## 🎯 改进目标

1. 移除 `set -e` 选项，避免脚本在任何命令失败时立即退出
2. 为关键操作添加错误处理和用户提示
3. 在命令失败时显示清晰的错误信息
4. 提供继续或取消操作的选择
5. 在命令行模式下返回正确的退出码

---

## 🔧 主要改进

### 1. 移除全局 `set -e`

**改进前**:
```bash
set -e  # 遇到错误立即退出
```

**改进后**:
```bash
# 注意：不使用 set -e，以便在错误时可以继续执行或给用户选择
```

**原因**: `set -e` 会导致任何命令失败时脚本立即退出，用户无法看到完整的错误信息或选择如何处理。

---

### 2. 添加错误处理函数

新增两个通用错误处理函数：

```bash
# 错误处理函数
handle_error() {
    local exit_code=$1
    local error_msg="$2"
    local continue_prompt="${3:-是否继续？}"
    
    if [ $exit_code -ne 0 ]; then
        echo ""
        print_error "$error_msg"
        echo ""
        read -p "$(echo -e ${YELLOW}$continue_prompt [y/N]: ${NC})" continue_choice
        if [ "$continue_choice" != "y" ] && [ "$continue_choice" != "Y" ]; then
            print_info "操作已取消"
            return 1
        fi
    fi
    return 0
}

# 执行命令并处理错误
execute_with_error_handling() {
    local cmd="$1"
    local error_msg="$2"
    local continue_prompt="${3:-命令执行失败，是否继续？}"
    
    eval "$cmd"
    local exit_code=$?
    
    if [ $exit_code -ne 0 ]; then
        handle_error $exit_code "$error_msg" "$continue_prompt"
        return $?
    fi
    return 0
}
```

---

### 3. 改进环境创建函数

#### Conda 环境创建

**改进前**:
```bash
conda create -n "$env_name" python="$py_version" -y
```

**改进后**:
```bash
if ! conda create -n "$env_name" python="$py_version" -y; then
    print_error "Conda 环境创建失败"
    pause
    return 1
fi
```

#### 依赖安装

**改进前**:
```bash
pip install -r requirements.txt
print_success "依赖安装完成！"
```

**改进后**:
```bash
if pip install -r requirements.txt; then
    print_success "依赖安装完成！"
else
    print_error "依赖安装失败"
    print_info "您可以稍后手动安装："
    print_info "  conda activate $env_name"
    print_info "  pip install -r requirements.txt"
fi
```

---

### 4. 改进测试函数

所有测试函数现在都会：
1. 检查命令执行结果
2. 显示成功或失败信息
3. 提供详细的错误提示

**示例 - run_all_tests**:

**改进前**:
```bash
eval "$cmd"
pause
```

**改进后**:
```bash
if eval "$cmd"; then
    echo ""
    print_success "所有测试通过！"
else
    echo ""
    print_error "部分测试失败"
    print_info "查看上方输出了解详细信息"
fi
pause
```

---

### 5. 改进代码质量检查

**改进前**:
```bash
black app tests scripts/python || true
flake8 app tests scripts/python || true
mypy app --config-file=pyproject.toml || true
print_success "所有检查完成"
```

**改进后**:
```bash
if black app tests scripts/python; then
    print_success "代码格式化完成"
else
    print_error "代码格式化失败"
fi

if flake8 app tests scripts/python; then
    print_success "代码风格检查通过"
else
    print_warning "发现代码风格问题"
fi

if mypy app --config-file=pyproject.toml; then
    print_success "类型检查通过"
else
    print_warning "发现类型问题"
fi

print_success "所有检查完成"
```

---

### 6. 改进命令行模式

命令行模式现在会返回正确的退出码：

**改进前**:
```bash
eval "$cmd"
```

**改进后**:
```bash
if eval "$cmd"; then
    echo ""
    print_success "所有测试通过！"
    exit 0
else
    echo ""
    print_error "部分测试失败"
    exit 1
fi
```

---

## 📊 改进的函数列表

### 环境管理
- ✅ `create_conda_env` - Conda 环境创建错误处理
- ✅ `create_venv_env` - venv 环境创建错误处理（依赖安装部分）
- ✅ `create_uv_env` - uv 环境创建错误处理（依赖安装部分）

### 测试相关
- ✅ `run_all_tests` - 所有测试错误处理
- ✅ `run_unit_tests` - 单元测试错误处理
- ✅ `run_integration_tests` - 集成测试错误处理
- ✅ `run_fast_tests` - 详细模式测试错误处理
- ✅ `run_coverage_tests` - 覆盖率测试错误处理

### 代码质量
- ✅ `code_quality_menu` - 代码质量检查菜单错误处理
- ✅ 命令行模式 `lint` - 代码质量检查错误处理
- ✅ 命令行模式 `format` - 代码格式化错误处理

### 命令行模式
- ✅ `test` - 测试命令错误处理和退出码
- ✅ `test-unit` - 单元测试命令错误处理和退出码
- ✅ `test-int` - 集成测试命令错误处理和退出码
- ✅ `test-cov` - 覆盖率测试命令错误处理和退出码
- ✅ `lint` - 代码质量检查命令错误处理和退出码
- ✅ `format` - 代码格式化命令错误处理和退出码

---

## 🎓 用户体验改进

### 改进前的问题

1. **脚本突然退出**: 任何命令失败都会导致脚本立即退出，用户无法看到完整错误信息
2. **无法继续操作**: 即使是非关键错误，用户也无法选择继续
3. **错误信息不清晰**: 只显示命令的原始错误输出，没有友好的提示
4. **无法判断成功失败**: 命令执行后没有明确的成功或失败提示

### 改进后的优势

1. **友好的错误提示**: 清晰显示错误原因和建议
2. **用户可选择**: 遇到错误时可以选择继续或取消
3. **明确的状态反馈**: 每个操作都有明确的成功/失败提示
4. **正确的退出码**: 命令行模式返回正确的退出码，便于脚本集成

---

## 📝 使用示例

### 交互式模式

```bash
./manage.sh

# 选择 "4. 运行所有测试"
# 如果测试失败，会显示：
# ✗ 部分测试失败
# ℹ  查看上方输出了解详细信息
# 按回车继续...
```

### 命令行模式

```bash
# 运行测试
./manage.sh test
# 退出码: 0 (成功) 或 1 (失败)

# 代码质量检查
./manage.sh lint
# 退出码: 0 (全部通过) 或 1 (部分未通过)

# 可以在 CI/CD 中使用
./manage.sh test && ./manage.sh lint
```

---

## 🔍 测试验证

### 验证场景

1. ✅ 测试失败时不退出脚本
2. ✅ 依赖安装失败时提供手动安装提示
3. ✅ 代码质量检查失败时显示具体问题
4. ✅ 命令行模式返回正确退出码
5. ✅ 交互式模式可以继续操作

---

## 💡 最佳实践

### 对于开发者

1. **交互式模式**: 日常开发使用交互式菜单，可以看到详细的错误信息并选择如何处理
2. **命令行模式**: CI/CD 或自动化脚本使用命令行模式，根据退出码判断成功失败

### 对于 CI/CD

```bash
# 在 CI/CD 中使用
./manage.sh test || exit 1
./manage.sh lint || exit 1
```

---

## 📚 相关文档

- [manage.sh 脚本](../../manage.sh)
- [虚拟环境创建指南](../development/虚拟环境创建指南.md)
- [测试配置指南](../testing/测试配置指南.md)
- [代码质量工具](../development/代码质量工具.md)

---

**审核状态**: ✅ 已完成  
**归档日期**: 2026-02-23
