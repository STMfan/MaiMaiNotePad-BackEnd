# 人设卡文件大小限制优化

## 修改日期
2026-02-22

## 修改概述
为人设卡的 TOML 配置文件添加专门的 5MB 大小限制，并优化测试数据大小以提高测试执行速度。

## 修改内容

### 1. 业务代码修改

#### 1.1 添加人设卡专用大小限制常量
**文件**: `app/services/file_upload_service.py`

```python
class FileUploadService:
    # 从配置管理器读取配置
    MAX_FILE_SIZE = settings.MAX_FILE_SIZE_MB * 1024 * 1024
    MAX_PERSONA_TOML_SIZE = 5 * 1024 * 1024  # 人设卡 TOML 文件限制为 5MB
```

#### 1.2 添加人设卡专用验证方法
**文件**: `app/services/file_upload_service.py`

新增两个方法：
- `_validate_persona_toml_size(file)`: 验证人设卡 TOML 文件大小（基于 file.size 属性）
- `_validate_persona_toml_content(file)`: 验证人设卡 TOML 文件内容大小（读取实际内容）

#### 1.3 更新人设卡上传方法
**文件**: `app/services/file_upload_service.py`

更新以下方法使用新的验证方法：
- `upload_persona_card()`: 创建人设卡时的文件验证
- `add_files_to_persona_card()`: 向已有人设卡添加文件时的验证

### 2. 测试代码优化

#### 2.1 优化测试数据大小
**文件**: `tests/unit/services/test_file_upload_service.py`

优化以下测试，将测试数据从 50MB/150MB 减少到刚好超过限制的大小：

1. `test_upload_persona_card_with_oversized_file`: 6MB（超过 5MB 限制）
2. `test_upload_persona_card_content_size_exceeded`: 5MB + 1 字节
3. `test_add_files_to_knowledge_base_content_size_exceeded`: 100MB + 1 字节
4. `test_validate_file_content_large_file`: 100MB + 1 字节

**优化效果**: 测试执行时间从数秒降低到不到 1 秒。

#### 2.2 优化属性测试
**文件**: `tests/property/test_parallel_isolation.py`

优化 `TestCacheIsolation::test_cache_isolation_property`:
- 减少 Hypothesis 示例数量：从 5 个减少到 2 个
- 减少最大 worker 数：从 8 个减少到 4 个
- 减少超时时间：从 60 秒减少到 30 秒
- 添加 `@pytest.mark.slow` 标记

同时为 `TestParallelIsolation` 类添加 `@pytest.mark.slow` 标记。

**优化效果**: 测试执行时间从数分钟降低到约 1 分钟，且可以通过 `-m "not slow"` 跳过。

### 3. API 文档更新

#### 3.1 创建人设卡接口
**文件**: `docs/api/API文档.md`

添加文件限制说明：
- 文件名必须为 `bot_config.toml`
- 文件类型必须为 `.toml`
- 单个文件最大 5MB
- 必须包含版本号字段（version）

添加错误响应示例：
```json
{
  "message": "人设卡配置错误：文件内容过大 bot_config.toml，单个文件最大允许5MB",
  "details": {
    "code": "PERSONA_FILE_CONTENT_SIZE_EXCEEDED",
    "filename": "bot_config.toml"
  }
}
```

#### 3.2 上传人设卡文件接口
**文件**: `docs/api/API文档.md`

添加相同的文件限制说明和错误响应示例。

### 4. 测试脚本优化

#### 4.1 修复 manage.sh 语法错误
**文件**: `manage.sh`

修复 `build_pytest_command` 函数中的输出重定向问题，避免 `print_info` 输出混入函数返回值。

#### 4.2 优化测试菜单
**文件**: `manage.sh`

更新测试选项：
- 选项 4: 运行所有测试（并行，快速验证）
- 选项 5: 运行单元测试（tests/unit）
- 选项 6: 运行集成测试（tests/integration）
- 选项 7: 详细模式测试（-vv，调试用）
- 选项 8: 生成测试覆盖率报告（单线程，完整报告）
- 选项 9: 完整测试流程（并行验证 + 覆盖率分析）

#### 4.3 解决并行测试 coverage 冲突
**文件**: `manage.sh`

- 并行测试时自动添加 `--no-cov` 参数
- 覆盖率测试使用单线程模式
- 完整流程会在最后自动清理临时 `.coverage.*` 文件

## 技术细节

### 文件大小限制对比

| 文件类型 | 原限制 | 新限制 | 说明 |
|---------|--------|--------|------|
| 知识库文件 | 100MB | 100MB | 保持不变 |
| 人设卡 TOML | 100MB | 5MB | 专门限制 |

### 错误码

| 错误码 | 说明 |
|--------|------|
| `PERSONA_FILE_SIZE_EXCEEDED` | 文件大小超限（基于 file.size） |
| `PERSONA_FILE_CONTENT_SIZE_EXCEEDED` | 文件内容大小超限（基于实际读取） |

## 测试验证

运行以下命令验证修改：

```bash
# 运行人设卡文件大小测试
python -m pytest tests/unit/services/test_file_upload_service.py::TestDeepCoverage::test_upload_persona_card_content_size_exceeded -v

# 运行所有文件上传服务测试
python -m pytest tests/unit/services/test_file_upload_service.py -v

# 运行快速测试（排除慢速测试）
python -m pytest -m "not slow" -v

# 运行属性测试（包括慢速测试）
python -m pytest tests/property/test_parallel_isolation.py::TestCacheIsolation::test_cache_isolation_property -v
```

## 影响范围

### 受影响的模块
- `app/services/file_upload_service.py`: 核心业务逻辑
- `tests/unit/services/test_file_upload_service.py`: 单元测试
- `tests/property/test_parallel_isolation.py`: 属性测试
- `docs/api/API文档.md`: API 文档
- `manage.sh`: 测试管理脚本

### 向后兼容性
- ✅ 完全向后兼容
- 现有的人设卡不受影响
- 只影响新上传的人设卡文件

## 注意事项

1. **文件大小验证**: 系统会进行两次验证
   - 第一次：基于 `file.size` 属性（快速检查）
   - 第二次：读取实际内容验证（准确检查）

2. **测试数据优化**: 测试中使用的大文件数据已优化为刚好超过限制的大小，避免不必要的内存分配和时间消耗

3. **并行测试**: 使用并行测试时会自动禁用 coverage，避免数据库冲突

4. **慢速测试标记**: 属性测试已标记为 `@pytest.mark.slow`，可以使用 `-m "not slow"` 跳过这些测试以加快日常开发测试速度

## 相关文档

- [API 文档](../api/API文档.md)
- [测试配置指南](../testing/测试配置指南.md)
- [文件上传服务](../../app/services/file_upload_service.py)
