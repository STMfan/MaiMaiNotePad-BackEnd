# 测试配置指南

## 概述

本项目的测试配置已经优化，支持灵活的并行测试配置和环境检查。

## 配置文件

测试配置位于 `tests/.test_env` 文件中。

### 主要配置项

```bash
# 并行测试配置
TEST_PARALLEL=true              # 是否启用并行测试（true/false）
TEST_WORKERS=auto               # 并行工作进程数（auto=自动检测CPU核心数，或指定数字如 4）
TEST_EXTRA_ARGS=                # pytest 额外参数（可选）

# 推荐的 Conda 环境名称
RECOMMENDED_CONDA_ENV=mai_notebook
```

### 配置说明

1. **TEST_PARALLEL**
   - `true`: 启用并行测试（推荐，速度快）
   - `false`: 禁用并行测试（用于调试）

2. **TEST_WORKERS**
   - `auto`: 自动检测 CPU 核心数（推荐）
   - 数字（如 `4`）: 指定固定的工作进程数
   - `0`: 禁用并行（等同于 TEST_PARALLEL=false）

3. **TEST_EXTRA_ARGS**
   - 可以添加任何 pytest 参数
   - 例如: `-x` (第一个失败时停止), `--lf` (只运行上次失败的测试)

4. **RECOMMENDED_CONDA_ENV**
   - 推荐使用的 Conda 环境名称
   - 运行测试前会检查当前环境是否匹配

## 使用 manage.sh 运行测试

### 检查测试环境

```bash
./manage.sh test-env
```

这会检查：
- 当前 Conda 环境是否正确
- Python 版本
- 关键依赖是否已安装
- 当前测试配置

### 运行测试

```bash
# 运行所有测试
./manage.sh test

# 运行单元测试
./manage.sh test-unit

# 运行集成测试
./manage.sh test-int

# 生成覆盖率报告
./manage.sh test-cov
```

所有测试命令都会：
1. 自动检查 Python 环境
2. 从配置文件读取并行参数
3. 显示将要执行的命令
4. 执行测试

### 环境检查行为

如果当前环境与推荐环境不匹配，脚本会：
1. 显示警告信息
2. 询问是否继续
3. 如果选择 "N"，显示切换环境的命令

示例输出：
```
⚠  当前 Conda 环境: base
⚠  推荐使用环境: mai_notebook

是否继续？[y/N]: N
ℹ  已取消操作
ℹ  请使用以下命令切换环境：
ℹ    conda activate mai_notebook
```

## 直接使用 pytest

如果你想直接使用 pytest 而不通过 manage.sh：

```bash
# 确保在正确的环境中
conda activate mai_notebook

# 运行测试（会自动使用 pyproject.toml 中的配置）
pytest

# 手动指定并行参数
pytest -n auto

# 禁用并行
pytest -n 0
# 或
pytest -p no:xdist
```

## 性能对比

### 并行测试 (TEST_WORKERS=auto)
- 执行时间: ~38-42 秒
- CPU 使用率: 600%+（多核心）
- 适用场景: 日常开发、CI/CD

### 串行测试 (TEST_PARALLEL=false)
- 执行时间: ~120-180 秒
- CPU 使用率: ~100%（单核心）
- 适用场景: 调试特定问题

## 故障排查

### 问题：测试卡住不动

**可能原因**：
1. pytest-xdist 未安装或版本不兼容
2. 环境变量冲突
3. 数据库锁定

**解决方案**：
```bash
# 1. 检查环境
./manage.sh test-env

# 2. 重新安装 pytest-xdist
pip install --force-reinstall pytest-xdist

# 3. 清理测试数据库
rm -f tests/test_*.db*

# 4. 尝试禁用并行测试
# 编辑 tests/.test_env，设置 TEST_PARALLEL=false
```

### 问题：环境检查失败

**可能原因**：
1. 未激活 Conda 环境
2. 缺少依赖包

**解决方案**：
```bash
# 1. 激活正确的环境
conda activate mai_notebook

# 2. 安装依赖
pip install -r requirements.txt

# 3. 再次检查
./manage.sh test-env
```

### 问题：并行测试出现随机失败

**可能原因**：
1. 测试之间有状态共享
2. 数据库隔离问题

**解决方案**：
```bash
# 1. 临时禁用并行测试来确认问题
# 编辑 tests/.test_env，设置 TEST_PARALLEL=false

# 2. 运行失败的测试
pytest tests/path/to/test.py -v

# 3. 检查测试是否正确使用 fixtures
# 确保每个测试都使用独立的数据库会话
```

## 最佳实践

1. **日常开发**：使用 `./manage.sh test` 运行所有测试
2. **快速反馈**：使用 `./manage.sh test-unit` 只运行单元测试
3. **调试问题**：临时禁用并行测试（TEST_PARALLEL=false）
4. **CI/CD**：保持并行测试启用，使用 `TEST_WORKERS=auto`
5. **环境管理**：始终在推荐的 Conda 环境中运行测试

## 配置示例

### 开发环境（快速反馈）
```bash
TEST_PARALLEL=true
TEST_WORKERS=auto
TEST_EXTRA_ARGS=
RECOMMENDED_CONDA_ENV=mai_notebook
```

### 调试环境（详细输出）
```bash
TEST_PARALLEL=false
TEST_WORKERS=0
TEST_EXTRA_ARGS=-vv --tb=long
RECOMMENDED_CONDA_ENV=mai_notebook
```

### CI/CD 环境（最大并行）
```bash
TEST_PARALLEL=true
TEST_WORKERS=auto
TEST_EXTRA_ARGS=--maxfail=5
RECOMMENDED_CONDA_ENV=mai_notebook
```

## 相关文件

- `tests/.test_env` - 测试配置文件
- `pyproject.toml` - pytest 基础配置
- `tests/conftest.py` - pytest fixtures 和钩子
- `manage.sh` - 项目管理脚本

## 更新日志

### 2026-02-22
- 将并行测试参数从 pyproject.toml 移到 tests/.test_env
- 添加环境检查功能
- 添加 test-env 命令
- 修复 pytest-xdist 安装问题


---

**文档信息**

| 项目 | 内容 |
|------|------|
| 创建日期 | 2026-02-22 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | 📝 参考文档 |
