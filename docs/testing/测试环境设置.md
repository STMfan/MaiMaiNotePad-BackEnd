# æµ‹è¯•ç¯å¢ƒè®¾ç½®æŒ‡å—

## å¿«é€Ÿå¼€å§‹

### 1. æ¿€æ´» Conda ç¯å¢ƒ

```bash
conda activate mai_notebook
```

### 2. æ£€æŸ¥ç¯å¢ƒ

```bash
./manage.sh test-env
```

é¢„æœŸè¾“å‡ºï¼š
```
âœ“ Conda ç¯å¢ƒ: mai_notebook
â„¹  Python ç‰ˆæœ¬: 3.13.x
â„¹  æ£€æŸ¥å…³é”®ä¾èµ–...
âœ“ æ‰€æœ‰å…³é”®ä¾èµ–å·²å®‰è£…

â„¹  æµ‹è¯•é…ç½®:
â„¹    å¹¶è¡Œæµ‹è¯•: true
â„¹    å·¥ä½œè¿›ç¨‹: auto
â„¹    æ¨èç¯å¢ƒ: mai_notebook
```

### 3. è¿è¡Œæµ‹è¯•

```bash
./manage.sh test
```

## ç¯å¢ƒè¦æ±‚

### Python ç‰ˆæœ¬
- Python 3.11+ (æ¨è 3.13)

### å…³é”®ä¾èµ–
- pytest >= 7.4.3
- pytest-xdist >= 3.6.1
- pytest-cov >= 6.0.0
- pytest-asyncio >= 1.3.0
- hypothesis >= 6.151.9
- fastapi
- sqlalchemy

### å®‰è£…ä¾èµ–

```bash
# ç¡®ä¿åœ¨æ­£ç¡®çš„ç¯å¢ƒä¸­
conda activate mai_notebook

# å®‰è£…æ‰€æœ‰ä¾èµ–
pip install -r requirements.txt

# éªŒè¯å®‰è£…
./manage.sh test-env
```

## å¸¸è§é—®é¢˜

### Q1: æµ‹è¯•å¡ä½ä¸åŠ¨

**ç—‡çŠ¶**ï¼šè¿è¡Œ `pytest` åæ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œè¿›ç¨‹å¡ä½

**åŸå› **ï¼špytest-xdist æœªæ­£ç¡®å®‰è£…åœ¨å½“å‰ Python ç¯å¢ƒä¸­

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®è®¤å½“å‰ç¯å¢ƒ
conda activate mai_notebook

# 2. æ£€æŸ¥ xdist æ˜¯å¦å®‰è£…
python -c "import xdist; print(xdist.__version__)"

# 3. å¦‚æœæŠ¥é”™ï¼Œé‡æ–°å®‰è£…
pip install --force-reinstall pytest-xdist

# 4. éªŒè¯
./manage.sh test-env
```

### Q2: ç¯å¢ƒæ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šè¿è¡Œ `./manage.sh test-env` æ˜¾ç¤ºä¾èµ–ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®è®¤ç¯å¢ƒ
conda activate mai_notebook

# 2. é‡æ–°å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œæ¸…ç†å¹¶é‡è£…
pip cache purge
pip install --no-cache-dir -r requirements.txt
```

### Q3: å¹¶è¡Œæµ‹è¯•å‡ºç°éšæœºå¤±è´¥

**ç—‡çŠ¶**ï¼šæŸäº›æµ‹è¯•åœ¨å¹¶è¡Œè¿è¡Œæ—¶å¤±è´¥ï¼Œå•ç‹¬è¿è¡Œæ—¶é€šè¿‡

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¼–è¾‘ tests/.test_env
# å°† TEST_PARALLEL=true æ”¹ä¸º TEST_PARALLEL=false
```

**æ°¸ä¹…è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æµ‹è¯•æ˜¯å¦æ­£ç¡®ä½¿ç”¨ fixtures
- ç¡®ä¿æµ‹è¯•ä¹‹é—´æ²¡æœ‰çŠ¶æ€å…±äº«
- ä½¿ç”¨ `@pytest.mark.serial` æ ‡è®°éœ€è¦ä¸²è¡Œè¿è¡Œçš„æµ‹è¯•

### Q4: åˆ‡æ¢ç¯å¢ƒåæµ‹è¯•å¤±è´¥

**ç—‡çŠ¶**ï¼šä» base ç¯å¢ƒåˆ‡æ¢åˆ° mai_notebook åæµ‹è¯•å¤±è´¥

**åŸå› **ï¼šä¸åŒç¯å¢ƒçš„ä¾èµ–ç‰ˆæœ¬ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ¸…ç†æ—§çš„æµ‹è¯•æ•°æ®
./manage.sh cleanup

# 2. åˆ é™¤æµ‹è¯•æ•°æ®åº“
rm -f tests/test_*.db*

# 3. é‡æ–°è¿è¡Œæµ‹è¯•
./manage.sh test
```

## ç¯å¢ƒéš”ç¦»

### ä¸ºä»€ä¹ˆéœ€è¦ç‹¬ç«‹çš„ Conda ç¯å¢ƒï¼Ÿ

1. **ä¾èµ–éš”ç¦»**ï¼šé¿å…ä¸åŒé¡¹ç›®çš„ä¾èµ–å†²çª
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šç¡®ä¿æ‰€æœ‰å¼€å‘è€…ä½¿ç”¨ç›¸åŒçš„ä¾èµ–ç‰ˆæœ¬
3. **æµ‹è¯•ç¨³å®šæ€§**ï¼šé¿å…å…¨å±€åŒ…å½±å“æµ‹è¯•ç»“æœ

### åˆ›å»ºæ–°çš„ Conda ç¯å¢ƒ

```bash
# åˆ›å»ºç¯å¢ƒ
conda create -n mai_notebook python=3.13

# æ¿€æ´»ç¯å¢ƒ
conda activate mai_notebook

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# éªŒè¯
./manage.sh test-env
```

## æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡Œæµ‹è¯•é…ç½®

ç¼–è¾‘ `tests/.test_env`ï¼š

```bash
# è‡ªåŠ¨æ£€æµ‹ CPU æ ¸å¿ƒæ•°ï¼ˆæ¨èï¼‰
TEST_WORKERS=auto

# æˆ–æŒ‡å®šå›ºå®šæ•°é‡
TEST_WORKERS=4

# ç¦ç”¨å¹¶è¡Œï¼ˆè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰
TEST_PARALLEL=false
```

### æ€§èƒ½å¯¹æ¯”

| é…ç½® | æ‰§è¡Œæ—¶é—´ | CPU ä½¿ç”¨ç‡ | é€‚ç”¨åœºæ™¯ |
|------|---------|-----------|---------|
| TEST_WORKERS=auto | ~40ç§’ | 600%+ | æ—¥å¸¸å¼€å‘ |
| TEST_WORKERS=4 | ~45ç§’ | 400% | å›ºå®šé…ç½® |
| TEST_PARALLEL=false | ~180ç§’ | 100% | è°ƒè¯•é—®é¢˜ |

## æœ€ä½³å®è·µ

### 1. å§‹ç»ˆä½¿ç”¨æ¨èç¯å¢ƒ

```bash
# åœ¨ ~/.bashrc æˆ– ~/.zshrc ä¸­æ·»åŠ åˆ«å
alias mai='conda activate mai_notebook'
```

### 2. è¿è¡Œæµ‹è¯•å‰æ£€æŸ¥ç¯å¢ƒ

```bash
# å…»æˆä¹ æƒ¯
./manage.sh test-env && ./manage.sh test
```

### 3. å®šæœŸæ›´æ–°ä¾èµ–

```bash
# æ¯å‘¨æˆ–æ¯æœˆæ›´æ–°ä¸€æ¬¡
conda activate mai_notebook
pip install --upgrade -r requirements.txt
```

### 4. ä¿æŒé…ç½®æ–‡ä»¶åŒæ­¥

```bash
# å¦‚æœä¿®æ”¹äº† tests/.test_envï¼Œæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
git add tests/.test_env
git commit -m "Update test configuration"
```

## æ•…éšœæ’æŸ¥æµç¨‹

```mermaid
graph TD
    A[æµ‹è¯•å¤±è´¥] --> B{ç¯å¢ƒæ­£ç¡®?}
    B -->|å¦| C[conda activate mai_notebook]
    B -->|æ˜¯| D{ä¾èµ–å®Œæ•´?}
    C --> D
    D -->|å¦| E[pip install -r requirements.txt]
    D -->|æ˜¯| F{å¹¶è¡Œæµ‹è¯•?}
    E --> F
    F -->|æ˜¯| G[å°è¯•ç¦ç”¨å¹¶è¡Œ]
    F -->|å¦| H[æ£€æŸ¥æµ‹è¯•ä»£ç ]
    G --> I[å•ç‹¬è¿è¡Œå¤±è´¥çš„æµ‹è¯•]
    H --> I
    I --> J[ä¿®å¤é—®é¢˜]
```

## ç›¸å…³å‘½ä»¤é€ŸæŸ¥

```bash
# ç¯å¢ƒç®¡ç†
conda activate mai_notebook          # æ¿€æ´»ç¯å¢ƒ
conda deactivate                     # é€€å‡ºç¯å¢ƒ
conda env list                       # åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒ

# æµ‹è¯•å‘½ä»¤
./manage.sh test-env                 # æ£€æŸ¥ç¯å¢ƒ
./manage.sh test                     # è¿è¡Œæ‰€æœ‰æµ‹è¯•
./manage.sh test-unit                # è¿è¡Œå•å…ƒæµ‹è¯•
./manage.sh test-int                 # è¿è¡Œé›†æˆæµ‹è¯•
./manage.sh test-cov                 # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

# æ¸…ç†å‘½ä»¤
./manage.sh cleanup                  # æ¸…ç†ç¼“å­˜
rm -f tests/test_*.db*               # æ¸…ç†æµ‹è¯•æ•°æ®åº“

# ä¾èµ–ç®¡ç†
pip list | grep pytest               # æŸ¥çœ‹ pytest ç›¸å…³åŒ…
pip install --upgrade pytest-xdist   # æ›´æ–° xdist
pip freeze > requirements.txt        # å¯¼å‡ºä¾èµ–
```

## è·å–å¸®åŠ©

```bash
# æŸ¥çœ‹ manage.sh å¸®åŠ©
./manage.sh help

# æŸ¥çœ‹ pytest å¸®åŠ©
pytest --help

# æŸ¥çœ‹æµ‹è¯•é…ç½®æ–‡æ¡£
cat docs/development/test_configuration.md
```


---

**æ–‡æ¡£ä¿¡æ¯**

| é¡¹ç›® | å†…å®¹ |
|------|------|
| åˆ›å»ºæ—¥æœŸ | 2026-02-22 |
| æœ€åæ›´æ–° | 2026-02-22 |
| ç»´æŠ¤è€… | CorrectPath, A-Dawn, cuckoo711 |
| çŠ¶æ€ | ğŸ“ å‚è€ƒæ–‡æ¡£ |
