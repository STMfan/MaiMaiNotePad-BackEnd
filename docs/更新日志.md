# ä¿®æ”¹æ—¥å¿— (CHANGELOG)

## 2026-02-22 - Tests ç›®å½•ç»“æ„ä¼˜åŒ–

### Tests ç›®å½•ç»“æ„ä¼˜åŒ– ğŸ“

#### é—®é¢˜
- `tests/unit/` æ ¹ç›®å½•ä¸‹æœ‰å¤šä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œæœªä¸¥æ ¼é•œåƒ `app/` ç»“æ„
- ç¼ºå°‘ `tests/unit/api/` ç›®å½•
- æµ‹è¯•è¾…åŠ©å·¥å…·çš„æµ‹è¯•æ–‡ä»¶æ··åœ¨ `tests/unit/` ä¸­
- ç›®å½•ç»“æ„ä¸å¤Ÿæ¸…æ™°ï¼Œä¸åˆ©äºç»´æŠ¤

#### è§£å†³æ–¹æ¡ˆ

**1. åˆ›å»ºæ–°ç›®å½•**
- åˆ›å»º `tests/unit/api/` ç›®å½•ç”¨äº API å±‚æµ‹è¯•

**2. ç§»åŠ¨æµ‹è¯•æ–‡ä»¶**ï¼ˆä¸¥æ ¼é•œåƒ `app/` ç»“æ„ï¼‰
- `test_security.py` â†’ `tests/unit/core/test_security.py`ï¼ˆå¯¹åº” `app/core/security.py`ï¼‰
- `test_deps.py` â†’ `tests/unit/api/test_deps.py`ï¼ˆå¯¹åº” `app/api/deps.py`ï¼‰
- `test_avatar.py` â†’ `tests/unit/utils/test_avatar.py`ï¼ˆå¯¹åº” `app/utils/avatar.py`ï¼‰
- `test_websocket_client_helper.py` â†’ `tests/test_helpers/test_websocket_client_helper.py`ï¼ˆæµ‹è¯•è¾…åŠ©å·¥å…·çš„æµ‹è¯•ï¼‰

**3. ä¿ç•™åœ¨æ ¹ç›®å½•çš„æ–‡ä»¶**ï¼ˆå¯¹åº” `app/` æ ¹ç›®å½•ï¼‰
- `test_main.py` - å¯¹åº” `app/main.py`
- `test_error_handlers.py` - å¯¹åº” `app/error_handlers.py`
- `test_file_upload*.py` (3ä¸ªæ–‡ä»¶) - å¯¹åº” `app/file_upload.py`
- `test_persona_validation.py` - å¯¹åº” `app/file_upload.py` çš„äººè®¾å¡éªŒè¯åŠŸèƒ½

**4. æ›´æ–°æ–‡æ¡£**
- æ›´æ–° `tests/docs/æµ‹è¯•è¯´æ˜.md` åæ˜ æ–°çš„ç›®å½•ç»“æ„
- æ›´æ–° `README.md` ä¸­çš„æµ‹è¯•ç›®å½•ç»“æ„è¯´æ˜
- æ›´æ–° `docs/æ¶æ„æ–‡æ¡£.md` ä¸­çš„æµ‹è¯•ç›®å½•ç»“æ„
- æ›´æ–° `docs/é¡¹ç›®æ•´ç†æ€»ç»“.md` è®°å½•æœ¬æ¬¡ä¼˜åŒ–

**5. æ¸…ç†ç¼“å­˜**
- åˆ é™¤ `tests/unit/__pycache__/` ä¸­çš„è¿‡æ—¶ç¼“å­˜æ–‡ä»¶

#### ä¼˜åŒ–åçš„ç›®å½•ç»“æ„
```
tests/
â”œâ”€â”€ unit/                         # å•å…ƒæµ‹è¯•ï¼ˆä¸¥æ ¼é•œåƒ app/ ç»“æ„ï¼‰
â”‚   â”œâ”€â”€ api/                      # API å±‚æµ‹è¯• âœ¨ æ–°å¢
â”‚   â”‚   â””â”€â”€ test_deps.py
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒæ¨¡å—æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_database.py
â”‚   â”‚   â””â”€â”€ test_security.py      # âœ¨ ç§»åŠ¨
â”‚   â”œâ”€â”€ services/                 # æœåŠ¡å±‚æµ‹è¯•
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°æµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_avatar.py        # âœ¨ ç§»åŠ¨
â”‚   â”œâ”€â”€ test_main.py              # åº”ç”¨ä¸»å…¥å£æµ‹è¯•
â”‚   â”œâ”€â”€ test_error_handlers.py   # é”™è¯¯å¤„ç†å™¨æµ‹è¯•
â”‚   â””â”€â”€ test_file_upload*.py     # æ–‡ä»¶ä¸Šä¼ ç›¸å…³æµ‹è¯•
â”œâ”€â”€ test_helpers/                 # æµ‹è¯•è¾…åŠ©å·¥å…·çš„æµ‹è¯•
â”‚   â””â”€â”€ test_websocket_client*.py # âœ¨ ç§»åŠ¨
â”œâ”€â”€ helpers/                      # æµ‹è¯•è¾…åŠ©å·¥å…·ï¼ˆä¾›æµ‹è¯•ä½¿ç”¨ï¼‰
â”œâ”€â”€ integration/                  # é›†æˆæµ‹è¯•
â””â”€â”€ property/                     # å±æ€§æµ‹è¯•
```

#### æ”¹è¿›æ•ˆæœ
- âœ… **ç»“æ„æ¸…æ™°**: `tests/unit/` ä¸¥æ ¼é•œåƒ `app/` ç›®å½•ç»“æ„
- âœ… **æ˜“äºæŸ¥æ‰¾**: æ ¹æ®ä¸šåŠ¡ä»£ç è·¯å¾„å¿«é€Ÿæ‰¾åˆ°å¯¹åº”æµ‹è¯•
- âœ… **æ˜“äºç»´æŠ¤**: æ–°å¢æµ‹è¯•æ–‡ä»¶æœ‰æ˜ç¡®çš„æ”¾ç½®ä½ç½®
- âœ… **åˆ†ç±»æ˜ç¡®**: æµ‹è¯•è¾…åŠ©å·¥å…·çš„æµ‹è¯•ç‹¬ç«‹åœ¨ `test_helpers/` ç›®å½•

#### æµ‹è¯•éªŒè¯
- âœ… 963ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… å¯¼å…¥è·¯å¾„è‡ªåŠ¨æ›´æ–°ï¼ˆä½¿ç”¨ smartRelocateï¼‰
- âœ… æ‰€æœ‰ç›¸å…³æ–‡æ¡£å·²æ›´æ–°

**æ–‡ä»¶**ï¼š
- `tests/unit/api/test_deps.py`ï¼ˆæ–°å¢ç›®å½•ï¼‰
- `tests/unit/core/test_security.py`ï¼ˆç§»åŠ¨ï¼‰
- `tests/unit/utils/test_avatar.py`ï¼ˆç§»åŠ¨ï¼‰
- `tests/test_helpers/test_websocket_client_helper.py`ï¼ˆç§»åŠ¨ï¼‰
- `tests/docs/æµ‹è¯•è¯´æ˜.md`ï¼ˆæ›´æ–°ï¼‰
- `README.md`ï¼ˆæ›´æ–°ï¼‰
- `docs/æ¶æ„æ–‡æ¡£.md`ï¼ˆæ›´æ–°ï¼‰
- `docs/é¡¹ç›®æ•´ç†æ€»ç»“.md`ï¼ˆæ›´æ–°ï¼‰

---

## 2025-02-20 - æµ‹è¯•æ€§èƒ½ä¼˜åŒ–å’Œæ–‡æ¡£æ›´æ–°

### æµ‹è¯•æ€§èƒ½ä¼˜åŒ– âš¡

#### 1. bcrypt å¯†ç å“ˆå¸Œä¼˜åŒ–

**é—®é¢˜**ï¼š
- æµ‹è¯•æ‰§è¡Œé€Ÿåº¦è¿‡æ…¢ï¼šå®Œæ•´æµ‹è¯•å¥—ä»¶éœ€è¦ 451 ç§’ï¼ˆ7åˆ†31ç§’ï¼‰
- æ ¹æœ¬åŸå› ï¼šbcrypt é»˜è®¤ä½¿ç”¨ 12 roundsï¼Œæ¯æ¬¡å¯†ç å“ˆå¸Œéœ€è¦ ~0.5 ç§’
- å½±å“ï¼š1366 ä¸ªæµ‹è¯•ä¸­å¤§é‡æ¶‰åŠå¯†ç æ“ä½œï¼Œç´¯ç§¯æ•ˆåº”æ˜¾è‘—

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨æµ‹è¯•ç¯å¢ƒä¸­é™ä½ bcrypt rounds ä» 12 åˆ° 4
- é€šè¿‡é…ç½®æ–‡ä»¶ `tests/.test_env` ä¸­çš„ `PASSLIB_BCRYPT_ROUNDS` æ§åˆ¶
- ç”Ÿäº§ç¯å¢ƒä»ä½¿ç”¨ 12 roundsï¼ˆé»˜è®¤å€¼ï¼‰

**å®ç°ä½ç½®**ï¼š
- `tests/.test_env`ï¼šé…ç½® `PASSLIB_BCRYPT_ROUNDS=4`
- `tests/.test_env.template`ï¼šé…ç½®æ¨¡æ¿
- `tests/conftest.py`ï¼šä»é…ç½®æ–‡ä»¶è¯»å–å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
- `app/core/security.py`ï¼šè¯»å–ç¯å¢ƒå˜é‡é…ç½® bcrypt rounds

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼š451s â†’ 21.31sï¼ˆ**æå‡ 21å€**ï¼‰
- å•ä¸ªè®¤è¯æµ‹è¯•æ–‡ä»¶ï¼š10.06s â†’ 1.36sï¼ˆ**æå‡ 7.4å€**ï¼‰
- å•ä¸ªç™»å½•æµ‹è¯•ï¼š0.56s â†’ 0.09sï¼ˆ**æå‡ 6.2å€**ï¼‰

**å®‰å…¨æ€§è¯´æ˜**ï¼š
- æµ‹è¯•ç¯å¢ƒä½¿ç”¨ 4 rounds ä¸å½±å“å®‰å…¨æ€§
- ç”Ÿäº§ç¯å¢ƒä¿æŒ 12 rounds çš„é«˜å®‰å…¨æ€§
- ä»…åœ¨æµ‹è¯•æ—¶é™ä½ roundsï¼Œä¸å½±å“å®é™…éƒ¨ç½²

**æ–‡ä»¶**ï¼š
- `tests/.test_env`
- `tests/.test_env.template`
- `tests/conftest.py`
- `app/core/security.py`
- `docs/testing/TEST_PERFORMANCE_OPTIMIZATION.md`ï¼ˆæ–°å¢ï¼‰

### æ–‡æ¡£æ›´æ–°

#### 1. æµ‹è¯•æ–‡æ¡£æ›´æ–° (TESTING.md)

**æ›´æ–°å†…å®¹**ï¼š
- æ›´æ–°æµ‹è¯•ç»Ÿè®¡æ•°æ®ï¼šä» 753 ä¸ªæµ‹è¯•å¢åŠ åˆ° 1366 ä¸ªæµ‹è¯•
- æ›´æ–°æµ‹è¯•é€šè¿‡ç‡ï¼šä» 745 é€šè¿‡å¢åŠ åˆ° 1355 é€šè¿‡
- æ›´æ–°å¤±è´¥æµ‹è¯•æ•°ï¼šä» 7 ä¸ªå¤±è´¥å‡å°‘åˆ° 10 ä¸ªå¤±è´¥ï¼ˆä½†æ€»æ•°å¢åŠ æ˜¯å› ä¸ºæ–°å¢äº†æ›´å¤šæµ‹è¯•ï¼‰
- æ›´æ–°æµ‹è¯•æ‰§è¡Œæ—¶é—´ï¼šä» 162 ç§’å¢åŠ åˆ° 451 ç§’ï¼ˆç”±äºæµ‹è¯•æ•°é‡å¢åŠ ï¼‰
- æ›´æ–°æµ‹è¯•è´¨é‡è¯„åˆ†ï¼šä» 8.7/10 è°ƒæ•´åˆ° 8.5/10
- æ›´æ–°æ”¹è¿›å»ºè®®ï¼šé’ˆå¯¹æ–°çš„å¤±è´¥æµ‹è¯•ç±»å‹ï¼ˆdeps å’Œ error_handlersï¼‰

**æ–‡ä»¶**ï¼š`docs/TESTING.md`

**å…³é”®å˜åŒ–**ï¼š
- æµ‹è¯•æ•°é‡å¢åŠ äº† 81%ï¼ˆä» 753 â†’ 1366ï¼‰
- æµ‹è¯•è¦†ç›–ç‡ä¿æŒåœ¨ 79%
- æ–°å¢çš„å¤±è´¥æµ‹è¯•ä¸»è¦é›†ä¸­åœ¨ä¾èµ–æ³¨å…¥å’Œé”™è¯¯å¤„ç†æ¨¡å—

### æ–‡ä»¶ç»“æ„ä¼˜åŒ–

#### 1. ç¿»è¯‘å­—å…¸æ–‡ä»¶æ•´åˆ

**é—®é¢˜**ï¼š
- é¡¹ç›®ä¸­å­˜åœ¨ä¸‰ä¸ªç›¸åŒçš„ `translation_dict.json` æ–‡ä»¶å‰¯æœ¬
  - `./translation_dict.json` (æ ¹ç›®å½•)
  - `./app/translation_dict.json`
  - `./app/api/translation_dict.json`
- æ‰€æœ‰ä¸‰ä¸ªæ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒï¼ˆMD5: `b795659f2585f4d87cacb84f2135ddbb`ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¿ç•™å”¯ä¸€çš„è§„èŒƒä½ç½®ï¼š`./app/api/translation_dict.json`
- åˆ é™¤äº†æ ¹ç›®å½•å’Œ `app/` ç›®å½•ä¸‹çš„é‡å¤å‰¯æœ¬
- ä»£ç å·²æ­£ç¡®å¼•ç”¨è§„èŒƒä½ç½®ï¼ˆ`app/api/routes/dictionary.py`ï¼‰
- æ‰€æœ‰ç›¸å…³æµ‹è¯•é€šè¿‡éªŒè¯ï¼ˆ10/10 æµ‹è¯•é€šè¿‡ï¼‰

**å½±å“**ï¼š
- å‡å°‘äº†é¡¹ç›®ä¸­çš„å†—ä½™æ–‡ä»¶
- ç®€åŒ–äº†æ–‡ä»¶ç»´æŠ¤
- ä¸å½±å“åŠŸèƒ½ï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰

**æ–‡ä»¶**ï¼š
- åˆ é™¤ï¼š`./translation_dict.json`
- åˆ é™¤ï¼š`./app/translation_dict.json`
- ä¿ç•™ï¼š`./app/api/translation_dict.json`

---

## 2025-02-20 - æ–‡æ¡£å’Œæ¶æ„æ›´æ–°

### æ–‡æ¡£æ›´æ–°

#### 1. API æ–‡æ¡£å®Œå…¨é‡å†™

**æ›´æ–°å†…å®¹**ï¼š
- æ›´æ–°äº†åŸºç¡€ä¿¡æ¯å’Œé¡¹ç›®æ¶æ„è¯´æ˜
- å®Œæ•´çš„æ¥å£åˆ†ç±»å’Œè¯´æ˜
- æ·»åŠ äº†æ‰€æœ‰ 10 ä¸ªè·¯ç”±æ¨¡å—çš„æ¥å£æ–‡æ¡£
- æ–°å¢è¯„è®ºæ¥å£æ–‡æ¡£ï¼ˆåˆ›å»ºã€åˆ—è¡¨ã€ç‚¹èµ/ç‚¹è¸©ã€åˆ é™¤ï¼‰
- æ–°å¢æ”¶è—æ¥å£æ–‡æ¡£
- æ–°å¢ç®¡ç†å‘˜æ¥å£æ–‡æ¡£
- æ–°å¢ WebSocket æ¥å£æ–‡æ¡£
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼è¯´æ˜
- å¸¸è§é”™è¯¯ç è¡¨
- è®¤è¯å’Œæƒé™è¯´æ˜

**æ–‡ä»¶**ï¼š`docs/API.md`

#### 2. æ•°æ®åº“æ¨¡å‹æ–‡æ¡£æ›´æ–°

**æ›´æ–°å†…å®¹**ï¼š
- æ›´æ–°äº†æ–‡ä»¶è·¯å¾„ï¼ˆä» `database_models.py` æ”¹ä¸º `app/models/database.py`ï¼‰
- æ·»åŠ äº† `is_super_admin` å­—æ®µè¯´æ˜
- æ·»åŠ äº† `version` å­—æ®µè¯´æ˜ï¼ˆçŸ¥è¯†åº“å’Œäººè®¾å¡ï¼‰
- æ·»åŠ äº† `DownloadRecord` æ¨¡å‹è¯´æ˜
- æ·»åŠ äº† `Comment` å’Œ `CommentReaction` æ¨¡å‹è¯´æ˜
- æ˜ç¡®è¯´æ˜äº†**æ— ç‰©ç†å¤–é”®è®¾è®¡**
- æ›´æ–°äº†ç»´æŠ¤å»ºè®®

**æ–‡ä»¶**ï¼š`docs/database/models.md`

#### 3. Alembic è¿ç§»æŒ‡å—æ›´æ–°

**æ›´æ–°å†…å®¹**ï¼š
- æ›´æ–°äº†æ–‡ä»¶è·¯å¾„å’Œé…ç½®è¯´æ˜
- æ·»åŠ äº†é¡¹ç›®é…ç½®ç°çŠ¶è¯´æ˜
- æ·»åŠ äº†å¸¸ç”¨å‘½ä»¤å‚è€ƒ
- æ”¹è¿›äº†æ—¥å¸¸å¼€å‘æµç¨‹è¯´æ˜
- æ›´æ–°äº†å¤šæ•°æ®åº“æ”¯æŒè¯´æ˜
- æ·»åŠ äº†é—®é¢˜æ’æŸ¥è¡¨

**æ–‡ä»¶**ï¼š`docs/database/Alembic_migration_guide.md`

#### 4. æ¶æ„æ–‡æ¡£æ›´æ–°

**æ›´æ–°å†…å®¹**ï¼š
- æ›´æ–°äº†ç›®å½•ç»“æ„ï¼ˆæ·»åŠ äº†æ–°çš„æ–‡ä»¶å’Œç›®å½•ï¼‰
- æ›´æ–°äº†æµ‹è¯•ç›®å½•ç»“æ„ï¼ˆpropertyã€unitã€integrationï¼‰
- æ›´æ–°äº†æ•°æ®æ¨¡å‹è¯´æ˜ï¼ˆ12 ä¸ªè¡¨çš„å®Œæ•´è¯´æ˜ï¼‰
- æ›´æ–°äº†æ¨¡å‹å…³ç³»å›¾
- æ˜ç¡®è¯´æ˜äº†**æ— ç‰©ç†å¤–é”®è®¾è®¡**
- æ›´æ–°äº†ç›¸å…³æ–‡æ¡£é“¾æ¥

**æ–‡ä»¶**ï¼š`docs/ARCHITECTURE.md`

### é¡¹ç›®ç»“æ„ä¼˜åŒ–

#### 1. æ–‡æ¡£ç›®å½•æ¸…ç†

**åˆ é™¤çš„æ–‡ä»¶**ï¼š
- ä¸´æ—¶æŠ¥å‘Šï¼šCLEANUP_SUMMARYã€COVERAGE_PROGRESS_REPORTã€FINAL_COVERAGE_REPORTã€TEST_FIXES_SUMMARYã€test_quality_report
- ä¸­æ–‡æ›´æ–°æ€»ç»“ï¼šCHANGELOG_CN
- TODO åˆ—è¡¨
- æµ‹è¯•å’Œè„šæœ¬çš„å­ç›®å½•

**ä¿ç•™çš„æ–‡ä»¶**ï¼š
- æ ¸å¿ƒæ–‡æ¡£ï¼šAPI.mdã€ARCHITECTURE.mdã€CHANGELOG.mdã€TESTING.mdã€README_ERROR_CODES.md
- æ•°æ®åº“æ–‡æ¡£ï¼šmodels.mdã€Alembic_migration_guide.md
- Postman é›†åˆ

#### 2. ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶æ¸…ç†

**åˆ é™¤çš„ç›®å½•**ï¼š
- `__pycache__/` - Python ç¼“å­˜
- `.pytest_cache/` - Pytest ç¼“å­˜
- `htmlcov/` - è¦†ç›–ç‡ HTML æŠ¥å‘Š

**åˆ é™¤çš„æ–‡ä»¶**ï¼š
- `.coverage` - è¦†ç›–ç‡æ•°æ®
- `coverage.json` - è¦†ç›–ç‡ JSON
- `test.db` - æµ‹è¯•æ•°æ®åº“
- `check_password.py` - æ ¹ç›®å½•è„šæœ¬
- å…¶ä»–ä¸´æ—¶æ–‡ä»¶

### æ•°æ®åº“è®¾è®¡è¯´æ˜

#### æ— ç‰©ç†å¤–é”®è®¾è®¡

é¡¹ç›®é‡‡ç”¨**æ— ç‰©ç†å¤–é”®è®¾è®¡**ï¼Œæ‰€æœ‰å…³ç³»å‡é€šè¿‡åº”ç”¨å±‚ç»´æŠ¤ï¼š

**ä¼˜ç‚¹**ï¼š
- çµæ´»æ€§é«˜ï¼Œå¯ä»¥è½»æ¾ä¿®æ”¹å…³ç³»
- æ•°æ®åº“è¿ç§»æ›´ç®€å•
- æ”¯æŒå¤šæ•°æ®åº“åˆ‡æ¢

**ç¼ºç‚¹**ï¼š
- åº”ç”¨å±‚å¿…é¡»ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- åˆ é™¤æ“ä½œéœ€è¦æ‰‹åŠ¨å¤„ç†çº§è”åˆ é™¤
- éœ€è¦æ›´è°¨æ…çš„ä¸šåŠ¡é€»è¾‘è®¾è®¡

**å®ç°æ–¹å¼**ï¼š
- æ‰€æœ‰å…³ç³»é€šè¿‡ SQLAlchemy çš„ `relationship` å£°æ˜ï¼ˆé€»è¾‘å…³ç³»ï¼‰
- æ•°æ®åº“ä¸­ä¸åˆ›å»ºç‰©ç†å¤–é”®çº¦æŸ
- åº”ç”¨å±‚è´Ÿè´£ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§

### å½±å“èŒƒå›´

**æ–‡æ¡£æ›´æ–°**ï¼š
- æ‰€æœ‰æ–‡æ¡£å·²åŒæ­¥åˆ°æœ€æ–°å®ç°
- æ–°å¢äº†å®Œæ•´çš„ API æ–‡æ¡£
- æ–°å¢äº†æ•°æ®åº“è¿ç§»æŒ‡å—
- æ›´æ–°äº†æ¶æ„æ–‡æ¡£

**é¡¹ç›®ç»“æ„**ï¼š
- æ–‡æ¡£ç›®å½•æ›´åŠ æ¸…æ™°
- åˆ é™¤äº†å¤§é‡ä¸´æ—¶æ–‡ä»¶
- é¡¹ç›®ä½“ç§¯å‡å°

### ç›¸å…³æ–‡ä»¶

- `docs/API.md` - API æ–‡æ¡£
- `docs/ARCHITECTURE.md` - æ¶æ„æ–‡æ¡£
- `docs/database/models.md` - æ•°æ®åº“æ¨¡å‹
- `docs/database/Alembic_migration_guide.md` - è¿ç§»æŒ‡å—

---

## 2025-12-01 - ç”¨æˆ·ä¸Šä¼ å†å²å’Œç»Ÿè®¡æ¥å£å¢å¼º

### æ–°å¢åŠŸèƒ½

#### 1. ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²æ¥å£

**æ–°å¢æ¥å£**ï¼š
- `GET /api/me/upload-history` - è·å–å½“å‰ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²è®°å½•

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢ç”¨æˆ·ä¸Šä¼ è®°å½•
- è¿”å›çŸ¥è¯†åº“å’Œäººè®¾å¡çš„ä¸Šä¼ è®°å½•
- åŒ…å«çŠ¶æ€æ˜ å°„ï¼ˆapprovedâ†’successï¼Œpendingâ†’processingï¼Œrejectedâ†’failedï¼‰
- æä¾›ç›®æ ‡å­˜åœ¨æ€§æ£€æŸ¥å’Œæ–‡ä»¶å¤§å°ç»Ÿè®¡
- æ”¯æŒå…¼å®¹å‰ç«¯çš„å“åº”æ ¼å¼æ„å»º

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`user_router.py`
- è¡Œå·ï¼šç¬¬1260-1320è¡Œ

#### 2. ç”¨æˆ·ä¸ªäººä¸Šä¼ ç»Ÿè®¡æ¥å£

**æ–°å¢æ¥å£**ï¼š
- `GET /api/me/upload-stats` - è·å–å½“å‰ç”¨æˆ·ä¸ªäººä¸Šä¼ ç»Ÿè®¡

**åŠŸèƒ½è¯´æ˜**ï¼š
- è·å–ç”¨æˆ·ä¸Šä¼ æ€»æ•°ã€æˆåŠŸæ•°ã€å¤„ç†ä¸­æ•°ã€å¤±è´¥æ•°
- è¿”å›åç«¯æ•°æ®åº“å­—æ®µåå’Œå‰ç«¯æœŸæœ›å­—æ®µåä¸¤ç§æ ¼å¼çš„ç»Ÿè®¡ç»“æœ
- æä¾›æˆåŠŸç‡å’Œæ–‡ä»¶å¤§å°ç»Ÿè®¡
- å…¼å®¹å‰ç«¯UIå±•ç¤ºéœ€æ±‚

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`user_router.py`
- è¡Œå·ï¼šç¬¬1321-1380è¡Œ

### å½±å“èŒƒå›´

**æ–°å¢æ¥å£**ï¼ˆå®¢æˆ·ç«¯å¯é€‰é›†æˆï¼‰ï¼š
- `GET /api/me/upload-history` - ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²è®°å½•
- `GET /api/me/upload-stats` - ç”¨æˆ·ä¸ªäººä¸Šä¼ ç»Ÿè®¡

**åŠŸèƒ½å½±å“**ï¼š
- ç”¨æˆ·ç°åœ¨å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¸Šä¼ å†å²å’Œç»Ÿè®¡æ•°æ®
- ä¸ç°æœ‰çš„ç®¡ç†å‘˜ä¸Šä¼ å†å²å’Œç»Ÿè®¡æ¥å£å½¢æˆäº’è¡¥
- æä¾›ä¸ªäººç»´åº¦çš„ä¸Šä¼ ç®¡ç†èƒ½åŠ›

### ç›¸å…³æ–‡ä»¶

- `user_router.py` - ç”¨æˆ·è·¯ç”±å®ç°
- `database_models.py` - æ•°æ®åº“æ¨¡å‹ï¼ˆUploadRecordè¡¨ï¼‰

---

## 2025-11-25 - å†…å®¹å­—æ®µå…¥åº“ä¸åˆ—è¡¨èƒ½åŠ›å¢å¼º

### åŠŸèƒ½ / æ¥å£
- çŸ¥è¯†åº“ä¸äººè®¾å¡ä¸Šä¼ æ–°å¢æ­£æ–‡ `content`ã€æ ‡ç­¾ `tags`ï¼Œå“åº”å¸¦ä½œè€…ä¿¡æ¯ã€æ–‡ä»¶åˆ—è¡¨ä¸å¤§å°èšåˆï¼Œåˆ é™¤æœ€åä¸€ä¸ªæ–‡ä»¶æ—¶è‡ªåŠ¨åˆ é™¤æ•´æ¡çŸ¥è¯†åº“ï¼ˆè¿”å› `knowledge_deleted` æ ‡è¯†ï¼‰
- ç”¨æˆ·ä¸Šä¼ è®°å½•ï¼ˆçŸ¥è¯†åº“ã€äººè®¾å¡ï¼‰æ”¯æŒåˆ†é¡µã€åç§°/æ ‡ç­¾/çŠ¶æ€ç­›é€‰ä¸å¤šå­—æ®µæ’åºï¼Œç®¡ç†å‘˜/å®¡æ ¸å‘˜å¯æŸ¥çœ‹ä»–äººè®°å½•
- ç”¨æˆ·æ”¶è—åˆ—è¡¨åˆ†é¡µåŒ–ï¼Œæ”¯æŒç±»å‹è¿‡æ»¤å’Œåˆ›å»ºæ—¶é—´/æ”¶è—æ•°æ’åºï¼Œè¿”å› `items/total/page/page_size` ç»“æ„
- ç®¡ç†ç«¯å†…å®¹åˆ—è¡¨æ–°å¢ä¸Šä¼ è€…ï¼ˆID/ç”¨æˆ·åæ¨¡ç³Šï¼‰ç­›é€‰ä¸æ’åºå­—æ®µ/æ–¹å‘å‚æ•°ï¼Œæ—¥å¿—è¾“å‡ºè¡¥å……ä¸Šä¸‹æ–‡
- ä¸Šä¼ /ä¸‹è½½ç›¸å…³ CORS æš´éœ² `Content-Disposition` å¤´ï¼Œå‰ç«¯å¯è¯»å–æ–‡ä»¶å

### æ¨¡å‹ / å­˜å‚¨
- `KnowledgeBase`ã€`PersonaCard` æ¨¡å‹æ–°å¢ `content`ã€`tags` å­—æ®µï¼›è¿”å›çš„ä½œè€…å­—æ®µå›è½åˆ°ç‰ˆæƒäºº/ä¸Šä¼ è€…
- SQLite è¿ç§»è¡¥å…… `content`ã€`tags` åˆ—å¹¶åœ¨ä¿å­˜å‰ç»Ÿä¸€å°†æ ‡ç­¾åˆ—è¡¨è½¬é€—å·å­—ç¬¦ä¸²

### æ–‡æ¡£
- API æ–‡æ¡£è¡¥å…… content/tags ä¼ å‚ã€ç”¨æˆ·ä¸Šä¼ /æ”¶è—åˆ†é¡µå‚æ•°ä¸å“åº”ã€åˆ é™¤æ–‡ä»¶è¿”å›å­—æ®µã€ç®¡ç†ç«¯ç­›é€‰ä¸æ’åºå‚æ•°ç¤ºä¾‹
- README/TODO åŒæ­¥ä¸Šè¿°è¡Œä¸ºä¸å®ŒæˆçŠ¶æ€

---

## 2025-11-24 - ç”¨æˆ·åŠŸèƒ½å’Œç®¡ç†å‘˜åŠŸèƒ½å¢å¼º

### æ–°å¢åŠŸèƒ½

#### 1. åˆ·æ–°ä»¤ç‰Œæœºåˆ¶

**æ–°å¢æ¥å£**ï¼š
- `POST /api/refresh` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ

**åŠŸèƒ½è¯´æ˜**ï¼š
- ç™»å½•æ¥å£ç°åœ¨è¿”å› `refresh_token` å’Œ `expires_in` å­—æ®µ
- æ”¯æŒä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸ15åˆ†é’Ÿï¼Œåˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸæ›´é•¿

#### 2. ç”¨æˆ·å¤´åƒåŠŸèƒ½

**æ–°å¢æ¥å£**ï¼š
- `POST /api/users/me/avatar` - ä¸Šä¼ å¤´åƒ
- `DELETE /api/users/me/avatar` - åˆ é™¤å¤´åƒ
- `GET /api/users/{user_id}/avatar` - è·å–ç”¨æˆ·å¤´åƒ

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒä¸Šä¼ ã€åˆ é™¤å’Œè·å–ç”¨æˆ·å¤´åƒ
- æ”¯æŒ JPGã€JPEGã€PNGã€GIFã€WEBP æ ¼å¼
- è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾
- å¦‚æœç”¨æˆ·æ²¡æœ‰ä¸Šä¼ å¤´åƒï¼Œè¿”å›è‡ªåŠ¨ç”Ÿæˆçš„å¤´åƒ
- å¤´åƒæœ€å¤§ 2MBï¼Œæœ€å¤§å°ºå¯¸ 1024x1024 åƒç´ 

#### 3. ä¿®æ”¹å¯†ç åŠŸèƒ½

**æ–°å¢æ¥å£**ï¼š
- `PUT /api/users/me/password` - ä¿®æ”¹å¯†ç 

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- éœ€è¦æä¾›å½“å‰å¯†ç è¿›è¡ŒéªŒè¯
- å¯†ç ä¿®æ”¹åï¼Œæ‰€æœ‰ç°æœ‰Tokenå°†å¤±æ•ˆï¼ˆé€šè¿‡password_versionæœºåˆ¶ï¼‰
- å¸¦é€Ÿç‡é™åˆ¶ï¼šæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡å°è¯•

#### 4. ç®¡ç†å‘˜åŠŸèƒ½å¢å¼º

**æ–°å¢æ¥å£**ï¼š
- `GET /api/admin/broadcast-messages` - è·å–å¹¿æ’­æ¶ˆæ¯ç»Ÿè®¡
- `GET /api/admin/stats` - è·å–ç³»ç»Ÿç»Ÿè®¡æ•°æ®
- `GET /api/admin/recent-users` - è·å–æœ€è¿‘æ³¨å†Œç”¨æˆ·
- `GET /api/admin/users` - è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œæœç´¢ï¼‰
- `PUT /api/admin/users/{user_id}/role` - æ›´æ–°ç”¨æˆ·è§’è‰²
- `DELETE /api/admin/users/{user_id}` - åˆ é™¤ç”¨æˆ·
- `POST /api/admin/users` - åˆ›å»ºæ–°ç”¨æˆ·
- `GET /api/admin/knowledge/all` - è·å–æ‰€æœ‰çŸ¥è¯†åº“ï¼ˆç®¡ç†å‘˜ï¼‰
- `GET /api/admin/persona/all` - è·å–æ‰€æœ‰äººè®¾å¡ï¼ˆç®¡ç†å‘˜ï¼‰
- `POST /api/admin/knowledge/{kb_id}/revert` - æ¢å¤çŸ¥è¯†åº“å®¡æ ¸çŠ¶æ€
- `POST /api/admin/persona/{pc_id}/revert` - æ¢å¤äººè®¾å¡å®¡æ ¸çŠ¶æ€
- `GET /api/admin/upload-history` - è·å–ä¸Šä¼ å†å²è®°å½•
- `GET /api/admin/upload-stats` - è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®
- `DELETE /api/admin/uploads/{upload_id}` - åˆ é™¤ä¸Šä¼ è®°å½•
- `POST /api/admin/uploads/{upload_id}/reprocess` - é‡æ–°å¤„ç†ä¸Šä¼ 

### æ¥å£å˜æ›´

#### ç™»å½•æ¥å£å“åº”æ ¼å¼æ›´æ–°

**å˜æ›´å‰**ï¼š
```json
{
  "access_token": "...",
  "token_type": "bearer"
}
```

**å˜æ›´å**ï¼š
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "token_type": "bearer",
  "expires_in": 900,
  "user": {
    "id": "...",
    "username": "...",
    "email": "...",
    "role": "..."
  }
}
```

---

## 2025-11-23 - æ–°å¢åŠŸèƒ½å’Œæ¥å£ä¼˜åŒ–

### æ–°å¢åŠŸèƒ½

#### 1. StarçŠ¶æ€æ£€æŸ¥æ¥å£

**æ–°å¢æ¥å£**ï¼š
- `GET /api/knowledge/{kb_id}/starred` - æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦å·²è¢«å½“å‰ç”¨æˆ·Star
- `GET /api/persona/{pc_id}/starred` - æ£€æŸ¥äººè®¾å¡æ˜¯å¦å·²è¢«å½“å‰ç”¨æˆ·Star

**åŠŸèƒ½è¯´æ˜**ï¼š
- è¿”å›æ ¼å¼ï¼š`{"starred": true/false}`
- éœ€è¦ç”¨æˆ·è®¤è¯
- ç”¨äºå‰ç«¯å¿«é€Ÿæ£€æŸ¥StarçŠ¶æ€ï¼Œé¿å…è·å–æ‰€æœ‰Starè®°å½•

#### 2. åˆ†é¡µæ”¯æŒ

**æ–°å¢åˆ†é¡µæ¥å£**ï¼š
- `GET /api/knowledge/public` - æ”¯æŒåˆ†é¡µã€æœç´¢ã€ç­›é€‰å’Œæ’åº
- `GET /api/persona/public` - æ”¯æŒåˆ†é¡µã€æœç´¢ã€ç­›é€‰å’Œæ’åº

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆ1-100ï¼‰
- `name`: æŒ‰åç§°æœç´¢ï¼ˆå¯é€‰ï¼‰
- `uploader_id`: æŒ‰ä¸Šä¼ è€…IDç­›é€‰ï¼ˆå¯é€‰ï¼‰
- `sort_by`: æ’åºå­—æ®µï¼ˆcreated_at, updated_at, star_countï¼‰
- `sort_order`: æ’åºé¡ºåºï¼ˆasc, descï¼‰

#### 3. ç”¨æˆ·Starè®°å½•æ¥å£å¢å¼º

**æ¥å£**ï¼š`GET /api/user/stars`

**æ–°å¢å‚æ•°**ï¼š
- `includeDetails`: æ˜¯å¦åŒ…å«å®Œæ•´è¯¦æƒ…ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼š
- å½“ `includeDetails=true` æ—¶ï¼Œè¿”å›Starè®°å½•çš„åŒæ—¶åŒ…å«çŸ¥è¯†åº“/äººè®¾å¡çš„å®Œæ•´ä¿¡æ¯
- å‡å°‘å‰ç«¯APIè°ƒç”¨æ¬¡æ•°ï¼Œä» 1+N æ¬¡è¯·æ±‚ä¼˜åŒ–åˆ° 1 æ¬¡è¯·æ±‚

---

## 2025-11-22 - API Bugä¿®å¤å’Œä¼˜åŒ–

### ä¿®å¤å†…å®¹

#### 1. å®¡æ ¸APIä¿®å¤ï¼ˆçŸ¥è¯†åº“å’Œäººè®¾å¡å®¡æ‰¹å¤±è´¥ï¼‰

**é—®é¢˜æè¿°**ï¼š
- `approve_knowledge_base`ã€`reject_knowledge_base`ã€`approve_persona_card` å’Œ `reject_persona_card` å››ä¸ªå®¡æ ¸APIåœ¨è°ƒç”¨ `save_knowledge_base` å’Œ `save_persona_card` æ—¶ä¼ çš„æ˜¯å¯¹è±¡ï¼Œä½†è¿™ä¸¤ä¸ªæ–¹æ³•æœŸæœ›å­—å…¸å‚æ•°ã€‚

**ä¿®å¤æ–¹æ³•**ï¼š
åœ¨è°ƒç”¨ `save_knowledge_base` å’Œ `save_persona_card` ä¹‹å‰ï¼Œç”¨ `to_dict()` æŠŠå¯¹è±¡è½¬æˆå­—å…¸ã€‚

#### 1.1. å®¡æ ¸æ‹’ç»APIå‚æ•°ä¼ é€’æ–¹å¼ä¼˜åŒ–

**é—®é¢˜æè¿°**ï¼š
- `reject_knowledge_base` å’Œ `reject_persona_card` æ¥å£çš„ `reason` å‚æ•°åŸæœ¬ä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼ˆQueryï¼‰ï¼Œä¸ç¬¦åˆRESTfulæœ€ä½³å®è·µã€‚

**ä¿®å¤æ–¹æ³•**ï¼š
å°† `reason` å‚æ•°ä»æŸ¥è¯¢å‚æ•°æ”¹ä¸ºè¯·æ±‚ä½“ï¼ˆBodyï¼‰ï¼Œä½¿ç”¨ `Body(..., embed=True)` æ¥æ”¶JSONæ ¼å¼çš„è¯·æ±‚ä½“ã€‚

#### 2. æ¶ˆæ¯å‘é€APIä¿®å¤ï¼ˆæ¶ˆæ¯åˆ›å»ºå¤±è´¥ï¼‰

**é—®é¢˜æè¿°**ï¼š
- `Message.to_dict()` æ–¹æ³•è¿”å›çš„ `created_at` å­—æ®µæ˜¯ ISO æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä½† `MessageResponse` Pydanticæ¨¡å‹æœŸæœ›æ¥æ”¶ `datetime` å¯¹è±¡ã€‚

**ä¿®å¤æ–¹æ³•**ï¼š
ä¿®æ”¹ `Message.to_dict()` æ–¹æ³•ï¼Œç¡®ä¿ `created_at` å­—æ®µè¿”å› `datetime` å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚

#### 3. æ¶ˆæ¯è·å–APIä¿®å¤ï¼ˆè·å–æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼‰

**é—®é¢˜æè¿°**ï¼š
- `api_routes.py` ä¸­å®šä¹‰äº†é‡å¤çš„ `MessageResponse` ç±»ï¼Œä¸ `models.py` ä¸­çš„å®šä¹‰ä¸ä¸€è‡´ã€‚

**ä¿®å¤æ–¹æ³•**ï¼š
ä» `models.py` å¯¼å…¥ `MessageResponse`ï¼Œåˆ é™¤ `api_routes.py` ä¸­é‡å¤çš„å®šä¹‰ã€‚

#### 4. æ¶ˆæ¯APIè¿›ä¸€æ­¥ä¿®å¤ï¼ˆæ‰¹é‡åˆ›å»ºå’ŒæŸ¥è¯¢ä¼˜åŒ–ï¼‰

**é—®é¢˜æè¿°**ï¼š
- `bulk_create_messages` æ–¹æ³•åœ¨å¼‚å¸¸æ—¶åªæ‰“å°é”™è¯¯å¹¶è¿”å›ç©ºåˆ—è¡¨
- SQLæŸ¥è¯¢ä¸­ä½¿ç”¨ `&` å’Œ `|` è¿ç®—ç¬¦æ—¶ï¼Œè¿ç®—ç¬¦ä¼˜å…ˆçº§å¯èƒ½å¯¼è‡´æŸ¥è¯¢é€»è¾‘é”™è¯¯

**ä¿®å¤æ–¹æ³•**ï¼š
- æ”¹è¿›å¼‚å¸¸å¤„ç†ï¼ŒæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯é™é»˜å¤±è´¥
- ä½¿ç”¨ `and_()` å’Œ `or_()` å‡½æ•°æ›¿ä»£ `&` å’Œ `|` è¿ç®—ç¬¦

#### 5. æ•°æ®åº“è¿ç§»ä¿®å¤ï¼ˆmessagesè¡¨ç¼ºå°‘message_typeåˆ—ï¼‰

**é—®é¢˜æè¿°**ï¼š
- æ•°æ®åº“è¡¨ `messages` ç¼ºå°‘ `message_type` å’Œ `broadcast_scope` åˆ—

**ä¿®å¤æ–¹æ³•**ï¼š
æ·»åŠ è‡ªåŠ¨æ•°æ®åº“è¿ç§»æ–¹æ³•ï¼Œåœ¨æ•°æ®åº“ç®¡ç†å™¨åˆå§‹åŒ–æ—¶æ£€æŸ¥å¹¶æ·»åŠ ç¼ºå¤±çš„åˆ—ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 4.0  
**æœ€åæ›´æ–°**: 2025-02-20  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

## 2025-11-24 - ç”¨æˆ·åŠŸèƒ½å’Œç®¡ç†å‘˜åŠŸèƒ½å¢å¼º

### æ–°å¢åŠŸèƒ½

#### 1. åˆ·æ–°ä»¤ç‰Œæœºåˆ¶

**æ–°å¢æ¥å£**ï¼š
- `POST /api/refresh` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ

**åŠŸèƒ½è¯´æ˜**ï¼š
- ç™»å½•æ¥å£ç°åœ¨è¿”å› `refresh_token` å’Œ `expires_in` å­—æ®µ
- æ”¯æŒä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸ15åˆ†é’Ÿï¼Œåˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸæ›´é•¿

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š`refresh_token`: ç¬¬121-180è¡Œ

#### 2. ç”¨æˆ·å¤´åƒåŠŸèƒ½

**æ–°å¢æ¥å£**ï¼š
- `POST /api/users/me/avatar` - ä¸Šä¼ å¤´åƒ
- `DELETE /api/users/me/avatar` - åˆ é™¤å¤´åƒ
- `GET /api/users/{user_id}/avatar` - è·å–ç”¨æˆ·å¤´åƒ

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒä¸Šä¼ ã€åˆ é™¤å’Œè·å–ç”¨æˆ·å¤´åƒ
- æ”¯æŒ JPGã€JPEGã€PNGã€GIFã€WEBP æ ¼å¼
- è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾
- å¦‚æœç”¨æˆ·æ²¡æœ‰ä¸Šä¼ å¤´åƒï¼Œè¿”å›è‡ªåŠ¨ç”Ÿæˆçš„å¤´åƒ
- å¤´åƒæœ€å¤§ 2MBï¼Œæœ€å¤§å°ºå¯¸ 1024x1024 åƒç´ 

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š
  - `upload_avatar`: ç¬¬493-566è¡Œ
  - `delete_avatar`: ç¬¬567-612è¡Œ
  - `get_user_avatar`: ç¬¬614-644è¡Œ
- æ–‡ä»¶ï¼š`avatar_utils.py` - å¤´åƒå¤„ç†å·¥å…·

#### 3. ä¿®æ”¹å¯†ç åŠŸèƒ½

**æ–°å¢æ¥å£**ï¼š
- `PUT /api/users/me/password` - ä¿®æ”¹å¯†ç 

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- éœ€è¦æä¾›å½“å‰å¯†ç è¿›è¡ŒéªŒè¯
- å¯†ç ä¿®æ”¹åï¼Œæ‰€æœ‰ç°æœ‰Tokenå°†å¤±æ•ˆï¼ˆé€šè¿‡password_versionæœºåˆ¶ï¼‰
- å¸¦é€Ÿç‡é™åˆ¶ï¼šæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡å°è¯•

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š`change_password`: ç¬¬422-490è¡Œ

#### 4. ç®¡ç†å‘˜åŠŸèƒ½å¢å¼º

**æ–°å¢æ¥å£**ï¼š
- `GET /api/admin/broadcast-messages` - è·å–å¹¿æ’­æ¶ˆæ¯ç»Ÿè®¡
- `GET /api/admin/stats` - è·å–ç³»ç»Ÿç»Ÿè®¡æ•°æ®
- `GET /api/admin/recent-users` - è·å–æœ€è¿‘æ³¨å†Œç”¨æˆ·
- `GET /api/admin/users` - è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œæœç´¢ï¼‰
- `PUT /api/admin/users/{user_id}/role` - æ›´æ–°ç”¨æˆ·è§’è‰²
- `DELETE /api/admin/users/{user_id}` - åˆ é™¤ç”¨æˆ·
- `POST /api/admin/users` - åˆ›å»ºæ–°ç”¨æˆ·
- `GET /api/admin/knowledge/all` - è·å–æ‰€æœ‰çŸ¥è¯†åº“ï¼ˆç®¡ç†å‘˜ï¼‰
- `GET /api/admin/persona/all` - è·å–æ‰€æœ‰äººè®¾å¡ï¼ˆç®¡ç†å‘˜ï¼‰
- `POST /api/admin/knowledge/{kb_id}/revert` - æ¢å¤çŸ¥è¯†åº“å®¡æ ¸çŠ¶æ€
- `POST /api/admin/persona/{pc_id}/revert` - æ¢å¤äººè®¾å¡å®¡æ ¸çŠ¶æ€
- `GET /api/admin/upload-history` - è·å–ä¸Šä¼ å†å²è®°å½•
- `GET /api/admin/upload-stats` - è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®
- `DELETE /api/admin/uploads/{upload_id}` - åˆ é™¤ä¸Šä¼ è®°å½•
- `POST /api/admin/uploads/{upload_id}/reprocess` - é‡æ–°å¤„ç†ä¸Šä¼ 

**åŠŸèƒ½è¯´æ˜**ï¼š
- æä¾›å®Œæ•´çš„ç®¡ç†å‘˜ç®¡ç†åŠŸèƒ½
- æ”¯æŒç”¨æˆ·ç®¡ç†ã€å†…å®¹ç®¡ç†ã€ä¸Šä¼ ç»Ÿè®¡ç­‰
- æ‰€æœ‰æ¥å£éœ€è¦adminæƒé™

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼šç¬¬2838-4108è¡Œ

### æ¥å£å˜æ›´

#### ç™»å½•æ¥å£å“åº”æ ¼å¼æ›´æ–°

**å˜æ›´å‰**ï¼š
```json
{
  "access_token": "...",
  "token_type": "bearer"
}
```

**å˜æ›´å**ï¼š
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "token_type": "bearer",
  "expires_in": 900,
  "user": {
    "id": "...",
    "username": "...",
    "email": "...",
    "role": "..."
  }
}
```

#### è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£å“åº”æ ¼å¼æ›´æ–°

**æ–°å¢å­—æ®µ**ï¼š
- `avatar_url`: å¤´åƒURL
- `avatar_updated_at`: å¤´åƒæ›´æ–°æ—¶é—´

### å½±å“èŒƒå›´

**æ–°å¢æ¥å£**ï¼ˆå®¢æˆ·ç«¯å¯é€‰é›†æˆï¼‰ï¼š
- `POST /api/refresh` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ
- `PUT /api/users/me/password` - ä¿®æ”¹å¯†ç 
- `POST /api/users/me/avatar` - ä¸Šä¼ å¤´åƒ
- `DELETE /api/users/me/avatar` - åˆ é™¤å¤´åƒ
- `GET /api/users/{user_id}/avatar` - è·å–ç”¨æˆ·å¤´åƒ
- æ‰€æœ‰ç®¡ç†å‘˜æ¥å£ï¼ˆéœ€è¦adminæƒé™ï¼‰

**æ¥å£å˜æ›´**ï¼ˆå®¢æˆ·ç«¯éœ€è¦æ›´æ–°ï¼‰ï¼š
- `POST /api/token` - å“åº”æ ¼å¼å·²æ›´æ–°ï¼ŒåŒ…å«æ›´å¤šå­—æ®µ
- `GET /api/users/me` - å“åº”æ ¼å¼å·²æ›´æ–°ï¼ŒåŒ…å«å¤´åƒä¿¡æ¯

### ç›¸å…³æ–‡ä»¶

- `MaiMaiNotePad-BackEnd/api_routes.py` - APIè·¯ç”±å®ç°
- `MaiMaiNotePad-BackEnd/avatar_utils.py` - å¤´åƒå¤„ç†å·¥å…·
- `MaiMaiNotePad-BackEnd/database_models.py` - æ•°æ®åº“æ¨¡å‹ï¼ˆUseræ¨¡å‹å·²åŒ…å«å¤´åƒå­—æ®µï¼‰
- `MaiMaiNotePad-BackEnd/jwt_utils.py` - JWTå·¥å…·ï¼ˆåŒ…å«åˆ·æ–°ä»¤ç‰ŒåŠŸèƒ½ï¼‰

---

## 2025-11-22 - API Bugä¿®å¤å’Œä¼˜åŒ–

### ä¿®å¤å†…å®¹

ä¸»è¦è§£å†³äº†å¤šä¸ªAPIçš„é—®é¢˜å’Œä¼˜åŒ–ï¼š

#### 1. å®¡æ ¸APIä¿®å¤ï¼ˆçŸ¥è¯†åº“å’Œäººè®¾å¡å®¡æ‰¹å¤±è´¥ï¼‰

**é—®é¢˜æè¿°ï¼š**
- `approve_knowledge_base`ã€`reject_knowledge_base`ã€`approve_persona_card` å’Œ `reject_persona_card` å››ä¸ªå®¡æ ¸APIåœ¨è°ƒç”¨ `save_knowledge_base` å’Œ `save_persona_card` æ—¶ä¼ çš„æ˜¯å¯¹è±¡ï¼Œä½†è¿™ä¸¤ä¸ªæ–¹æ³•æœŸæœ›å­—å…¸å‚ã€‚

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š
  - `approve_knowledge_base`: ç¬¬1656è¡Œ
  - `reject_knowledge_base`: ç¬¬1700è¡Œ
  - `approve_persona_card`: ç¬¬1753è¡Œ
  - `reject_persona_card`: ç¬¬1797è¡Œ

**ä¿®å¤æ–¹æ³•ï¼š**
åœ¨è°ƒç”¨ `save_knowledge_base` å’Œ `save_persona_card` ä¹‹å‰ï¼Œç”¨ `to_dict()` æŠŠå¯¹è±¡è½¬æˆå­—å…¸ã€‚

**ä¿®æ”¹å‰ï¼š**
```python
updated_kb = db_manager.save_knowledge_base(kb)
```

**ä¿®æ”¹åï¼š**
```python
updated_kb = db_manager.save_knowledge_base(kb.to_dict())
```

---

#### 1.1. å®¡æ ¸æ‹’ç»APIå‚æ•°ä¼ é€’æ–¹å¼ä¼˜åŒ–

**é—®é¢˜æè¿°ï¼š**
- `reject_knowledge_base` å’Œ `reject_persona_card` æ¥å£çš„ `reason` å‚æ•°åŸæœ¬ä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼ˆQueryï¼‰ï¼Œä¸ç¬¦åˆRESTfulæœ€ä½³å®è·µï¼Œä¸”å¯¹äºè¾ƒé•¿çš„æ‹’ç»åŸå› ä¸å¤Ÿå‹å¥½ã€‚

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š
  - `reject_knowledge_base`: ç¬¬1694è¡Œ
  - `reject_persona_card`: ç¬¬1791è¡Œ

**ä¿®å¤æ–¹æ³•ï¼š**
å°† `reason` å‚æ•°ä»æŸ¥è¯¢å‚æ•°æ”¹ä¸ºè¯·æ±‚ä½“ï¼ˆBodyï¼‰ï¼Œä½¿ç”¨ `Body(..., embed=True)` æ¥æ”¶JSONæ ¼å¼çš„è¯·æ±‚ä½“ã€‚

**ä¿®æ”¹å‰ï¼š**
```python
@api_router.post("/review/knowledge/{kb_id}/reject")
async def reject_knowledge_base(
    kb_id: str,
    reason: str = Query(...),  # æŸ¥è¯¢å‚æ•°
    current_user: dict = Depends(get_current_user)
):
    # ...
```

**ä¿®æ”¹åï¼š**
```python
@api_router.post("/review/knowledge/{kb_id}/reject")
async def reject_knowledge_base(
    kb_id: str,
    reason: str = Body(..., embed=True),  # è¯·æ±‚ä½“
    current_user: dict = Depends(get_current_user)
):
    # ...
```

**APIè°ƒç”¨æ–¹å¼å˜æ›´ï¼š**

ä¿®æ”¹å‰ï¼ˆæŸ¥è¯¢å‚æ•°ï¼‰ï¼š
```bash
POST /api/review/knowledge/{kb_id}/reject?reason=æ‹’ç»åŸå› 
```

ä¿®æ”¹åï¼ˆè¯·æ±‚ä½“ï¼‰ï¼š
```bash
POST /api/review/knowledge/{kb_id}/reject
Content-Type: application/json

{
  "reason": "æ‹’ç»åŸå› "
}
```

**å½±å“ï¼š**
- å®¢æˆ·ç«¯éœ€è¦æ›´æ–°è°ƒç”¨æ–¹å¼ï¼Œå°† `reason` å‚æ•°ä»æŸ¥è¯¢å­—ç¬¦ä¸²æ”¹ä¸ºJSONè¯·æ±‚ä½“
- æ›´ç¬¦åˆRESTful APIè®¾è®¡è§„èŒƒ
- æ”¯æŒæ›´é•¿çš„æ‹’ç»åŸå› æ–‡æœ¬

---

#### 2. æ¶ˆæ¯å‘é€APIä¿®å¤ï¼ˆæ¶ˆæ¯åˆ›å»ºå¤±è´¥ï¼‰

**é—®é¢˜æè¿°ï¼š**
- `Message.to_dict()` æ–¹æ³•è¿”å›çš„ `created_at` å­—æ®µæ˜¯ ISO æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä½† `MessageResponse` Pydanticæ¨¡å‹æœŸæœ›æ¥æ”¶ `datetime` å¯¹è±¡ï¼ˆè¿™é‡Œçš„ISOæ ¼å¼å­—ç¬¦ä¸²æˆ‘çœŸçš„æ²¡æ‡‚å«ä¹‰ï¼Œè‹¥çœŸçš„è¦ç”¨çš„è¯æ­¤å¤„ä¿®å¤å¯æ¢ä¸ªå®ç°æ–¹å¼ï¼‰ã€‚

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`database_models.py`
- ç±»ï¼š`Message`
- æ–¹æ³•ï¼š`to_dict()`
- è¡Œå·ï¼šç¬¬338-351è¡Œ

**ä¿®å¤æ–¹æ³•ï¼š**
ä¿®æ”¹ `Message.to_dict()` æ–¹æ³•ï¼Œç¡®ä¿ `created_at` å­—æ®µè¿”å› `datetime` å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚

**ä¿®æ”¹å‰ï¼š**
```python
def to_dict(self):
    """å°†æ¶ˆæ¯å¯¹è±¡è½¬æ¢ä¸ºå­—å…¸"""
    data = {
        ...
        "created_at": self.created_at.isoformat() if self.created_at else datetime.now().isoformat()
    }
    return data
```

**ä¿®æ”¹åï¼š**
```python
def to_dict(self):
    """å°†æ¶ˆæ¯å¯¹è±¡è½¬æ¢ä¸ºå­—å…¸"""
    data = {
        ...
        "created_at": self.created_at if self.created_at else datetime.now()
    }
    return data
```

---

#### 3. æ¶ˆæ¯è·å–APIä¿®å¤ï¼ˆè·å–æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼‰

**é—®é¢˜æè¿°ï¼š**
- `api_routes.py` ä¸­å®šä¹‰äº†é‡å¤çš„ `MessageResponse` ç±»ï¼Œä¸ `models.py` ä¸­çš„å®šä¹‰ä¸ä¸€è‡´ï¼Œå¯¼è‡´ç±»å‹éªŒè¯å¤±è´¥ã€‚

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼šç¬¬14-16è¡Œï¼ˆå¯¼å…¥è¯­å¥ï¼‰ï¼Œç¬¬1934-1942è¡Œï¼ˆåˆ é™¤é‡å¤å®šä¹‰ï¼‰

**ä¿®å¤æ–¹æ³•ï¼š**
1. ä» `models.py` å¯¼å…¥ `MessageResponse`
2. åˆ é™¤ `api_routes.py` ä¸­é‡å¤çš„ `MessageResponse` ç±»å®šä¹‰

**ä¿®æ”¹å‰ï¼š**
```python
from models import (
    KnowledgeBase, PersonaCard, Message, MessageCreate, StarRecord,
    KnowledgeBaseUpdate
)

# ... åœ¨æ–‡ä»¶ä¸­æŸå¤„å®šä¹‰äº†é‡å¤çš„ MessageResponse
class MessageResponse(BaseModel):
    id: str
    sender_id: str
    recipient_id: str
    title: str
    content: str
    message_type: str
    broadcast_scope: Optional[str]
    is_read: bool
    created_at: str
```

**ä¿®æ”¹åï¼š**
```python
from models import (
    KnowledgeBase, PersonaCard, Message, MessageCreate, StarRecord,
    KnowledgeBaseUpdate, MessageResponse
)

# åˆ é™¤äº†é‡å¤çš„ MessageResponse å®šä¹‰
```

---

#### 4. æ¶ˆæ¯APIè¿›ä¸€æ­¥ä¿®å¤ï¼ˆæ‰¹é‡åˆ›å»ºå’ŒæŸ¥è¯¢ä¼˜åŒ–ï¼‰

**é—®é¢˜æè¿°ï¼š**
- `bulk_create_messages` æ–¹æ³•åœ¨å¼‚å¸¸æ—¶åªæ‰“å°é”™è¯¯å¹¶è¿”å›ç©ºåˆ—è¡¨ï¼Œå¯¼è‡´é”™è¯¯ä¿¡æ¯ä¸¢å¤±
- SQLæŸ¥è¯¢ä¸­ä½¿ç”¨ `&` å’Œ `|` è¿ç®—ç¬¦æ—¶ï¼Œè¿ç®—ç¬¦ä¼˜å…ˆçº§å¯èƒ½å¯¼è‡´æŸ¥è¯¢é€»è¾‘é”™è¯¯

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`database_models.py`
- æ–¹æ³•ï¼š
  - `bulk_create_messages`: ç¬¬681-697è¡Œ
  - `get_conversation_messages`: ç¬¬699-707è¡Œ
  - `get_user_messages`: ç¬¬709-714è¡Œ
- æ–‡ä»¶ï¼š`api_routes.py`
- æ–¹æ³•ï¼š`send_message`: ç¬¬1886-1888è¡Œ

**ä¿®å¤æ–¹æ³•ï¼š**

1. **æ”¹è¿›å¼‚å¸¸å¤„ç†ï¼š** `bulk_create_messages` ç°åœ¨ä¼šæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯é™é»˜å¤±è´¥
2. **ä¿®å¤SQLæŸ¥è¯¢ï¼š** ä½¿ç”¨ `and_()` å’Œ `or_()` å‡½æ•°æ›¿ä»£ `&` å’Œ `|` è¿ç®—ç¬¦ï¼Œç¡®ä¿æŸ¥è¯¢é€»è¾‘æ­£ç¡®
3. **æ”¹è¿›é”™è¯¯ä¼ æ’­ï¼š** APIè·¯ç”±ä¸­æ•è·å¹¶è½¬æ¢å¼‚å¸¸ä¸º `DatabaseError`

**ä¿®æ”¹å‰ï¼š**
```python
def bulk_create_messages(self, messages: List[dict]) -> List[Message]:
    try:
        # ... åˆ›å»ºæ¶ˆæ¯
        return message_models
    except Exception as e:
        print(f"æ‰¹é‡åˆ›å»ºæ¶ˆæ¯å¤±è´¥: {str(e)}")
        return []  # é™é»˜å¤±è´¥

def get_conversation_messages(self, user_id: str, other_user_id: str, ...):
    return session.query(Message).filter(
        (Message.sender_id == user_id) & (Message.recipient_id == other_user_id) |
        (Message.sender_id == other_user_id) & (Message.recipient_id == user_id)
    ).all()  # è¿ç®—ç¬¦ä¼˜å…ˆçº§å¯èƒ½å¯¼è‡´é€»è¾‘é”™è¯¯
```

**ä¿®æ”¹åï¼š**
```python
def bulk_create_messages(self, messages: List[dict]) -> List[Message]:
    session = None
    try:
        with self.get_session() as session:
            # ... åˆ›å»ºæ¶ˆæ¯
            return message_models
    except Exception as e:
        if session:
            try:
                session.rollback()
            except:
                pass
        raise Exception(f"æ‰¹é‡åˆ›å»ºæ¶ˆæ¯å¤±è´¥: {str(e)}")  # æŠ›å‡ºå¼‚å¸¸

def get_conversation_messages(self, user_id: str, other_user_id: str, ...):
    return session.query(Message).filter(
        or_(
            and_(Message.sender_id == user_id, Message.recipient_id == other_user_id),
            and_(Message.sender_id == other_user_id, Message.recipient_id == user_id)
        )
    ).all()  # ä½¿ç”¨æ˜ç¡®çš„é€»è¾‘å‡½æ•°
```

---

#### 5. æ•°æ®åº“è¿ç§»ä¿®å¤ï¼ˆmessagesè¡¨ç¼ºå°‘message_typeåˆ—ï¼‰

**é—®é¢˜æè¿°ï¼š**
- æ•°æ®åº“è¡¨ `messages` ç¼ºå°‘ `message_type` å’Œ `broadcast_scope` åˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯åˆ›å»ºå’ŒæŸ¥è¯¢å¤±è´¥
- é”™è¯¯ä¿¡æ¯ï¼š`table messages has no column named message_type`

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`database_models.py`
- ç±»ï¼š`SQLiteDatabaseManager`
- æ–¹æ³•ï¼š`__init__` å’Œæ–°å¢çš„ `_migrate_database`
- è¡Œå·ï¼šç¬¬437-463è¡Œ

**ä¿®å¤æ–¹æ³•ï¼š**
æ·»åŠ è‡ªåŠ¨æ•°æ®åº“è¿ç§»æ–¹æ³•ï¼Œåœ¨æ•°æ®åº“ç®¡ç†å™¨åˆå§‹åŒ–æ—¶æ£€æŸ¥å¹¶æ·»åŠ ç¼ºå¤±çš„åˆ—ã€‚

**ä¿®æ”¹å‰ï¼š**
```python
def __init__(self, db_path: str = "./data/maimnp.db"):
    # ...
    # åˆ›å»ºæ‰€æœ‰è¡¨
    Base.metadata.create_all(bind=self.engine)
    # æ²¡æœ‰è¿ç§»é€»è¾‘ï¼Œå¦‚æœè¡¨å·²å­˜åœ¨ä½†ç¼ºå°‘åˆ—ï¼Œä¼šå¯¼è‡´é”™è¯¯
```

**ä¿®æ”¹åï¼š**
```python
def __init__(self, db_path: str = "./data/maimnp.db"):
    # ...
    # åˆ›å»ºæ‰€æœ‰è¡¨
    Base.metadata.create_all(bind=self.engine)
    
    # æ‰§è¡Œæ•°æ®åº“è¿ç§»
    self._migrate_database()

def _migrate_database(self):
    """æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼Œæ·»åŠ ç¼ºå¤±çš„åˆ—"""
    try:
        inspector = inspect(self.engine)
        if 'messages' in inspector.get_table_names():
            existing_columns = [col['name'] for col in inspector.get_columns('messages')]
            
            if 'message_type' not in existing_columns:
                with self.engine.begin() as conn:
                    conn.execute(text("ALTER TABLE messages ADD COLUMN message_type VARCHAR DEFAULT 'direct'"))
                print("å·²æ·»åŠ  message_type åˆ—åˆ° messages è¡¨")
            
            if 'broadcast_scope' not in existing_columns:
                with self.engine.begin() as conn:
                    conn.execute(text("ALTER TABLE messages ADD COLUMN broadcast_scope VARCHAR"))
                print("å·²æ·»åŠ  broadcast_scope åˆ—åˆ° messages è¡¨")
    except Exception as e:
        print(f"æ•°æ®åº“è¿ç§»å¤±è´¥: {str(e)}")
```

**æ³¨æ„äº‹é¡¹ï¼š**
- è¿ç§»ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
- å¦‚æœè¡¨å·²å­˜åœ¨ä½†ç¼ºå°‘åˆ—ï¼Œè¿ç§»ä¼šè‡ªåŠ¨æ·»åŠ 
- è¿ç§»å¤±è´¥ä¸ä¼šé˜»æ­¢åº”ç”¨å¯åŠ¨ï¼Œä½†ä¼šæ‰“å°é”™è¯¯ä¿¡æ¯

---

### å½±å“èŒƒå›´

- **APIç«¯ç‚¹ï¼š**
  - `POST /review/knowledge/{kb_id}/approve` - å®¡æ ¸é€šè¿‡çŸ¥è¯†åº“
  - `POST /review/knowledge/{kb_id}/reject` - å®¡æ ¸æ‹’ç»çŸ¥è¯†åº“ï¼ˆ**å‚æ•°ä¼ é€’æ–¹å¼å˜æ›´ï¼šä»æŸ¥è¯¢å‚æ•°æ”¹ä¸ºè¯·æ±‚ä½“**ï¼‰
  - `POST /review/persona/{pc_id}/approve` - å®¡æ ¸é€šè¿‡äººè®¾å¡
  - `POST /review/persona/{pc_id}/reject` - å®¡æ ¸æ‹’ç»äººè®¾å¡ï¼ˆ**å‚æ•°ä¼ é€’æ–¹å¼å˜æ›´ï¼šä»æŸ¥è¯¢å‚æ•°æ”¹ä¸ºè¯·æ±‚ä½“**ï¼‰
  - `POST /api/messages/send` - å‘é€æ¶ˆæ¯ï¼ˆç§ä¿¡å’Œå…¬å‘Šï¼‰
  - `GET /api/messages` - è·å–æ¶ˆæ¯åˆ—è¡¨
  - `GET /api/messages?other_user_id={id}` - è·å–ä¸ç‰¹å®šç”¨æˆ·çš„å¯¹è¯

- **æ•°æ®æ¨¡å‹ï¼š**
  - `Message.to_dict()` æ–¹æ³•çš„è¿”å›å€¼æ ¼å¼

- **APIè°ƒç”¨æ–¹å¼å˜æ›´ï¼š**
  - `POST /api/review/knowledge/{kb_id}/reject` å’Œ `POST /api/review/persona/{pc_id}/reject` æ¥å£çš„è°ƒç”¨æ–¹å¼éœ€è¦æ›´æ–°
  - å®¢æˆ·ç«¯éœ€è¦å°† `reason` å‚æ•°ä»æŸ¥è¯¢å­—ç¬¦ä¸²æ”¹ä¸ºJSONè¯·æ±‚ä½“

---

### å˜æ›´æ€»è§ˆ

**ä»£ç é€»è¾‘å±‚é¢çš„ä¿®å¤ï¼š**
1. æ•°æ®ç±»å‹è½¬æ¢ï¼ˆå¯¹è±¡è½¬å­—å…¸ï¼‰
2. è¿”å›æ ¼å¼è°ƒæ•´ï¼ˆå­—ç¬¦ä¸²è½¬datetimeå¯¹è±¡ï¼‰
3. ä»£ç é‡æ„ï¼ˆåˆ é™¤é‡å¤å®šä¹‰ï¼Œç»Ÿä¸€ç”¨models.pyä¸­çš„å®šä¹‰ï¼‰
4. å¼‚å¸¸å¤„ç†æ”¹è¿›ï¼ˆæŠ›å‡ºå¼‚å¸¸è€Œä¸æ˜¯é™é»˜å¤±è´¥ï¼‰
5. SQLæŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨æ˜ç¡®çš„é€»è¾‘å‡½æ•°ç¡®ä¿æŸ¥è¯¢æ­£ç¡®ï¼‰

**APIæ¥å£ä¼˜åŒ–ï¼š**
6. å®¡æ ¸æ‹’ç»æ¥å£å‚æ•°ä¼ é€’æ–¹å¼ä¼˜åŒ–ï¼ˆä»æŸ¥è¯¢å‚æ•°æ”¹ä¸ºè¯·æ±‚ä½“ï¼Œæ›´ç¬¦åˆRESTfulè§„èŒƒï¼‰

**æ•°æ®åº“ç»“æ„ä¿®å¤ï¼š**
7. è‡ªåŠ¨æ•°æ®åº“è¿ç§»ï¼ˆæ·»åŠ ç¼ºå¤±çš„ `message_type` å’Œ `broadcast_scope` åˆ—ï¼‰

**æ•°æ®åº“è¿ç§»è¯´æ˜ï¼š**
- è¿ç§»ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
- å¦‚æœ `messages` è¡¨å·²å­˜åœ¨ä½†ç¼ºå°‘åˆ—ï¼Œè¿ç§»ä¼šè‡ªåŠ¨æ·»åŠ 
- ä¸éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒSQLè„šæœ¬ï¼Œé‡å¯åº”ç”¨å³å¯

---

### ç›¸å…³æ–‡ä»¶

- `MaiMaiNotePad-BackEnd/api_routes.py` - APIè·¯ç”±å®ç°
- `MaiMaiNotePad-BackEnd/database_models.py` - æ•°æ®åº“æ¨¡å‹å®šä¹‰
- `MaiMaiNotePad-BackEnd/models.py` - Pydanticæ¨¡å‹å®šä¹‰

---

## 2025-11-23 - æ–°å¢åŠŸèƒ½å’Œæ¥å£ä¼˜åŒ–

### æ–°å¢åŠŸèƒ½

#### 1. StarçŠ¶æ€æ£€æŸ¥æ¥å£

**æ–°å¢æ¥å£**ï¼š
- `GET /api/knowledge/{kb_id}/starred` - æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦å·²è¢«å½“å‰ç”¨æˆ·Star
- `GET /api/persona/{pc_id}/starred` - æ£€æŸ¥äººè®¾å¡æ˜¯å¦å·²è¢«å½“å‰ç”¨æˆ·Star

**åŠŸèƒ½è¯´æ˜**ï¼š
- è¿”å›æ ¼å¼ï¼š`{"starred": true/false}`
- éœ€è¦ç”¨æˆ·è®¤è¯
- ç”¨äºå‰ç«¯å¿«é€Ÿæ£€æŸ¥StarçŠ¶æ€ï¼Œé¿å…è·å–æ‰€æœ‰Starè®°å½•

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š
  - `check_knowledge_starred`: ç¬¬861-874è¡Œ
  - `check_persona_starred`: ç¬¬1508-1521è¡Œ

#### 2. åˆ†é¡µæ”¯æŒ

**æ–°å¢åˆ†é¡µæ¥å£**ï¼š
- `GET /api/knowledge/public` - æ”¯æŒåˆ†é¡µã€æœç´¢ã€ç­›é€‰å’Œæ’åº
- `GET /api/persona/public` - æ”¯æŒåˆ†é¡µã€æœç´¢ã€ç­›é€‰å’Œæ’åº

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆ1-100ï¼‰
- `name`: æŒ‰åç§°æœç´¢ï¼ˆå¯é€‰ï¼‰
- `uploader_id`: æŒ‰ä¸Šä¼ è€…IDç­›é€‰ï¼ˆå¯é€‰ï¼‰
- `sort_by`: æ’åºå­—æ®µï¼ˆcreated_at, updated_at, star_countï¼‰
- `sort_order`: æ’åºé¡ºåºï¼ˆasc, descï¼‰

**å“åº”æ ¼å¼**ï¼š
```json
{
  "items": [...],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

#### 3. ç”¨æˆ·Starè®°å½•æ¥å£å¢å¼º

**æ¥å£**ï¼š`GET /api/user/stars`

**æ–°å¢å‚æ•°**ï¼š
- `includeDetails`: æ˜¯å¦åŒ…å«å®Œæ•´è¯¦æƒ…ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼š
- å½“ `includeDetails=true` æ—¶ï¼Œè¿”å›Starè®°å½•çš„åŒæ—¶åŒ…å«çŸ¥è¯†åº“/äººè®¾å¡çš„å®Œæ•´ä¿¡æ¯
- å‡å°‘å‰ç«¯APIè°ƒç”¨æ¬¡æ•°ï¼Œä» 1+N æ¬¡è¯·æ±‚ä¼˜åŒ–åˆ° 1 æ¬¡è¯·æ±‚

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼š`get_user_stars`: ç¬¬2026-2075è¡Œ

### å½±å“èŒƒå›´

**æ–°å¢æ¥å£**ï¼ˆå®¢æˆ·ç«¯å¯é€‰é›†æˆï¼‰ï¼š
- `GET /api/knowledge/{kb_id}/starred` - StarçŠ¶æ€æ£€æŸ¥
- `GET /api/persona/{pc_id}/starred` - StarçŠ¶æ€æ£€æŸ¥
- `GET /api/knowledge/public` - æ”¯æŒåˆ†é¡µå‚æ•°
- `GET /api/persona/public` - æ”¯æŒåˆ†é¡µå‚æ•°
- `GET /api/user/stars` - æ”¯æŒ `includeDetails` å‚æ•°

### ç›¸å…³æ–‡ä»¶

- `MaiMaiNotePad-BackEnd/api_routes.py` - APIè·¯ç”±å®ç°

## 2025-11-25 - å†…å®¹å­—æ®µå…¥åº“ä¸åˆ—è¡¨èƒ½åŠ›å¢å¼º

### åŠŸèƒ½ / æ¥å£
- çŸ¥è¯†åº“ä¸äººè®¾å¡ä¸Šä¼ æ–°å¢æ­£æ–‡ `content`ã€æ ‡ç­¾ `tags`ï¼Œå“åº”å¸¦ä½œè€…ä¿¡æ¯ã€æ–‡ä»¶åˆ—è¡¨ä¸å¤§å°èšåˆï¼Œåˆ é™¤æœ€åä¸€ä¸ªæ–‡ä»¶æ—¶è‡ªåŠ¨åˆ é™¤æ•´æ¡çŸ¥è¯†åº“ï¼ˆè¿”å› `knowledge_deleted` æ ‡è¯†ï¼‰
- ç”¨æˆ·ä¸Šä¼ è®°å½•ï¼ˆçŸ¥è¯†åº“ã€äººè®¾å¡ï¼‰æ”¯æŒåˆ†é¡µã€åç§°/æ ‡ç­¾/çŠ¶æ€ç­›é€‰ä¸å¤šå­—æ®µæ’åºï¼Œç®¡ç†å‘˜/å®¡æ ¸å‘˜å¯æŸ¥çœ‹ä»–äººè®°å½•
- ç”¨æˆ·æ”¶è—åˆ—è¡¨åˆ†é¡µåŒ–ï¼Œæ”¯æŒç±»å‹è¿‡æ»¤å’Œåˆ›å»ºæ—¶é—´/æ”¶è—æ•°æ’åºï¼Œè¿”å› `items/total/page/page_size` ç»“æ„
- ç®¡ç†ç«¯å†…å®¹åˆ—è¡¨æ–°å¢ä¸Šä¼ è€…ï¼ˆID/ç”¨æˆ·åæ¨¡ç³Šï¼‰ç­›é€‰ä¸æ’åºå­—æ®µ/æ–¹å‘å‚æ•°ï¼Œæ—¥å¿—è¾“å‡ºè¡¥å……ä¸Šä¸‹æ–‡
- ä¸Šä¼ /ä¸‹è½½ç›¸å…³ CORS æš´éœ² `Content-Disposition` å¤´ï¼Œå‰ç«¯å¯è¯»å–æ–‡ä»¶å

### æ¨¡å‹ / å­˜å‚¨
- `KnowledgeBase`ã€`PersonaCard` æ¨¡å‹æ–°å¢ `content`ã€`tags` å­—æ®µï¼›è¿”å›çš„ä½œè€…å­—æ®µå›è½åˆ°ç‰ˆæƒäºº/ä¸Šä¼ è€…
- SQLite è¿ç§»è¡¥å…… `content`ã€`tags` åˆ—å¹¶åœ¨ä¿å­˜å‰ç»Ÿä¸€å°†æ ‡ç­¾åˆ—è¡¨è½¬é€—å·å­—ç¬¦ä¸²

### æ–‡æ¡£
- API æ–‡æ¡£è¡¥å…… content/tags ä¼ å‚ã€ç”¨æˆ·ä¸Šä¼ /æ”¶è—åˆ†é¡µå‚æ•°ä¸å“åº”ã€åˆ é™¤æ–‡ä»¶è¿”å›å­—æ®µã€ç®¡ç†ç«¯ç­›é€‰ä¸æ’åºå‚æ•°ç¤ºä¾‹
- README/TODO åŒæ­¥ä¸Šè¿°è¡Œä¸ºä¸å®ŒæˆçŠ¶æ€

---

## 2025-12-01 - ç”¨æˆ·ä¸Šä¼ å†å²å’Œç»Ÿè®¡æ¥å£å¢å¼º

### æ–°å¢åŠŸèƒ½

#### 1. ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²æ¥å£

**æ–°å¢æ¥å£**ï¼š
- `GET /api/me/upload-history` - è·å–å½“å‰ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²è®°å½•

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢ç”¨æˆ·ä¸Šä¼ è®°å½•
- è¿”å›çŸ¥è¯†åº“å’Œäººè®¾å¡çš„ä¸Šä¼ è®°å½•
- åŒ…å«çŠ¶æ€æ˜ å°„ï¼ˆapprovedâ†’successï¼Œpendingâ†’processingï¼Œrejectedâ†’failedï¼‰
- æä¾›ç›®æ ‡å­˜åœ¨æ€§æ£€æŸ¥å’Œæ–‡ä»¶å¤§å°ç»Ÿè®¡
- æ”¯æŒå…¼å®¹å‰ç«¯çš„å“åº”æ ¼å¼æ„å»º

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`user_router.py`
- è¡Œå·ï¼šç¬¬1260-1320è¡Œ

#### 2. ç”¨æˆ·ä¸ªäººä¸Šä¼ ç»Ÿè®¡æ¥å£

**æ–°å¢æ¥å£**ï¼š
- `GET /api/me/upload-stats` - è·å–å½“å‰ç”¨æˆ·ä¸ªäººä¸Šä¼ ç»Ÿè®¡

**åŠŸèƒ½è¯´æ˜**ï¼š
- è·å–ç”¨æˆ·ä¸Šä¼ æ€»æ•°ã€æˆåŠŸæ•°ã€å¤„ç†ä¸­æ•°ã€å¤±è´¥æ•°
- è¿”å›åç«¯æ•°æ®åº“å­—æ®µåå’Œå‰ç«¯æœŸæœ›å­—æ®µåä¸¤ç§æ ¼å¼çš„ç»Ÿè®¡ç»“æœ
- æä¾›æˆåŠŸç‡å’Œæ–‡ä»¶å¤§å°ç»Ÿè®¡
- å…¼å®¹å‰ç«¯UIå±•ç¤ºéœ€æ±‚

**å®ç°ä½ç½®**ï¼š
- æ–‡ä»¶ï¼š`user_router.py`
- è¡Œå·ï¼šç¬¬1321-1380è¡Œ

### å½±å“èŒƒå›´

**æ–°å¢æ¥å£**ï¼ˆå®¢æˆ·ç«¯å¯é€‰é›†æˆï¼‰ï¼š
- `GET /api/me/upload-history` - ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²è®°å½•
- `GET /api/me/upload-stats` - ç”¨æˆ·ä¸ªäººä¸Šä¼ ç»Ÿè®¡

**åŠŸèƒ½å½±å“**ï¼š
- ç”¨æˆ·ç°åœ¨å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä¸Šä¼ å†å²å’Œç»Ÿè®¡æ•°æ®
- ä¸ç°æœ‰çš„ç®¡ç†å‘˜ä¸Šä¼ å†å²å’Œç»Ÿè®¡æ¥å£å½¢æˆäº’è¡¥
- æä¾›ä¸ªäººç»´åº¦çš„ä¸Šä¼ ç®¡ç†èƒ½åŠ›

### ç›¸å…³æ–‡ä»¶

- `user_router.py` - ç”¨æˆ·è·¯ç”±å®ç°
- `database_models.py` - æ•°æ®åº“æ¨¡å‹ï¼ˆUploadRecordè¡¨ï¼‰

---

## 2025-11-23 - ä»£ç è´¨é‡æ”¹è¿›

### ä»£ç è´¨é‡ä¿®å¤

#### 1. é‡å¤å®šä¹‰é—®é¢˜ä¿®å¤ âœ…

**é—®é¢˜æè¿°ï¼š**
- `api_routes.py` å’Œ `models.py` ä¸­é‡å¤å®šä¹‰äº†ç›¸åŒçš„å“åº”æ¨¡å‹ç±»
- å¯¼è‡´ç»´æŠ¤å›°éš¾ï¼Œå¯èƒ½å‡ºç°ä¸ä¸€è‡´é—®é¢˜

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`api_routes.py`
- è¡Œå·ï¼šç¬¬15-19è¡Œï¼ˆå¯¼å…¥è¯­å¥ï¼‰

**ä¿®å¤æ–¹æ³•ï¼š**
ç»Ÿä¸€ä» `models.py` å¯¼å…¥å“åº”æ¨¡å‹ï¼Œåˆ é™¤ `api_routes.py` ä¸­çš„é‡å¤å®šä¹‰ã€‚

**ä¿®æ”¹åï¼š**
```python
# api_routes.py ç¬¬15-19è¡Œ
from models import (
    KnowledgeBase, PersonaCard, Message, MessageCreate, MessageUpdate, StarRecord,
    KnowledgeBaseUpdate, MessageResponse, KnowledgeBaseResponse, PersonaCardResponse,
    StarResponse, KnowledgeBasePaginatedResponse, PersonaCardPaginatedResponse
)
```

**å½±å“ï¼š**
- ä»£ç ç¬¦åˆDRYåŸåˆ™
- å‡å°‘ç»´æŠ¤æˆæœ¬
- é¿å…å®šä¹‰ä¸ä¸€è‡´é—®é¢˜

#### 2. æ•°æ®åº“ç®¡ç†å™¨å®ä¾‹åŒ–ä¿®å¤ âœ…

**é—®é¢˜æè¿°ï¼š**
- æ•°æ®åº“ç®¡ç†å™¨å®ä¾‹åŒ–é—®é¢˜å¯èƒ½å¯¼è‡´å¾ªç¯å¯¼å…¥
- å…¶ä»–æ¨¡å—æ— æ³•æ­£å¸¸å¯¼å…¥å’Œä½¿ç”¨æ•°æ®åº“ç®¡ç†å™¨

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`database_models.py`
- è¡Œå·ï¼šç¬¬1809è¡Œ

**ä¿®å¤æ–¹æ³•ï¼š**
åˆ›å»ºå…¨å±€å®ä¾‹ `sqlite_db_manager`ï¼Œç¡®ä¿å…¶ä»–æ¨¡å—å¯ä»¥æ­£å¸¸å¯¼å…¥å’Œä½¿ç”¨ã€‚

**å½±å“ï¼š**
- è§£å†³å¾ªç¯å¯¼å…¥é—®é¢˜
- ç»Ÿä¸€æ•°æ®åº“ç®¡ç†å™¨å®ä¾‹
- æå‡ä»£ç å¯ç»´æŠ¤æ€§

### ç›¸å…³æ–‡ä»¶

- `MaiMaiNotePad-BackEnd/api_routes.py` - APIè·¯ç”±å®ç°
- `MaiMaiNotePad-BackEnd/database_models.py` - æ•°æ®åº“æ¨¡å‹å®šä¹‰
- `MaiMaiNotePad-BackEnd/models.py` - Pydanticæ¨¡å‹å®šä¹‰
