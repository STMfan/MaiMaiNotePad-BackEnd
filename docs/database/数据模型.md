# 数据库模型说明

基于 `app/models/database.py`，描述所有 SQLAlchemy 模型、字段、索引及关联关系，方便各位了解数据结构。本文档会随着数据库模型的更新而持续维护。

> 说明：所有模型均继承同一个 `Base`，默认主键使用 `UUID` 字符串。时间字段采用 `datetime.now` 作为默认值，除非特别注明。
> 术语：PK = 主键；FK = 外键

---

## 目录

1. 用户与权限：`User`  
2. 知识库体系：`KnowledgeBase`、`KnowledgeBaseFile`  
3. 人设卡体系：`PersonaCard`、`PersonaCardFile`  
4. 互动/运营：`Message`、`StarRecord`  
5. 验证服务：`EmailVerification`  
6. 上传记录：`UploadRecord`  
7. 下载记录：`DownloadRecord`  
8. 评论体系：`Comment`、`CommentReaction`

---

## 1. `User`（表：`users`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK，UUID | 用户唯一标识 |
| `username` | `String` | `unique`, `nullable=False` | 登录名/展示名 |
| `email` | `String` | `unique`, `nullable=False` | 邮箱 |
| `hashed_password` | `String` | `nullable=False` | Bcrypt 加密后的密码 |
| `is_active` | `Boolean` | `default=True` | 是否启用 |
| `is_admin` | `Boolean` | `default=False` | 管理员标志 |
| `is_moderator` | `Boolean` | `default=False` | 版主标志 |
| `is_super_admin` | `Boolean` | `default=False` | 超级管理员标志 |
| `created_at` | `DateTime` | `default=datetime.now` | 注册时间 |
| `failed_login_attempts` | `Integer` | `default=0` | 失败登录尝试次数（账户锁定相关） |
| `locked_until` | `DateTime` | `nullable=True` | 账户锁定到期时间 |
| `last_failed_login` | `DateTime` | `nullable=True` | 最后一次失败登录时间 |
| `is_muted` | `Boolean` | `default=False` | 是否被禁言 |
| `muted_until` | `DateTime` | `nullable=True` | 禁言到期时间，`NULL` 表示永久禁言 |
| `ban_reason` | `String` | `nullable=True` | 账户封禁原因（由管理员填写） |
| `mute_reason` | `String` | `nullable=True` | 禁言原因（由管理员填写） |
| `avatar_path` | `String` | `nullable=True` | 头像文件路径（相对路径或URL） |
| `avatar_updated_at` | `DateTime` | `nullable=True` | 头像最后更新时间 |
| `password_version` | `Integer` | `default=0` | 密码版本号（用于Token失效机制，每次修改密码时递增） |

- **索引**：用户名、邮箱、激活状态、管理员、版主、超级管理员均建单列索引。  
- **关系**：与 `KnowledgeBase`、`PersonaCard`、`Message`、`StarRecord` 均保持 SQLAlchemy `relationship`（逻辑关系，无物理外键）。  
- **业务逻辑**：提供密码验证、密码更新、权限管理等功能。密码修改时会自动递增 `password_version`，使所有现有Token失效。

---

## 2. 知识库体系

### 2.1 `KnowledgeBase`（表：`knowledge_bases`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 知识库 ID |
| `name` | `String` | `nullable=False` | 名称 |
| `description` | `Text` | `nullable=False` | 描述/概要 |
| `uploader_id` | `String` | FK -> `users.id` | 上传者 |
| `copyright_owner` | `String` | 可空 | 版权声明 |
| `content` | `Text` | 可空 | 正文内容 |
| `tags` | `Text` | 可空 | 标签，逗号分隔存储 |
| `star_count` | `Integer` | `default=0` | 收藏数 |
| `downloads` | `Integer` | `default=0` | 下载次数 |
| `base_path` | `Text` | `default="[]"` | 文件列表 JSON（字符串存储） |
| `is_public` | `Boolean` | `default=False` | 是否公开 |
| `is_pending` | `Boolean` | `default=True` | 审核状态 |
| `rejection_reason` | `Text` | 可空 | 拒绝原因 |
| `version` | `String` | `default="1.0"` | 版本号 |
| `created_at` | `DateTime` | 默认当前时间 | 创建时间 |
| `updated_at` | `DateTime` | 自动更新时间 | 最后修改 |

- **索引**：上传者、公开状态、审核状态、星数、创建/更新时间。  
- **关系**：`uploader` 指回 `User`（逻辑关系，无物理外键）。  
- **方法**：`to_dict()` 用于序列化为字典格式。

### 2.2 `KnowledgeBaseFile`（`knowledge_base_files`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 文件记录 ID |
| `knowledge_base_id` | `String` | 非空 | 所属知识库 |
| `file_name` | `String` | 非空 | 存储文件名 |
| `original_name` | `String` | 非空 | 原始文件名 |
| `file_path` | `String` | 非空 | 物理路径 |
| `file_type` | `String` | 非空 | MIME/扩展类型 |
| `file_size` | `Integer` | `default=0` | 大小（字节） |
| `created_at` | `DateTime` | 默认 | 上传时间 |
| `updated_at` | `DateTime` | 自动更新 | 最近操作 |

- **索引**：`knowledge_base_id`、`file_type`、`file_size`、`created_at`、`updated_at`。  
- **关系**：无（逻辑上属于 `KnowledgeBase`，但无物理外键）

---

## 3. 人设卡体系

### 3.1 `PersonaCard`（`persona_cards`）

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (`String`, PK) | 人设卡 ID |
| `name` (`String`, 非空) | 标题 |
| `description` (`Text`, 非空) | 描述 |
| `uploader_id` (`String`, FK -> `users.id`) | 上传者 |
| `copyright_owner` (`String`, 可空) | 版权声明 |
| `star_count` (`Integer`, 默认 0) | 收藏数 |
| `downloads` (`Integer`, 默认 0) | 下载次数 |
| `content` (`Text`, 可空) | 正文内容 |
| `tags` (`Text`, 可空) | 标签，逗号分隔 |
| `base_path` (`String`, 非空) | 资源路径 |
| `is_public` (`Boolean`, 默认 False) | 是否公开 |
| `is_pending` (`Boolean`, 默认 True) | 审核状态 |
| `rejection_reason` (`Text`, 可空) | 拒绝原因 |
| `version` (`String`, 默认 "1.0") | 版本号 |
| `created_at` / `updated_at` (`DateTime`) | 创建/更新时间 |

- **索引**：上传者、公开/审核状态、星数、创建/更新时间。  
- **关系**：`uploader` 指向 `User`（逻辑关系，无物理外键）。  
- **方法**：`to_dict()` 用于序列化为字典格式。

### 3.2 `PersonaCardFile`（`persona_card_files`）

字段与 `KnowledgeBaseFile` 类似，只是 `persona_card_id` 指向人设卡 ID。  
- **索引**：`persona_card_id`、`file_type`、`file_size`、时间戳。  
- **关系**：无 FK。

---

## 4. 互动 / 运营

### 4.1 `Message`（`messages`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 消息 ID |
| `recipient_id` | `String` | FK -> `users.id` | 收件人 |
| `sender_id` | `String` | FK -> `users.id` | 发件人 |
| `title` | `String` | 非空 | 标题 |
| `content` | `Text` | 非空 | 内容 |
| `summary` | `Text` | 可空 | 消息简介/摘要（可选） |
| `message_type` | `String` | 默认 `direct` | direct / announcement |
| `broadcast_scope` | `String` | 可空 | 广播范围（如 `all_users`） |
| `is_read` | `Boolean` | 默认 False | 已读标记 |
| `created_at` | `DateTime` | 默认 | 发送时间 |

- **索引**：收件人、发件人、已读状态、创建时间、复合索引 `recipient_id + is_read`。  
- **关系**：`recipient`、`sender` 与 `User` 双向绑定。

### 4.2 `StarRecord`（`star_records`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | Star 记录 |
| `user_id` | `String` | FK -> `users.id` | 创建者 |
| `target_id` | `String` | 无 FK | 目标内容 ID |
| `target_type` | `String` | 非空 | `knowledge` / `persona` |
| `created_at` | `DateTime` | 默认 | 收藏时间 |

- **索引**：用户、目标 ID、目标类型、创建时间，以及复合索引 `(user_id, target_id, target_type)` 用于快速判断是否已收藏。  
- **关系**：仅与 `User` 建立关系；目标对象需手动查询。

---

## 5. 验证服务：`EmailVerification`（`email_verifications`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK |
| `email` | `String` | 非空 | 邮箱地址 |
| `code` | `String` | 非空 | 验证码 |
| `is_used` | `Boolean` | 默认 False | 是否已用 |
| `created_at` | `DateTime` | 默认 | 生成时间 |
| `expires_at` | `DateTime` | 非空 | 失效时间 |

- **索引**：邮箱、验证码、过期时间。  
- **业务**：用于限制验证码发送频率、验证注册/找回密码流程。验证码使用后自动标记为已用。

---

## 6. 上传记录：`UploadRecord`（`upload_records`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 上传记录 ID |
| `uploader_id` | `String` | FK -> `users.id` | 上传者用户 ID |
| `target_id` | `String` | 非空 | 目标内容 ID（知识库或人设卡的ID） |
| `target_type` | `String` | 非空 | 目标类型：`knowledge` 或 `persona` |
| `name` | `String` | 非空 | 知识库或人设卡名称 |
| `description` | `Text` | 可空 | 描述信息 |
| `status` | `String` | `default="pending"` | 状态：`pending`（待审核）、`approved`（已通过）、`rejected`（已驳回） |
| `created_at` | `DateTime` | 默认当前时间 | 创建时间 |
| `updated_at` | `DateTime` | 自动更新时间 | 最后修改时间 |

- **索引**：上传者ID、目标ID、目标类型、状态、创建时间。  
- **业务**：用于记录所有上传操作，防止恶意删除。管理员可以通过此表追踪所有上传历史，并支持恢复已删除的内容。

---

## 7. 下载记录：`DownloadRecord`（`download_records`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 下载记录 ID |
| `target_id` | `String` | 非空 | 目标内容 ID（知识库或人设卡的ID） |
| `target_type` | `String` | 非空 | 目标类型：`knowledge` 或 `persona` |
| `created_at` | `DateTime` | 默认当前时间 | 下载时间 |

- **索引**：目标ID、目标类型、创建时间。  
- **业务**：用于记录下载操作，支持统计下载次数。

---

## 8. 评论体系

### 8.1 `Comment`（`comments`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 评论 ID |
| `user_id` | `String` | 非空 | 评论者用户 ID |
| `target_id` | `String` | 非空 | 目标内容 ID（知识库或人设卡的ID） |
| `target_type` | `String` | 非空 | 目标类型：`knowledge` 或 `persona` |
| `parent_id` | `String` | 可空 | 父评论 ID（用于回复） |
| `content` | `Text` | 非空 | 评论内容 |
| `is_deleted` | `Boolean` | `default=False` | 是否已删除 |
| `like_count` | `Integer` | `default=0` | 点赞数 |
| `dislike_count` | `Integer` | `default=0` | 点踩数 |
| `created_at` | `DateTime` | 默认当前时间 | 创建时间 |
| `updated_at` | `DateTime` | 自动更新时间 | 最后修改时间 |

- **索引**：目标ID+类型、用户ID、父评论ID、创建时间。  
- **业务**：支持评论和回复，支持点赞/点踩，支持软删除。无物理外键，数据一致性由应用层维护。

### 8.2 `CommentReaction`（`comment_reactions`）

| 字段 | 类型 | 约束/默认值 | 说明 |
| --- | --- | --- | --- |
| `id` | `String` | PK | 反应记录 ID |
| `user_id` | `String` | 非空 | 用户 ID |
| `comment_id` | `String` | 非空 | 评论 ID |
| `reaction_type` | `String` | 非空 | 反应类型：`like` 或 `dislike` |
| `created_at` | `DateTime` | 默认当前时间 | 创建时间 |

- **索引**：用户ID+评论ID、评论ID。  
- **业务**：记录用户对评论的点赞/点踩操作，防止重复操作。无物理外键，数据一致性由应用层维护。

---

## 附：维护建议

1. **字段更新**：修改模型后务必运行 Alembic 自动迁移，以保持数据库结构一致。  
2. **无物理外键设计**：项目采用无物理外键设计，所有关系均通过应用层维护，优点是灵活性高、迁移简单，缺点是需要应用层确保数据一致性。  
3. **索引命名**：所有索引已手动命名，跨数据库迁移时避免冲突。  
4. **时间字段**：默认使用本地时间，如需时区支持请改为 `DateTime(timezone=True)` 并统一使用 UTC。  
5. **JSON 字段**：`base_path` 等 JSON 字符串字段适合小规模数据，若未来增长，可考虑拆分到独立表。  
6. **关系维护**：所有关系均通过 SQLAlchemy 的 `relationship` 声明，支持双向导航，但无数据库级别的约束。

---

## 📚 相关文档

- [Alembic 迁移指南](./Alembic_migration_guide.md) - 数据库迁移和版本管理
- [API文档](../API.md) - 完整的API接口文档
- [CHANGELOG.md](../CHANGELOG.md) - 变更日志

---

## 更新日志

### 2025-02-20 更新
- 更新文档以反映当前实现状态
- 添加 `is_super_admin` 字段说明
- 添加 `version` 字段说明（知识库和人设卡）
- 添加 `DownloadRecord` 模型说明
- 添加 `Comment` 和 `CommentReaction` 模型说明
- 移除过时的 `SQLiteDatabaseManager` 说明
- 更新维护建议

---

**文档信息**

| 项目 | 内容 |
|------|------|
| 文档版本 | 3.0 |
| 创建日期 | 2025-02-20 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | 📝 参考文档 |
