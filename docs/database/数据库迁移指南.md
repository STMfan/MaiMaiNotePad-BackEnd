# Alembic 数据库迁移指南

本项目已完整接入 Alembic，使用 SQLAlchemy 的声明式模型（`app/models/database.py`），支持数据库版本管理和多数据库切换。

## 目录

1. 当前数据库结构概览  
2. Alembic 配置与使用  
3. 日常开发流程  
4. 多数据库支持（SQLite / MySQL / PostgreSQL）  
5. 常见问题排查

---

## 1. 数据库结构概览

所有模型定义集中在 `app/models/database.py`，已实现的表如下：

**核心表：**
- `users`：用户基础信息，UUID 主键，包含激活状态、管理员/版主标记及多个索引。  
- `knowledge_bases`：知识库元数据，记录描述、上传者、星标数、公开与审核状态。  
- `knowledge_base_files`：知识库文件明细，保存文件名、路径、类型、大小、时间戳。  
- `persona_cards` / `persona_card_files`：人设卡及其附件。  
- `messages`：站内信，包含发送/接收者、消息类型、状态、引用内容等。  
- `email_verifications`：邮箱验证码记录。  
- `star_records`：用户收藏记录。  

**扩展表：**
- `upload_records`：文件上传记录。  
- `download_records`：文件下载记录。  
- `comments`：评论表。  
- `comment_reactions`：评论反应（点赞等）。

所有表共享同一个 Base Metadata，可通过 `Base.metadata.tables.keys()` 快速检查。

---

## 2. Alembic 配置与使用

### 2.1 项目配置现状

Alembic 已完整配置，无需重新初始化：

- **配置文件**：`configs/alembic.ini` - 包含数据库 URL 和日志配置
- **包装脚本**：`scripts/shell/alembic.sh` - 自动使用 `configs/alembic.ini`
- **迁移脚本**：`alembic/env.py` - 已配置环境变量支持，自动从 `.env` 读取 `DATABASE_URL`
- **迁移版本**：`alembic/versions/` - 包含初始化迁移脚本 `5ffaf739f376_init_schema.py`

**重要**：
- 直接使用 `./scripts/shell/alembic.sh` 命令，它会自动指定配置文件路径
- 或者使用 `./manage.sh` 的数据库管理菜单
- 不要直接运行 `alembic` 命令（会找不到配置文件）

### 2.2 环境配置

在 `.env` 文件中配置数据库 URL：

```bash
# SQLite（开发/测试）
DATABASE_URL=sqlite:///data/mainnp.db

# MySQL
DATABASE_URL=mysql+pymysql://user:password@localhost:3306/maimnp

# PostgreSQL
DATABASE_URL=postgresql+psycopg2://user:password@localhost:5432/maimnp
```

### 2.3 常用命令

```bash
# 查看当前迁移状态
./scripts/shell/alembic.sh current

# 查看迁移历史
./scripts/shell/alembic.sh history

# 应用所有待处理迁移
./scripts/shell/alembic.sh upgrade head

# 回滚到上一个版本
./scripts/shell/alembic.sh downgrade -1

# 回滚到指定版本
./scripts/shell/alembic.sh downgrade <revision>
```

**或者使用 manage.sh**：
```bash
./manage.sh  # 选择"数据库管理"菜单
```

---

## 3. 日常开发流程

当需要修改数据库结构时，按以下步骤操作：

1. **修改模型**  
   编辑 `app/models/database.py` 中的 SQLAlchemy 模型。

2. **生成迁移脚本**  
   ```bash
   ./scripts/shell/alembic.sh revision --autogenerate -m "describe your change"
   ```
   Alembic 会自动对比模型和数据库，生成迁移脚本到 `alembic/versions/`。

3. **审核迁移脚本**  
   打开生成的迁移文件，检查：
   - 操作是否正确（特别是 SQLite 的 ALTER TABLE 限制）
   - 索引、外键名是否符合各数据库约束
   - 是否需要手工调整以支持多数据库

4. **应用迁移**  
   ```bash
   ./scripts/shell/alembic.sh upgrade head
   ```
   在开发环境测试通过后，可在启动脚本或 CI/CD 流程中自动执行。

5. **提交代码**  
   同时提交模型变更和迁移脚本，保持两者同步。

> **提示**：若 `autogenerate` 未检测到变更，确认：
> - 模型是否正确导入
> - MetaData 是否共享（应使用 `app.models.database.Base`）
> - 是否存在自定义 `__table_args__` 未被识别的情况

---

## 4. 多数据库支持（SQLite / MySQL / PostgreSQL）

### 4.1 统一配置思路

项目已支持多数据库切换，通过环境变量驱动：

- 在 `.env` 文件中设置 `DATABASE_URL`
- `alembic/env.py` 自动从环境变量读取配置
- 切换数据库时只需修改 `DATABASE_URL` 环境变量

### 4.2 数据库驱动安装

根据目标数据库安装对应驱动：

```bash
# MySQL
pip install pymysql

# PostgreSQL
pip install psycopg2-binary

# SQLite（已内置）
# 无需额外安装
```

### 4.3 各数据库特性与注意事项

**SQLite**
- 适合开发/测试，数据库即文件
- 不支持大多数 `ALTER TABLE` 语句，复杂迁移需要创建新表复制数据
- 事务中的 `DDL` 限制较多，建议使用单连接模式
- 当前项目使用 SQLite 作为默认开发数据库

**MySQL (InnoDB)**
- 需要明确字符集（推荐 `utf8mb4`）
- Alembic 默认索引长度可能超过限制（尤其是 `VARCHAR(255)` + 索引，需要指定 `length` 或使用前缀索引）
- 时间字段默认 `DATETIME`，若需要精度可设置 `DateTime(fsp=6)`
- 建议使用 `mysql+pymysql://` 连接字符串

**PostgreSQL**
- 支持更丰富的类型（JSONB、ARRAY 等）
- Alembic 可自动识别 `server_default=text(...)` 等设置
- 注意保留大小写敏感的表名/列名（SQLAlchemy 默认小写）
- 建议使用 `postgresql+psycopg2://` 连接字符串

### 4.4 数据库切换步骤

1. **准备目标数据库**  
   在目标数据库系统中创建空库。

2. **更新环境变量**  
   修改 `.env` 中的 `DATABASE_URL`。

3. **应用迁移**  
   ```bash
   ./scripts/shell/alembic.sh upgrade head
   ```
   Alembic 会自动在目标数据库中创建所有表结构。

4. **数据迁移**（如需要）  
   - 可使用 `alembic upgrade` 后配合 ETL/导出导入工具
   - 或使用数据库原生工具（如 `mysqldump`、`pg_dump` 等）

---

## 5. 常见问题排查

| 问题 | 解决方案 |
|------|--------|
| `alembic` 命令找不到 | 确认虚拟环境已激活且已安装 Alembic（`pip install alembic`） |
| `ModuleNotFoundError: app.models.database` | 检查 `alembic/env.py` 的 `sys.path` 配置，确保能找到项目根目录 |
| 自动迁移未捕捉关系/索引 | 某些逻辑（例如未声明的外键）不会被识别，需手工添加到迁移脚本 |
| 多数据库切换失败 | 检查 `.env` 中的 `DATABASE_URL` 是否正确，驱动是否已安装 |
| SQLite 迁移失败（ALTER TABLE） | SQLite 不支持大多数 ALTER 操作，需要手工编写迁移脚本（创建新表、复制数据、删除旧表） |
| 大表迁移耗时长 | 优先在测试环境验证脚本，再在生产环境停机或使用在线 DDL（取决于数据库类型） |
| 迁移脚本冲突 | 多人开发时可能产生冲突，需要手工合并或重新生成 |

---

## 相关文件

- 模型定义：`app/models/database.py`
- Alembic 配置：`alembic/env.py`、`configs/alembic.ini`
- 迁移脚本：`alembic/versions/`
- 环境配置：`.env`



---

**文档信息**

| 项目 | 内容 |
|------|------|
| 创建日期 | 2025-02-20 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | 📝 参考文档 |
