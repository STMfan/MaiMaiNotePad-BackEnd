# 后端更新总结文档

## 更新日期
2025-11-25

---

## 更新概览

本次更新主要包含以下方面：
- **字段扩展与入库**：知识库/人设卡上传新增 `content`、`tags` 字段并直接入库，响应带作者、文件列表与大小聚合
- **列表能力增强**：用户上传记录与收藏列表支持分页、筛选、排序；管理端内容列表支持上传者筛选和排序字段/方向
- **删除联动**：删除知识库文件时若为最后一个文件，自动删除整条知识库并清理上传记录
- **兼容性改进**：CORS 暴露 Content-Disposition 头；SQLite 迁移自动补充 content/tags 列并规范标签入库

---

## 主要修复内容

### 1. 审核API修复

#### 1.1 审核通过/拒绝接口修复
**问题描述**：
- `approve_knowledge_base`、`reject_knowledge_base`、`approve_persona_card` 和 `reject_persona_card` 四个审核API在调用 `save_knowledge_base` 和 `save_persona_card` 时传的是对象，但这两个方法期望字典参数。

**修复位置**：
- 文件：`api_routes.py`
- 行号：
  - `approve_knowledge_base`: 第1656行
  - `reject_knowledge_base`: 第1700行
  - `approve_persona_card`: 第1753行
  - `reject_persona_card`: 第1797行

**修复方法**：
在调用 `save_knowledge_base` 和 `save_persona_card` 之前，用 `to_dict()` 把对象转成字典。

**修改前**：
```python
updated_kb = db_manager.save_knowledge_base(kb)
```

**修改后**：
```python
updated_kb = db_manager.save_knowledge_base(kb.to_dict())
```

#### 1.2 审核拒绝API参数传递方式优化
**问题描述**：
- `reject_knowledge_base` 和 `reject_persona_card` 接口的 `reason` 参数原本使用查询参数（Query），不符合RESTful最佳实践，且对于较长的拒绝原因不够友好。

**修复位置**：
- 文件：`api_routes.py`
- 行号：
  - `reject_knowledge_base`: 第1694行
  - `reject_persona_card`: 第1791行

**修复方法**：
将 `reason` 参数从查询参数改为请求体（Body），使用 `Body(..., embed=True)` 接收JSON格式的请求体。

**API调用方式变更**：

修改前（查询参数）：
```bash
POST /api/review/knowledge/{kb_id}/reject?reason=拒绝原因
```

修改后（请求体）：
```bash
POST /api/review/knowledge/{kb_id}/reject
Content-Type: application/json

{
  "reason": "拒绝原因"
}
```

---

### 2. 消息API修复

#### 2.1 消息创建失败修复
**问题描述**：
- `Message.to_dict()` 方法返回的 `created_at` 字段是 ISO 格式的字符串，但 `MessageResponse` Pydantic模型期望接收 `datetime` 对象。

**修复位置**：
- 文件：`database_models.py`
- 类：`Message`
- 方法：`to_dict()`
- 行号：第338-351行

**修复方法**：
修改 `Message.to_dict()` 方法，确保 `created_at` 字段返回 `datetime` 对象而不是字符串。

**修改前**：
```python
def to_dict(self):
    data = {
        ...
        "created_at": self.created_at.isoformat() if self.created_at else datetime.now().isoformat()
    }
    return data
```

**修改后**：
```python
def to_dict(self):
    data = {
        ...
        "created_at": self.created_at if self.created_at else datetime.now()
    }
    return data
```

#### 2.2 消息获取API修复
**问题描述**：
- `api_routes.py` 中定义了重复的 `MessageResponse` 类，与 `models.py` 中的定义不一致，导致类型验证失败。

**修复位置**：
- 文件：`api_routes.py`
- 行号：第14-16行（导入语句），第1934-1942行（删除重复定义）

**修复方法**：
1. 从 `models.py` 导入 `MessageResponse`
2. 删除 `api_routes.py` 中重复的 `MessageResponse` 类定义

#### 2.3 消息批量创建和查询优化
**问题描述**：
- `bulk_create_messages` 方法在异常时只打印错误并返回空列表，导致错误信息丢失
- SQL查询中使用 `&` 和 `|` 运算符时，运算符优先级可能导致查询逻辑错误

**修复位置**：
- 文件：`database_models.py`
- 方法：
  - `bulk_create_messages`: 第681-697行
  - `get_conversation_messages`: 第699-707行
  - `get_user_messages`: 第709-714行
- 文件：`api_routes.py`
- 方法：`send_message`: 第1886-1888行

**修复方法**：
1. **改进异常处理**：`bulk_create_messages` 现在会抛出异常而不是静默失败
2. **修复SQL查询**：使用 `and_()` 和 `or_()` 函数替代 `&` 和 `|` 运算符，确保查询逻辑正确
3. **改进错误传播**：API路由中捕获并转换异常为 `DatabaseError`

---

### 3. 数据库迁移修复

**问题描述**：
- 数据库表 `messages` 缺少 `message_type` 和 `broadcast_scope` 列，导致消息创建和查询失败
- 错误信息：`table messages has no column named message_type`

**修复位置**：
- 文件：`database_models.py`
- 类：`SQLiteDatabaseManager`
- 方法：`__init__` 和新增的 `_migrate_database`
- 行号：第437-463行

**修复方法**：
添加自动数据库迁移方法，在数据库管理器初始化时检查并添加缺失的列。

**新增代码**：
```python
def _migrate_database(self):
    """执行数据库迁移，添加缺失的列"""
    try:
        inspector = inspect(self.engine)
        if 'messages' in inspector.get_table_names():
            existing_columns = [col['name'] for col in inspector.get_columns('messages')]
            
            if 'message_type' not in existing_columns:
                with self.engine.begin() as conn:
                    conn.execute(text("ALTER TABLE messages ADD COLUMN message_type VARCHAR DEFAULT 'direct'"))
                print("已添加 message_type 列到 messages 表")
            
            if 'broadcast_scope' not in existing_columns:
                with self.engine.begin() as conn:
                    conn.execute(text("ALTER TABLE messages ADD COLUMN broadcast_scope VARCHAR"))
                print("已添加 broadcast_scope 列到 messages 表")
    except Exception as e:
        print(f"数据库迁移失败: {str(e)}")
```

**注意事项**：
- 迁移会在应用启动时自动执行
- 如果表已存在但缺少列，迁移会自动添加
- 迁移失败不会阻止应用启动，但会打印错误信息

---

## 新增功能

### 1. Star状态检查接口

**新增接口**：
- `GET /api/knowledge/{kb_id}/starred` - 检查知识库是否已被当前用户Star
- `GET /api/persona/{pc_id}/starred` - 检查人设卡是否已被当前用户Star

**功能说明**：
- 返回格式：`{"starred": true/false}`
- 需要用户认证
- 用于前端快速检查Star状态，避免获取所有Star记录

**实现位置**：
- 文件：`api_routes.py`
- 行号：
  - `check_knowledge_starred`: 第861-874行
  - `check_persona_starred`: 第1508-1521行

### 2. 分页支持

**新增分页接口**：
- `GET /api/knowledge/public` - 支持分页、搜索、筛选和排序
- `GET /api/persona/public` - 支持分页、搜索、筛选和排序

**查询参数**：
- `page`: 页码（从1开始）
- `page_size`: 每页数量（1-100）
- `name`: 按名称搜索（可选）
- `uploader_id`: 按上传者ID筛选（可选）
- `sort_by`: 排序字段（created_at, updated_at, star_count）
- `sort_order`: 排序顺序（asc, desc）

**响应格式**：
```json
{
  "items": [...],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

### 3. 用户Star记录接口增强

**接口**：`GET /api/user/stars`

**新增参数**：
- `includeDetails`: 是否包含完整详情（可选，默认false）

**功能说明**：
- 当 `includeDetails=true` 时，返回Star记录的同时包含知识库/人设卡的完整信息
- 减少前端API调用次数，从 1+N 次请求优化到 1 次请求

### 4. 管理员功能增强

**新增接口**：
- `GET /api/admin/broadcast-messages` - 获取广播消息统计
- `GET /api/admin/stats` - 获取系统统计数据
- `GET /api/admin/recent-users` - 获取最近注册用户
- `GET /api/admin/users` - 获取用户列表（支持分页和搜索）
- `PUT /api/admin/users/{user_id}/role` - 更新用户角色
- `DELETE /api/admin/users/{user_id}` - 删除用户
- `POST /api/admin/users` - 创建新用户
- `GET /api/admin/knowledge/all` - 获取所有知识库（管理员）
- `GET /api/admin/persona/all` - 获取所有人设卡（管理员）
- `POST /api/admin/knowledge/{kb_id}/revert` - 恢复知识库审核状态
- `POST /api/admin/persona/{pc_id}/revert` - 恢复人设卡审核状态
- `GET /api/admin/upload-history` - 获取上传历史记录
- `GET /api/admin/upload-stats` - 获取上传统计数据
- `DELETE /api/admin/uploads/{upload_id}` - 删除上传记录
- `POST /api/admin/uploads/{upload_id}/reprocess` - 重新处理上传

### 5. 消息功能增强

**新增接口**：
- `GET /api/messages/{message_id}` - 获取单条消息详情
- `PUT /api/messages/{message_id}` - 更新消息
- `DELETE /api/messages/{message_id}` - 删除消息
- `POST /api/messages/batch-delete` - 批量删除消息

**功能说明**：
- 支持消息的完整CRUD操作
- 支持批量操作，提升管理效率

### 6. 用户功能增强

**新增接口**：
- `POST /api/refresh` - 刷新访问令牌
- `PUT /api/users/me/password` - 修改密码
- `POST /api/users/me/avatar` - 上传头像
- `DELETE /api/users/me/avatar` - 删除头像
- `GET /api/users/{user_id}/avatar` - 获取用户头像

### 7. 用户上传历史和统计接口

**新增接口**：
- `GET /api/me/upload-history` - 获取当前用户个人上传历史记录
- `GET /api/me/upload-stats` - 获取当前用户个人上传统计

**功能说明**：
- 支持分页查询用户上传记录
- 返回知识库和人设卡的上传记录
- 包含状态映射（approved→success，pending→processing，rejected→failed）
- 提供目标存在性检查和文件大小统计
- 获取用户上传总数、成功数、处理中数、失败数等统计数据
- 返回后端数据库字段名和前端期望字段名两种格式的统计结果

**实现位置**：
- 文件：`user_router.py`

---

## 变更总览

### 代码逻辑层面的修复
1. **数据类型转换**：对象转字典（审核API）
2. **返回格式调整**：字符串转datetime对象（消息API）
3. **代码重构**：删除重复定义，统一使用models.py中的定义
4. **异常处理改进**：抛出异常而不是静默失败
5. **SQL查询优化**：使用明确的逻辑函数确保查询正确

### API接口优化
6. **审核拒绝接口**：参数传递方式优化（从查询参数改为请求体，更符合RESTful规范）
7. **分页支持**：公开知识库和人设卡接口支持分页、搜索、筛选和排序
8. **Star功能优化**：新增Star状态检查接口，提升性能

### 数据库结构修复
9. **自动数据库迁移**：添加缺失的 `message_type` 和 `broadcast_scope` 列

### 安全性增强
10. **错误处理改进**：统一错误处理机制，防止信息泄露
11. **权限验证优化**：改进权限检查逻辑

### 代码质量改进
12. **重复定义问题修复**：统一从 `models.py` 导入响应模型，删除 `api_routes.py` 中的重复定义
13. **数据库管理器实例化修复**：创建全局实例 `sqlite_db_manager`，解决循环导入问题

---

## 影响范围

### API端点

**需要客户端更新的接口**：
- `POST /api/review/knowledge/{kb_id}/reject`
- `POST /api/review/persona/{pc_id}/reject` 

> 已完成更新

**新增接口**：
- `GET /api/knowledge/{kb_id}/starred` - Star状态检查
- `GET /api/persona/{pc_id}/starred` - Star状态检查
- `GET /api/knowledge/public` - 支持分页参数
- `GET /api/persona/public` - 支持分页参数

### 数据模型变更
- `Message.to_dict()` 方法的返回值格式（`created_at` 从字符串改为datetime对象）

---

## 相关文件

### 修改的文件
- `MaiMaiNotePad-BackEnd/api_routes.py` - API路由实现
- `MaiMaiNotePad-BackEnd/database_models.py` - 数据库模型定义和迁移逻辑
- `MaiMaiNotePad-BackEnd/models.py` - Pydantic模型定义

### 新增的文件
- `MaiMaiNotePad-BackEnd/middleware_config.py` - 中间件配置
- `MaiMaiNotePad-BackEnd/static_routes.py` - 静态文件路由
- `MaiMaiNotePad-BackEnd/avatar_utils.py` - 头像处理工具

---

## 部署说明

### 数据库迁移
- 迁移会在应用启动时自动执行
- 如果 `messages` 表已存在但缺少列，迁移会自动添加
- 不需要手动执行SQL脚本，重启应用即可

### 兼容性
- 大部分修改保持向后兼容
- 审核拒绝接口的参数传递方式变更，但是前端已同步更新

---

## 相关文档

- [API文档](./API.md) - 完整的API接口文档
- [CHANGELOG.md](./CHANGELOG.md) - 详细的变更日志
- [数据库模型文档](./database_models.md) - 数据库结构说明

---

**文档版本**: 1.0  
**最后更新**: 2025-11-25 
**维护者**: ARC

