# MaiMai NotePad 系统架构图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端层 (Frontend)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  • 用户界面 (React/Vue.js)                                                  │
│  • 管理后台界面                                                             │
│  • 人设卡展示页面                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/HTTPS
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API网关层 (API Gateway)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  • 路由分发                                                                 │
│  • 认证授权 (JWT)                                                           │
│  • 限流控制                                                                 │
│  • 请求日志                                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│   用户服务模块      │ │   知识库服务模块    │ │   人设卡服务模块    │
├─────────────────────┤ ├─────────────────────┤ ├─────────────────────┤
│ • 用户注册/登录     │ │ • 知识库CRUD        │ │ • 人设卡上传        │
│ • 密码重置         │ │ • 版本控制          │ │ • 人设卡审核        │
│ • 用户资料管理      │ │ • 分类管理          │ │ • 人设卡搜索        │
│ • 权限管理          │ │ • 全文搜索          │ │ • 格式转换          │
└─────────────────────┘ └─────────────────────┘ └─────────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据存储层 (Data Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐ │
│  │   MongoDB/D1数据库  │  │   文件存储系统      │  │   缓存系统          │ │
│  ├─────────────────────┤  ├─────────────────────┤  ├─────────────────────┤ │
│  │ • users表           │  │ • 人设卡文件        │  │ • 用户会话          │ │
│  │ • notes表           │  │ • 知识库附件        │  │ • 热门数据          │ │
│  │ • characters表      │  │ • 用户头像          │  │ • 搜索结果          │ │
│  │ • files表           │  │ • 系统文件          │  │ • 统计数据          │ │
│  │ • audit_logs表      │  │                     │  │                     │ │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        外部服务层 (External Services)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐ │
│  │   邮件服务          │  │   文件存储          │  │   CDN服务           │ │
│  ├─────────────────────┤  ├─────────────────────┤  ├─────────────────────┤ │
│  │ • SMTP服务器        │  │ • Cloudflare R2     │  │ • Cloudflare CDN    │ │
│  │ • 邮件模板          │  │ • AWS S3            │  │ • 图片优化          │ │
│  │ • 发送队列          │  │ • 本地存储          │  │ • 全球分发          │ │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 人设卡系统架构详解

### 人设卡上传流程

```
用户上传人设卡
     │
     ▼
┌─────────────────────┐
│   文件验证层        │
├─────────────────────┤
│ • 文件格式检查      │
│ • 文件大小限制      │
│ • 内容安全检测      │
└─────────────────────┘
     │
     ▼
┌─────────────────────┐
│   内容解析层        │
├─────────────────────┤
│ • JSON格式解析      │
│ • Markdown解析      │
│ • TOML格式解析      │
│ • 纯文本处理        │
└─────────────────────┘
     │
     ▼
┌─────────────────────┐
│   数据存储层        │
├─────────────────────┤
│ • 文件存储到R2/S3   │
│ • 元数据存入数据库  │
│ • 生成文件访问URL   │
└─────────────────────┘
     │
     ▼
┌─────────────────────┐
│   审核系统          │
├─────────────────────┤
│ • 状态设为待审核  │
│ • 通知管理员        │
│ • 等待人工审核      │
└─────────────────────┘
```

### 人设卡审核流程

```
管理员审核
     │
     ▼
┌─────────────────────┐
│   审核界面          │
├─────────────────────┤
│ • 查看人设卡详情    │
│ • 预览文件内容      │
│ • 检查合规性        │
└─────────────────────┘
     │
     ├────────通过───────►┌─────────────────────┐
     │                    │   审核通过处理      │
     │                    ├─────────────────────┤
     │                    │ • 状态更新为已通过  │
     │                    │ • 设为公开可见      │
     │                    │ • 通知用户          │
     │                    └─────────────────────┘
     │
     └────────拒绝───────►┌─────────────────────┐
                          │   审核拒绝处理      │
                          ├─────────────────────┤
                          │ • 状态更新为已拒绝  │
                          │ • 记录拒绝原因      │
                          │ • 通知用户          │
                          └─────────────────────┘
```

### 人设卡数据模型

```json
{
  "_id": "ObjectId",
  "title": "人设卡标题",
  "description": "人设卡描述",
  "content": "人设卡内容",
  "fileUrl": "文件存储URL",
  "fileType": "文件类型",
  "format": "格式类型(json/md/txt/toml)",
  "category": "分类",
  "tags": ["标签数组"],
  "author": {
    "id": "用户ID",
    "username": "用户名",
    "email": "用户邮箱"
  },
  "status": "pending/approved/rejected",
  "isPublic": true/false,
  "downloadCount": 0,
  "rating": {
    "average": 0,
    "count": 0
  },
  "review": {
    "reviewedBy": "审核员ID",
    "reviewedAt": "审核时间",
    "comments": "审核意见",
    "reason": "拒绝原因"
  },
  "createdAt": "创建时间",
  "updatedAt": "更新时间"
}
```

## 技术栈说明

### 后端技术
- **Node.js + Express.js**: 传统部署方案
- **Cloudflare Workers**: Serverless部署方案
- **MongoDB**: 主数据库（传统部署）
- **Cloudflare D1**: SQLite数据库（Workers部署）

### 文件存储
- **Cloudflare R2**: 对象存储服务
- **AWS S3**: 备选对象存储
- **本地文件系统**: 开发环境使用

### 文件格式支持
- **JSON**: 结构化人设卡数据
- **Markdown**: 格式化文档
- **TOML**: 配置文件格式
- **纯文本**: 简单文本内容

### 安全措施
- **JWT认证**: 用户身份验证
- **文件类型检查**: 防止恶意文件上传
- **内容长度限制**: 防止超大文件
- **输入验证**: 防止注入攻击
- **CORS配置**: 跨域请求控制

### 性能优化
- **缓存机制**: Redis/Workers KV缓存
- **CDN分发**: 静态资源加速
- **分页查询**: 大数据集分页显示
- **索引优化**: 数据库查询优化

## 部署架构

### 传统部署
```
用户请求 → Nginx → Node.js应用 → MongoDB
                ↓
            文件存储 → 本地磁盘/NAS
```

### Cloudflare Workers部署
```
用户请求 → Cloudflare CDN → Workers函数 → D1数据库
                           ↓
                       R2对象存储
```

## 监控与日志

### 日志系统
- **应用日志**: Winston日志框架
- **访问日志**: HTTP请求记录
- **错误日志**: 异常信息捕获
- **审核日志**: 重要操作记录

### 监控指标
- **系统性能**: CPU、内存、磁盘使用率
- **应用指标**: 请求响应时间、错误率
- **业务指标**: 用户活跃度、文件上传量
- **审核指标**: 待审核数量、审核效率