# 版本管理指南

本文档说明如何管理 MaiMaiNotePad 后端项目的版本号。

## 📍 版本号位置

项目使用**单一来源原则（Single Source of Truth）**管理版本号：

### 唯一的版本号定义位置 ✨
```
app/__version__.py  ← 只需在这里修改版本号！
```

### 自动同步
```
pyproject.toml  ← 自动从 __version__.py 读取（无需手动修改）
```

**重要**：你只需要修改 `app/__version__.py`，其他地方会自动同步！

## 🔢 版本号规则

遵循 [语义化版本（Semantic Versioning）](https://semver.org/lang/zh-CN/) 规范：

| 版本类型 | 何时增加 | 示例 |
|---------|---------|------|
| **主版本号** | 不兼容的 API 修改 | 1.0.0 → 2.0.0 |
| **次版本号** | 向下兼容的功能性新增 | 1.0.0 → 1.1.0 |
| **修订号** | 向下兼容的问题修正 | 1.0.0 → 1.0.1 |

### 详细说明

#### 主版本号（Major）
增加主版本号时：
- 进行了不兼容的 API 修改
- 重大架构变更
- 删除或重命名了公开的 API
- 修改了数据库结构且不兼容旧版本

**示例**：
- `1.x.x` → `2.0.0`：重构了整个认证系统
- `2.x.x` → `3.0.0`：更换了数据库引擎

#### 次版本号（Minor）
增加次版本号时：
- 添加了新功能
- 标记了某些功能为过时（但仍可用）
- 改进了内部实现但不影响 API

**示例**：
- `1.0.x` → `1.1.0`：新增评论功能
- `1.1.x` → `1.2.0`：新增消息通知功能

#### 修订号（Patch）
增加修订号时：
- 修复了 Bug
- 性能优化
- 文档更新
- 代码重构（不影响功能）

**示例**：
- `1.0.0` → `1.0.1`：修复登录失败的 Bug
- `1.0.1` → `1.0.2`：优化数据库查询性能

## 📝 如何更新版本号

### 简化流程（只需一步）✨

**你只需要修改一个文件**：`app/__version__.py`

编辑 `app/__version__.py`：

```python
"""
版本信息模块
"""

__version__ = "1.1.0"  # ← 只需修改这里！
__version_info__ = tuple(int(x) for x in __version__.split("."))

# 版本历史
VERSION_HISTORY = {
    "1.1.0": "2026-03-01 - 新增评论功能",  # ← 添加新版本记录
    "1.0.0": "2026-02-22 - 初始版本发布",
}
```

**就这样！** `pyproject.toml` 会自动从这里读取版本号。

### 完整发布流程

```bash
# 1. 确保在主分支且代码最新
git checkout main
git pull origin main

# 2. 运行所有测试
pytest

# 3. 更新版本号（只需修改一个文件）
# 编辑 app/__version__.py，修改 __version__ 和 VERSION_HISTORY

# 4. 更新更新日志
# 编辑 docs/更新日志.md

# 5. 提交版本变更
git add app/__version__.py docs/更新日志.md
git commit -m "chore: bump version to 1.1.0"

# 6. 创建标签
git tag -a v1.1.0 -m "Release version 1.1.0"

# 7. 推送到远程
git push origin main
git push origin v1.1.0
```

### ~~旧方法（已废弃）~~

~~以前需要同时修改两个文件：~~
- ~~`app/__version__.py`~~
- ~~`pyproject.toml`~~

**现在不需要了！** `pyproject.toml` 使用 `dynamic = ["version"]` 配置，会自动从 `app.__version__.__version__` 读取版本号。

## 🔍 如何查看版本号

### 在代码中查看

```python
# 方法 1：从 app 包导入
from app import __version__
print(f"当前版本：{__version__}")

# 方法 2：从 __version__ 模块导入
from app.__version__ import __version__, __version_info__
print(f"版本号：{__version__}")
print(f"版本信息：{__version_info__}")  # (1, 0, 0)

# 方法 3：从配置读取
from app.core.config import settings
print(f"应用版本：{settings.APP_VERSION}")
```

### 在 API 中查看

访问根路径：
```bash
curl http://localhost:9278/
```

响应：
```json
{
  "message": "MaiMNP Backend API",
  "version": "1.0.0"
}
```

### 在命令行查看

```bash
# 方法 1：使用 Python
python -c "from app import __version__; print(__version__)"

# 方法 2：查看文件
cat app/__version__.py | grep __version__

# 方法 3：使用 grep
grep "version = " pyproject.toml
```

## 📦 版本号的使用位置

版本号会自动应用到以下位置：

1. **API 响应**
   - 根路径 `/` 返回版本信息
   - 健康检查 `/health` 包含版本号

2. **应用配置**
   - `settings.APP_VERSION` 可在代码中使用

3. **日志输出**
   - 应用启动时输出版本号

4. **文档**
   - API 文档显示版本号
   - Swagger UI 显示版本号

## 🎯 最佳实践

### ✅ 推荐做法

1. **只在一个地方修改版本号** ✨
   - 只修改 `app/__version__.py`
   - `pyproject.toml` 会自动读取

2. **每次发布前更新版本号**
   - 确保版本号反映实际变更

3. **记录版本历史**
   - 在 `VERSION_HISTORY` 中记录每个版本
   - 在 `docs/更新日志.md` 中详细说明变更

4. **使用 Git 标签**
   - 每个版本创建对应的 Git 标签
   - 标签格式：`v1.0.0`

5. **遵循语义化版本**
   - 严格按照规则增加版本号
   - 让用户清楚了解变更影响

### ❌ 避免做法

1. ~~**不要手动修改 pyproject.toml 中的版本号**~~ ✨
   - 它会自动从 `__version__.py` 读取

2. **不要跳过版本号**
   - 按顺序递增：1.0.0 → 1.0.1 → 1.1.0

3. **不要随意修改历史版本号**
   - 已发布的版本号不应修改

4. **不要忘记更新文档**
   - 版本号变更必须同步更新文档

## 🔄 版本发布流程

### 完整的发布流程

```bash
# 1. 确保在主分支且代码最新
git checkout main
git pull origin main

# 2. 运行所有测试
pytest

# 3. 更新版本号（只需修改一个文件！）
# 编辑 app/__version__.py

# 4. 更新更新日志
# 编辑 docs/更新日志.md

# 5. 提交版本变更
git add app/__version__.py docs/更新日志.md
git commit -m "chore: bump version to 1.1.0"

# 6. 创建标签
git tag -a v1.1.0 -m "Release version 1.1.0"

# 7. 推送到远程
git push origin main
git push origin v1.1.0

# 8. 创建 GitHub Release（可选）
# 在 GitHub 上创建 Release，附上更新日志
```

## 📚 相关文档

- [更新日志](./更新日志.md) - 详细的版本变更记录
- [语义化版本规范](https://semver.org/lang/zh-CN/) - 官方规范文档
- [项目整理总结](./项目整理总结.md) - 项目改进历史

## 🔗 快速链接

- 版本号文件：`app/__version__.py`
- 项目配置：`pyproject.toml`
- 更新日志：`docs/更新日志.md`

---

**文档信息**

| 项目 | 内容 |
|------|------|
| 创建日期 | 2026-02-22 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | 📝 参考文档 |
