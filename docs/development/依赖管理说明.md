# 依赖管理说明

**日期**: 2026-02-22

---

## 📦 依赖文件说明

项目使用分离的依赖文件来区分生产环境和开发环境：

### 文件结构

```
项目根目录/
├── requirements.txt          # 生产环境依赖（必需）
└── requirements-dev.txt      # 开发/测试环境依赖（包含生产依赖）
```

---

## 📋 依赖文件详解

### requirements.txt - 生产环境依赖

**用途**: 生产环境部署时安装

**包含**:
- Web 框架（FastAPI, Uvicorn）
- 数据库（SQLAlchemy, Alembic）
- 数据验证（Pydantic）
- 安全（bcrypt, PyJWT）
- 工具库（python-dotenv, aiofiles, requests 等）
- 限流（slowapi）
- 图像处理（Pillow）

**特点**:
- ✅ 最小化依赖，减少安全风险
- ✅ 只包含运行时必需的包
- ✅ 适合 Docker 镜像构建

### requirements-dev.txt - 开发/测试环境依赖

**用途**: 本地开发和 CI/CD 测试时安装

**包含**:
- 所有生产环境依赖（通过 `-r requirements.txt`）
- 测试框架（pytest 及插件）
- 属性测试（hypothesis）
- HTTP 测试客户端（httpx）
- 代码质量工具（可选，已注释）

**特点**:
- ✅ 包含所有开发和测试所需的工具
- ✅ 自动包含生产依赖
- ✅ 可选的代码质量工具

---

## 🚀 使用方法

### 生产环境部署

```bash
# 只安装生产环境依赖
pip install -r requirements.txt
```

**适用场景**:
- Docker 容器构建
- 生产服务器部署
- 云平台部署（如 AWS, Azure, GCP）

### 开发环境设置

```bash
# 安装开发环境依赖（包含生产依赖）
pip install -r requirements-dev.txt
```

**适用场景**:
- 本地开发
- 运行测试
- CI/CD 流水线

### 虚拟环境推荐

推荐使用项目管理工具创建虚拟环境：

```bash
# 使用管理工具创建虚拟环境（推荐）
./manage.sh create-env
# 支持三种方式：
# - Conda 环境（推荐，可指定 Python 版本）
# - venv 环境（Python 内置）
# - uv 环境（极快的包管理器）
```

或手动创建 venv 环境：

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# 安装依赖
pip install -r requirements-dev.txt
```

---

## 📊 依赖分类

### 生产环境依赖（requirements.txt）

| 类别 | 包名 | 版本 | 说明 |
|------|------|------|------|
| Web 框架 | fastapi | 0.129.0 | 现代 Web 框架 |
| | uvicorn[standard] | 0.30.3 | ASGI 服务器 |
| 数据库 | sqlalchemy | 2.0.46 | ORM 框架 |
| | alembic | 1.18.4 | 数据库迁移工具 |
| 数据验证 | pydantic[email] | 2.12.5 | 数据验证 |
| | pydantic-settings | 2.13.0 | 配置管理 |
| 安全 | bcrypt | 4.2.1 | 密码哈希 |
| | PyJWT | 2.10.1 | JWT 令牌 |
| 工具库 | python-dotenv | 1.2.1 | 环境变量 |
| | python-multipart | 0.0.22 | 文件上传 |
| | aiofiles | 25.1.0 | 异步文件操作 |
| | requests | 2.32.4 | HTTP 客户端 |
| | toml | 0.10.2 | TOML 解析 |
| | werkzeug | 3.1.5 | WSGI 工具 |
| 限流 | slowapi | 0.1.9 | API 限流 |
| 图像 | Pillow | 10.4.0 | 图像处理 |

### 开发/测试依赖（requirements-dev.txt）

| 类别 | 包名 | 版本 | 说明 |
|------|------|------|------|
| 测试框架 | pytest | 9.0.2 | 测试框架 |
| | pytest-xdist | 3.6.1 | 并行测试 |
| | pytest-cov | 6.0.0 | 覆盖率报告 |
| | pytest-asyncio | 0.25.2 | 异步测试 |
| 属性测试 | hypothesis | 6.122.4 | 属性测试 |
| HTTP 测试 | httpx | 0.28.1 | 异步 HTTP 客户端 |

---

## 🔄 依赖更新

### 检查过期依赖

```bash
pip list --outdated
```

### 更新单个依赖

```bash
# 更新到最新版本
pip install --upgrade package-name

# 更新到指定版本
pip install package-name==x.y.z

# 更新 requirements 文件
pip freeze | grep package-name
```

### 更新所有依赖

```bash
# 谨慎操作！建议先在测试环境验证
pip install --upgrade -r requirements-dev.txt
```

### 锁定依赖版本

当前使用固定版本（`==`），确保环境一致性：

```
fastapi==0.129.0  # 固定版本
```

如需允许小版本更新，可使用：

```
fastapi~=0.129.0  # 允许 0.129.x 更新
fastapi>=0.129.0,<0.130.0  # 版本范围
```

---

## 🐳 Docker 使用

### Dockerfile 示例

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 只复制生产依赖文件
COPY requirements.txt .

# 安装生产依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 多阶段构建（推荐）

```dockerfile
# 构建阶段
FROM python:3.11-slim as builder

WORKDIR /app
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# 运行阶段
FROM python:3.11-slim

WORKDIR /app
COPY --from=builder /root/.local /root/.local
COPY . .

ENV PATH=/root/.local/bin:$PATH

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 🔒 安全建议

### 1. 定期更新依赖

```bash
# 每月检查一次
pip list --outdated
```

### 2. 扫描安全漏洞

```bash
# 使用 pip-audit（需要安装）
pip install pip-audit
pip-audit -r requirements.txt
```

### 3. 使用虚拟环境

始终在虚拟环境中开发，避免污染系统 Python。

### 4. 锁定版本

生产环境使用固定版本（`==`），避免意外更新。

---

## 📝 添加新依赖

### 生产依赖

1. 安装包：
   ```bash
   pip install package-name
   ```

2. 添加到 `requirements.txt`：
   ```bash
   echo "package-name==x.y.z" >> requirements.txt
   ```

3. 按类别排序和注释

### 开发依赖

1. 安装包：
   ```bash
   pip install package-name
   ```

2. 添加到 `requirements-dev.txt`：
   ```bash
   echo "package-name==x.y.z" >> requirements-dev.txt
   ```

---

## 🎯 最佳实践

### ✅ 推荐做法

1. **分离依赖** - 生产和开发依赖分开
2. **固定版本** - 使用 `==` 锁定版本
3. **虚拟环境** - 始终使用虚拟环境
4. **定期更新** - 每月检查并更新依赖
5. **安全扫描** - 定期扫描安全漏洞
6. **文档化** - 记录依赖用途和版本选择原因

### ❌ 避免做法

1. **混合依赖** - 不要把测试工具放在生产依赖中
2. **不锁定版本** - 避免使用 `>=` 在生产环境
3. **全局安装** - 不要在系统 Python 中安装项目依赖
4. **忽略更新** - 不要长期不更新依赖
5. **过度依赖** - 避免安装不必要的包

---

## 🔗 相关文档

- [项目主文档](../../README.md)
- [配置管理文档](../configuration/配置管理文档.md)
- [Docker 部署指南](../../README.md#docker-部署)

---

## 📚 参考资源

- [pip 官方文档](https://pip.pypa.io/)
- [Python 虚拟环境指南](https://docs.python.org/3/tutorial/venv.html)
- [依赖管理最佳实践](https://packaging.python.org/guides/tool-recommendations/)

---

**文档信息**

| 项目 | 内容 |
|------|------|
| 创建日期 | 2026-02-22 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | 📝 参考文档 |
