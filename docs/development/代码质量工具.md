# 代码质量工具

本项目使用多个代码质量工具来确保代码的一致性、可读性和可维护性。

## 工具概览

### Black - 代码格式化工具

Black 是一个不妥协的 Python 代码格式化工具，自动格式化代码以符合 PEP 8 规范。

**特点：**
- 自动格式化代码
- 统一的代码风格
- 减少代码审查中的格式争议

**配置文件：** `pyproject.toml`

**使用方法：**
```bash
# 格式化所有代码
./manage.sh format

# 或直接使用 black
black app tests scripts/python

# 仅检查不修改
black --check app tests scripts/python

# 查看差异
black --check --diff app tests scripts/python
```

### Flake8 - 代码风格检查工具

Flake8 是一个代码风格检查工具，检查代码是否符合 PEP 8 规范，并发现潜在的错误。

**检查内容：**
- PEP 8 代码风格
- 未使用的导入
- 未定义的变量
- 代码复杂度

**配置文件：** `.flake8`

**使用方法：**
```bash
# 检查所有代码
flake8 app tests scripts/python

# 检查特定文件
flake8 app/core/security.py

# 显示统计信息
flake8 --statistics app
```

### Mypy - 静态类型检查工具

Mypy 是一个静态类型检查工具，检查 Python 类型注解的正确性。

**特点：**
- 类型安全检查
- 提前发现类型错误
- 提高代码可维护性

**配置文件：** `pyproject.toml`

**使用方法：**
```bash
# 检查所有代码
mypy app

# 检查特定模块
mypy app/core

# 显示详细信息
mypy --verbose app
```

## 快速开始

### 安装工具

```bash
# 安装开发依赖（包含所有代码质量工具）
pip install -r requirements-dev.txt
```

### 运行所有检查

```bash
# 使用管理脚本（推荐）
./manage.sh lint

# 或手动运行
black app tests scripts/python
flake8 app tests scripts/python
mypy app
```

### 集成到工作流

#### 1. 提交前检查

在提交代码前运行代码质量检查：

```bash
./manage.sh lint
```

#### 2. Git Pre-commit Hook（可选）

创建 `.git/hooks/pre-commit` 文件：

```bash
#!/bin/bash
echo "运行代码质量检查..."
black --check app tests scripts/python || exit 1
flake8 app tests scripts/python || exit 1
mypy app || exit 1
echo "代码质量检查通过"
```

然后添加执行权限：

```bash
chmod +x .git/hooks/pre-commit
```

#### 3. CI/CD 集成

在 CI/CD 流程中添加代码质量检查步骤：

```yaml
# 示例：GitHub Actions
- name: 代码质量检查
  run: |
    pip install -r requirements-dev.txt
    black --check app tests scripts/python
    flake8 app tests scripts/python
    mypy app
```

## 配置说明

### Black 配置

在 `pyproject.toml` 中配置：

```toml
[tool.black]
line-length = 120              # 最大行长度
target-version = ['py311']     # 目标 Python 版本
include = '\.pyi?$'            # 包含的文件
extend-exclude = '''           # 排除的目录
/(
  alembic/versions
  | data
  | logs
  | uploads
)/
'''
```

### Flake8 配置

在 `.flake8` 中配置：

```ini
[flake8]
max-line-length = 120          # 最大行长度
max-complexity = 10            # 最大复杂度
ignore = E203,W503,E501        # 忽略的错误码
exclude = .git,__pycache__     # 排除的目录
```

### Mypy 配置

在 `pyproject.toml` 中配置：

```toml
[tool.mypy]
python_version = "3.11"
# 渐进式类型检查 - 适合现有项目
check_untyped_defs = false
ignore_missing_imports = true
no_implicit_optional = false
```

**注意**：项目采用渐进式类型检查策略，当前配置较为宽松。随着项目发展，可以逐步启用更严格的检查。

## 常见问题

### Q: Black 和 Flake8 冲突怎么办？

A: 已在 `pyproject.toml` 的 `[tool.flake8]` 中配置忽略与 Black 冲突的规则（E203, W503, E501）。

### Q: Mypy 报告大量类型错误？

A: 这是正常的。项目采用**渐进式类型检查**策略：
- 当前配置较为宽松，主要检查明显的类型错误
- 不强制要求类型注解
- 忽略第三方库的类型问题
- 随着项目发展，可以逐步启用更严格的检查

### Q: Mypy 报告第三方库类型错误？

A: 已配置 `ignore_missing_imports = true`，会忽略第三方库的类型检查。如果仍有问题，可以安装对应的类型存根包（如 `types-toml`）。

### Q: 如何临时禁用某个检查？

A: 使用注释：

```python
# Black: 使用 fmt: off/on
# fmt: off
code_here = "不会被格式化"
# fmt: on

# Flake8: 使用 noqa
import unused_module  # noqa: F401

# Mypy: 使用 type: ignore
result = some_function()  # type: ignore[error-code]
```

### Q: 代码格式化后测试失败？

A: 某些测试可能依赖特定的格式（如字符串比较）。建议：
1. 更新测试以适应新格式
2. 或在测试中使用 `# fmt: off` 保持原格式

### Q: SQLAlchemy Column 类型错误？

A: SQLAlchemy 的 Column 类型在 mypy 中比较复杂。当前配置已经放宽检查。如果需要严格检查，可以：
1. 使用 SQLAlchemy 2.0 的新式类型注解
2. 或在特定文件中禁用 mypy：`# type: ignore` 在文件顶部

## 最佳实践

1. **定期运行检查**
   - 每次提交前运行 `./manage.sh lint`
   - 或设置 Git pre-commit hook 自动检查

2. **逐步改进**
   - 对于大型项目，可以先格式化新代码
   - 逐步重构旧代码以符合规范

3. **团队协作**
   - 确保所有团队成员使用相同的工具版本
   - 统一配置文件（`.flake8`, `pyproject.toml`）

4. **CI/CD 集成**
   - 在 CI/CD 流程中强制执行代码质量检查
   - 不通过检查的代码不允许合并

## 相关链接

- [Black 官方文档](https://black.readthedocs.io/)
- [Flake8 官方文档](https://flake8.pycqa.org/)
- [Mypy 官方文档](https://mypy.readthedocs.io/)
- [PEP 8 风格指南](https://pep8.org/)

## 参考

- [../README.md](../README.md) - 项目文档索引
- [版本管理.md](版本管理.md) - 版本管理规范
- [错误码文档.md](错误码文档.md) - 错误码规范


---

**文档信息**

| 项目 | 内容 |
|------|------|
| 创建日期 | 2025-02-20 |
| 最后更新 | 2026-02-22 |
| 维护者 | CorrectPath, A-Dawn, cuckoo711 |
| 状态 | 📝 参考文档 |
