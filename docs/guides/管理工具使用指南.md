# MaiMaiNotePad 管理工具使用指南

## 概述

MaiMaiNotePad 后端管理工具 (`manage.sh`) 是一个友好的命令行工具，提供 TUI（Terminal User Interface）和 CLI 两种交互模式，以及直接命令执行方式，帮助你快速完成环境配置、服务管理、测试运行等常见任务。

## 快速开始

### 基本使用

```bash
# 交互式菜单（自动选择 TUI 或 CLI 模式）
./manage.sh

# 强制使用 CLI 模式
./manage.sh --cli

# 直接执行命令（推荐熟悉后使用）
./manage.sh test
./manage.sh start-dev
./manage.sh status
```

### TUI vs CLI 模式

管理工具会自动检测你的系统环境：

- **TUI 模式**（推荐）：如果系统安装了 `dialog` 工具，会自动使用图形化菜单界面
  - 更直观的菜单导航
  - 支持鼠标操作（部分终端）
  - 更好的视觉体验
  
- **CLI 模式**：如果未安装 `dialog`，会使用传统的文本菜单
  - 兼容性更好
  - 适合脚本化使用
  - 适合远程 SSH 连接

- **强制 CLI 模式**：使用 `--cli` 参数可以强制使用 CLI 模式
  ```bash
  ./manage.sh --cli
  ```

### dialog 安装提示

如果你的系统没有安装 `dialog`，运行 `./manage.sh` 时会看到一个友好的提示：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  💡 提示：安装 dialog 获得更好的 TUI 体验
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  当前使用 CLI 模式。安装 dialog 工具后可以使用更直观的 TUI 界面。

  TUI 模式特性：
    • 图形化菜单界面
    • 方向键导航
    • 支持鼠标操作（部分终端）
    • 更直观的用户体验

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  安装方法：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  macOS:
    brew install dialog

  Linux:
    sudo apt-get install dialog

  Windows:
    推荐使用以下方式之一：
    1. WSL (Windows Subsystem for Linux) - 推荐
       wsl --install
       然后在 WSL 中: sudo apt-get install dialog
    2. Git Bash - dialog 支持有限，建议使用 CLI 模式
    3. Cygwin - 安装时选择 dialog 包

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  选项：
    y    - 现在安装 dialog（需要管理员权限）
    n    - 继续使用 CLI 模式
    c    - 不再提示（创建标记文件）

请选择 [y/n/c]:
```

**选项说明**：
- **输入 y**：立即安装 dialog（需要管理员权限，macOS/Linux）
  - macOS: 使用 Homebrew 安装
  - Ubuntu/Debian: 使用 apt-get 安装
  - CentOS/RHEL: 使用 yum 安装
  - Arch Linux: 使用 pacman 安装
  - Windows: 显示安装指南，不提供自动安装
  - 安装成功后脚本会自动退出，请重新运行以使用 TUI 模式
  
- **输入 n**：继续使用 CLI 模式，下次运行时仍会显示此提示

- **输入 c**：不再提示，在 `pyproject.toml` 中设置 `hide_dialog_tip = true`

**Windows 用户特别说明**：
- 系统会显示详细的安装指南
- 不提供自动安装功能
- 只有两个选项：回车（继续）或 c（不再提示）
- 建议直接使用 CLI 模式：`./manage.sh --cli`

**重要提示**：
- 默认情况下，每次运行都会显示此提示
- 只有选择 'c' 才会在 `pyproject.toml` 中设置 `hide_dialog_tip = true`
- 如果想再次看到提示，编辑 `pyproject.toml`，将 `hide_dialog_tip` 改为 `false`

### 安装 dialog（可选）

如果想使用 TUI 模式，可以安装 `dialog` 工具：

**macOS:**
```bash
brew install dialog
```

**Ubuntu/Debian:**
```bash
sudo apt-get install dialog
```

**CentOS/RHEL:**
```bash
sudo yum install dialog
```

**Arch Linux:**
```bash
sudo pacman -S dialog
```

**Windows:**

Windows 用户推荐使用以下方式之一：

1. **WSL (Windows Subsystem for Linux)** - 推荐
   ```bash
   wsl --install
   # 然后在 WSL 中安装 dialog
   sudo apt-get install dialog
   ```

2. **Git Bash**
   - 下载：https://git-scm.com/download/win
   - 注意：dialog 支持有限，建议使用 CLI 模式

3. **Cygwin**
   - 下载：https://www.cygwin.com/
   - 安装时选择 dialog 包

**注意**：Windows 环境建议直接使用 CLI 模式（`./manage.sh --cli`）

## 功能模块

### 1. 环境管理

#### 智能环境检测

管理工具会自动检测你的 Python 环境，并在需要时提供智能建议：

**场景 1: 当前环境不是推荐环境**
```
⚠  当前 Conda 环境: base
⚠  推荐使用环境: mai_notebook

选项：
  1. 继续使用当前环境
  2. 查看并切换到其他环境
  3. 取消操作

请选择 [1-3]:
```

选择选项 2 后，会列出所有可用的 Conda 环境：
```
可用的 Conda 环境：

  1. base (当前)
  2. mai_notebook (推荐)
  3. AlbumVision
  4. MaiBotEnv
  ...
  
  0. 不切换，继续使用当前环境

请选择要激活的环境 [0-5]:
```

**场景 2: 安装了 Conda 但未激活环境**
```
⚠  检测到 Conda 已安装，但未激活任何环境
ℹ  推荐使用 Conda 环境: mai_notebook

选项：
  1. 继续使用当前 Python 环境
  2. 查看并激活 Conda 环境
  3. 取消操作

请选择 [1-3]:
```

**场景 3: 未安装 Conda**

工具会继续使用当前 Python 环境，并检查依赖是否完整。

#### 创建虚拟环境
支持三种虚拟环境类型：

**Conda 环境**（推荐）
- 可指定 Python 版本（3.11/3.12/3.13）
- 强大的包管理
- 跨平台支持

**venv 环境**
- Python 内置
- 使用系统 Python
- 轻量级

**uv 环境**
- 极快的包管理器
- 可指定 Python 版本
- 现代化工具

```bash
# 交互式创建
./manage.sh create-env

# 然后根据提示选择环境类型
```

#### 查看项目状态
显示完整的项目状态信息：
- Python 环境（Conda 环境名称、Python 版本和路径）
- 关键依赖（FastAPI、Pytest、Redis、SQLAlchemy 的安装状态和版本）
- 数据库状态（数据库文件是否存在及大小）
- Docker 服务（Redis 容器运行状态）
- 配置文件（.env 和 config.toml 是否存在）

```bash
./manage.sh status
```

#### 依赖管理
- 安装所有依赖
- 安装开发依赖
- 更新依赖
- 检查依赖状态
- 导出当前依赖

```bash
./manage.sh deps-install
```

#### 配置管理
管理不同环境的配置文件：
- dev（开发环境）
- prod（生产环境）
- degraded（降级模式，禁用缓存）

```bash
./manage.sh config-show
./manage.sh config-switch prod
./manage.sh config-validate
```

### 2. 服务管理

#### 启动开发服务器
```bash
./manage.sh start-dev
```
特性：
- 自动重载
- 详细的错误堆栈信息
- 自动生成的 API 文档

#### 启动生产服务器
```bash
./manage.sh start-prod
```
特性：
- 多进程运行
- 访问日志记录
- 优化的日志格式

#### Docker 管理
```bash
./manage.sh docker-start   # 启动 Redis
./manage.sh docker-stop    # 停止 Redis
./manage.sh docker-status  # 查看状态
```

### 3. 测试相关

```bash
./manage.sh test           # 运行所有测试（并行模式）
./manage.sh test-unit      # 运行单元测试
./manage.sh test-int       # 运行集成测试
./manage.sh test-cov       # 生成覆盖率报告
./manage.sh test-env       # 检查测试环境
```

### 4. 项目维护

```bash
./manage.sh cleanup        # 清理项目
./manage.sh lint           # 代码质量检查
./manage.sh format         # 代码格式化
./manage.sh db-upgrade     # 升级数据库
./manage.sh logs           # 查看日志
```

### 5. 高级操作

```bash
./manage.sh init-admin     # 初始化超级管理员
```

## 常见问题

```bash
# 环境管理
./manage.sh create-env          # 创建虚拟环境
./manage.sh status              # 查看项目状态
./manage.sh deps-install        # 安装依赖
./manage.sh config-show         # 查看配置
./manage.sh config-switch prod  # 切换到生产环境

# 服务管理
./manage.sh start-dev           # 启动开发服务器
./manage.sh start-prod          # 启动生产服务器
./manage.sh docker-start        # 启动 Redis
./manage.sh docker-stop         # 停止 Redis

# 测试相关
./manage.sh test                # 运行所有测试
./manage.sh test-unit           # 运行单元测试
./manage.sh test-int            # 运行集成测试
./manage.sh test-cov            # 生成覆盖率报告

# 项目维护
./manage.sh cleanup             # 清理项目
./manage.sh lint                # 代码质量检查
./manage.sh format              # 代码格式化
./manage.sh db-upgrade          # 升级数据库

# 其他
./manage.sh init-admin          # 初始化管理员
./manage.sh help                # 查看帮助
```

## 常见问题

### Q: 如何在 CI/CD 中使用？

在 CI/CD 环境中，建议使用直接命令方式：

```bash
./manage.sh test
./manage.sh lint
./manage.sh db-upgrade
```

### Q: Windows 用户如何使用？

推荐使用以下方式之一：

1. **WSL (Windows Subsystem for Linux)** - 推荐
   - 完整的 Linux 环境
   - 最佳兼容性
   - 支持 TUI 模式
   - 安装：`wsl --install`

2. **Git Bash**
   - 轻量级
   - 基本功能可用
   - dialog 支持有限，建议使用 CLI 模式

3. **Cygwin**
   - 完整的 POSIX 环境
   - 需要额外安装
   - 可以安装 dialog

**建议**：Windows 用户直接使用 CLI 模式获得最佳体验：
```bash
./manage.sh --cli
```

### Q: 如何退出交互式菜单？

**TUI 模式**：
- 选择 "0. 退出" 选项
- 或按 ESC 键
- 或按 Ctrl+C

**CLI 模式**：
- 选择 "0. 退出" 选项
- 或按 Ctrl+C

### Q: TUI 界面显示异常怎么办？

如果 TUI 界面显示异常，可能是终端不兼容。尝试：

1. 使用 `--cli` 参数切换到 CLI 模式：
   ```bash
   ./manage.sh --cli
   ```

2. 更新终端模拟器到最新版本

3. 检查 `TERM` 环境变量设置：
   ```bash
   echo $TERM
   ```

4. 如果问题持续，可以卸载 dialog 以永久使用 CLI 模式：
   ```bash
   # macOS
   brew uninstall dialog
   
   # Ubuntu/Debian
   sudo apt-get remove dialog
   ```

## 高级功能

### 配置环境切换

支持三种配置环境：

- **dev** (开发环境) - 默认，使用 `configs/config.dev.toml`
- **prod** (生产环境) - 使用 `configs/config.prod.toml`
- **degraded** (降级模式) - 使用 `configs/config.degraded.toml`，禁用缓存

切换方式：

```bash
# 使用 TUI 模式
./manage.sh
# 选择: 环境管理 → 配置管理 → 切换环境

# 使用 CLI 命令
./manage.sh config-switch prod

# 设置环境变量
export CONFIG_ENV=prod
./manage.sh start-dev
```

### 虚拟环境管理

支持三种虚拟环境：

1. **Conda 环境**（推荐）
   - 可指定 Python 版本（3.11/3.12/3.13）
   - 强大的包管理
   - 跨平台支持

2. **venv 环境**
   - Python 内置
   - 使用系统 Python
   - 轻量级

3. **uv 环境**
   - 极快的包管理器
   - 可指定 Python 版本
   - 现代化工具

### 测试配置

测试配置文件位于 `tests/.test_env`：

```bash
# 是否启用并行测试
TEST_PARALLEL=true

# 并行工作进程数
TEST_WORKERS=auto

# 推荐的 Conda 环境
RECOMMENDED_CONDA_ENV=mai_notebook

# 额外的 pytest 参数
TEST_EXTRA_ARGS=
```

## 故障排除

### dialog 未安装

如果看到以下提示，说明系统未安装 `dialog` 工具：

```
# 管理工具会自动回退到 CLI 模式
```

你可以选择：

1. **安装 dialog**（推荐）：
   ```bash
   # macOS
   brew install dialog
   
   # Ubuntu/Debian
   sudo apt-get install dialog
   
   # CentOS/RHEL
   sudo yum install dialog
   ```

2. **继续使用 CLI 模式**：
   - CLI 模式功能完全相同，只是界面不同
   - 使用 `--cli` 参数可以跳过 dialog 检测

### TUI 界面显示异常

如果 TUI 界面显示异常，可能是终端不兼容。尝试：

1. 使用 `--cli` 参数切换到 CLI 模式
2. 更新终端模拟器
3. 检查 `TERM` 环境变量设置

### 权限问题

如果遇到权限问题：

```bash
# 给脚本添加执行权限
chmod +x manage.sh

# 如果需要 sudo 权限
sudo ./manage.sh
```

## 贡献

欢迎提交问题和改进建议！

## 许可证

[项目许可证信息]
