# 环境检测功能说明

## 概述

管理工具 (`manage.sh`) 内置了智能的 Conda 环境检测功能，能够自动识别当前环境状态，并在需要时提供友好的环境切换选项。

## 功能特性

### 1. 自动检测 Conda 安装状态

- ✅ 检测系统是否安装了 Conda
- ✅ 检测当前是否激活了 Conda 环境
- ✅ 识别当前激活的环境名称

### 2. 智能环境建议

根据 `tests/.test_env` 配置文件中的 `RECOMMENDED_CONDA_ENV` 设置，自动判断当前环境是否为推荐环境。

### 3. 交互式环境切换

当检测到环境不匹配时，提供友好的交互式选项，让用户可以：
- 查看所有可用的 Conda 环境
- 通过编号快速选择要激活的环境
- 清晰标识当前环境和推荐环境

## 使用场景

### 场景 1: 当前环境不是推荐环境

**触发条件：**
- 已激活 Conda 环境
- 当前环境名称与推荐环境不匹配

**交互流程：**

```bash
$ ./manage.sh test

⚠  当前 Conda 环境: base
⚠  推荐使用环境: mai_notebook

选项：
  1. 继续使用当前环境
  2. 查看并切换到其他环境
  3. 取消操作

请选择 [1-3]: 2

============================================================================
Conda 环境选择
============================================================================

可用的 Conda 环境：

  1. base (当前)
  2. mai_notebook (推荐)
  3. AlbumVision
  4. MaiBotEnv
  5. yysKnowledgeBase

  0. 不切换，继续使用当前环境

请选择要激活的环境 [0-5]: 2

ℹ  正在激活环境: mai_notebook

⚠  由于 shell 限制，无法在脚本中直接激活环境
ℹ  请在新的终端中运行以下命令：

  conda activate mai_notebook
  ./manage.sh
```

**用户操作：**
1. 选择选项 2 查看环境列表
2. 输入环境编号（如 2）
3. 在新终端中执行提示的命令

### 场景 2: 安装了 Conda 但未激活环境

**触发条件：**
- 系统已安装 Conda
- 未激活任何 Conda 环境（使用系统 Python）

**交互流程：**

```bash
$ ./manage.sh test

⚠  检测到 Conda 已安装，但未激活任何环境
ℹ  推荐使用 Conda 环境: mai_notebook

选项：
  1. 继续使用当前 Python 环境
  2. 查看并激活 Conda 环境
  3. 取消操作

请选择 [1-3]: 2

============================================================================
Conda 环境选择
============================================================================

可用的 Conda 环境：

  1. base
  2. mai_notebook (推荐)
  3. AlbumVision
  ...
```

### 场景 3: 未安装 Conda

**触发条件：**
- 系统未安装 Conda

**交互流程：**

```bash
$ ./manage.sh test

⚠  未检测到 Conda
ℹ  推荐使用 Conda 环境: mai_notebook

是否继续？[y/N]: y

ℹ  Python 版本: 3.12.12
ℹ  检查关键依赖...
✓ 所有关键依赖已安装
```

工具会继续使用当前 Python 环境，并检查依赖完整性。

### 场景 4: 当前环境正确

**触发条件：**
- 当前激活的环境与推荐环境匹配

**交互流程：**

```bash
$ ./manage.sh test

✓ Conda 环境: mai_notebook
ℹ  Python 版本: 3.12.12
ℹ  检查关键依赖...
✓ 所有关键依赖已安装
```

直接继续执行，无需用户干预。

## 环境列表显示

环境列表会清晰标识：

- **(当前)** - 当前激活的环境，用绿色标识
- **(推荐)** - 推荐使用的环境，用青色标识

```
可用的 Conda 环境：

  1. base (当前)          ← 绿色标识
  2. mai_notebook (推荐)  ← 青色标识
  3. AlbumVision
  4. MaiBotEnv
```

## 技术限制

### Shell 环境限制

由于 Bash 脚本的限制，无法在子 shell 中直接激活 Conda 环境。因此，当用户选择切换环境时，脚本会：

1. 显示需要执行的命令
2. 提示用户在新终端中手动执行
3. 返回错误码，停止当前操作

**解决方案：**

用户需要：
1. 打开新终端（或在当前终端）
2. 执行 `conda activate <环境名>`
3. 重新运行 `./manage.sh`

### 为什么不能自动激活？

Conda 的 `activate` 命令需要修改当前 shell 的环境变量，这在子 shell（脚本执行环境）中无法影响父 shell（用户的终端）。

**技术细节：**
- `conda activate` 实际上是一个 shell 函数，不是独立的可执行文件
- 它需要修改 `PATH`、`CONDA_DEFAULT_ENV` 等环境变量
- 这些修改只在当前 shell 会话中有效
- 子 shell 的环境变量修改不会传递到父 shell

## 配置

### 设置推荐环境

编辑 `tests/.test_env` 文件：

```bash
# 推荐的 Conda 环境名称
RECOMMENDED_CONDA_ENV=mai_notebook
```

### 禁用环境检测

如果不想使用环境检测功能，可以：

1. **清空推荐环境配置：**
   ```bash
   RECOMMENDED_CONDA_ENV=
   ```

2. **在命令行中选择"继续使用当前环境"**

## 最佳实践

### 1. 创建专用环境

为项目创建专用的 Conda 环境：

```bash
./manage.sh create-env
# 选择 Conda 环境
# 输入环境名称: mai_notebook
```

### 2. 配置推荐环境

在 `tests/.test_env` 中设置：

```bash
RECOMMENDED_CONDA_ENV=mai_notebook
```

### 3. 激活环境后使用

```bash
conda activate mai_notebook
./manage.sh test
```

### 4. 团队协作

团队成员应该：
1. 使用相同的环境名称
2. 遵循 `tests/.test_env` 中的推荐配置
3. 在运行测试前确保环境正确

## 故障排除

### Q: 为什么选择环境后还需要手动激活？

A: 这是 Bash 脚本的技术限制。脚本运行在子 shell 中，无法修改父 shell（你的终端）的环境变量。

### Q: 如何快速切换环境？

A: 使用 Conda 的快捷命令：

```bash
# 方法 1: 直接激活
conda activate mai_notebook

# 方法 2: 使用别名（添加到 ~/.bashrc 或 ~/.zshrc）
alias mai='conda activate mai_notebook'
```

### Q: 环境列表为空怎么办？

A: 检查：
1. Conda 是否正确安装：`conda --version`
2. 是否有创建的环境：`conda env list`
3. 如果没有环境，使用 `./manage.sh create-env` 创建

### Q: 如何跳过环境检测？

A: 在提示时选择"继续使用当前环境"（选项 1）。

## 相关文档

- [管理工具使用指南](./管理工具使用指南.md)
- [管理工具快速参考](./管理工具快速参考.md)
