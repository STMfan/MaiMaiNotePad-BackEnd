# 配置管理文档

## 概述

MaiMNP 后端使用统一的配置管理系统，支持从多个来源加载配置：

- **环境变量 (.env)** - 最高优先级，用于敏感信息和环境差异配置
- **config.toml 文件** - 中等优先级，用于业务规则和通用配置
- **默认值** - 最低优先级，代码中的默认值

## 配置分工原则

### 环境配置 (.env)
**用途**: 敏感信息、环境差异配置

**适用场景**:
- 密码、密钥等敏感信息
- 不同环境（开发/测试/生产）需要不同值的配置
- 不应提交到版本控制的配置

**示例**:
- `JWT_SECRET_KEY` - JWT 签名密钥
- `SUPERADMIN_PWD` - 管理员密码
- `DATABASE_URL` - 数据库连接（不同环境不同）
- `MAIL_PWD` - 邮箱授权码

### 业务配置 (config.toml)
**用途**: 业务规则、功能参数、通用配置

**适用场景**:
- 业务逻辑参数
- 功能开关
- 所有环境通用的配置
- 可以提交到版本控制的配置

**示例**:
- `upload.avatar.max_size_mb` - 头像大小限制
- `pagination.default_page_size` - 默认分页大小
- `security.max_failed_login_attempts` - 最大登录失败次数

## 配置文件

### 配置文件目录结构

```
configs/
├── config.toml              # 业务配置文件（不提交到 Git）
├── alembic.ini              # Alembic 数据库迁移配置
└── templates/               # 配置模板目录
    ├── config.toml.template # 业务配置模板
    └── .env.template        # 环境配置模板

项目根目录/
├── .env                     # 环境配置文件（不提交到 Git）
├── alembic.ini              # 符号链接 → configs/alembic.ini
└── pytest.ini               # 符号链接 → configs/pytest.ini
```

### .env
环境配置文件，包含敏感信息和环境差异配置。此文件不应提交到版本控制系统。

**位置**: `.env`（项目根目录）

### config.toml
业务配置文件，包含业务规则和通用配置。此文件不应提交到版本控制系统。

**位置**: `configs/config.toml`

### 配置模板
- `.env.template` - 环境配置模板
- `config.toml.template` - 业务配置模板

新部署时应复制模板文件并根据实际情况修改。

## 配置优先级

配置加载遵循以下优先级（从高到低）：

1. **环境变量 (.env)** - 最高优先级，用于敏感信息和环境差异
2. **config.toml** - 中等优先级，用于业务规则
3. **默认值** - 最低优先级，代码中的默认值

## 配置项说明

### 环境配置 (.env)

#### 密钥和密码（必需）

```bash
# JWT 密钥（必需）
JWT_SECRET_KEY=your_secret_key_here

# 超级管理员密码（必需）
SUPERADMIN_PWD=admin123456

# 最高权限密码（必需）
HIGHEST_PASSWORD=your_highest_password

# 邮箱授权码（必需）
MAIL_PWD=your_email_authorization_code
```

#### 环境差异配置

```bash
# 数据库连接
DATABASE_URL=sqlite:///data/mainnp.db

# 服务器配置
HOST=0.0.0.0
PORT=9278

# 邮箱配置
MAIL_HOST=smtp.qq.com
MAIL_USER=your_email@qq.com
MAIL_PORT=465

# 日志级别
LOG_LEVEL=INFO
```

#### 可选配置

```bash
# 外部域名
EXTERNAL_DOMAIN=example.com

# 上传目录
UPLOAD_DIR=uploads
```

### 业务配置 (config.toml)

#### 应用配置 [app]

```toml
[app]
name = "MaiMNP Backend"      # 应用名称
# 注意：版本号从 app/__version__.py 自动读取
```

**版本号管理**：
- 版本号从 `app/__version__.py` 自动读取
- 不需要在 `config.toml` 中配置
- 详见 [版本管理指南](./版本管理.md)

#### JWT 配置 [jwt]

```toml
[jwt]
algorithm = "HS256"
access_token_expire_minutes = 15
refresh_token_expire_days = 7
```

**注意**: `JWT_SECRET_KEY` 必须从环境变量读取

#### 邮件配置 [email]

```toml
[email]
timeout = 30
```

**注意**: `MAIL_USER` 和 `MAIL_PWD` 必须从环境变量读取

#### 管理员配置 [admin]

```toml
[admin]
superadmin_username = "superadmin"
```

**注意**: `SUPERADMIN_PWD` 和 `HIGHEST_PASSWORD` 必须从环境变量读取

#### 日志配置 [logging]

```toml
[logging]
file = "logs/app.log"
format = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
```

**注意**: `LOG_LEVEL` 从环境变量读取

#### 上传配置 [upload]

```toml
[upload]
max_file_size_mb = 100

[upload.avatar]
max_size_mb = 2
max_dimension = 1024
thumbnail_size = 128
allowed_formats = [".jpg", ".jpeg", ".png", ".gif", ".webp"]

[upload.knowledge]
max_files = 100
allowed_types = [".txt", ".json"]

[upload.persona]
max_files = 1
allowed_types = [".toml"]
```
- `UPLOAD_DIR` - 覆盖上传目录
- `MAX_FILE_SIZE_MB` - 覆盖最大文件大小

### JWT 配置 [jwt]

```toml
[jwt]
algorithm = "HS256"                    # JWT 算法
expiration_hours = 24                  # Token 过期时间（小时）
access_token_expire_minutes = 15       # 访问令牌过期时间（分钟）
refresh_token_expire_days = 7          # 刷新令牌过期时间（天）
```

环境变量（必需）：
- `JWT_SECRET_KEY` - JWT 密钥（必须从环境变量读取）
- `JWT_ALGORITHM` - 覆盖算法
- `JWT_EXPIRATION_HOURS` - 覆盖过期时间
- `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` - 覆盖访问令牌过期时间
- `JWT_REFRESH_TOKEN_EXPIRE_DAYS` - 覆盖刷新令牌过期时间

### 邮件配置 [email]

```toml
[email]
host = "smtp.qq.com"          # SMTP 服务器地址
port = 465                    # SMTP 端口
timeout = 30                  # 连接超时（秒）
```

环境变量（必需）：
- `MAIL_USER` - 邮箱用户名（必须从环境变量读取）
- `MAIL_PWD` - 邮箱密码（必须从环境变量读取）
- `MAIL_HOST` - 覆盖 SMTP 服务器
- `MAIL_PORT` - 覆盖 SMTP 端口
- `MAIL_TIMEOUT` - 覆盖超时时间

### 管理员配置 [admin]

```toml
[admin]
superadmin_username = "superadmin"    # 超级管理员用户名
external_domain = "example.com"       # 外部域名
```

环境变量（必需）：
- `SUPERADMIN_PWD` - 超级管理员密码（必须从环境变量读取）
- `HIGHEST_PASSWORD` - 最高权限密码（必须从环境变量读取）
- `SUPERADMIN_USERNAME` - 覆盖超级管理员用户名
- `EXTERNAL_DOMAIN` - 覆盖外部域名

### 日志配置 [logging]

```toml
[logging]
level = "INFO"                # 日志级别
file = "logs/app.log"         # 日志文件路径
```

环境变量：
- `LOG_LEVEL` - 覆盖日志级别
- `LOG_FILE` - 覆盖日志文件路径

### 安全配置 [security]

```toml
[security]
bcrypt_rounds = 12                      # Bcrypt 哈希轮数
max_failed_login_attempts = 5           # 最大登录失败次数
account_lock_duration_minutes = 30      # 账户锁定时长（分钟）
```

环境变量：
- `PASSLIB_BCRYPT_ROUNDS` - 覆盖 Bcrypt 轮数（测试环境可用）

### 邮箱验证配置 [email_verification]

```toml
[email_verification]
code_expire_minutes = 2                 # 验证码有效期（分钟）
hourly_limit = 5                        # 每小时发送限制
minute_limit = 1                        # 每分钟发送限制
```

### 分页配置 [pagination]

```toml
[pagination]
default_page_size = 20                  # 默认分页大小
max_page_size = 100                     # 最大分页大小
admin_default_page_size = 10            # 管理员默认分页大小
```

### 审核配置 [moderation]

```toml
[moderation]
mute_durations = ["1d", "7d", "30d", "permanent"]    # 禁言时长选项
ban_durations = ["1d", "7d", "30d", "permanent"]     # 封禁时长选项
```

### 统计配置 [statistics]

```toml
[statistics]
min_trend_days = 1                      # 趋势统计最小天数
max_trend_days = 90                     # 趋势统计最大天数
default_trend_days = 30                 # 趋势统计默认天数
```

## 使用配置管理器

### 在代码中使用

```python
from app.core.config_manager import config_manager

# 获取配置值
max_size = config_manager.get("upload.avatar.max_size_mb", default=2)

# 获取配置值（带环境变量覆盖）
jwt_key = config_manager.get("jwt.secret_key", env_var="JWT_SECRET_KEY")

# 获取整数配置
port = config_manager.get_int("app.port", default=9278, env_var="PORT")

# 获取布尔配置
debug = config_manager.get_bool("app.debug", default=False, env_var="DEBUG")

# 获取列表配置
allowed_formats = config_manager.get_list("upload.avatar.allowed_formats")

# 获取整个配置节
avatar_config = config_manager.get_section("upload.avatar")
```

### 使用 Settings 类

```python
from app.core.config import settings

# 直接访问配置
app_name = settings.APP_NAME
database_url = settings.DATABASE_URL
jwt_secret = settings.JWT_SECRET_KEY
```

## 部署指南

### 1. 创建配置文件

```bash
# 复制环境变量模板
cp configs/templates/.env.template .env

# 复制应用配置模板
cp configs/templates/config.toml.template configs/config.toml
```

### 2. 编辑配置文件

根据实际情况修改 `configs/config.toml` 中的配置项。

### 3. 设置环境变量

编辑 `.env` 文件并设置敏感信息：

```bash
# JWT 配置
JWT_SECRET_KEY=your-secret-key-here

# 邮件配置
MAIL_USER=your-email@example.com
MAIL_PWD=your-email-password

# 管理员配置
SUPERADMIN_PWD=your-admin-password
HIGHEST_PASSWORD=your-highest-password
```

### 4. 测试环境配置

测试环境使用独立的配置：

- 测试环境变量文件：`tests/.test_env`
- 测试上传目录：`test_uploads/`（自动清理）
- 测试数据库：独立的测试数据库文件

## 安全建议

1. **永远不要将敏感信息提交到版本控制系统**
   - JWT 密钥
   - 数据库密码
   - 邮箱密码
   - 管理员密码

2. **使用环境变量存储敏感信息**
   - 在生产环境中使用环境变量
   - 在开发环境中使用 `.env` 文件（已在 `.gitignore` 中）

3. **定期更新密钥**
   - 定期更换 JWT 密钥
   - 定期更换管理员密码

4. **使用强密码**
   - JWT 密钥应至少 32 个字符
   - 管理员密码应包含大小写字母、数字和特殊字符

## 故障排查

### 配置未生效

1. 检查配置文件是否存在：`configs/config.toml`
2. 检查配置文件语法是否正确（TOML 格式）
3. 检查环境变量是否正确设置
4. 检查配置优先级（环境变量 > config.toml > 默认值）

### 找不到配置文件

配置管理器会在以下位置查找 `config.toml`：

1. `configs/config.toml`（项目根目录下的 configs 文件夹）
2. 如果未找到，使用默认配置

### 配置值类型错误

确保配置值类型正确：

- 字符串：`"value"`
- 整数：`123`
- 布尔：`true` 或 `false`
- 列表：`["item1", "item2"]`

## 更新日志

- 2026-02-22: 创建统一配置管理系统
  - 添加 `config.toml` 配置文件
  - 添加 `ConfigManager` 配置管理器
  - 更新所有模块使用配置管理器
  - 添加配置模板文件
