# Scripts 脚本目录

本目录包含项目维护、测试和开发相关的脚本工具。

## ⚠️ 重要说明

**所有脚本都必须从项目根目录运行**，不要在 `scripts/` 目录下运行。

正确示例：
```bash
# 在项目根目录下运行
python scripts/python/reset_security_env.py
bash scripts/shell/cleanup.sh
```

错误示例：
```bash
# ❌ 不要这样做
cd scripts/python
python reset_security_env.py  # 会找不到 .env 文件
```

## 📁 目录结构

```
scripts/
├── 脚本说明.md        # 本文档
├── python/            # Python 脚本
│   ├── check_superadmin.py
│   ├── check_version.py
│   ├── generate_error_codes_doc.py
│   ├── generate_test_templates.py
│   ├── init_superadmin.py
│   ├── log_analyzer.py
│   ├── reset_security_env.py
│   └── test_email.py
└── shell/             # Shell 脚本
    ├── alembic.sh
    ├── cleanup.sh
    └── run_parallel_isolation_tests.sh
```

## 🐍 Python 脚本

### check_superadmin.py
**功能**: 超级管理员诊断工具

**用途**:
- 检查环境变量配置
- 验证数据库中的超级管理员账户
- 测试密码是否正确
- 诊断登录问题

**使用方法**:
```bash
python scripts/python/check_superadmin.py
```

**输出示例**:
```
============================================================
超级管理员诊断工具
============================================================

1. 检查环境变量配置
------------------------------------------------------------
SUPERADMIN_USERNAME: superadmin
SUPERADMIN_PWD: *********** (长度: 43)
EXTERNAL_DOMAIN: example.com
DATABASE_URL: sqlite:///data/mainnp.db

2. 连接数据库
------------------------------------------------------------
✅ 数据库连接成功

3. 查询超级管理员账户
------------------------------------------------------------
✅ 找到超级管理员账户
   用户名: superadmin
   邮箱: superadmin@example.com
   是否激活: True

4. 验证密码
------------------------------------------------------------
✅ 密码验证成功

登录信息:
   用户名: superadmin
   密码: your_password_here
```

**适用场景**:
- 清库后无法登录
- 忘记超级管理员密码
- 验证配置是否正确

---

### init_superadmin.py
**功能**: 初始化超级管理员账户

**用途**:
- 手动创建超级管理员账户
- 清库后重新初始化
- 修复超级管理员缺失问题

**使用方法**:
```bash
python scripts/python/init_superadmin.py
```

**交互示例**:
```
============================================================
初始化超级管理员
============================================================

用户名: superadmin
密码: ***********
邮箱: superadmin@example.com

确认创建超级管理员? (yes/no): yes

正在创建超级管理员...
✅ 超级管理员创建成功

登录信息:
   用户名: superadmin
   密码: your_password_here
```

**注意事项**:
- 如果超级管理员已存在，不会重复创建
- 密码从 .env 文件的 SUPERADMIN_PWD 读取
- 创建后可以立即使用该账户登录

---

### check_version.py
**功能**: 版本号检查工具

**用途**:
- 验证版本号配置是否正确
- 检查所有位置的版本号是否一致
- 显示版本历史记录
- 确认动态版本号配置工作正常

**使用方法**:
```bash
python scripts/python/check_version.py
```

**输出示例**:
```
============================================================
版本号检查
============================================================

✓ app.__version__.__version__: 2.0.0
✓ app.__version__.__version_info__: (2, 0, 0)
✓ app.__version__: 2.0.0
✓ settings.APP_VERSION: 2.0.0
✓ pyproject.toml dynamic: ['version']
✓ version source: app.__version__.__version__

版本历史:
  • 2.0.0: 2026-02-22 - 项目重构完成

============================================================
✅ 当前版本: 2.0.0
✅ 版本号配置正确！
============================================================

💡 提示：
   要更新版本号，只需修改 app/__version__.py 文件
   pyproject.toml 会自动从那里读取版本号
```

**相关文档**: [版本管理指南](../docs/development/版本管理.md)

---

### generate_error_codes_doc.py
**功能**: 自动生成错误码文档

**用途**:
- 从 `app/error_messages.json` 读取错误消息
- 自动生成 `docs/README_ERROR_CODES.md` 文档
- 按模块分类错误码
- 包含中英文错误消息

**使用方法**:
```bash
python scripts/python/generate_error_codes_doc.py
```

**输出**: `docs/README_ERROR_CODES.md`

---

### generate_test_templates.py
**功能**: 测试模板生成器

**用途**:
- 分析代码覆盖率，找出未覆盖的代码
- 自动为覆盖率低的文件生成测试模板
- 帮助提升测试覆盖率（当前：91%）

**前置条件**:
```bash
# 1. 先生成覆盖率报告
pytest --cov=app --cov-report=json --cov-report=term-missing

# 这会生成 coverage.json 文件
```

**使用方法**:
```bash
python scripts/python/generate_test_templates.py
```

**输出**: 
- 显示覆盖率最低的 10 个文件
- 为覆盖率低于 50% 的文件生成测试模板
- 测试文件保存在 `tests/test_*_generated.py`

**注意**:
- 生成的测试只是模板，需要手动完善
- 不会覆盖已存在的测试文件
- 建议定期运行以识别未测试的代码

**示例输出**:
```
发现 15 个文件需要提升覆盖率:
  app/utils/helper.py: 45.2% (23 行未覆盖)
  app/services/cache.py: 67.8% (12 行未覆盖)
  
生成测试模板...
  ✓ 生成: tests/test_utils_helper_generated.py
  ⊗ 跳过: tests/test_services_cache_generated.py (已存在)
```

---

### log_analyzer.py
**功能**: 智能日志分析工具

**用途**:
- 根据错误信息自动检索日志
- 支持多种搜索条件（状态码、错误码、请求ID、关键词）
- 显示日志上下文
- 统计分析日志信息

**使用方法**:
```bash
python scripts/python/log_analyzer.py
```

**交互示例**:
```
============================================================
智能日志分析工具
============================================================

使用说明:
  输入包含错误信息的文本，工具会自动提取关键信息并搜索日志
  支持识别: 状态码、错误码、请求ID、关键词

多行输入:
  - 可以粘贴多行日志内容
  - 输入空行结束输入并开始搜索
  - 或者单行输入后直接回车

示例:
  该邮箱已被注册 状态码 422 错误码 40022 请求ID fc972dbc-770f-455c-98d3-ad0dad100395
  用户登录失败 错误码 40001
  500 Internal Server Error

命令:
  q/quit/exit - 退出程序
  clear/cls   - 清屏
============================================================

请输入查询内容（多行输入请以空行结束）:
> 2026-02-22 12:14:38,971 - WARNING - API 错误: POST /api/auth/send_verification_code
  ID=8af98bd3-1c72-46c8-b9fb-8db4d542fe35 - Type=API_ERROR
  Message=发送验证码失败: 邮件发送失败
  INFO: 127.0.0.1:53598 - "POST /api/auth/send_verification_code HTTP/1.1" 400 Bad Request
  (输入空行结束)

🔍 提取的搜索条件:
  请求ID: 8af98bd3-1c72-46c8-b9fb-8db4d542fe35
  状态码: 400
  关键词: 发送验证码失败, 邮件发送失败

🔍 提取的搜索条件:
  请求ID: fc972dbc-770f-455c-98d3-ad0dad100395
  错误码: 40022
  状态码: 422
  关键词: 该邮箱已被注册

🔎 正在搜索日志...

============================================================
日志分析结果
============================================================

📊 统计信息
------------------------------------------------------------
找到记录数: 3
时间范围: 2026-02-22 12:14:38 ~ 2026-02-22 12:14:39
日志级别: ERROR(1), WARNING(2)
错误码: 40022
状态码: 422
请求ID数量: 1

📝 详细记录
------------------------------------------------------------

[1] maimnp.log:1234
    时间: 2026-02-22 12:14:38
    级别: WARNING
    匹配: 请求ID: fc972dbc-770f-455c-98d3-ad0dad100395
    内容: API 错误: POST /api/auth/register - ID=fc972dbc-770f-455c-98d3-ad0dad100395 - Type=API_ERROR - Message=该邮箱已被注册
    上下文:
        2026-02-22 12:14:37 - INFO - 收到注册请求: email=user@example.com
      → API 错误: POST /api/auth/register - ID=fc972dbc-770f-455c-98d3-ad0dad100395 - Type=API_ERROR - Message=该邮箱已被注册
        2026-02-22 12:14:38 - INFO - 返回响应: 422 Unprocessable Entity

[2] maimnp.log:1235
    时间: 2026-02-22 12:14:38
    级别: ERROR
    匹配: 错误码: 40022
    内容: 注册失败: 错误码 40022 - 该邮箱已被注册
    ...
```

**支持的搜索条件**:
- **请求ID**: 自动识别 UUID 格式的请求ID
- **错误码**: 自动识别 5 位数字的错误码
- **状态码**: 自动识别 3 位数字的 HTTP 状态码
- **关键词**: 自动提取中文关键词

**特性**:
- ✅ 智能提取搜索条件
- ✅ 显示日志上下文（前后各2行）
- ✅ 彩色输出（按日志级别）
- ✅ 统计分析（时间范围、日志级别、错误码等）
- ✅ 交互式查询
- ✅ 支持多个日志文件

**适用场景**:
- 快速定位错误日志
- 追踪请求处理流程
- 分析错误模式
- 问题排查和调试

---

### test_email.py
**功能**: 邮件配置测试工具

**用途**:
- 测试邮件服务器连接
- 验证邮箱认证
- 发送测试邮件
- 诊断邮件配置问题

**使用方法**:
```bash
python scripts/python/test_email.py
```

**输出示例**:
```
============================================================
邮件配置测试工具
============================================================

当前配置:
  MAIL_HOST: mail.example.com
  MAIL_USER: user@example.com
  MAIL_PWD: *********** (长度: 16)
  MAIL_PORT: 587
  MAIL_TIMEOUT: 30

============================================================
测试 1: 连接到邮件服务器
============================================================
使用 SMTP 连接到 mail.example.com:587...
尝试 STARTTLS...
✅ 连接成功

============================================================
测试 2: 邮箱认证
============================================================
尝试登录: user@example.com
✅ 认证成功

============================================================
测试 3: 发送测试邮件
============================================================
请输入测试收件人邮箱（留空跳过发送测试）: test@example.com
发送测试邮件到 test@example.com...
✅ 邮件发送成功

============================================================
✅ 所有测试通过！邮件配置正确
============================================================
```

**失败时的诊断信息**:
```
❌ 认证失败: (535, b'5.7.8 Error: authentication failed')

可能的原因:
1. 邮箱密码错误
2. 需要使用授权码而不是密码
3. 用户名格式错误（可能需要完整邮箱地址）

建议:
- 检查 MAIL_USER 是否需要完整邮箱地址（如 user@example.com）
- 检查是否需要在邮箱后台开启 SMTP 服务并生成授权码
- 确认 MAIL_PWD 是否正确
```

**适用场景**:
- 配置新的邮件服务器
- 排查邮件发送问题
- 验证邮箱授权码
- 测试不同端口和加密方式

---

### reset_security_env.py
**功能**: 清档脚本 - 完整的环境重置工具

**用途**:
- 重新生成 JWT 密钥、超级管理员密码、最高权限密码
- 删除并重新初始化数据库
- 清空 uploads 和 logs 目录
- 自动初始化超级管理员账户
- 验证超级管理员账户是否正确
- 用于本机开发测试或上线前清档

**使用方法**:
```bash
# 必须从项目根目录运行
python scripts/python/reset_security_env.py
```

**执行流程**:
```
1. 确认操作（输入 RESET）
   ↓
2. 更新环境配置（生成新密钥和密码）
   ↓
3. 重置数据库（删除并重建）
   ↓
4. 清理文件（清空 uploads 和 logs）
   ↓
5. 初始化超级管理员
   ↓
6. 验证超级管理员
   ↓
7. 显示登录信息
```

**输出示例**:
```
============================================================
清档脚本 - 重置安全环境
============================================================

步骤 1/5: 更新环境配置
------------------------------------------------------------
安全配置已写入 .env：
JWT_SECRET_KEY=...
SUPERADMIN_PWD=...
HIGHEST_PASSWORD=...

步骤 2/5: 重置数据库
------------------------------------------------------------
数据库已使用 Alembic 重新创建

步骤 3/5: 清理文件
------------------------------------------------------------
uploads 与 logs 目录内容已清空

步骤 4/5: 初始化超级管理员
------------------------------------------------------------
✅ 超级管理员创建成功
   用户名: superadmin
   密码: xxx
   邮箱: superadmin@example.com

步骤 5/5: 验证超级管理员
------------------------------------------------------------
✅ 超级管理员验证成功
   用户ID: xxx
   用户名: superadmin
   邮箱: superadmin@example.com

============================================================
清档完成
============================================================

✅ 所有步骤执行成功

登录信息：
   用户名: superadmin
   密码: xxx

下一步：
   启动应用: python -m uvicorn app.main:app --host 0.0.0.0 --port 9278
   或使用: ./manage.sh start-dev
```

**警告**: 
- ⚠️ 此操作不可撤销
- ⚠️ 仅用于开发环境或上线前清档
- ⚠️ 切勿在正在运行的生产机器上执行
- ⚠️ 会删除所有数据库数据和上传文件

**优势**:
- ✅ 一键完成所有清档操作
- ✅ 自动初始化超级管理员
- ✅ 自动验证账户正确性
- ✅ 清晰的步骤提示
- ✅ 失败时给出明确的解决方案

---

## 🐚 Shell 脚本

### cleanup.sh
**功能**: 项目清理脚本（增强版）

**清理内容**:

1. **Python 缓存**
   - `__pycache__` 目录
   - `*.pyc`, `*.pyo`, `*.pyd` 文件

2. **测试相关**
   - `.pytest_cache`, `.hypothesis` 缓存
   - `.coverage`, `htmlcov` 覆盖率文件
   - `.tox`, `.mypy_cache`, `.ruff_cache`
   - 测试数据库 (`test_*.db*`)
   - 测试日志和临时文件

3. **构建产物**
   - `build/`, `dist/` 目录
   - `*.egg-info`, `.eggs/` 目录

4. **编辑器临时文件**
   - Vim: `*~`, `*.swp`, `*.swo`, `*.swn`
   - Emacs: `#*#`, `.#*`
   - VS Code: `.vscode/.ropeproject`

5. **系统临时文件**
   - macOS: `.DS_Store`, `._*`
   - Windows: `Thumbs.db`, `desktop.ini`
   - SQLite: `*.db-journal`, `*.db-wal`, `*.db-shm`

6. **可选清理**（需要确认）
   - 日志文件 (`logs/*.log`)
   - pip 缓存
   - 备份文件 (`*.bak`, `*.backup`, `*.old`)

**使用方法**:
```bash
bash scripts/shell/cleanup.sh
```

**特性**:
- ✅ 彩色输出，清晰易读
- ✅ 显示清理统计信息
- ✅ 可选清理项需要用户确认
- ✅ 安全错误处理

**建议**: 
- 每周运行一次保持项目整洁
- 提交代码前运行
- 切换分支前运行

**示例输出**:
```
🧹 开始清理项目...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ℹ️  📦 清理 Python 缓存...
✅   清理了 45 个 __pycache__ 目录
✅   清理了 123 个 .pyc 文件

ℹ️  🧪 清理测试相关文件...
✅   清理了 .pytest_cache
✅   清理了 15 个测试数据库文件

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ ✨ 清理完成！共清理了 183 项
```

---

### run_parallel_isolation_tests.sh
**功能**: 运行并行隔离测试

**用途**:
- 单独运行并行隔离测试
- 验证测试套件的并行执行隔离性
- 测试缓存隔离、依赖注入隔离等

**使用方法**:
```bash
bash scripts/shell/run_parallel_isolation_tests.sh
```

**说明**: 这些测试内部会启动并行测试，不应在主测试套件中运行

**输出示例**:
```
==========================================
Running Parallel Isolation Tests
==========================================

Test 1: Parallel Execution Isolation
--------------------------------------
✓ PASSED

Test 2: Authenticated Client Isolation
--------------------------------------
✓ PASSED

Test 3: Single Test Execution Preservation
--------------------------------------
✓ PASSED

==========================================
Summary
==========================================
✓ All parallel isolation tests passed
```

---

## 📋 使用场景

### 日常开发
```bash
# 检查版本号
python scripts/python/check_version.py

# 清理项目
bash scripts/shell/cleanup.sh

# 生成错误码文档
python scripts/python/generate_error_codes_doc.py

# 运行集成测试
pytest tests/integration/
```

### 测试相关
```bash
# 运行所有测试
pytest

# 运行集成测试
pytest tests/integration/

# 运行并行隔离测试
bash scripts/shell/run_parallel_isolation_tests.sh

# 清理项目（包括测试文件）
bash scripts/shell/cleanup.sh
```

### 文档维护
```bash
# 生成错误码文档
python scripts/python/generate_error_codes_doc.py
```

### 测试覆盖率提升
```bash
# 1. 生成覆盖率报告
pytest --cov=app --cov-report=json --cov-report=term-missing

# 2. 生成测试模板
python scripts/python/generate_test_templates.py

# 3. 完善生成的测试
# 编辑 tests/test_*_generated.py 文件

# 4. 运行新测试
pytest tests/test_*_generated.py
```

### 环境配置
```bash
# 重置安全环境（仅开发环境）
# ⚠️ 必须从项目根目录运行
python scripts/python/reset_security_env.py
```

**重要提示**:
- 脚本会要求输入 `RESET` 确认
- 会重新生成 JWT 密钥、超级管理员密码、最高权限密码
- 会删除并重新初始化数据库
- 会清空 uploads 和 logs 目录
- 此操作不可撤销，仅用于开发环境或上线前清档

---

## 🔧 维护建议

1. **定期清理**: 每周运行 `cleanup.sh` 保持项目整洁
2. **测试验证**: 使用 `run_parallel_isolation_tests.sh` 验证并行隔离
3. **文档同步**: 修改错误消息后运行 `generate_error_codes_doc.py`
4. **提交前检查**: 运行清理脚本确保不提交临时文件

---

## 📝 添加新脚本

添加新脚本时：

1. **选择目录**:
   - Python 脚本 → `scripts/python/`
   - Shell 脚本 → `scripts/shell/`

2. **添加执行权限**:
   ```bash
   chmod +x scripts/shell/your_script.sh
   ```

3. **更新文档**: 在本 README 中添加脚本说明

4. **添加注释**: 在脚本开头添加功能说明

---

## 🔗 相关文档

- [测试文档](../tests/docs/测试说明.md)
- [API 文档](../docs/api/API文档.md)
- [架构文档](../docs/architecture/架构文档.md)
- [错误码文档](../docs/development/错误码文档.md)
