# 并行隔离测试说明

## 概述

并行隔离测试（Parallel Isolation Tests）是一组特殊的测试，用于验证测试套件在并行执行时的隔离性。这些测试内部会启动子进程来运行并行测试，因此不应该在主测试套件中运行，以避免冲突。

## 为什么需要单独运行？

这些测试的特殊之处在于：

1. **内部运行并行测试**：它们会启动 `pytest -n 4` 来并行运行测试子集
2. **资源密集**：需要大量系统资源（多个进程、数据库连接等）
3. **可能冲突**：与主测试套件的并行执行机制冲突

## 如何运行

### 方法1：使用脚本（推荐）

```bash
bash scripts/run_parallel_isolation_tests.sh
```

这个脚本会：
- 单独运行每个并行隔离测试
- 显示详细的测试结果
- 提供清晰的成功/失败总结

### 方法2：使用 pytest 命令

```bash
# 运行所有并行隔离测试
python -m pytest tests/property/test_parallel_isolation.py --run-parallel-isolation -v

# 运行单个测试
python -m pytest tests/property/test_parallel_isolation.py::TestParallelIsolation::test_parallel_execution_isolation --run-parallel-isolation -v
```

## 测试列表

### 1. test_parallel_execution_isolation
**位置**: `tests/property/test_parallel_isolation.py::TestParallelIsolation::test_parallel_execution_isolation`

**测试内容**:
- 并行运行 `tests/integration/routes` 中的测试
- 验证没有认证失败（401错误）
- 验证没有清理错误
- 验证没有外键约束违反
- 验证没有文件清理竞态条件

**预期结果**: 所有测试通过，无错误

### 2. test_authenticated_client_isolation
**位置**: `tests/property/test_parallel_isolation.py::TestDependencyOverrideIsolation::test_authenticated_client_isolation`

**测试内容**:
- 并行运行使用 `authenticated_client` fixture 的测试
- 验证依赖注入覆盖不会冲突
- 验证没有认证失败

**预期结果**: 所有测试通过，无认证错误

### 3. test_single_test_execution_passes
**位置**: `tests/property/test_preservation.py::TestSingleTestExecution::test_single_test_execution_passes`

**测试内容**:
- 运行单个测试文件
- 验证单独运行时测试通过

**预期结果**: 测试文件成功运行

## 在主测试套件中的行为

当运行主测试套件时（不带 `--run-parallel-isolation` 标志）：

```bash
python -m pytest tests/
```

这些测试会被**自动跳过**，显示如下信息：
```
SKIPPED [1] tests/property/test_parallel_isolation.py:XX: Skipped in main test suite. Run separately with --run-parallel-isolation flag
```

这是**正常且预期的行为**，不是错误。

## CI/CD 集成

在 CI/CD 管道中，建议：

1. **主测试阶段**：运行主测试套件（不包括并行隔离测试）
   ```bash
   python -m pytest tests/
   ```

2. **并行隔离测试阶段**：单独运行并行隔离测试
   ```bash
   bash scripts/run_parallel_isolation_tests.sh
   ```

## 故障排查

### 问题：并行隔离测试失败

**可能原因**:
1. 测试套件中存在状态污染
2. 缓存隔离问题
3. 数据库事务管理问题
4. 依赖注入冲突

**解决方法**:
1. 检查 `tests/conftest.py` 中的 fixture 隔离
2. 验证每个 worker 使用独立的数据库
3. 确保测试清理逻辑正确
4. 检查全局状态和单例对象

### 问题：测试在主套件中运行

**症状**: 看到 "This test runs parallel tests internally" 相关错误

**原因**: 没有使用 `--run-parallel-isolation` 标志

**解决**: 使用推荐的运行方法（见上文）

## 相关文件

- `tests/property/test_parallel_isolation.py` - 并行隔离测试
- `tests/property/test_preservation.py` - 测试保留验证
- `scripts/run_parallel_isolation_tests.sh` - 运行脚本
- `tests/conftest.py` - pytest 配置和 fixture

## 更多信息

如有问题，请查看：
- 主测试文档: `tests/测试说明.md`
- 架构文档: `docs/ARCHITECTURE.md`
