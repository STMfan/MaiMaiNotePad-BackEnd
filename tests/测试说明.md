# æµ‹è¯•æ–‡ä»¶å¤¹è¯´æ˜

æœ¬æ–‡ä»¶å¤¹åŒ…å«é¡¹ç›®çš„æ‰€æœ‰æµ‹è¯•ä»£ç ï¼Œé‡‡ç”¨åˆ†å±‚æµ‹è¯•æ¶æ„ã€‚

## ğŸ“ æ–‡ä»¶å¤¹ç»“æ„

```
tests/
â”œâ”€â”€ conftest.py              # pytest å…¨å±€é…ç½®å’Œ fixtures
â”œâ”€â”€ db_manager.py            # æµ‹è¯•æ•°æ®åº“ç®¡ç†å™¨
â”œâ”€â”€ README.md                # è¯¦ç»†æµ‹è¯•æ–‡æ¡£ï¼ˆè‹±æ–‡ï¼‰
â”œâ”€â”€ æµ‹è¯•è¯´æ˜.md              # æœ¬æ–‡æ¡£ï¼ˆä¸­æ–‡ï¼‰
â”œâ”€â”€ .test_env                # æµ‹è¯•ç¯å¢ƒå˜é‡
â”‚
â”œâ”€â”€ test_*.db                # æµ‹è¯•æ•°æ®åº“ï¼ˆè‡ªåŠ¨ç”Ÿæˆå’Œæ¸…ç†ï¼‰
â”œâ”€â”€ tests.log                # æµ‹è¯•æ—¥å¿—ï¼ˆè‡ªåŠ¨ç”Ÿæˆå’Œæ¸…ç†ï¼‰
â”‚
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ core/               # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆæ•°æ®åº“ç­‰ï¼‰
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡æœåŠ¡å±‚æµ‹è¯•
â”‚   â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°æµ‹è¯•
â”‚   â””â”€â”€ helpers/            # è¾…åŠ©å·¥å…·æµ‹è¯•
â”‚
â”œâ”€â”€ integration/            # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ routes/            # API è·¯ç”±é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ workflows/         # ä¸šåŠ¡æµç¨‹æµ‹è¯•
â”‚
â”œâ”€â”€ property/              # å±æ€§æµ‹è¯•ï¼ˆåŸºäº Hypothesisï¼‰
â”‚
â”œâ”€â”€ helpers/               # æµ‹è¯•è¾…åŠ©å·¥å…·
â”‚   â”œâ”€â”€ boundary_generator.py    # è¾¹ç•Œå€¼ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ exception_injector.py    # å¼‚å¸¸æ³¨å…¥å™¨
â”‚   â”œâ”€â”€ generators.py            # æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ assertions.py            # è‡ªå®šä¹‰æ–­è¨€
â”‚   â”œâ”€â”€ mocks.py                 # Mock å¯¹è±¡
â”‚   â””â”€â”€ websocket_client.py      # WebSocket æµ‹è¯•å®¢æˆ·ç«¯
â”‚
â””â”€â”€ fixtures/              # å…±äº«çš„æµ‹è¯•æ•°æ®å’Œ fixtures
    â”œâ”€â”€ config.py          # é…ç½®ç›¸å…³æµ‹è¯•
    â””â”€â”€ data_factory.py    # æµ‹è¯•æ•°æ®å·¥å‚
```

## ğŸ”§ æµ‹è¯•ç±»å‹

### 1. å•å…ƒæµ‹è¯• (`unit/`)
**ç”¨é€”**: æµ‹è¯•å•ä¸ªå‡½æ•°ã€ç±»æˆ–æ¨¡å—çš„åŠŸèƒ½ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡

**å­ç›®å½•**:
- `core/` - æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆæ•°æ®åº“ã€é…ç½®ç­‰ï¼‰
- `services/` - ä¸šåŠ¡æœåŠ¡å±‚æµ‹è¯•
- `utils/` - å·¥å…·å‡½æ•°æµ‹è¯•
- `helpers/` - è¾…åŠ©å·¥å…·æµ‹è¯•

**ç‰¹ç‚¹**:
- å¿«é€Ÿæ‰§è¡Œ
- ä½¿ç”¨ Mock éš”ç¦»å¤–éƒ¨ä¾èµ–
- ä¸“æ³¨äºå•ä¸€åŠŸèƒ½

**ä¸»è¦æµ‹è¯•æ–‡ä»¶**:
- `services/test_auth_service.py` - è®¤è¯æœåŠ¡æµ‹è¯•
- `services/test_user_service.py` - ç”¨æˆ·æœåŠ¡æµ‹è¯•
- `test_file_upload.py` - æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
- `test_security.py` - å®‰å…¨åŠŸèƒ½æµ‹è¯•

### 2. é›†æˆæµ‹è¯• (`integration/`)
**ç”¨é€”**: æµ‹è¯•å¤šä¸ªæ¨¡å—æˆ–æœåŠ¡ä¹‹é—´çš„äº¤äº’

**å­ç›®å½•**:
- `routes/` - API è·¯ç”±ç«¯åˆ°ç«¯æµ‹è¯•
- `workflows/` - ä¸šåŠ¡æµç¨‹æµ‹è¯•

**ç‰¹ç‚¹**:
- ä½¿ç”¨çœŸå®æˆ–æµ‹è¯•æ•°æ®åº“
- æµ‹è¯•å®Œæ•´çš„è¯·æ±‚-å“åº”å‘¨æœŸ
- éªŒè¯ä¸šåŠ¡æµç¨‹

**ä¸»è¦æµ‹è¯•æ–‡ä»¶**:
- `test_websocket_endpoint.py` - WebSocket ç«¯ç‚¹é›†æˆæµ‹è¯•
- `test_file_upload_integration.py` - æ–‡ä»¶ä¸Šä¼ é›†æˆæµ‹è¯•
- `routes/test_auth_routes.py` - è®¤è¯è·¯ç”±æµ‹è¯•
- `routes/test_user_routes.py` - ç”¨æˆ·è·¯ç”±æµ‹è¯•

### 3. å±æ€§æµ‹è¯• (`property/`)
**ç”¨é€”**: ä½¿ç”¨ Hypothesis æ¡†æ¶è‡ªåŠ¨å‘ç°è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸

**ç‰¹ç‚¹**:
- è‡ªåŠ¨ç”Ÿæˆå¤§é‡æµ‹è¯•ç”¨ä¾‹
- å‘ç°æ„å¤–çš„è¾¹ç•Œæƒ…å†µ
- éªŒè¯ç³»ç»Ÿå±æ€§å’Œä¸å˜é‡

**ä¸»è¦æµ‹è¯•æ–‡ä»¶**:
- `test_coverage_monotonicity.py` - æµ‹è¯•è¦†ç›–ç‡å•è°ƒæ€§
- `test_exception_handling_completeness.py` - å¼‚å¸¸å¤„ç†å®Œæ•´æ€§
- `test_websocket_cleanup.py` - WebSocket è¿æ¥æ¸…ç†
- `test_boundary_value_safety.py` - è¾¹ç•Œå€¼å®‰å…¨æ€§
- `test_data_consistency.py` - æ•°æ®ä¸€è‡´æ€§

**è¯¦ç»†è¯´æ˜**: å‚è§ `property/å±æ€§æµ‹è¯•è¯´æ˜.md`

## ğŸ› ï¸ æµ‹è¯•è¾…åŠ©å·¥å…· (`helpers/`)

### è¾¹ç•Œå€¼ç”Ÿæˆå™¨ (Boundary Value Generator)
è‡ªåŠ¨ç”Ÿæˆå„ç§è¾¹ç•Œå€¼å’Œæç«¯æƒ…å†µï¼š
- ç©ºå€¼ï¼ˆNone, "", [], {}ï¼‰
- æœ€å¤§/æœ€å°å€¼
- ç‰¹æ®Šå­—ç¬¦å’Œ Unicode
- è¶…é•¿å­—ç¬¦ä¸²

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from tests.helpers.boundary_generator import BoundaryValueGenerator

generator = BoundaryValueGenerator()
boundaries = generator.generate_string_boundaries()
```

è¯¦è§: `helpers/è¾¹ç•Œå€¼ç”Ÿæˆå™¨ä½¿ç”¨æŒ‡å—.md`

### å¼‚å¸¸æ³¨å…¥å™¨ (Exception Injector)
ç³»ç»ŸåŒ–åœ°æ³¨å…¥å„ç§å¼‚å¸¸ï¼š
- æ•°æ®åº“å¼‚å¸¸
- ç½‘ç»œå¼‚å¸¸
- æ–‡ä»¶ç³»ç»Ÿå¼‚å¸¸
- éªŒè¯é”™è¯¯

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from tests.helpers.exception_injector import ExceptionInjector

injector = ExceptionInjector()
with injector.inject_database_error():
    # æµ‹è¯•æ•°æ®åº“é”™è¯¯å¤„ç†
    pass
```

è¯¦è§: `helpers/å¼‚å¸¸æ³¨å…¥å™¨ä½¿ç”¨æŒ‡å—.md`

## ï¿½ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
pytest
```

### è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•
```bash
pytest tests/unit/              # å•å…ƒæµ‹è¯•
pytest tests/integration/       # é›†æˆæµ‹è¯•
pytest tests/property/          # å±æ€§æµ‹è¯•
```

### å¹¶è¡Œè¿è¡Œæµ‹è¯•ï¼ˆæ¨èï¼‰
```bash
pytest -n auto                  # è‡ªåŠ¨æ£€æµ‹ CPU æ ¸å¿ƒæ•°
pytest -n 4                     # ä½¿ç”¨ 4 ä¸ª worker
```

### è¿è¡Œç‰¹å®šæ–‡ä»¶æˆ–æµ‹è¯•
```bash
pytest tests/unit/services/test_user_service.py -v
pytest tests/unit/test_security.py::test_password_hash -v
pytest -k "password"            # è¿è¡Œåç§°åŒ…å« password çš„æµ‹è¯•
```

### æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
```bash
pytest --cov=app --cov-report=html
```

### è¿è¡Œå±æ€§æµ‹è¯•ï¼ˆå¸¦ç»Ÿè®¡ä¿¡æ¯ï¼‰
```bash
pytest tests/property/ -v --hypothesis-show-statistics
```

## ğŸ” Fixtures å’Œæµ‹è¯•æ•°æ®

### å…¨å±€ Fixtures (`conftest.py`)
- `test_db` - æµ‹è¯•æ•°æ®åº“ä¼šè¯ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
- `client` - FastAPI æµ‹è¯•å®¢æˆ·ç«¯
- `authenticated_client` - å·²è®¤è¯çš„æµ‹è¯•å®¢æˆ·ç«¯
- `admin_client` - ç®¡ç†å‘˜å®¢æˆ·ç«¯
- `moderator_client` - ç‰ˆä¸»å®¢æˆ·ç«¯
- `super_admin_client` - è¶…çº§ç®¡ç†å‘˜å®¢æˆ·ç«¯

### ç”¨æˆ· Fixtures
- `test_user` - æ™®é€šæµ‹è¯•ç”¨æˆ·
- `admin_user` - ç®¡ç†å‘˜ç”¨æˆ·
- `moderator_user` - ç‰ˆä¸»ç”¨æˆ·
- `super_admin_user` - è¶…çº§ç®¡ç†å‘˜ç”¨æˆ·

### æµ‹è¯•æ•°æ®å·¥å‚ (`fixtures/data_factory.py`)
æä¾›åˆ›å»ºæµ‹è¯•æ•°æ®çš„å·¥å‚å‡½æ•°ã€‚

## âš™ï¸ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡ (`.test_env`)
- `DATABASE_URL` - æµ‹è¯•æ•°æ®åº“ URL
- `PASSLIB_BCRYPT_ROUNDS=4` - å¿«é€Ÿå¯†ç å“ˆå¸Œï¼ˆæµ‹è¯•ä¸“ç”¨ï¼‰
- `TEST_PARALLEL=true` - å¯ç”¨å¹¶è¡Œæµ‹è¯•

### Per-Worker æ•°æ®åº“éš”ç¦»
ä½¿ç”¨ pytest-xdist å¹¶è¡Œè¿è¡Œæ—¶ï¼Œæ¯ä¸ª worker ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ï¼š
- Worker 0: `test_gw0.db`
- Worker 1: `test_gw1.db`
- ...

è¿™é¿å…äº†å¹¶è¡Œæµ‹è¯•ä¸­çš„æ•°æ®åº“é”å®šé—®é¢˜ã€‚

### è‡ªåŠ¨æ¸…ç†æµ‹è¯•æ–‡ä»¶ âœ¨
pytest è¿è¡Œç»“æŸåä¼šè‡ªåŠ¨æ¸…ç†ä»¥ä¸‹æ–‡ä»¶ï¼š
- æµ‹è¯•æ•°æ®åº“æ–‡ä»¶ï¼š`test_*.db`, `test_*.db-shm`, `test_*.db-wal`
- è¦†ç›–ç‡æ–‡ä»¶ï¼š`.coverage.*`, `coverage.json`
- æ—¥å¿—æ–‡ä»¶ï¼š`test_results_*.log`, `tests.log`

å¦‚æœéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼Œå¯ä»¥è¿è¡Œï¼š
```bash
./scripts/cleanup_test_files.sh
```

## ğŸ“ æœ€ä½³å®è·µ

### ğŸ”’ å®‰å…¨åŸåˆ™

1. **æ°¸è¿œä¸è¦ä½¿ç”¨çœŸå®å‡­è¯**
   - æµ‹è¯•ç¯å¢ƒä½¿ç”¨å‡çš„é‚®ç®±è´¦å¯†
   - ä¸è¦åœ¨æµ‹è¯•ä¸­è¿æ¥çœŸå®çš„å¤–éƒ¨æœåŠ¡
   - è¯¦è§ï¼š[æµ‹è¯•æœ€ä½³å®è·µ](./TESTING_BEST_PRACTICES.md)

2. **Mock å¤–éƒ¨æœåŠ¡**
   ```python
   @patch('app.services.email_service.EmailService.send_email')
   def test_send_email(mock_send):
       mock_send.return_value = True
       # æµ‹è¯•ä»£ç ...ä¸ä¼šçœŸå®å‘é€é‚®ä»¶
   ```

3. **æµ‹è¯•å‘½å**: ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
   ```python
   def test_user_can_login_with_valid_credentials():
       pass
   ```

2. **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€

3. **ä½¿ç”¨ Fixtures**: åˆ©ç”¨ pytest fixtures å…±äº«æµ‹è¯•è®¾ç½®

4. **Mock å¤–éƒ¨ä¾èµ–**: å•å…ƒæµ‹è¯•ä¸­ mock æ•°æ®åº“ã€API ç­‰å¤–éƒ¨æœåŠ¡

5. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**: ä½¿ç”¨è¾¹ç•Œå€¼ç”Ÿæˆå™¨æµ‹è¯•æç«¯æƒ…å†µ

6. **æµ‹è¯•å¼‚å¸¸å¤„ç†**: ä½¿ç”¨å¼‚å¸¸æ³¨å…¥å™¨éªŒè¯é”™è¯¯å¤„ç†

7. **ä¿æŒæµ‹è¯•ç®€æ´**: æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º

8. **æ¸…ç†èµ„æº**: ä½¿ç”¨ fixture çš„ teardown æ¸…ç†æµ‹è¯•èµ„æº

## ğŸ› å¸¸è§é—®é¢˜

### æ•°æ®åº“é”å®šé”™è¯¯
å¦‚æœé‡åˆ° "database is locked" é”™è¯¯ï¼š
- ä½¿ç”¨ `pytest -n auto` å¹¶è¡Œè¿è¡Œ
- æ£€æŸ¥ `conftest.py` ä¸­çš„ per-worker æ•°æ®åº“é…ç½®

### æµ‹è¯•é€Ÿåº¦æ…¢
- ä½¿ç”¨ `-n auto` å¹¶è¡Œè¿è¡Œæµ‹è¯•
- ç¡®ä¿ `.test_env` ä¸­ `PASSLIB_BCRYPT_ROUNDS=4`
- è€ƒè™‘å°†æ…¢é€Ÿæµ‹è¯•æ ‡è®°ä¸º `@pytest.mark.slow`

### æµ‹è¯•å¤±è´¥
- æŸ¥çœ‹è¯¦ç»†è¾“å‡º: `pytest -vv`
- åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•: `pytest --lf`
- æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯å †æ ˆ: `pytest --tb=long`

### æµ‹è¯•ä¸´æ—¶æ–‡ä»¶æ¸…ç†
æ‰€æœ‰æµ‹è¯•äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶éƒ½åœ¨ `tests/` ç›®å½•å†…ï¼š
- **è‡ªåŠ¨æ¸…ç†**: pytest ä¼šè¯ç»“æŸåè‡ªåŠ¨æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
- **æ‰‹åŠ¨æ¸…ç†**: è¿è¡Œ `bash scripts/cleanup_test_files.sh`
- **ä¸´æ—¶æ–‡ä»¶åŒ…æ‹¬**:
  - `tests/test_*.db` - æµ‹è¯•æ•°æ®åº“
  - `tests/test_*.db-shm`, `tests/test_*.db-wal` - SQLite ä¸´æ—¶æ–‡ä»¶
  - `tests/tests.log` - æµ‹è¯•æ—¥å¿—

**æ³¨æ„**: é¡¹ç›®æ ¹ç›®å½•ä¸åº”è¯¥æœ‰æµ‹è¯•ä¸´æ—¶æ–‡ä»¶ã€‚å¦‚æœå‘ç°æœ‰ï¼Œè¯´æ˜é…ç½®å¯èƒ½æœ‰é—®é¢˜ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æµ‹è¯•ç›®å½•æ–‡æ¡£
- [è¯¦ç»†æµ‹è¯•æ–‡æ¡£ (README.md)](./README.md) - è‹±æ–‡è¯¦ç»†æ–‡æ¡£
- [æµ‹è¯•æœ€ä½³å®è·µ (TESTING_BEST_PRACTICES.md)](./TESTING_BEST_PRACTICES.md) - å®‰å…¨å’Œæœ€ä½³å®è·µ â­
- [å®‰å…¨æ£€æŸ¥æ¸…å• (SECURITY_CHECKLIST.md)](./SECURITY_CHECKLIST.md) - æµ‹è¯•å®‰å…¨æ£€æŸ¥

### ä¸“é¡¹æ–‡æ¡£
- [å±æ€§æµ‹è¯•è¯´æ˜](property/å±æ€§æµ‹è¯•è¯´æ˜.md) - Hypothesis å±æ€§æµ‹è¯•
- [è¾¹ç•Œå€¼ç”Ÿæˆå™¨ä½¿ç”¨æŒ‡å—](helpers/è¾¹ç•Œå€¼ç”Ÿæˆå™¨ä½¿ç”¨æŒ‡å—.md) - è¾¹ç•Œå€¼æµ‹è¯•
- [å¼‚å¸¸æ³¨å…¥å™¨ä½¿ç”¨æŒ‡å—](helpers/å¼‚å¸¸æ³¨å…¥å™¨ä½¿ç”¨æŒ‡å—.md) - å¼‚å¸¸å¤„ç†æµ‹è¯•
- [é›†æˆæµ‹è¯•æ€»ç»“](helpers/é›†æˆæµ‹è¯•æ€»ç»“.md) - é›†æˆæµ‹è¯•æŒ‡å—

### æµ‹è¯•ç­–ç•¥æ–‡æ¡£ï¼ˆdocs/testing/ï¼‰
- [æµ‹è¯•ç­–ç•¥](../docs/testing/æµ‹è¯•ç­–ç•¥.md) - æµ‹è¯•ç­–ç•¥å’Œæœ€ä½³å®è·µ
- [æµ‹è¯•æ ‡è®°](../docs/testing/æµ‹è¯•æ ‡è®°.md) - æµ‹è¯•æ ‡è®°ä½¿ç”¨æŒ‡å—
- [æ€§èƒ½ä¼˜åŒ–](../docs/testing/æ€§èƒ½ä¼˜åŒ–.md) - æµ‹è¯•æ€§èƒ½ä¼˜åŒ–
- [å¹¶è¡Œæµ‹è¯•](../docs/testing/å¹¶è¡Œæµ‹è¯•.md) - å¹¶è¡Œæµ‹è¯•é…ç½®
- [Fixtureç¼“å­˜ä¼˜åŒ–](../docs/testing/Fixtureç¼“å­˜ä¼˜åŒ–.md) - Fixture ä¼˜åŒ–
- [WebSocketæµ‹è¯•å®¢æˆ·ç«¯](../docs/testing/WebSocketæµ‹è¯•å®¢æˆ·ç«¯.md) - WebSocket æµ‹è¯•

## ğŸ”— å¤–éƒ¨èµ„æº

- [pytest æ–‡æ¡£](https://docs.pytest.org/)
- [Hypothesis æ–‡æ¡£](https://hypothesis.readthedocs.io/)
- [FastAPI æµ‹è¯•æ–‡æ¡£](https://fastapi.tiangolo.com/tutorial/testing/)
