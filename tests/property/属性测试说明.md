# Property-Based Testing Suite

This directory contains property-based tests using Hypothesis to automatically discover edge cases and verify system properties.

**Validates: Requirements FR6 - 基于属性的测试**

## Test Files

### 1. test_coverage_monotonicity.py
Tests that code coverage should monotonically increase or stay the same as tests are added.

**Properties Tested:**
- Coverage never decreases with new tests
- Coverage increases with meaningful tests
- Coverage is stable across runs
- File-level coverage monotonicity
- Branch coverage monotonicity

**Key Classes:**
- `TestCoverageMonotonicity`: Main coverage monotonicity tests
- `TestCoverageMetrics`: Coverage metrics consistency tests

### 2. test_exception_handling_completeness.py
Tests that all service methods correctly handle exceptions, log errors, and rollback transactions.

**Properties Tested:**
- All service methods handle database exceptions
- Exceptions are caught and not propagated
- Errors are logged correctly
- Database transactions are rolled back on errors
- System state remains consistent after exceptions

**Key Classes:**
- `TestExceptionHandlingCompleteness`: Exception handling property tests
- `TestDatabaseTransactionRollback`: Transaction rollback tests
- `TestErrorLogging`: Error logging completeness tests
- `TestExceptionPropagation`: Exception propagation tests

### 3. test_websocket_cleanup.py
Tests that all WebSocket connections are properly cleaned up with no memory leaks.

**Properties Tested:**
- Single connections are cleaned up
- Multiple concurrent connections are all cleaned up
- Connections are cleaned up even on exceptions
- Connection manager state remains consistent
- No memory leaks after connections

**Key Classes:**
- `TestWebSocketConnectionCleanup`: WebSocket cleanup property tests
- `TestMemoryLeakPrevention`: Memory leak prevention tests
- `TestConcurrentConnectionHandling`: Concurrent connection tests

### 4. test_boundary_value_safety.py
Tests that all functions safely handle boundary value inputs.

**Properties Tested:**
- Functions handle None values safely
- Functions handle empty strings safely
- Functions handle extreme numeric values safely
- Functions handle very long strings safely
- Functions handle special characters safely
- Functions handle Unicode characters safely

**Key Classes:**
- `TestBoundaryValueSafety`: Main boundary value safety tests
- `TestNumericBoundaryValues`: Numeric boundary value tests
- `TestStringBoundaryValues`: String boundary value tests
- `TestSpecialCharacterHandling`: Special character handling tests

### 5. test_data_consistency.py
Tests that database state remains consistent after concurrent operations.

**Properties Tested:**
- No duplicate data after concurrent operations
- No data loss after concurrent operations
- Foreign key constraints are maintained
- Transaction isolation is correct
- Data integrity is preserved

**Key Classes:**
- `TestDataConsistency`: Main data consistency tests
- `TestTransactionIsolation`: Transaction isolation tests
- `TestForeignKeyConstraints`: Foreign key constraint tests
- `TestDataIntegrity`: Data integrity tests

## Running the Tests

### Run all property-based tests:
```bash
pytest tests/property/ -v
```

### Run a specific test file:
```bash
pytest tests/property/test_coverage_monotonicity.py -v
```

### Run with Hypothesis statistics:
```bash
pytest tests/property/ -v --hypothesis-show-statistics
```

### Run with specific Hypothesis profile:
```bash
HYPOTHESIS_PROFILE=dev pytest tests/property/ -v  # Fast, 10 examples
HYPOTHESIS_PROFILE=ci pytest tests/property/ -v   # Thorough, 100 examples
```

## Hypothesis Configuration

The tests use Hypothesis profiles configured in `tests/conftest.py`:

- **ci profile**: 100 examples, verbose output, no deadline
- **dev profile**: 10 examples, normal output, no deadline

Default profile is `ci` for thorough testing.

## Test Strategies

### Coverage Monotonicity
- Measures coverage before and after adding tests
- Verifies coverage never decreases
- Tests file-level and branch-level coverage

### Exception Handling
- Injects various exception types (SQLAlchemyError, ValueError, etc.)
- Verifies exceptions are caught and logged
- Verifies database transactions are rolled back

### WebSocket Cleanup
- Creates multiple concurrent connections
- Verifies all connections are cleaned up
- Checks for memory leaks using garbage collection

### Boundary Values
- Generates None, empty strings, extreme values
- Tests with special characters and Unicode
- Verifies functions handle all inputs safely

### Data Consistency
- Runs concurrent operations using ThreadPoolExecutor
- Verifies no duplicate data
- Checks foreign key constraints
- Tests transaction isolation

## Property Definitions

### Property 1: Coverage Monotonicity
```
∀ test_suite, coverage_before, coverage_after:
    run_tests(test_suite) ⟹ coverage_after >= coverage_before
```

### Property 2: Exception Handling Completeness
```
∀ method ∈ ServiceMethods, exception ∈ Exceptions:
    inject_exception(method, exception) ⟹ 
        (exception_caught ∧ error_logged ∧ db_rolled_back)
```

### Property 3: WebSocket Connection Cleanup
```
∀ n ∈ ℕ⁺, connections:
    create_connections(n) ∧ close_all() ⟹ 
        active_connections == 0 ∧ no_memory_leak
```

### Property 4: Boundary Value Safety
```
∀ value ∈ {None, "", [], 0, MAX_INT, ...}:
    function(value) ⟹ (no_exception ∨ expected_exception)
```

### Property 5: Data Consistency
```
∀ operations ∈ ConcurrentOperations:
    execute_concurrent(operations) ⟹ 
        (no_data_loss ∧ no_duplicates ∧ constraints_valid)
```

## Notes

- Some tests may be skipped if they cannot collect coverage data in subprocesses
- Tests use independent database sessions for concurrent operations
- Tests clean up all data after execution
- Tests are designed to be deterministic and repeatable

## Discovered Issues

Property-based tests are designed to discover edge cases and bugs. Any issues found should be documented here:

1. **Unicode Encoding**: Fixed issue with surrogate characters in boundary value tests
2. **Database Locking**: Some concurrent tests may experience database locking with SQLite
3. **Coverage Measurement**: Coverage monotonicity tests require subprocess execution

## Future Improvements

- Add more property tests for file upload operations
- Add property tests for authentication and authorization
- Add property tests for API rate limiting
- Add property tests for caching behavior
