# MaiMNP-rereremake-Flutter åç«¯é¡¹ç›®ä»»åŠ¡æ¸…å•

## å·²å®Œæˆä»»åŠ¡

1. âœ… **å®ç°çŸ¥è¯†åº“ä¸Šä¼ è·¯ç”±å’Œå…ƒæ•°æ®ç®¡ç†**
   - å®ŒæˆçŸ¥è¯†åº“æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
   - å®ç°çŸ¥è¯†åº“å…ƒæ•°æ®å­˜å‚¨å’Œç®¡ç†
   - æ·»åŠ æ–‡ä»¶è·¯å¾„éªŒè¯å’Œå­˜å‚¨

2. âœ… **å®ç°äººè®¾å¡ä¸Šä¼ è·¯ç”±å’Œå…ƒæ•°æ®ç®¡ç†**
   - å®Œæˆäººè®¾å¡æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
   - å®ç°äººè®¾å¡å…ƒæ•°æ®å­˜å‚¨å’Œç®¡ç†
   - æ·»åŠ æ–‡ä»¶è·¯å¾„éªŒè¯å’Œå­˜å‚¨

3. âœ… **å®ç°å®¡æ ¸åŠŸèƒ½ï¼ˆadminå’Œmoderatoræƒé™ï¼‰**
   - å®ç°çŸ¥è¯†åº“å’Œäººè®¾å¡çš„å®¡æ ¸æµç¨‹
   - æ·»åŠ å®¡æ ¸é€šè¿‡/æ‹’ç»åŠŸèƒ½
   - å®ç°å®¡æ ¸æƒé™æ§åˆ¶

4. âœ… **å®ç°ç”¨æˆ·ä¸ªäººä¸Šä¼ è®°å½•æŸ¥çœ‹è·¯ç”±ï¼ˆå¸¦èº«ä»½éªŒè¯ï¼‰**
   - å®Œæˆç”¨æˆ·ä¸Šä¼ è®°å½•æŸ¥è¯¢åŠŸèƒ½
   - å®ç°èº«ä»½éªŒè¯å’Œæƒé™æ§åˆ¶
   - æ·»åŠ åˆ†é¡µå’Œç­›é€‰åŠŸèƒ½

5. âœ… **å®ç°ç”¨æˆ·å·²starçš„çŸ¥è¯†åº“/äººè®¾å¡æŸ¥çœ‹è·¯ç”±ï¼ˆå¸¦èº«ä»½éªŒè¯ï¼‰**
   - å®Œæˆç”¨æˆ·Starè®°å½•æŸ¥è¯¢åŠŸèƒ½
   - å®ç°Star/å–æ¶ˆStaråŠŸèƒ½
   - æ·»åŠ èº«ä»½éªŒè¯å’Œæƒé™æ§åˆ¶

6. âœ… **å®ç°ä¿¡ç®±åŠŸèƒ½å’Œæ‹’ç»åŸå› é€šçŸ¥**
   - å®Œæˆæ¶ˆæ¯ç³»ç»Ÿå®ç°
   - æ·»åŠ å®¡æ ¸æ‹’ç»é€šçŸ¥åŠŸèƒ½
   - å®ç°æ¶ˆæ¯è¯»å–çŠ¶æ€ç®¡ç†

7. âœ… **å®ç°è·å–æ‰€æœ‰å…¬å…±çŸ¥è¯†åº“æ¥å£**
   - å®Œæˆå…¬å…±çŸ¥è¯†åº“æŸ¥è¯¢åŠŸèƒ½
   - æ·»åŠ åˆ†é¡µå’Œæ’åºåŠŸèƒ½
   - å®ç°æœç´¢å’Œç­›é€‰åŠŸèƒ½

8. âœ… **å®ç°è·å–æ‰€æœ‰å…¬å…±äººè®¾å¡æ¥å£**
   - å®Œæˆäººè®¾å¡æŸ¥è¯¢åŠŸèƒ½
   - æ·»åŠ åˆ†é¡µå’Œæ’åºåŠŸèƒ½
   - å®ç°æœç´¢å’Œç­›é€‰åŠŸèƒ½

9. âœ… **ä¿®å¤å¾ªç¯å¯¼å…¥é—®é¢˜**
   - è§£å†³api_routes.pyå’Œmain.pyä¹‹é—´çš„å¾ªç¯å¯¼å…¥
   - é‡æ„ä»£ç ç»“æ„ï¼Œä¼˜åŒ–æ¨¡å—ä¾èµ–å…³ç³»
   - æ·»åŠ æ•°æ®åº“ç®¡ç†å™¨å®ä¾‹åˆå§‹åŒ–

10. âœ… **å®‰è£…ç¼ºå¤±çš„ä¾èµ–åŒ…**
    - å®‰è£…tomlæ¨¡å—æ”¯æŒé…ç½®æ–‡ä»¶è§£æ
    - å®‰è£…python-multipartæ¨¡å—æ”¯æŒè¡¨å•æ•°æ®å¤„ç†
    - æ›´æ–°requirements.txtæ–‡ä»¶

11. âœ… **åœ¨æ­£ç¡®ç«¯å£9278ä¸Šå¯åŠ¨FastAPIæœåŠ¡å™¨å¹¶æµ‹è¯•APIæ¥å£**
    - æˆåŠŸç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
    - åœ¨ç«¯å£9278ä¸Šå¯åŠ¨FastAPIæœåŠ¡å™¨
    - æµ‹è¯•APIæ¥å£åŸºæœ¬åŠŸèƒ½æ­£å¸¸
    - éªŒè¯æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€ç¨³å®š

12. âœ… **æ¸…é™¤æµ‹è¯•è„šæœ¬å¹¶ç”ŸæˆREADME.md**
    - åˆ é™¤äº†test_main.pyæµ‹è¯•è„šæœ¬æ–‡ä»¶
    - åˆ›å»ºäº†è¯¦ç»†çš„README.mdæ–‡æ¡£
    - åŒ…å«é¡¹ç›®ä»‹ç»ã€åŠŸèƒ½ç‰¹æ€§ã€APIæ–‡æ¡£ç­‰å†…å®¹
    - æä¾›äº†å®Œæ•´çš„ä½¿ç”¨è¯´æ˜å’Œå¸¸è§é—®é¢˜è§£ç­”

13. âœ… **å°†æ•°æ®åº“ä»JSONæ–‡ä»¶è¿ç§»åˆ°SQLite**
    - åˆ›å»ºSQLiteæ•°æ®åº“æ¨¡å‹å’Œè¡¨ç»“æ„
    - å®ç°æ•°æ®è¿ç§»è„šæœ¬migrate_to_sqlite.py
    - ä¿®å¤ç”¨æˆ·æ•°æ®å­—æ®µæ˜ å°„é—®é¢˜(userID -> id, pwdHash -> hashed_password)
    - æˆåŠŸè¿ç§»ç”¨æˆ·æ•°æ®åˆ°SQLiteæ•°æ®åº“
    - éªŒè¯APIæ¥å£æ­£å¸¸å·¥ä½œï¼Œæ•°æ®åº“è¿æ¥æ­£å¸¸

14. âœ… **æ£€æŸ¥APIæ¥å£ä¸README.mdæ–‡æ¡£ä¸€è‡´æ€§**
    - æ£€æŸ¥main.pyå’Œapi_routes.pyä¸­çš„å®é™…APIæ¥å£
    - å¯¹æ¯”README.mdä¸­æè¿°çš„APIæ¥å£
    - å‘ç°å¹¶ä¿®å¤äº†APIè·¯å¾„å‰ç¼€ä¸ä¸€è‡´é—®é¢˜
    - ç¡®ä¿æ–‡æ¡£ä¸å®é™…å®ç°ä¿æŒä¸€è‡´

15. âœ… **æ›´æ–°README.mdæ–‡æ¡£ä»¥åæ˜ SQLiteæ•°æ®åº“å®ç°**
   - æ›´æ–°æŠ€æœ¯æ ˆéƒ¨åˆ†ï¼Œå°†"JSONæ–‡ä»¶å­˜å‚¨"æ”¹ä¸º"SQLiteæ•°æ®åº“"
   - æ·»åŠ SQLAlchemy ORMæ¡†æ¶è¯´æ˜
   - æ›´æ–°é¡¹ç›®ç»“æ„ï¼Œå°†JSONæ–‡ä»¶æ”¹ä¸ºSQLiteæ•°æ®åº“æ–‡ä»¶
   - æ›´æ–°æ•°æ®å­˜å‚¨è¯´æ˜ï¼Œæè¿°SQLiteè¡¨ç»“æ„

16. âœ… **ä¿®å¤ç™»å½•æ¥å£422é”™è¯¯ï¼šæ·»åŠ /apiå‰ç¼€ï¼Œæ›´æ–°JWTåº“ä¸ºPyJWT**
    - åœ¨main.pyä¸­ä¸ºAPIè·¯ç”±æ·»åŠ /apiå‰ç¼€ï¼Œä½¿APIè·¯å¾„ä¸å‰ç«¯è¯·æ±‚ä¸€è‡´
    - å°†requirements.txtä¸­çš„jwtæ›´æ”¹ä¸ºPyJWTï¼Œä½¿ç”¨æ­£ç¡®çš„JWTåº“åç§°
    - ä¿®å¤ç™»å½•æ¥å£/api/tokençš„422é”™è¯¯ï¼Œç¡®ä¿JWTä»¤ç‰Œæ­£å¸¸è¿”å›
    - éªŒè¯å—ä¿æŠ¤çš„APIç«¯ç‚¹ï¼ˆå¦‚/api/users/meï¼‰å¯ä»¥æ­£å¸¸è®¿é—®

17. âœ… **ä¿®å¤APIæ¥å£è·¯å¾„é—®é¢˜ï¼špersonasåº”ä¸ºpersona**
    - å‘ç°/api/personasæ¥å£è¿”å›404é”™è¯¯ï¼Œæ£€æŸ¥ä»£ç å‘ç°å®é™…è·¯å¾„ä¸º/api/persona
    - éªŒè¯/api/persona/publicå’Œ/api/knowledge/publicæ¥å£æ­£å¸¸å·¥ä½œ
    - ç¡®è®¤æ‰€æœ‰APIæ¥å£éƒ½ä½¿ç”¨äº†æ­£ç¡®çš„/apiå‰ç¼€ï¼Œå¹¶ä¸”JWTè®¤è¯æ­£å¸¸å·¥ä½œ

18. âœ… **ä¿®å¤ç™»å½•æ¥å£JSONæ ¼å¼æ”¯æŒé—®é¢˜**
    - é‡æ–°è®¾è®¡ç™»å½•æ¥å£ï¼Œä½¿ç”¨Requestå¯¹è±¡æ‰‹åŠ¨è§£æJSONå’Œè¡¨å•æ•°æ®
    - æ”¯æŒapplication/jsonå’Œapplication/x-www-form-urlencodedä¸¤ç§Content-Type
    - æµ‹è¯•éªŒè¯JSONæ ¼å¼å’Œè¡¨å•æ ¼å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ
    - æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯

## å¾…å®Œæˆä»»åŠ¡

1. ğŸ”„ **æ·»åŠ APIæ–‡æ¡£å’Œæµ‹è¯•ç”¨ä¾‹**
   - å®Œå–„APIæ¥å£æ–‡æ¡£
   - ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
   - æ·»åŠ APIä½¿ç”¨ç¤ºä¾‹

2. ğŸ”„ **ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½**
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢è¯­å¥
   - æ·»åŠ æ•°æ®åº“ç´¢å¼•
   - å®ç°æŸ¥è¯¢ç¼“å­˜æœºåˆ¶

3. ğŸ”„ **å®ç°æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶å’Œç±»å‹æ£€æŸ¥**
   - æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶
   - å®ç°æ–‡ä»¶ç±»å‹æ£€æŸ¥
   - æ·»åŠ æ–‡ä»¶å†…å®¹éªŒè¯

4. ğŸ”„ **æ·»åŠ æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†**
   - å®Œå–„æ—¥å¿—è®°å½•ç³»ç»Ÿ
   - ä¼˜åŒ–é”™è¯¯å¤„ç†æœºåˆ¶
   - æ·»åŠ æ€§èƒ½ç›‘æ§

## é¡¹ç›®ç»“æ„

```
backend-python-remake/
â”œâ”€â”€ api_routes.py         # APIè·¯ç”±å®šä¹‰
â”œâ”€â”€ database_models.py    # SQLiteæ•°æ®åº“æ¨¡å‹å’Œç®¡ç†å™¨
â”œâ”€â”€ file_upload.py        # æ–‡ä»¶ä¸Šä¼ æœåŠ¡
â”œâ”€â”€ logger.py            # æ—¥å¿—è®°å½•æ¨¡å—
â”œâ”€â”€ main.py              # ä¸»åº”ç”¨å…¥å£
â”œâ”€â”€ migrate_to_sqlite.py # æ•°æ®è¿ç§»è„šæœ¬
â”œâ”€â”€ models.py            # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ user_management.py   # ç”¨æˆ·ç®¡ç†æ¨¡å—
â”œâ”€â”€ data/                # åŸå§‹JSONæ•°æ®å­˜å‚¨ç›®å½•ï¼ˆå·²è¿ç§»åˆ°SQLiteï¼‰
â”‚   â”œâ”€â”€ knowledge_bases.json
â”‚   â”œâ”€â”€ messages.json
â”‚   â”œâ”€â”€ persona_cards.json
â”‚   â”œâ”€â”€ stars.json
â”‚   â””â”€â”€ users.json
â”œâ”€â”€ uploads/             # æ–‡ä»¶ä¸Šä¼ ç›®å½•
â”‚   â”œâ”€â”€ knowledge/
â”‚   â””â”€â”€ persona/
â”œâ”€â”€ database.db          # SQLiteæ•°æ®åº“æ–‡ä»¶
â””â”€â”€ requirements.txt     # é¡¹ç›®ä¾èµ–
```

## APIæ¥å£æ¦‚è§ˆ

### è®¤è¯ç›¸å…³
- `POST /token` - ç”¨æˆ·ç™»å½•è·å–token
- `GET /users/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

### çŸ¥è¯†åº“ç›¸å…³
- `POST /knowledge/upload` - ä¸Šä¼ çŸ¥è¯†åº“
- `GET /knowledge/public` - è·å–å…¬å¼€çŸ¥è¯†åº“
- `GET /knowledge/{kb_id}` - è·å–æŒ‡å®šçŸ¥è¯†åº“
- `GET /knowledge/user/{user_id}` - è·å–ç”¨æˆ·çŸ¥è¯†åº“
- `POST /knowledge/{kb_id}/star` - StarçŸ¥è¯†åº“
- `DELETE /knowledge/{kb_id}/star` - å–æ¶ˆStarçŸ¥è¯†åº“

### äººè®¾å¡ç›¸å…³
- `POST /persona/upload` - ä¸Šä¼ äººè®¾å¡
- `GET /persona/public` - è·å–å…¬å¼€äººè®¾å¡
- `GET /persona/{pc_id}` - è·å–æŒ‡å®šäººè®¾å¡
- `GET /persona/user/{user_id}` - è·å–ç”¨æˆ·äººè®¾å¡
- `POST /persona/{pc_id}/star` - Staräººè®¾å¡
- `DELETE /persona/{pc_id}/star` - å–æ¶ˆStaräººè®¾å¡

### å®¡æ ¸ç›¸å…³
- `GET /review/knowledge/pending` - è·å–å¾…å®¡æ ¸çŸ¥è¯†åº“
- `GET /review/persona/pending` - è·å–å¾…å®¡æ ¸äººè®¾å¡
- `POST /review/knowledge/{kb_id}/approve` - å®¡æ ¸é€šè¿‡çŸ¥è¯†åº“
- `POST /review/knowledge/{kb_id}/reject` - å®¡æ ¸æ‹’ç»çŸ¥è¯†åº“
- `POST /review/persona/{pc_id}/approve` - å®¡æ ¸é€šè¿‡äººè®¾å¡
- `POST /review/persona/{pc_id}/reject` - å®¡æ ¸æ‹’ç»äººè®¾å¡

### æ¶ˆæ¯ç›¸å…³
- `GET /messages` - è·å–ç”¨æˆ·æ¶ˆæ¯
- `POST /messages/{message_id}/read` - æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»

### ç”¨æˆ·ç›¸å…³
- `GET /user/stars` - è·å–ç”¨æˆ·Starçš„çŸ¥è¯†åº“å’Œäººè®¾å¡

## è¿è¡Œè¯´æ˜

1. å®‰è£…ä¾èµ–ï¼š
   ```bash
   pip install -r requirements.txt
   ```

2. æ•°æ®è¿ç§»ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–ä»JSONè¿ç§»åˆ°SQLiteï¼‰ï¼š
   ```bash
   python migrate_to_sqlite.py
   ```

3. å¯åŠ¨æœåŠ¡å™¨ï¼š
   ```bash
   python -m uvicorn main:app --host 0.0.0.0 --port 9278 --reload
   ```

4. è®¿é—®APIæ–‡æ¡£ï¼š
   ```
   http://localhost:9278/docs
   ```

## æ³¨æ„äº‹é¡¹

- æœåŠ¡å™¨é»˜è®¤è¿è¡Œåœ¨9278ç«¯å£
- æ–‡ä»¶ä¸Šä¼ è·¯å¾„ä¸º`uploads/knowledge/`å’Œ`uploads/persona/`
- æ•°æ®å·²ä»JSONæ–‡ä»¶è¿ç§»åˆ°SQLiteæ•°æ®åº“ï¼ˆdatabase.dbï¼‰
- åŸå§‹JSONæ•°æ®æ–‡ä»¶ä¿ç•™åœ¨`data/`ç›®å½•ä½œä¸ºå¤‡ä»½
- ç”¨æˆ·è®¤è¯ä½¿ç”¨JWT token
- å®¡æ ¸åŠŸèƒ½éœ€è¦adminæˆ–moderatoræƒé™