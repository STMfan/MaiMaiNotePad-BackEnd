# MaiMaiNotePad åç«¯æœåŠ¡

è¿™æ˜¯ä¸€ä¸ªåŸºäº FastAPI æ„å»ºçš„åç«¯æœåŠ¡ï¼Œæä¾›çŸ¥è¯†åº“ç®¡ç†ã€äººè®¾å¡åŠŸèƒ½ã€ç”¨æˆ·ç®¡ç†ã€æ¶ˆæ¯ç³»ç»Ÿå’Œå®¡æ ¸åŠŸèƒ½ã€‚

å¯¹åº”çš„å‰ç«¯é¡¹ç›®ä½äºï¼š`../MaiMaiNotePad-FrontEnd`ï¼Œä¸¤è€…é…åˆè¿è¡Œå³å¯å®Œæˆå®Œæ•´åŠŸèƒ½ä½“éªŒã€‚

## ğŸ“š æ–‡æ¡£å¯¼èˆª

- **[ğŸ“– å®Œæ•´æ–‡æ¡£ç´¢å¼•](docs/README.md)** - æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®æ–‡æ¡£
- **[ğŸ› ï¸ ç®¡ç†å·¥å…·ä½¿ç”¨æŒ‡å—](docs/guides/ç®¡ç†å·¥å…·ä½¿ç”¨æŒ‡å—.md)** - manage.sh å®Œæ•´ä½¿ç”¨æ–‡æ¡£
- **[ğŸ”§ API æ–‡æ¡£](docs/api/APIæ–‡æ¡£.md)** - REST API æ¥å£è¯´æ˜
- **[ğŸ—ï¸ æ¶æ„æ–‡æ¡£](docs/architecture/æ¶æ„æ–‡æ¡£.md)** - ç³»ç»Ÿæ¶æ„è®¾è®¡
- **[ğŸ§ª æµ‹è¯•æ–‡æ¡£](tests/docs/æµ‹è¯•è¯´æ˜.md)** - æµ‹è¯•ç­–ç•¥å’Œæ–¹æ³•
- **[âŒ é”™è¯¯ç æ–‡æ¡£](docs/development/é”™è¯¯ç æ–‡æ¡£.md)** - é”™è¯¯ç è¯´æ˜
- **[âš™ï¸ é…ç½®æ–‡æ¡£](docs/configuration/é…ç½®ç®¡ç†æ–‡æ¡£.md)** - é…ç½®ç®¡ç†è¯´æ˜
- **[ğŸ› ï¸ è„šæœ¬å·¥å…·](scripts/è„šæœ¬è¯´æ˜.md)** - ç»´æŠ¤è„šæœ¬è¯´æ˜
- **[ğŸ“ æ›´æ–°æ—¥å¿—](docs/guides/æ›´æ–°æ—¥å¿—.md)** - ç‰ˆæœ¬å†å²

---

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### ğŸ“š çŸ¥è¯†åº“ç®¡ç†
- **æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒçŸ¥è¯†åº“æ–‡ä»¶ä¸Šä¼ ã€æ­£æ–‡(`content`)ä¸æ ‡ç­¾(`tags`)å…¥åº“ï¼Œé™„å¸¦ä½œè€…ä¿¡æ¯
- **å®¡æ ¸ç³»ç»Ÿ**: å®Œæ•´çš„å®¡æ ¸æµç¨‹ï¼ˆå¾…å®¡æ ¸ã€é€šè¿‡ã€æ‹’ç»ï¼‰
- **æœç´¢ç­›é€‰**: æ”¯æŒæŒ‰æ ‡ç­¾ã€å…³é”®è¯æœç´¢å’Œç­›é€‰ï¼Œä¸ªäººä¸Šä¼ è®°å½•æ”¯æŒåˆ†é¡µ/æ’åº/çŠ¶æ€è¿‡æ»¤
- **StaråŠŸèƒ½**: ç”¨æˆ·å¯ä»¥Staræ„Ÿå…´è¶£çš„çŸ¥è¯†åº“
- **æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

### ğŸ­ äººè®¾å¡ç®¡ç†
- **æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒäººè®¾å¡æ–‡ä»¶ä¸Šä¼ ã€æ­£æ–‡(`content`)ä¸æ ‡ç­¾(`tags`)å…¥åº“ï¼Œé™„å¸¦ä½œè€…ä¿¡æ¯
- **å®¡æ ¸ç³»ç»Ÿ**: ä¸çŸ¥è¯†åº“ç›¸åŒçš„å®¡æ ¸æµç¨‹
- **åˆ†ç±»ç®¡ç†**: æ”¯æŒåˆ†ç±»å’Œæ ‡ç­¾ç³»ç»Ÿï¼Œä¸ªäººä¸Šä¼ è®°å½•æ”¯æŒåˆ†é¡µ/æ’åº/çŠ¶æ€è¿‡æ»¤
- **StaråŠŸèƒ½**: ç”¨æˆ·å¯ä»¥Staræ„Ÿå…´è¶£çš„äººè®¾å¡
- **ä¸ªäººæ”¶è—**: æŸ¥çœ‹ç”¨æˆ·å·²Starçš„äººè®¾å¡

### ğŸ‘¥ ç”¨æˆ·ç³»ç»Ÿ
- **ç”¨æˆ·è®¤è¯**: JWT tokenè®¤è¯æœºåˆ¶
- **è§’è‰²ç®¡ç†**: æ”¯æŒadminã€moderatorã€userä¸‰ç§è§’è‰²
- **ä¸ªäººä¸­å¿ƒ**: æŸ¥çœ‹ä¸ªäººèµ„æ–™ã€ä¿®æ”¹å¯†ç ã€ç®¡ç†ä¸ªäººæ•°æ®
- **æ¶ˆæ¯ç³»ç»Ÿ**: å®¡æ ¸ç»“æœé€šçŸ¥å’Œæ¶ˆæ¯ç®¡ç†

### ğŸ”§ ç®¡ç†ä¸ç»Ÿè®¡
- **å®¡æ ¸é¢æ¿**: ç®¡ç†å‘˜å’Œå®¡æ ¸å‘˜å¯ä»¥å®¡æ ¸å†…å®¹
- **ç”¨æˆ·ç®¡ç†**: ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ç”¨æˆ·æƒé™
- **å†…å®¹è¿è¥**: ç®¡ç†ç«¯å†…å®¹åˆ—è¡¨æ”¯æŒä¸Šä¼ è€…è¿‡æ»¤ã€æ’åºå­—æ®µ/æ–¹å‘é…ç½®
- **ä¸Šä¼ ä¸è¡Œä¸ºç»Ÿè®¡**: æä¾›ä¸Šä¼ è®°å½•ã€ç³»ç»Ÿä¸Šä¼ ç»Ÿè®¡å’Œä¸‹è½½/æ”¶è—è¡Œä¸ºè¶‹åŠ¿æ•°æ®

### ğŸ“§ é‚®ä»¶æœåŠ¡
- **é‚®ä»¶å‘é€**: æ”¯æŒå‘é€é‚®ä»¶é€šçŸ¥
- **SMTPé…ç½®**: å¯é…ç½®çš„SMTPæœåŠ¡å™¨è®¾ç½®
- **é‚®ç®±è®¤è¯**: æ”¯æŒQQé‚®ç®±ç­‰ä¸»æµé‚®ç®±æœåŠ¡

### ğŸ¤– AI å†…å®¹å®¡æ ¸
- **æ™ºèƒ½å®¡æ ¸**: åŸºäºç¡…åŸºæµåŠ¨ Qwen æ¨¡å‹çš„å†…å®¹å®‰å…¨å®¡æ ¸
- **å¤šç±»å‹æ£€æµ‹**: æ”¯æŒè‰²æƒ…ã€æ¶‰æ”¿ã€è¾±éª‚ä¸‰ç±»è¿è§„å†…å®¹æ£€æµ‹
- **ç½®ä¿¡åº¦è¯„åˆ†**: æä¾› 0-1 çš„è¿è§„ç½®ä¿¡åº¦è¯„åˆ†
- **ä¸‰çº§åˆ¤æ–­**: é€šè¿‡/æ‹’ç»/ä¸ç¡®å®šä¸‰ç§å®¡æ ¸ç»“æœ
- **å¿«é€Ÿé›†æˆ**: 5 åˆ†é’Ÿå³å¯å®Œæˆé…ç½®å’Œæµ‹è¯•
- **è¯¦ç»†æ–‡æ¡£**: æä¾›å®Œæ•´çš„ä½¿ç”¨æŒ‡å—å’Œå¿«é€Ÿå¼€å§‹æ–‡æ¡£

---

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: FastAPI (Python)
- **æ•°æ®å­˜å‚¨**: SQLiteæ•°æ®åº“ï¼ˆè½»é‡çº§å…³ç³»å‹æ•°æ®åº“ï¼‰
- **ORMæ¡†æ¶**: SQLAlchemyï¼ˆPythonå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰
- **è®¤è¯**: JWT (JSON Web Tokens)
- **å¯†ç å®‰å…¨**: bcryptå“ˆå¸Œ
- **æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼
- **APIæ–‡æ¡£**: è‡ªåŠ¨ç”ŸæˆSwaggeræ–‡æ¡£

---

## ğŸ“ é¡¹ç›®ç»“æ„

é¡¹ç›®é‡‡ç”¨æ ‡å‡†çš„ FastAPI åˆ†å±‚æ¶æ„ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—å’ŒèŒè´£æ¸…æ™°åˆ’åˆ†ä»£ç ï¼š

```
MaiMaiNotePad-BackEnd/
â”œâ”€â”€ app/                          # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                   # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ api/                      # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py           # è·¯ç”±æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ deps.py               # ä¾èµ–æ³¨å…¥ï¼ˆè®¤è¯ã€æƒé™ï¼‰
â”‚   â”‚   â”œâ”€â”€ websocket.py          # WebSocket å¤„ç†
â”‚   â”‚   â””â”€â”€ routes/               # è·¯ç”±æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py           # è®¤è¯è·¯ç”±ï¼ˆç™»å½•ã€æ³¨å†Œã€å¯†ç é‡ç½®ï¼‰
â”‚   â”‚       â”œâ”€â”€ users.py          # ç”¨æˆ·è·¯ç”±ï¼ˆä¸ªäººä¿¡æ¯ã€å¤´åƒï¼‰
â”‚   â”‚       â”œâ”€â”€ knowledge.py      # çŸ¥è¯†åº“è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ persona.py        # äººè®¾å¡è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ messages.py       # æ¶ˆæ¯è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ admin.py          # ç®¡ç†å‘˜è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ review.py         # å®¡æ ¸è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ dictionary.py     # å­—å…¸è·¯ç”±
â”‚   â”‚       â””â”€â”€ comments.py       # è¯„è®ºè·¯ç”±
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒé…ç½®å’Œä¾èµ–
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py             # é…ç½®ç®¡ç†ï¼ˆPydantic Settingsï¼‰
â”‚   â”‚   â”œâ”€â”€ security.py           # å®‰å…¨ç›¸å…³ï¼ˆJWTã€å¯†ç å“ˆå¸Œï¼‰
â”‚   â”‚   â”œâ”€â”€ database.py           # æ•°æ®åº“è¿æ¥å’Œä¼šè¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ middleware.py         # ä¸­é—´ä»¶é…ç½®
â”‚   â”‚   â””â”€â”€ logging.py            # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ database.py           # SQLAlchemy æ•°æ®åº“æ¨¡å‹
â”‚   â”‚   â””â”€â”€ schemas.py            # Pydantic API æ¨¡å‹
â”‚   â”œâ”€â”€ services/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py       # ç”¨æˆ·æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ auth_service.py       # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ knowledge_service.py  # çŸ¥è¯†åº“æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ persona_service.py    # äººè®¾å¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ message_service.py    # æ¶ˆæ¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ email_service.py      # é‚®ä»¶æœåŠ¡
â”‚   â”‚   â””â”€â”€ file_service.py       # æ–‡ä»¶æœåŠ¡
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ file.py               # æ–‡ä»¶å¤„ç†å·¥å…·
â”‚       â”œâ”€â”€ avatar.py             # å¤´åƒå¤„ç†å·¥å…·
â”‚       â””â”€â”€ websocket.py          # WebSocket ç®¡ç†å™¨
â”œâ”€â”€ tests/                        # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ docs/                     # æµ‹è¯•æ–‡æ¡£
â”‚   â”œâ”€â”€ fixtures/                 # æµ‹è¯• fixtures
â”‚   â”œâ”€â”€ helpers/                  # æµ‹è¯•è¾…åŠ©å·¥å…·ï¼ˆä¾›æµ‹è¯•ä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ test_helpers/             # æµ‹è¯•è¾…åŠ©å·¥å…·çš„å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ unit/                     # å•å…ƒæµ‹è¯•ï¼ˆä¸¥æ ¼é•œåƒ app/ ç»“æ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ api/                  # API å±‚æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒæ¨¡å—æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ services/             # æœåŠ¡å±‚æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_main.py          # åº”ç”¨ä¸»å…¥å£æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_error_handlers.py  # é”™è¯¯å¤„ç†å™¨æµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_file_upload*.py  # æ–‡ä»¶ä¸Šä¼ ç›¸å…³æµ‹è¯•
â”‚   â”œâ”€â”€ integration/              # é›†æˆæµ‹è¯•
â”‚   â”‚   â””â”€â”€ routes/               # API è·¯ç”±æµ‹è¯•
â”‚   â”œâ”€â”€ property/                 # å±æ€§æµ‹è¯•ï¼ˆHypothesisï¼‰
â”‚   â”œâ”€â”€ conftest.py               # æµ‹è¯•é…ç½®
â”‚   â””â”€â”€ db_manager.py             # æµ‹è¯•æ•°æ®åº“ç®¡ç†å™¨
â”œâ”€â”€ alembic/                      # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ versions/                 # è¿ç§»ç‰ˆæœ¬
â”‚   â””â”€â”€ env.py                    # Alembic ç¯å¢ƒé…ç½®
â”œâ”€â”€ scripts/                      # è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ python/                  # Python è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ generate_error_codes_doc.py    # ç”Ÿæˆé”™è¯¯ç æ–‡æ¡£
â”‚   â”‚   â”œâ”€â”€ generate_test_templates.py     # ç”Ÿæˆæµ‹è¯•æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ reset_security_env.py          # é‡ç½®å®‰å…¨ç¯å¢ƒ
â”‚   â””â”€â”€ shell/                   # Shell è„šæœ¬
â”‚       â”œâ”€â”€ alembic.sh           # Alembic åŒ…è£…è„šæœ¬
â”‚       â”œâ”€â”€ cleanup.sh           # æ¸…ç†é¡¹ç›®
â”‚       â””â”€â”€ run_parallel_isolation_tests.sh  # è¿è¡Œå¹¶è¡Œéš”ç¦»æµ‹è¯•
â”œâ”€â”€ docs/                         # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ docker/                       # Docker ç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ README.md                 # Docker å¿«é€Ÿå¼€å§‹æŒ‡å—
â”‚   â”œâ”€â”€ docker-compose.yml        # Docker Compose é…ç½®
â”‚   â””â”€â”€ .env.docker               # Docker ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ uploads/                      # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨
â”œâ”€â”€ data/                         # æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ logs/                         # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ main.py                       # åº”ç”¨å…¥å£ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
â”œâ”€â”€ manage.sh                     # ğŸ†• ç®¡ç†å·¥å…·ï¼ˆæ¨èä½¿ç”¨ï¼‰
â”œâ”€â”€ requirements.txt              # Python ä¾èµ–
â”œâ”€â”€ pyproject.toml                # é¡¹ç›®é…ç½®ï¼ˆåŒ…å« pytest é…ç½®ï¼‰
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ config.toml               # åº”ç”¨é…ç½®ï¼ˆä¸æäº¤åˆ° Gitï¼‰
â”‚   â”œâ”€â”€ alembic.ini               # Alembic æ•°æ®åº“è¿ç§»é…ç½®
â”‚   â””â”€â”€ templates/                # é…ç½®æ¨¡æ¿ç›®å½•
â”‚       â”œâ”€â”€ config.toml.template  # åº”ç”¨é…ç½®æ¨¡æ¿
â”‚       â””â”€â”€ .env.template         # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md                     # é¡¹ç›®æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
```

### æ¶æ„è¯´æ˜

é¡¹ç›®é‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ï¼š

1. **API å±‚** (`app/api/`): å¤„ç† HTTP è¯·æ±‚å’Œå“åº”ï¼Œè¿›è¡Œè¯·æ±‚éªŒè¯ã€æƒé™æ£€æŸ¥å’Œå“åº”æ ¼å¼åŒ–
2. **æœåŠ¡å±‚** (`app/services/`): å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†æ•°æ®è½¬æ¢å’Œäº‹åŠ¡ç®¡ç†
3. **æ•°æ®å±‚** (`app/models/`): å®šä¹‰æ•°æ®åº“æ¨¡å‹å’Œ API æ¨¡å‹ï¼Œå¤„ç†æ•°æ®æŒä¹…åŒ–

è¿™ç§åˆ†å±‚æ¶æ„çš„ä¼˜åŠ¿ï¼š
- **èŒè´£æ¸…æ™°**: æ¯å±‚ä¸“æ³¨äºç‰¹å®šèŒè´£ï¼Œé™ä½è€¦åˆåº¦
- **æ˜“äºæµ‹è¯•**: æœåŠ¡å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ– HTTP æ¡†æ¶
- **å¯ç»´æŠ¤æ€§**: ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨æœåŠ¡å±‚ï¼Œä¾¿äºä¿®æ”¹å’Œæ‰©å±•
- **å¯å¤ç”¨æ€§**: æœåŠ¡å±‚å¯ä»¥è¢«å¤šä¸ªè·¯ç”±æˆ–å…¶ä»–æœåŠ¡è°ƒç”¨

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ç®¡ç†å·¥å…·ï¼ˆæ¨èï¼‰

é¡¹ç›®æä¾›äº†å‹å¥½çš„å‘½ä»¤è¡Œç®¡ç†å·¥å…· `manage.sh`ï¼Œå¯ä»¥é€šè¿‡äº¤äº’å¼èœå•å®Œæˆæ‰€æœ‰æ“ä½œï¼š

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/STMfan/MaiMaiNotePad-BackEnd.git
cd MaiMaiNotePad/MaiMaiNotePad-BackEnd

# 2. è¿è¡Œç®¡ç†å·¥å…·
./manage.sh
```

é¦–æ¬¡è¿è¡Œæ—¶ï¼Œç®¡ç†å·¥å…·ä¼šï¼š
- è‡ªåŠ¨è¿›å…¥äº¤äº’å¼èœå•
- æä¾›ç¯å¢ƒç®¡ç†ã€æœåŠ¡ç®¡ç†ã€æµ‹è¯•ç­‰åŠŸèƒ½
- å¼•å¯¼ä½ å®Œæˆç¯å¢ƒåˆ›å»ºå’Œä¾èµ–å®‰è£…

**ç®¡ç†å·¥å…·åŠŸèƒ½ï¼š**
- ğŸŒ **ç¯å¢ƒç®¡ç†** - åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆConda/venv/uvï¼‰ã€æŸ¥çœ‹é¡¹ç›®çŠ¶æ€ã€ä¾èµ–ç®¡ç†ã€é…ç½®ç®¡ç†
- ğŸš€ **æœåŠ¡ç®¡ç†** - å¯åŠ¨å¼€å‘/ç”Ÿäº§æœåŠ¡å™¨ã€Docker ç®¡ç†
- ğŸ§ª **æµ‹è¯•ç›¸å…³** - è¿è¡Œæµ‹è¯•ã€ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
- ğŸ§¹ **é¡¹ç›®ç»´æŠ¤** - æ¸…ç†é¡¹ç›®ã€æ•°æ®åº“ç®¡ç†ã€ä»£ç è´¨é‡æ£€æŸ¥
- âš™ï¸ **é«˜çº§æ“ä½œ** - åˆå§‹åŒ–ç®¡ç†å‘˜ã€æ¸…æ¡£é‡ç½®

**ç›´æ¥å‘½ä»¤æ–¹å¼ï¼š**

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
./manage.sh create-env

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
./manage.sh start-dev

# è¿è¡Œæµ‹è¯•
./manage.sh test

# æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
./manage.sh help
```

è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼š[ç®¡ç†å·¥å…·ä½¿ç”¨æŒ‡å—](docs/guides/ç®¡ç†å·¥å…·ä½¿ç”¨æŒ‡å—.md)

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨é…ç½®

### ç¯å¢ƒè¦æ±‚
- Python 3.8+
- pipåŒ…ç®¡ç†å™¨

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/STMfan/MaiMaiNotePad-BackEnd.git
cd MaiMaiNotePad/MaiMaiNotePad-BackEnd
```

### 2. å®‰è£…ä¾èµ–

é¡¹ç›®ä½¿ç”¨ Python 3.8+ å’Œ FastAPI æ¡†æ¶ã€‚å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–åŒ…æ‹¬ï¼š
- `fastapi`: Web æ¡†æ¶
- `uvicorn`: ASGI æœåŠ¡å™¨
- `sqlalchemy`: ORM æ¡†æ¶
- `pydantic`: æ•°æ®éªŒè¯
- `pydantic-settings`: é…ç½®ç®¡ç†
- `python-jose`: JWT å¤„ç†
- `passlib`: å¯†ç å“ˆå¸Œ
- `alembic`: æ•°æ®åº“è¿ç§»
- `pytest`: æµ‹è¯•æ¡†æ¶

### 3. é…ç½®ç¯å¢ƒå˜é‡å’Œåº”ç”¨é…ç½®

é¦–æ¬¡ä½¿ç”¨æ—¶ï¼Œå¤åˆ¶é…ç½®æ¨¡æ¿å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp configs/templates/.env.template .env

# å¤åˆ¶åº”ç”¨é…ç½®æ¨¡æ¿
cp configs/templates/config.toml.template configs/config.toml
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œè®¾ç½®å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰ï¼š

```bash
# JWT å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
JWT_SECRET_KEY=your-secret-key-here

# é‚®ä»¶é…ç½®ï¼ˆå¿…éœ€ï¼‰
MAIL_USER=your-email@example.com
MAIL_PWD=your-email-password

# ç®¡ç†å‘˜é…ç½®ï¼ˆå¿…éœ€ï¼‰
SUPERADMIN_PWD=your-admin-password
HIGHEST_PASSWORD=your-highest-password
```

ç¼–è¾‘ `configs/config.toml` æ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´åº”ç”¨é…ç½®ï¼ˆéæ•æ„Ÿä¿¡æ¯ï¼‰ã€‚

å¿…é¡»é…ç½®çš„å…³é”®é¡¹ï¼š
- `JWT_SECRET_KEY`: JWT å¯†é’¥ï¼ˆå»ºè®®ä½¿ç”¨ 32 å­—ç¬¦ä»¥ä¸Šçš„éšæœºå­—ç¬¦ä¸²ï¼‰
- `SUPERADMIN_PWD`: è¶…çº§ç®¡ç†å‘˜å¯†ç 
- `HIGHEST_PASSWORD`: æœ€é«˜æƒé™å¯†ç 
- `MAIL_USER`: å‘ä»¶é‚®ç®±åœ°å€
- `MAIL_PWD`: é‚®ç®±æˆæƒç 

è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒä¸‹æ–¹çš„ã€Œé…ç½®è¯´æ˜ã€ç« èŠ‚ã€‚

### 4. åˆå§‹åŒ–æ•°æ®åº“

é¡¹ç›®ä½¿ç”¨ Alembic è¿›è¡Œæ•°æ®åº“è¿ç§»ç®¡ç†ã€‚é¦–æ¬¡è¿è¡Œæ—¶éœ€è¦åˆå§‹åŒ–æ•°æ®åº“ï¼š

```bash
# åˆ›å»ºæ•°æ®åº“å¹¶æ‰§è¡Œè¿ç§»
./scripts/shell/alembic.sh upgrade head

# æˆ–è€…ç›´æ¥ä½¿ç”¨ alembic å‘½ä»¤ï¼ˆéœ€è¦æŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
alembic -c configs/alembic.ini upgrade head
```

è¿™å°†åˆ›å»º SQLite æ•°æ®åº“æ–‡ä»¶ `data/mainnp.db` å¹¶å»ºç«‹æ‰€æœ‰è¡¨ç»“æ„ã€‚

### 5. å¯åŠ¨æœåŠ¡å™¨

æ¨èä½¿ç”¨ç®¡ç†å·¥å…·å¯åŠ¨æœåŠ¡ï¼š

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆä¼šæç¤ºè¾“å…¥ä¸»æœºå’Œç«¯å£ï¼‰
./manage.sh start-dev

# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨ï¼ˆä¼šæç¤ºè¾“å…¥é…ç½®ï¼‰
./manage.sh start-prod
```

æˆ–ç›´æ¥ä½¿ç”¨ uvicorn å¯åŠ¨ï¼š

```bash
# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
python -m uvicorn app.main:app --host 0.0.0.0 --port 9278 --reload

# ç”Ÿäº§æ¨¡å¼ï¼ˆå¤šè¿›ç¨‹ï¼‰
python -m uvicorn app.main:app --host 0.0.0.0 --port 9278 --workers 4
```

å¼€å‘æ¨¡å¼ç‰¹æ€§ï¼š
- ä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯
- è¯¦ç»†çš„é”™è¯¯å †æ ˆä¿¡æ¯
- è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£
- é»˜è®¤è®¿é—®åœ°å€ï¼šhttp://localhost:9278
- API æ–‡æ¡£ï¼šhttp://localhost:9278/docs

ç”Ÿäº§æ¨¡å¼ç‰¹æ€§ï¼š
- å¤šè¿›ç¨‹è¿è¡Œï¼ˆæé«˜å¹¶å‘æ€§èƒ½ï¼‰
- è®¿é—®æ—¥å¿—è®°å½•
- ä¼˜åŒ–çš„æ—¥å¿—æ ¼å¼

# æˆ–ä½¿ç”¨Docker
cd docker
docker build -t mainnp-backend .
docker run -p 9278:9278 mainnp-backend
```

### 6. è®¿é—®APIæ–‡æ¡£

FastAPI è‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼ API æ–‡æ¡£ï¼š

- **Swagger UI**: http://localhost:9278/docs  
  æä¾›äº¤äº’å¼ API æµ‹è¯•ç•Œé¢ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•æ‰€æœ‰æ¥å£
  
- **ReDoc**: http://localhost:9278/redoc  
  æä¾›æ›´å‹å¥½çš„ API æ–‡æ¡£é˜…è¯»ç•Œé¢

### 7. æµ‹è¯•API
å¯ä»¥ä½¿ç”¨å†…ç½®çš„æµ‹è¯•ç”¨æˆ·ç™»å½•ï¼š
- ç”¨æˆ·å: testuser
- å¯†ç : testpass

æˆ–è€…é€šè¿‡Swagger UIç•Œé¢è¿›è¡Œäº¤äº’å¼æµ‹è¯•ã€‚

## ğŸ“– APIæ¥å£æ–‡æ¡£

### è®¤è¯ç›¸å…³
- `POST /api/token` - ç”¨æˆ·ç™»å½•è·å–tokenï¼ˆè¿”å›access_tokenå’Œrefresh_tokenï¼‰
- `POST /api/refresh` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ
- `POST /api/send_verification_code` - å‘é€æ³¨å†ŒéªŒè¯ç 
- `POST /api/send_reset_password_code` - å‘é€é‡ç½®å¯†ç éªŒè¯ç 
- `POST /api/reset_password` - é‡ç½®å¯†ç 
- `POST /api/user/register` - ç”¨æˆ·æ³¨å†Œ
- `GET /api/users/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `PUT /api/users/me/password` - ä¿®æ”¹å¯†ç 
- `POST /api/users/me/avatar` - ä¸Šä¼ å¤´åƒ
- `DELETE /api/users/me/avatar` - åˆ é™¤å¤´åƒ
- `GET /api/users/{user_id}/avatar` - è·å–ç”¨æˆ·å¤´åƒ

### çŸ¥è¯†åº“ç›¸å…³
- `POST /api/knowledge/upload` - ä¸Šä¼ çŸ¥è¯†åº“ï¼ˆæ”¯æŒæ­£æ–‡`content`ä¸æ ‡ç­¾`tags`ï¼‰
- `GET /api/knowledge/public` - è·å–å…¬å¼€çŸ¥è¯†åº“
- `GET /api/knowledge/{kb_id}` - è·å–æŒ‡å®šçŸ¥è¯†åº“è¯¦æƒ…
- `GET /api/knowledge/user/{user_id}` - è·å–ç”¨æˆ·çŸ¥è¯†åº“ï¼ˆåˆ†é¡µï¼Œæ”¯æŒåç§°/æ ‡ç­¾/çŠ¶æ€ç­›é€‰ä¸æ’åºï¼Œç®¡ç†å‘˜/å®¡æ ¸å‘˜å¯æŸ¥çœ‹ä»–äººï¼‰
- `PUT /api/knowledge/{kb_id}` - æ›´æ–°çŸ¥è¯†åº“ä¿¡æ¯
- `POST /api/knowledge/{kb_id}/files` - æ·»åŠ çŸ¥è¯†åº“æ–‡ä»¶
- `DELETE /api/knowledge/{kb_id}/{file_id}` - åˆ é™¤çŸ¥è¯†åº“æ–‡ä»¶ï¼ˆåˆ é™¤æœ€åä¸€ä¸ªæ–‡ä»¶æ—¶è‡ªåŠ¨æ¸…ç†æ•´æ¡çŸ¥è¯†åº“ï¼‰
- `GET /api/knowledge/{kb_id}/download` - ä¸‹è½½çŸ¥è¯†åº“å…¨éƒ¨æ–‡ä»¶ï¼ˆZIPï¼Œæ–‡ä»¶åè§„åˆ™ï¼š`çŸ¥è¯†åº“_{åç§°}_{ä½œè€…}_{æœ€åæ›´æ–°æ—¶é—´yyyyMMddHHmmss}.zip`ï¼‰
- `GET /api/knowledge/{kb_id}/file/{file_id}` - ä¸‹è½½çŸ¥è¯†åº“å•ä¸ªæ–‡ä»¶
- `DELETE /api/knowledge/{kb_id}` - åˆ é™¤çŸ¥è¯†åº“
- `POST /api/knowledge/{kb_id}/star` - StarçŸ¥è¯†åº“
- `DELETE /api/knowledge/{kb_id}/star` - å–æ¶ˆStarçŸ¥è¯†åº“
- `GET /api/knowledge/{kb_id}/starred` - æ£€æŸ¥çŸ¥è¯†åº“StarçŠ¶æ€

### äººè®¾å¡ç›¸å…³
- `POST /api/persona/upload` - ä¸Šä¼ äººè®¾å¡ï¼ˆæ”¯æŒæ­£æ–‡`content`ä¸æ ‡ç­¾`tags`ï¼‰
- `GET /api/persona/public` - è·å–å…¬å¼€äººè®¾å¡
- `GET /api/persona/{pc_id}` - è·å–æŒ‡å®šäººè®¾å¡è¯¦æƒ…
- `GET /api/persona/user/{user_id}` - è·å–ç”¨æˆ·äººè®¾å¡ï¼ˆåˆ†é¡µï¼Œæ”¯æŒåç§°/æ ‡ç­¾/çŠ¶æ€ç­›é€‰ä¸æ’åºï¼Œç®¡ç†å‘˜/å®¡æ ¸å‘˜å¯æŸ¥çœ‹ä»–äººï¼‰
- `PUT /api/persona/{pc_id}` - æ›´æ–°äººè®¾å¡ä¿¡æ¯
- `POST /api/persona/{pc_id}/files` - æ·»åŠ äººè®¾å¡æ–‡ä»¶
- `DELETE /api/persona/{pc_id}/{file_id}` - åˆ é™¤äººè®¾å¡æ–‡ä»¶
- `GET /api/persona/{pc_id}/download` - ä¸‹è½½äººè®¾å¡å…¨éƒ¨æ–‡ä»¶ï¼ˆZIPï¼Œæ–‡ä»¶åè§„åˆ™ï¼š`äººè®¾å¡_{åç§°}_{ä½œè€…}_{æœ€åæ›´æ–°æ—¶é—´yyyyMMddHHmmss}.zip`ï¼‰
- `GET /api/persona/{pc_id}/file/{file_id}` - ä¸‹è½½äººè®¾å¡å•ä¸ªæ–‡ä»¶
- `DELETE /api/persona/{pc_id}` - åˆ é™¤äººè®¾å¡
- `POST /api/persona/{pc_id}/star` - Staräººè®¾å¡
- `DELETE /api/persona/{pc_id}/star` - å–æ¶ˆStaräººè®¾å¡
- `GET /api/persona/{pc_id}/starred` - æ£€æŸ¥äººè®¾å¡StarçŠ¶æ€

### å®¡æ ¸ç›¸å…³ï¼ˆéœ€è¦admin/moderatoræƒé™ï¼‰
- `GET /api/review/knowledge/pending` - è·å–å¾…å®¡æ ¸çŸ¥è¯†åº“
- `GET /api/review/persona/pending` - è·å–å¾…å®¡æ ¸äººè®¾å¡
- `POST /api/review/knowledge/{kb_id}/approve` - å®¡æ ¸é€šè¿‡çŸ¥è¯†åº“
- `POST /api/review/knowledge/{kb_id}/reject` - å®¡æ ¸æ‹’ç»çŸ¥è¯†åº“ï¼ˆéœ€åœ¨è¯·æ±‚ä½“ä¸­ä¼ é€’ `{"reason": "æ‹’ç»åŸå› "}`ï¼‰
- `POST /api/review/persona/{pc_id}/approve` - å®¡æ ¸é€šè¿‡äººè®¾å¡
- `POST /api/review/persona/{pc_id}/reject` - å®¡æ ¸æ‹’ç»äººè®¾å¡ï¼ˆéœ€åœ¨è¯·æ±‚ä½“ä¸­ä¼ é€’ `{"reason": "æ‹’ç»åŸå› "}`ï¼‰

### æ¶ˆæ¯ç›¸å…³
- `POST /api/messages/send` - å‘é€æ¶ˆæ¯
- `GET /api/messages` - è·å–ç”¨æˆ·æ¶ˆæ¯
- `POST /api/messages/{message_id}/read` - æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»

### é‚®ä»¶æœåŠ¡ç›¸å…³ï¼ˆæœªå®ç°ï¼‰
- `POST /api/email/send` - å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰**çŠ¶æ€ï¼šæœªå®ç°**
- `GET /api/email/config` - è·å–é‚®ç®±é…ç½®ä¿¡æ¯ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰**çŠ¶æ€ï¼šæœªå®ç°**
- `PUT /api/email/config` - æ›´æ–°é‚®ç®±é…ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰**çŠ¶æ€ï¼šæœªå®ç°**

**æ³¨æ„**ï¼šé‚®ä»¶æœåŠ¡APIç›®å‰æœªå®ç°ï¼Œæ–‡æ¡£ä»…æä¾›è§„åˆ’ä¿¡æ¯ã€‚ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨é‚®ä»¶æœåŠ¡å‘é€éªŒè¯ç ç­‰åŠŸèƒ½ï¼Œä½†æœªæä¾›å…¬å¼€çš„APIæ¥å£ã€‚

### ç”¨æˆ·ç›¸å…³
- `GET /api/user/stars` - è·å–ç”¨æˆ·Starçš„çŸ¥è¯†åº“å’Œäººè®¾å¡ï¼ˆåˆ†é¡µï¼Œæ”¯æŒç±»å‹è¿‡æ»¤ã€æ’åºã€å¯é€‰ `includeDetails`ï¼‰
- `GET /api/me/upload-history` - è·å–å½“å‰ç”¨æˆ·çš„ä¸ªäººä¸Šä¼ å†å²è®°å½•ï¼ˆåˆ†é¡µï¼‰
- `GET /api/me/upload-stats` - è·å–å½“å‰ç”¨æˆ·çš„ä¸ªäººä¸Šä¼ ç»Ÿè®¡

### ç®¡ç†å‘˜ç›¸å…³ï¼ˆéœ€è¦adminæƒé™ï¼‰
- `GET /api/admin/broadcast-messages` - è·å–å¹¿æ’­æ¶ˆæ¯ç»Ÿè®¡
- `GET /api/admin/stats` - è·å–ç³»ç»Ÿç»Ÿè®¡æ•°æ®
- `GET /api/admin/recent-users` - è·å–æœ€è¿‘æ³¨å†Œç”¨æˆ·
- `GET /api/admin/users` - è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œæœç´¢ï¼‰
- `PUT /api/admin/users/{user_id}/role` - æ›´æ–°ç”¨æˆ·è§’è‰²
- `DELETE /api/admin/users/{user_id}` - åˆ é™¤ç”¨æˆ·
- `POST /api/admin/users` - åˆ›å»ºæ–°ç”¨æˆ·
- `GET /api/admin/knowledge/all` - è·å–æ‰€æœ‰çŸ¥è¯†åº“ï¼ˆç®¡ç†å‘˜ï¼Œæ”¯æŒä¸Šä¼ è€…ç­›é€‰ä¸æ’åºå­—æ®µ/æ–¹å‘ï¼‰
- `GET /api/admin/persona/all` - è·å–æ‰€æœ‰äººè®¾å¡ï¼ˆç®¡ç†å‘˜ï¼Œæ”¯æŒä¸Šä¼ è€…ç­›é€‰ä¸æ’åºå­—æ®µ/æ–¹å‘ï¼‰
- `POST /api/admin/knowledge/{kb_id}/revert` - æ¢å¤çŸ¥è¯†åº“å®¡æ ¸çŠ¶æ€
- `POST /api/admin/persona/{pc_id}/revert` - æ¢å¤äººè®¾å¡å®¡æ ¸çŠ¶æ€
- `GET /api/admin/upload-history` - è·å–ä¸Šä¼ å†å²è®°å½•
- `GET /api/admin/upload-stats` - è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®
- `DELETE /api/admin/uploads/{upload_id}` - åˆ é™¤ä¸Šä¼ è®°å½•
- `POST /api/admin/uploads/{upload_id}/reprocess` - é‡æ–°å¤„ç†ä¸Šä¼ 

---

## ğŸ“Š åŠŸèƒ½å®Œæˆè¿›åº¦

> ä»¥ä¸‹ä¸ºåç«¯è§†è§’çš„åŠŸèƒ½å®Œæˆæƒ…å†µï¼Œç”¨äºä¸å‰ç«¯ README ä¸­çš„è¿›åº¦è¯´æ˜å¯¹é½ã€‚

### è®¤è¯ä¸ç”¨æˆ·

- [x] JWT ç™»å½•ã€åˆ·æ–° Tokenã€æ³¨å†Œã€æ‰¾å›/é‡ç½®å¯†ç 
- [x] è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ã€å¤´åƒä¸Šä¼ /åˆ é™¤
- [x] ç”¨æˆ·è§’è‰²ç®¡ç†ï¼ˆadmin / moderator / userï¼‰

### çŸ¥è¯†åº“æ¨¡å—

- [x] çŸ¥è¯†åº“ä¸Šä¼  / æ›´æ–° / åˆ é™¤
- [x] çŸ¥è¯†åº“æ–‡ä»¶æ–°å¢ã€åˆ é™¤ä¸æ•´åº“æ‰“åŒ…ä¸‹è½½ï¼ˆZIPï¼‰
- [x] å…¬å¼€çŸ¥è¯†åº“æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ã€æ’åºï¼‰
- [x] Star / å–æ¶ˆ Star ä¸ Star çŠ¶æ€æŸ¥è¯¢
- [x] çŸ¥è¯†åº“å®¡æ ¸æµç¨‹ï¼ˆå¾…å®¡æ ¸ / é€šè¿‡ / æ‹’ç»ï¼‰åŠç›¸å…³æ¥å£

### äººè®¾å¡æ¨¡å—

- [x] äººè®¾å¡ä¸Šä¼  / æ›´æ–° / åˆ é™¤
- [x] äººè®¾å¡æ–‡ä»¶æ–°å¢ã€åˆ é™¤ä¸æ•´å¡æ‰“åŒ…ä¸‹è½½ï¼ˆZIPï¼‰
- [x] å…¬å¼€äººè®¾å¡æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ã€æ’åºï¼‰
- [x] Star / å–æ¶ˆ Star ä¸ Star çŠ¶æ€æŸ¥è¯¢
- [x] äººè®¾å¡å®¡æ ¸æµç¨‹ï¼ˆå¾…å®¡æ ¸ / é€šè¿‡ / æ‹’ç»ï¼‰åŠç›¸å…³æ¥å£

### æ¶ˆæ¯ã€æ”¶è—ä¸ç»Ÿè®¡

- [x] ç«™å†…æ¶ˆæ¯å‘é€ã€åˆ—è¡¨ã€æ ‡è®°å·²è¯»
- [x] ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²ä¸ç»Ÿè®¡æ¥å£
- [x] ç”¨æˆ·æ”¶è—çš„çŸ¥è¯†åº“å’Œäººè®¾å¡æŸ¥è¯¢æ¥å£ï¼ˆ`GET /api/user/stars`ï¼‰
- [x] ç®¡ç†å‘˜ä¸Šä¼ ç»Ÿè®¡ã€ä¸Šä¼ è®°å½•ã€æœ€è¿‘ç”¨æˆ·ç­‰åŸºç¡€è¿è¥ç»Ÿè®¡æ¥å£

### é‚®ä»¶æœåŠ¡

- [x] å†…éƒ¨éªŒè¯ç é‚®ä»¶å‘é€èƒ½åŠ›ï¼ˆæ³¨å†Œ / é‡ç½®å¯†ç ç­‰ï¼‰
- [ ] å¯¹å¤–é‚®ä»¶æœåŠ¡ APIï¼ˆæ–‡æ¡£ä¸­åˆ—å‡ºçš„ `/api/email/*` æ¥å£ï¼‰

---

## è¿­ä»£é˜¶æ®µè§„åˆ’ï¼ˆRoadmapï¼‰

> ä»¥ä¸‹ä¸ºåç«¯è§†è§’çš„é˜¶æ®µæ€§è§„åˆ’ï¼Œä¸»è¦å›´ç»• API å®Œæ•´åº¦ã€æ€§èƒ½ä¸ç¨³å®šæ€§ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ã€å®‰å…¨ä¸è¿ç»´èƒ½åŠ›åˆ†é˜¶æ®µæ¼”è¿›ã€‚

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒ API ä¸é¢†åŸŸèƒ½åŠ›ï¼ˆå·²å®Œæˆï¼‰

**1.1 è®¤è¯ä¸ç”¨æˆ·**

- [x] JWT ç™»å½•ã€åˆ·æ–° Tokenã€æ³¨å†Œã€æ‰¾å›/é‡ç½®å¯†ç 
- [x] å½“å‰ç”¨æˆ·ä¿¡æ¯ã€å¤´åƒä¸Šä¼ /åˆ é™¤ã€ç”¨æˆ·è§’è‰²ç®¡ç†

**1.2 çŸ¥è¯†åº“ä¸äººè®¾å¡**

- [x] çŸ¥è¯†åº“ä¸äººè®¾å¡çš„ä¸Šä¼  / æ›´æ–° / åˆ é™¤
- [x] æ–‡ä»¶æ–°å¢ã€åˆ é™¤ä¸æ•´åº“/æ•´å¡ ZIP æ‰“åŒ…ä¸‹è½½
- [x] å…¬å¼€åˆ—è¡¨æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ã€æ’åºï¼‰
- [x] Star / å–æ¶ˆ Star / Star çŠ¶æ€æŸ¥è¯¢
- [x] å®¡æ ¸æµç¨‹ï¼ˆå¾…å®¡æ ¸ / é€šè¿‡ / æ‹’ç»ï¼‰åŠå®¡æ ¸æ¥å£

**1.3 æ¶ˆæ¯ä¸è¿è¥ç»Ÿè®¡**

- [x] ç«™å†…æ¶ˆæ¯å‘é€ã€åˆ—è¡¨ã€æ ‡è®°å·²è¯»
- [x] ç”¨æˆ·ä¸ªäººä¸Šä¼ å†å²ä¸ç»Ÿè®¡æ¥å£
- [x] ç®¡ç†å‘˜ä¸Šä¼ ç»Ÿè®¡ã€ä¸Šä¼ è®°å½•ã€æœ€è¿‘ç”¨æˆ·ç­‰åŸºç¡€è¿è¥ç»Ÿè®¡

### é˜¶æ®µäºŒï¼šæ€§èƒ½ä¸ç¨³å®šæ€§ï¼ˆè§„åˆ’ä¸­ï¼‰

**2.1 æ€§èƒ½åŸºçº¿ä¸ä¼˜åŒ–**

- [ ] å…³é”®æ¥å£æ€§èƒ½åŸºçº¿æµ‹è¯•  
  é’ˆå¯¹ç™»å½•ã€ä¸Šä¼ ã€å®¡æ ¸ã€ä¸‹è½½ã€æ¶ˆæ¯ç­‰æ ¸å¿ƒè·¯å¾„è¿›è¡ŒåŸºå‡†å‹æµ‹ï¼Œè®°å½•å»¶è¿Ÿä¸ååæŒ‡æ ‡ã€‚
- [ ] æŸ¥è¯¢ä¸ç´¢å¼•ä¼˜åŒ–  
  ç»“åˆå®é™…æ•°æ®é‡ä¸è®¿é—®æ¨¡å¼ï¼Œä¸ºçŸ¥è¯†åº“ã€äººè®¾å¡ã€æ¶ˆæ¯ç­‰è¡¨å¢åŠ å¿…è¦ç´¢å¼•ï¼Œä¼˜åŒ–åˆ†é¡µä¸ç­›é€‰æ€§èƒ½ã€‚

**2.2 ç¨³å®šæ€§ä¸é™çº§ç­–ç•¥**

- [ ] æ–‡ä»¶ä¸Šä¼ ä¸ä¸‹è½½çš„è¶…æ—¶ä¸é‡è¯•ç­–ç•¥  
  åœ¨å¤§æ–‡ä»¶æˆ–ç½‘ç»œä¸ç¨³å®šåœºæ™¯ä¸‹ï¼Œè¡¥å……åˆç†çš„è¶…æ—¶ã€é‡è¯•åŠé”™è¯¯ä¿¡æ¯è¿”å›ã€‚
- [ ] é€Ÿç‡é™åˆ¶ä¸é˜²åˆ·ç»†åŒ–  
  å·²æœ‰é€Ÿç‡é™åˆ¶å™¨åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥åŒºåˆ† IP / ç”¨æˆ·ç»´åº¦çš„é™æµç­–ç•¥ï¼Œå¹¶å¯¹å¼‚å¸¸è¡Œä¸ºåšæ›´ç²¾ç»†ç»Ÿè®¡ã€‚

### é˜¶æ®µä¸‰ï¼šç›‘æ§ä¸å¯è§‚æµ‹æ€§ï¼ˆè§„åˆ’ä¸­ï¼‰

**3.1 æŒ‡æ ‡ä¸æ—¥å¿—ç»“æ„åŒ–**

- [ ] ç»“æ„åŒ–æ—¥å¿—ä¸æ—¥å¿—å­—æ®µè§„èŒƒ  
  ä¸ºå…³é”®æ—¥å¿—ç»Ÿä¸€å­—æ®µï¼ˆrequest_idã€user_idã€ä¸šåŠ¡æ¨¡å—ç­‰ï¼‰ï¼Œæ–¹ä¾¿åç»­æ¥å…¥æ—¥å¿—å¹³å°ã€‚
- [ ] ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡é¢„ç•™  
  ä¸ºä¸Šä¼ é‡ã€å®¡æ ¸é€šè¿‡ç‡ã€é”™è¯¯ç‡ç­‰æŒ‡æ ‡é¢„ç•™æ‰“ç‚¹ä½ç½®ï¼Œä¸å‰ç«¯è¿è¥çœ‹æ¿å½¢æˆé—­ç¯ã€‚

**3.2 ç›‘æ§ä¸å‘Šè­¦å¯¹æ¥é¢„ç•™**

- [ ] å¥åº·æ£€æŸ¥ä¸æ¢é’ˆæ¥å£  
  æä¾› `/health` / `/ready` ç­‰å¥åº·æ£€æŸ¥æ¥å£ï¼Œä¾¿äºå®¹å™¨ç¼–æ’ä¸è´Ÿè½½å‡è¡¡ã€‚
- [ ] å‘Šè­¦é€šé“å¯¹æ¥é¢„ç•™  
  ä¸ºåç»­æ¥å…¥ Prometheus / Grafana / Sentry ç­‰ç›‘æ§æˆ–é”™è¯¯ä¸ŠæŠ¥ç³»ç»Ÿé¢„ç•™æ‰©å±•ç‚¹ã€‚

### é˜¶æ®µå››ï¼šå®‰å…¨ä¸è¿ç»´èƒ½åŠ›ï¼ˆè§„åˆ’ä¸­ï¼‰

**4.1 å®‰å…¨åŠ å›º**

- [ ] æƒé™æ¨¡å‹ä¸è¾¹ç•Œæ ¡éªŒå›é¡¾  
  é€è·¯ç”±æ£€æŸ¥è§’è‰²æƒé™ã€èµ„æºæ‹¥æœ‰è€…æ ¡éªŒï¼Œå®Œå–„å¼‚å¸¸è·¯å¾„ï¼ˆä¾‹å¦‚è¢«å°ç¦ç”¨æˆ·çš„è¡Œä¸ºå¤„ç†ï¼‰ã€‚
- [ ] è¾“å…¥éªŒè¯ä¸é˜²æ³¨å…¥  
  å¯¹ä¸Šä¼ å†…å®¹ã€æœç´¢å‚æ•°ç­‰è¿›è¡Œæ›´ä¸¥æ ¼çš„å­—æ®µæ ¡éªŒä¸é•¿åº¦/æ ¼å¼é™åˆ¶ã€‚

**4.2 éƒ¨ç½²ä¸å¤šç¯å¢ƒæ”¯æŒ**

- [ ] å¤šç¯å¢ƒé…ç½®ä¸åˆ†å±‚é…ç½®ç®¡ç†  
  å°†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„é…ç½®æ‹†åˆ†ï¼Œå¹¶æä¾›ä¸€è‡´çš„åŠ è½½ä¸è¦†ç›–ç­–ç•¥ã€‚
- [ ] éƒ¨ç½²è„šæœ¬ä¸å®¹å™¨åŒ–å®Œå–„  
  å®Œå–„ Dockerfile / å¯åŠ¨è„šæœ¬ï¼Œä½¿éƒ¨ç½²æµç¨‹æ›´æ ‡å‡†åŒ–ã€å¯å¤ç”¨ã€‚

## ğŸ” æƒé™è¯´æ˜

### è§’è‰²å®šä¹‰
- **admin**: ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™
- **moderator**: å®¡æ ¸å‘˜ï¼Œå¯ä»¥å®¡æ ¸å†…å®¹
- **user**: æ™®é€šç”¨æˆ·ï¼Œå¯ä»¥ä¸Šä¼ å’ŒæŸ¥çœ‹å†…å®¹

### æƒé™æ§åˆ¶
- æ–‡ä»¶ä¸Šä¼ ï¼šæ‰€æœ‰è®¤è¯ç”¨æˆ·
- å†…å®¹å®¡æ ¸ï¼šadminå’Œmoderator
- ç”¨æˆ·ç®¡ç†ï¼šadmin
- æ•°æ®ç»Ÿè®¡ï¼šadmin

## ğŸ“ æ–‡ä»¶å­˜å‚¨

### ä¸Šä¼ æ–‡ä»¶ç»“æ„
```
uploads/
â”œâ”€â”€ knowledge/          # çŸ¥è¯†åº“æ–‡ä»¶
â”‚   â””â”€â”€ {user_id}/      # æŒ‰ç”¨æˆ·IDåˆ†ç±»
â”‚       â””â”€â”€ {kb_id}/    # æŒ‰çŸ¥è¯†åº“IDåˆ†ç±»
â””â”€â”€ persona/           # äººè®¾å¡æ–‡ä»¶
    â””â”€â”€ {user_id}/     # æŒ‰ç”¨æˆ·IDåˆ†ç±»
        â””â”€â”€ {pc_id}/   # æŒ‰äººè®¾å¡IDåˆ†ç±»
```

### æ•°æ®å­˜å‚¨
é¡¹ç›®ä½¿ç”¨SQLiteæ•°æ®åº“å­˜å‚¨æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·ä¿¡æ¯ï¼ˆusersè¡¨ï¼‰
- çŸ¥è¯†åº“ä¿¡æ¯ï¼ˆknowledge_basesè¡¨ï¼‰
- äººè®¾å¡ä¿¡æ¯ï¼ˆpersona_cardsè¡¨ï¼‰
- æ¶ˆæ¯ï¼ˆmessagesè¡¨ï¼‰
- Starè®°å½•ï¼ˆstarsè¡¨ï¼‰

æ•°æ®åº“æ–‡ä»¶ä½äºï¼š`data/mainnp.db`

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®
é¡¹ç›®ä½¿ç”¨ `.env` æ–‡ä»¶è¿›è¡Œé…ç½®ç®¡ç†ã€‚é¦–æ¬¡ä½¿ç”¨æ—¶ï¼Œè¯·å¤åˆ¶ `.env.template` æ–‡ä»¶ä¸º `.env` å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®ï¼š

```bash
cp .env.template .env
```

#### ä¸»è¦é…ç½®é¡¹

ä¸‹è¡¨ä¸ `.env.template` ä¿æŒä¸€è‡´ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `SUPERADMIN_USERNAME` | è¶…çº§ç®¡ç†å‘˜ç”¨æˆ·åï¼ˆä»…åœ¨æ•°æ®åº“ä¸ºç©ºæ—¶åˆå§‹åŒ–ï¼‰ | superadmin |
| `SUPERADMIN_PWD` | è¶…çº§ç®¡ç†å‘˜å¯†ç ï¼ˆä»…åœ¨æ•°æ®åº“ä¸ºç©ºæ—¶åˆå§‹åŒ–ï¼‰ | admin123456 |
| `HIGHEST_PASSWORD` | æœ€é«˜æƒé™å¯†ç ï¼ˆä»…æœåŠ¡ç«¯ææƒä½¿ç”¨ï¼‰ | your_highest_password |
| `EXTERNAL_DOMAIN` | å¤–éƒ¨åŸŸåï¼ˆç”¨äºæ„é€ é»˜è®¤é‚®ç®±ç­‰ï¼‰ | example.com |
| `MAIL_HOST` | SMTPæœåŠ¡å™¨åœ°å€ | smtp.qq.com |
| `MAIL_USER` | å‘ä»¶é‚®ç®±åœ°å€ | your_email@qq.com |
| `MAIL_PORT` | SMTPæœåŠ¡å™¨ç«¯å£ | 465 |
| `MAIL_PWD` | é‚®ç®±æˆæƒç /SMTPå¯†ç  | your_email_authorization_code |
| `MAIL_TIMEOUT` | SMTP è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ | 30 |
| `PORT` | æœåŠ¡å™¨ç«¯å£ | 9278 |
| `HOST` | æœåŠ¡å™¨ä¸»æœº | 0.0.0.0 |
| `DATABASE_URL` | æ•°æ®åº“è¿æ¥URLï¼ˆåº”ç”¨ä¸ Alembic å…±ç”¨ï¼‰ | sqlite:///data/mainnp.db |
| `JWT_SECRET_KEY` | JWT å¯†é’¥ | change_me_to_a_very_long_random_string_like_this_example_32_chars_or_more |
| `JWT_ALGORITHM` | JWT ç®—æ³• | HS256 |
| `JWT_EXPIRATION_HOURS` | JWT è¿‡æœŸæ—¶é—´ï¼ˆå°æ—¶ï¼‰ | 24 |
| `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` | è®¿é—® Token è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ | 15 |
| `JWT_REFRESH_TOKEN_EXPIRE_DAYS` | åˆ·æ–° Token è¿‡æœŸæ—¶é—´ï¼ˆå¤©ï¼‰ | 7 |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | INFO |
| `LOG_FILE` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | logs/app.log |
| `MAX_FILE_SIZE_MB` | æœ€å¤§æ–‡ä»¶ä¸Šä¼ å¤§å°ï¼ˆMBï¼‰ | 100 |
| `UPLOAD_DIR` | æ–‡ä»¶ä¸Šä¼ ç›®å½• | uploads |

#### é‚®ç®±é…ç½®è¯´æ˜
é‚®ä»¶æœåŠ¡æ”¯æŒå¤šç§é‚®ç®±æä¾›å•†ï¼š

**QQé‚®ç®±é…ç½®ï¼š**
- éœ€è¦åœ¨QQé‚®ç®±è®¾ç½®ä¸­å¼€å¯SMTPæœåŠ¡
- è·å–æˆæƒç ï¼ˆä¸æ˜¯QQå¯†ç ï¼‰
- ä½¿ç”¨ç«¯å£465ï¼ˆSSLï¼‰æˆ–587ï¼ˆTLSï¼‰

**å…¶ä»–é‚®ç®±é…ç½®ï¼š**
- Gmail: smtp.gmail.com, ç«¯å£587
- 163é‚®ç®±: smtp.163.com, ç«¯å£465
- Outlook: smtp-mail.outlook.com, ç«¯å£587

### æ—§ç‰ˆé…ç½®ï¼ˆå·²å¼ƒç”¨ï¼‰
- ç«¯å£é…ç½®ï¼šé»˜è®¤9278
- æ–‡ä»¶ä¸Šä¼ é™åˆ¶ï¼šå¯é…ç½®
- æ•°æ®å­˜å‚¨è·¯å¾„ï¼šå¯é…ç½®

## ğŸ§¹ æ¸…æ¡£è„šæœ¬ä½¿ç”¨è¯´æ˜

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªå®‰å…¨æ¸…æ¡£è„šæœ¬ï¼Œç”¨äºåœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒä¸­å¿«é€Ÿé‡ç½®å®‰å…¨ç›¸å…³é…ç½®å’Œä¸šåŠ¡æ•°æ®ã€‚

è„šæœ¬ä½ç½®ï¼š`scripts/reset_security_env.py`

### åŠŸèƒ½æ¦‚è¿°

æ‰§è¡Œè„šæœ¬ä¼šå®Œæˆä»¥ä¸‹æ“ä½œï¼š

- å¤‡ä»½å½“å‰ `.env` ä¸º `.env.bak`
- ä¸ºä»¥ä¸‹å­—æ®µç”Ÿæˆæ–°çš„éšæœºå€¼å¹¶å†™å› `.env`ï¼š
  - `JWT_SECRET_KEY`
  - `SUPERADMIN_PWD`
  - `HIGHEST_PASSWORD`
- åˆ é™¤å¹¶é‡å»º SQLite æ•°æ®åº“ `data/mainnp.db`ï¼Œå¹¶æ‰§è¡Œ `alembic upgrade head` é‡æ–°å»ºè¡¨
- æ¸…ç©º `uploads/` ä¸ `logs/` ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼ˆä¿ç•™ç›®å½•ç»“æ„ï¼‰

### é€‚ç”¨åœºæ™¯

- æœ¬åœ°å¼€å‘æ—¶éœ€è¦ã€Œæ¸…æ¡£ã€åˆ°å…¨æ–°ç¯å¢ƒï¼ˆæ¸…ç©ºç”¨æˆ·ã€å†…å®¹ã€ä¸Šä¼ æ–‡ä»¶ã€æ—¥å¿—ç­‰ï¼‰
- è°ƒè¯•å®‰å…¨ç›¸å…³é€»è¾‘ï¼ˆä¾‹å¦‚å°ç¦ã€é”å®šã€å®¡æ ¸æµç¨‹ï¼‰å‰ï¼Œå¸Œæœ›å¿«é€Ÿé‡ç½®å®‰å…¨é…ç½®å’Œè¶…çº§ç®¡ç†å‘˜å¯†ç 

### ä½¿ç”¨æ–¹æ³•

åœ¨åç«¯é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š

```bash
cd MaiMaiNotePad-BackEnd
python scripts/reset_security_env.py
```

è¿è¡Œè„šæœ¬æ—¶ï¼Œç»ˆç«¯ä¼šä»¥é†’ç›®çš„å½©è‰²æç¤ºå±•ç¤ºå°†è¦æ‰§è¡Œçš„å±é™©æ“ä½œï¼Œå¹¶è¦æ±‚ä½ æ‰‹åŠ¨è¾“å…¥å¤§å†™ `RESET` è¿›è¡Œç¡®è®¤ï¼Œåªæœ‰è¾“å…¥æ­£ç¡®æ‰ä¼šç»§ç»­æ‰§è¡Œæ¸…æ¡£ã€‚

æ‰§è¡Œå®Œæˆåï¼Œç»ˆç«¯ä¼šæ‰“å°æ–°çš„ï¼š

- `JWT_SECRET_KEY`
- `SUPERADMIN_PWD`
- `HIGHEST_PASSWORD`

è¯·å¦¥å–„ä¿å­˜æ–°çš„ `SUPERADMIN_PWD`ï¼Œç”¨äºç™»å½•è¶…çº§ç®¡ç†å‘˜è´¦å·ï¼›`HIGHEST_PASSWORD` åªåº”åœ¨æœåŠ¡ç«¯è¿ç»´è„šæœ¬ä¸­ä½¿ç”¨ã€‚

> âš ï¸ æ³¨æ„ï¼šè¯¥è„šæœ¬ä¼šåˆ é™¤æ•°æ®åº“æ–‡ä»¶å¹¶æ¸…ç©ºä¸Šä¼ ä¸æ—¥å¿—ç›®å½•ï¼Œä»…é€‚ç”¨äºæœ¬æœºå¼€å‘æµ‹è¯•æˆ–ä¸Šçº¿å‰çš„æ¸…æ¡£ï¼Œè¯·å‹¿åœ¨æ­£åœ¨è¿è¡Œçš„ç”Ÿäº§æœºå™¨ä¸Šæ‰§è¡Œã€‚

## ğŸ“ å¼€å‘è¯´æ˜

### é¡¹ç›®æ¶æ„

é¡¹ç›®é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œå„å±‚èŒè´£å¦‚ä¸‹ï¼š

#### 1. API å±‚ (`app/api/`)

è´Ÿè´£å¤„ç† HTTP è¯·æ±‚å’Œå“åº”ï¼š
- **è·¯ç”±å®šä¹‰**: å®šä¹‰ API ç«¯ç‚¹å’Œè·¯å¾„
- **è¯·æ±‚éªŒè¯**: ä½¿ç”¨ Pydantic æ¨¡å‹éªŒè¯è¯·æ±‚æ•°æ®
- **æƒé™æ£€æŸ¥**: é€šè¿‡ä¾èµ–æ³¨å…¥è¿›è¡Œè®¤è¯å’Œæˆæƒ
- **å“åº”æ ¼å¼åŒ–**: ç»Ÿä¸€è¿”å›æ ¼å¼

ç¤ºä¾‹è·¯ç”±ï¼š
```python
from fastapi import APIRouter, Depends
from app.api.deps import get_current_user
from app.services.user_service import UserService

router = APIRouter(prefix="/users", tags=["users"])

@router.get("/me")
async def get_current_user_info(
    current_user: dict = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    user_service = UserService(db)
    return user_service.get_user_by_id(current_user["id"])
```

#### 2. æœåŠ¡å±‚ (`app/services/`)

å°è£…ä¸šåŠ¡é€»è¾‘ï¼š
- **ä¸šåŠ¡è§„åˆ™**: å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **æ•°æ®è½¬æ¢**: åœ¨æ•°æ®åº“æ¨¡å‹å’Œ API æ¨¡å‹ä¹‹é—´è½¬æ¢
- **äº‹åŠ¡ç®¡ç†**: å¤„ç†æ•°æ®åº“äº‹åŠ¡
- **ç‹¬ç«‹æµ‹è¯•**: ä¸ä¾èµ– FastAPIï¼Œæ˜“äºå•å…ƒæµ‹è¯•

ç¤ºä¾‹æœåŠ¡ï¼š
```python
from sqlalchemy.orm import Session
from app.models.database import User

class UserService:
    def __init__(self, db: Session):
        self.db = db
    
    def get_user_by_id(self, user_id: str):
        return self.db.query(User).filter(User.id == user_id).first()
    
    def create_user(self, username: str, email: str, password: str):
        # ä¸šåŠ¡é€»è¾‘å®ç°
        pass
```

#### 3. æ•°æ®å±‚ (`app/models/`)

å®šä¹‰æ•°æ®æ¨¡å‹ï¼š
- **database.py**: SQLAlchemy æ•°æ®åº“æ¨¡å‹ï¼Œå®šä¹‰è¡¨ç»“æ„å’Œå…³ç³»
- **schemas.py**: Pydantic API æ¨¡å‹ï¼Œç”¨äºè¯·æ±‚éªŒè¯å’Œå“åº”åºåˆ—åŒ–

### æ·»åŠ æ–°åŠŸèƒ½

#### 1. æ·»åŠ æ–°çš„ API ç«¯ç‚¹

1. åœ¨ `app/services/` ä¸­åˆ›å»ºæˆ–æ›´æ–°æœåŠ¡ç±»
2. åœ¨ `app/api/routes/` ä¸­åˆ›å»ºæˆ–æ›´æ–°è·¯ç”±æ–‡ä»¶
3. åœ¨ `app/api/__init__.py` ä¸­æ³¨å†Œæ–°è·¯ç”±ï¼ˆå¦‚æœæ˜¯æ–°æ–‡ä»¶ï¼‰
4. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

#### 2. æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹

1. åœ¨ `app/models/database.py` ä¸­å®šä¹‰ SQLAlchemy æ¨¡å‹
2. åœ¨ `app/models/schemas.py` ä¸­å®šä¹‰ Pydantic æ¨¡å‹
3. åˆ›å»º Alembic è¿ç§»ï¼š
   ```bash
   ./scripts/shell/alembic.sh revision --autogenerate -m "Add new model"
   ./scripts/shell/alembic.sh upgrade head
   ```

#### 3. æ·»åŠ æ–°çš„é…ç½®é¡¹

1. åœ¨ `app/core/config.py` çš„ `Settings` ç±»ä¸­æ·»åŠ å­—æ®µ
2. åœ¨ `.env.template` ä¸­æ·»åŠ é…ç½®è¯´æ˜
3. æ›´æ–° README.md çš„é…ç½®è¯´æ˜éƒ¨åˆ†

### ä»£ç è§„èŒƒ

#### å¯¼å…¥è§„èŒƒ
- ä½¿ç”¨ç»å¯¹å¯¼å…¥ï¼ˆä» `app` å¼€å§‹ï¼‰
- é¿å…å¾ªç¯ä¾èµ–
- æŒ‰æ ‡å‡†åº“ã€ç¬¬ä¸‰æ–¹åº“ã€æœ¬åœ°æ¨¡å—çš„é¡ºåºç»„ç»‡å¯¼å…¥

```python
# æ ‡å‡†åº“
from typing import Optional, List
from datetime import datetime

# ç¬¬ä¸‰æ–¹åº“
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

# æœ¬åœ°æ¨¡å—
from app.core.database import get_db
from app.services.user_service import UserService
from app.models.schemas import UserResponse
```

#### ç±»å‹æ³¨è§£
- æ‰€æœ‰å‡½æ•°å‚æ•°å’Œè¿”å›å€¼éƒ½åº”è¯¥æœ‰ç±»å‹æ³¨è§£
- ä½¿ç”¨ `typing` æ¨¡å—æä¾›çš„ç±»å‹

```python
from typing import Optional, List

def get_users(
    db: Session,
    skip: int = 0,
    limit: int = 100
) -> List[User]:
    return db.query(User).offset(skip).limit(limit).all()
```

#### æ–‡æ¡£å­—ç¬¦ä¸²
- æ‰€æœ‰å…¬å…±å‡½æ•°éƒ½åº”è¯¥æœ‰ docstring
- ä½¿ç”¨ Google é£æ ¼çš„ docstring

```python
def create_user(username: str, email: str, password: str) -> User:
    """åˆ›å»ºæ–°ç”¨æˆ·
    
    Args:
        username: ç”¨æˆ·å
        email: é‚®ç®±åœ°å€
        password: å¯†ç ï¼ˆæ˜æ–‡ï¼‰
    
    Returns:
        åˆ›å»ºçš„ç”¨æˆ·å¯¹è±¡
    
    Raises:
        ValueError: ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨
    """
    pass
```

### æµ‹è¯•

#### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/test_auth.py

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
pytest tests/test_auth.py::test_login

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
pytest --cov=app --cov-report=html
```

#### ç¼–å†™æµ‹è¯•

æµ‹è¯•æ–‡ä»¶åº”è¯¥é•œåƒ `app/` çš„ç›®å½•ç»“æ„ï¼š

```
tests/
â”œâ”€â”€ conftest.py           # æµ‹è¯•é…ç½®å’Œ fixtures
â”œâ”€â”€ test_auth.py          # è®¤è¯ç›¸å…³æµ‹è¯•
â”œâ”€â”€ test_users.py         # ç”¨æˆ·ç›¸å…³æµ‹è¯•
â””â”€â”€ services/             # æœåŠ¡å±‚æµ‹è¯•
    â”œâ”€â”€ test_user_service.py
    â””â”€â”€ test_auth_service.py
```

ç¤ºä¾‹æµ‹è¯•ï¼š
```python
import pytest
from app.services.user_service import UserService

def test_create_user(db_session):
    """æµ‹è¯•åˆ›å»ºç”¨æˆ·"""
    service = UserService(db_session)
    user = service.create_user(
        username="testuser",
        email="test@example.com",
        password="password123"
    )
    
    assert user.username == "testuser"
    assert user.email == "test@example.com"
```

### ä»£ç è´¨é‡

é¡¹ç›®ä½¿ç”¨å¤šä¸ªä»£ç è´¨é‡å·¥å…·ç¡®ä¿ä»£ç è§„èŒƒï¼š

```bash
# è¿è¡Œæ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥
./manage.sh lint

# æˆ–å•ç‹¬è¿è¡Œ
black app tests scripts/python      # ä»£ç æ ¼å¼åŒ–
flake8 app tests scripts/python     # ä»£ç é£æ ¼æ£€æŸ¥
mypy app                            # ç±»å‹æ£€æŸ¥
```

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š[ä»£ç è´¨é‡å·¥å…·æ–‡æ¡£](docs/development/ä»£ç è´¨é‡å·¥å…·.md)

### æ•°æ®åº“è¿ç§»

ä½¿ç”¨ Alembic ç®¡ç†æ•°æ®åº“è¿ç§»ï¼š

```bash
# ä½¿ç”¨åŒ…è£…è„šæœ¬ï¼ˆæ¨èï¼‰
./scripts/shell/alembic.sh revision --autogenerate -m "æè¿°è¿ç§»å†…å®¹"
./scripts/shell/alembic.sh upgrade head
./scripts/shell/alembic.sh downgrade -1
./scripts/shell/alembic.sh history
./scripts/shell/alembic.sh current

# æˆ–è€…ç›´æ¥ä½¿ç”¨ alembic å‘½ä»¤ï¼ˆéœ€è¦æŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
alembic -c configs/alembic.ini revision --autogenerate -m "æè¿°è¿ç§»å†…å®¹"
alembic -c configs/alembic.ini upgrade head
alembic -c configs/alembic.ini downgrade -1
alembic -c configs/alembic.ini history
alembic -c configs/alembic.ini current
```

### è°ƒè¯•æŠ€å·§

#### 1. ä½¿ç”¨æ—¥å¿—

```python
from app.core.logging import logger

logger.info("ç”¨æˆ·ç™»å½•", extra={"user_id": user.id})
logger.error("ç™»å½•å¤±è´¥", extra={"username": username})
```

#### 2. ä½¿ç”¨ FastAPI çš„è°ƒè¯•æ¨¡å¼

åœ¨ `app/main.py` ä¸­è®¾ç½®ï¼š
```python
app = FastAPI(debug=True)
```

#### 3. ä½¿ç”¨ Python è°ƒè¯•å™¨

```python
import pdb; pdb.set_trace()  # è®¾ç½®æ–­ç‚¹
```

### å¸¸è§é—®é¢˜

#### Q: å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ
A: 
1. æ£€æŸ¥å¯¼å…¥é¡ºåºï¼Œå°†ç±»å‹æ³¨è§£æ”¹ä¸ºå­—ç¬¦ä¸²å½¢å¼
2. ä½¿ç”¨ `TYPE_CHECKING` æ¡ä»¶å¯¼å…¥
3. é‡æ–°è®¾è®¡æ¨¡å—ç»“æ„ï¼Œé¿å…ç›¸äº’ä¾èµ–

```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from app.models.database import User

def get_user() -> "User":
    pass
```

#### Q: å¦‚ä½•å¤„ç†æ•°æ®åº“ä¼šè¯ï¼Ÿ
A: ä½¿ç”¨ä¾èµ–æ³¨å…¥è·å–æ•°æ®åº“ä¼šè¯ï¼ŒFastAPI ä¼šè‡ªåŠ¨ç®¡ç†ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸï¼š

```python
from fastapi import Depends
from app.core.database import get_db

@router.get("/users")
def get_users(db: Session = Depends(get_db)):
    # ä½¿ç”¨ db è¿›è¡Œæ•°æ®åº“æ“ä½œ
    pass
```

#### Q: å¦‚ä½•æ·»åŠ ä¸­é—´ä»¶ï¼Ÿ
A: åœ¨ `app/core/middleware.py` ä¸­å®šä¹‰ä¸­é—´ä»¶ï¼Œç„¶ååœ¨ `app/main.py` ä¸­æ³¨å†Œï¼š

```python
# app/core/middleware.py
from fastapi import Request

async def custom_middleware(request: Request, call_next):
    # å¤„ç†è¯·æ±‚å‰çš„é€»è¾‘
    response = await call_next(request)
    # å¤„ç†å“åº”åçš„é€»è¾‘
    return response

# app/main.py
from app.core.middleware import custom_middleware

app.middleware("http")(custom_middleware)
```

### ä»£ç è§„èŒƒ
- ä½¿ç”¨Pythonç±»å‹æ³¨è§£
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ
- æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£

### é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

### å®‰å…¨æ€§
- å¯†ç ä½¿ç”¨bcryptå“ˆå¸Œ
- JWT tokenè®¤è¯
- è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ£€æŸ¥

## ğŸ› å¸¸è§é—®é¢˜

### Q: ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ
A: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å¹¶ç»ˆæ­¢å ç”¨è¿›ç¨‹ï¼š
```bash
netstat -ano | findstr :9278
taskkill /PID <PID> /F
```

### Q: APIæ¥å£è°ƒç”¨å¤±è´¥ï¼Ÿ
A: è¯·ç¡®ä¿æ‰€æœ‰APIè¯·æ±‚éƒ½åŒ…å«`/api`å‰ç¼€ï¼Œä¾‹å¦‚ï¼š
- ç™»å½•æ¥å£åº”ä¸º `/api/token` è€Œä¸æ˜¯ `/token`
- äººè®¾å¡æ¥å£åº”ä¸º `/api/persona/public` è€Œä¸æ˜¯ `/persona/public`

### Q: å¦‚ä½•æ·»åŠ æ–°ç”¨æˆ·ï¼Ÿ
A: é€šè¿‡APIæ¥å£æˆ–ä¿®æ”¹users.jsonæ–‡ä»¶

### Q: æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥uploadsç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´

### Q: å¦‚ä½•ä¿®æ”¹é»˜è®¤ç«¯å£ï¼Ÿ
A: ä¿®æ”¹å¯åŠ¨å‘½ä»¤ä¸­çš„ç«¯å£å·å‚æ•°

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç æ›´æ”¹
4. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- é¡¹ç›®Issues
- é‚®ç®±è”ç³»

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªæ•™è‚²é¡¹ç›®ï¼Œè¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ã€‚å¦‚éœ€ç”Ÿäº§éƒ¨ç½²ï¼Œè¯·è€ƒè™‘æ·»åŠ æ•°æ®åº“ã€ç¼“å­˜ã€ç›‘æ§ç­‰ç”Ÿäº§çº§åŠŸèƒ½ã€‚
