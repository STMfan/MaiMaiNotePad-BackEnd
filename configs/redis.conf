# ============================================================================
# Redis 配置文件
# 用途：Redis 服务器的详细配置
# 说明：此文件由 Docker Compose 挂载到 Redis 容器中
# ============================================================================

# ============================================================================
# 网络配置
# ============================================================================

# 绑定地址（0.0.0.0 允许所有网络接口访问）
bind 0.0.0.0

# 保护模式（在 Docker 环境中可以禁用）
protected-mode no

# 端口
port 6379

# TCP 连接队列长度
tcp-backlog 511

# 客户端超时时间（0 表示禁用）
timeout 0

# TCP keepalive
tcp-keepalive 300

# ============================================================================
# 持久化配置
# ============================================================================

# RDB 持久化配置
# 格式：save <seconds> <changes>
# 说明：在指定时间内有指定数量的键变化时触发保存
save 900 1      # 900 秒内至少 1 个键变化
save 300 10     # 300 秒内至少 10 个键变化
save 60 10000   # 60 秒内至少 10000 个键变化

# RDB 文件名
dbfilename dump.rdb

# 数据目录
dir /data

# RDB 压缩
rdbcompression yes

# RDB 校验和
rdbchecksum yes

# AOF 持久化配置
appendonly yes
appendfilename "appendonly.aof"

# AOF 同步策略
# - always: 每次写入都同步（最安全但最慢）
# - everysec: 每秒同步一次（推荐，平衡性能和安全）
# - no: 由操作系统决定何时同步（最快但最不安全）
appendfsync everysec

# AOF 重写配置
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================================================
# 内存管理
# ============================================================================

# 最大内存限制（2GB）
maxmemory 2gb

# 内存淘汰策略
# - allkeys-lru: 在所有键中使用 LRU 算法淘汰（推荐）
# - volatile-lru: 仅在设置了过期时间的键中使用 LRU 算法
# - allkeys-random: 在所有键中随机淘汰
# - volatile-random: 仅在设置了过期时间的键中随机淘汰
# - volatile-ttl: 淘汰即将过期的键
# - noeviction: 不淘汰，内存满时返回错误
maxmemory-policy allkeys-lru

# 内存样本数量（用于 LRU 算法）
maxmemory-samples 5

# ============================================================================
# 日志配置
# ============================================================================

# 日志级别
# - debug: 大量信息，适合开发和测试
# - verbose: 包含很多不太有用的信息，但比 debug 少
# - notice: 适度冗长，适合生产环境（推荐）
# - warning: 仅记录非常重要的消息
loglevel notice

# 日志文件（空字符串表示输出到标准输出）
logfile ""

# ============================================================================
# 客户端配置
# ============================================================================

# 最大客户端连接数
maxclients 10000

# ============================================================================
# 慢查询日志
# ============================================================================

# 慢查询阈值（微秒）
# 10000 微秒 = 10 毫秒
slowlog-log-slower-than 10000

# 慢查询日志最大长度
slowlog-max-len 128

# ============================================================================
# 高级配置
# ============================================================================

# 哈希表配置
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表配置
list-max-ziplist-size -2
list-compress-depth 0

# 集合配置
set-max-intset-entries 512

# 有序集合配置
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog 配置
hll-sparse-max-bytes 3000

# 流配置
stream-node-max-bytes 4096
stream-node-max-entries 100

# 活跃碎片整理
activerehashing yes

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 后台任务频率（1-500，值越大频率越高）
hz 10

# 动态 hz
dynamic-hz yes

# AOF 重写时是否使用增量同步
aof-rewrite-incremental-fsync yes

# RDB 保存时是否使用增量同步
rdb-save-incremental-fsync yes
